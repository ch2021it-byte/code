

/**
 * ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - Google Apps Script Backend
 */

// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏∑‡πà‡∏≠ Spreadsheet ‡πÅ‡∏•‡∏∞ Sheet
const SPREADSHEET_ID = '10SgCZ2H-4d37-3Slcj-riBK2SDgAbYpXW6SZvgSFUa8';
const ITEMS_SHEET = 'Items';
const PRICE_STUDY_SHEET = '‡∫™‡∫∂‡∫Å‡∫™‡∫≤‡∫•‡∫≤‡∫Ñ‡∫≤‡∫ï‡∫ª‡ªâ‡∫ô‡∫ó‡∫∂‡∫ô';
const ORDER_SHEET_ID = '1zk7v8iClQjGf7WseWld_hwix4upAr7KoGqn-eo01fgk';
const ORDER_SHEET = '‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤';

const INITIAL_QUOTA = 20000;

/**
 * ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö HTML
 */
function doGet() {
  return HtmlService.createTemplateFromFile('index')
    .evaluate()
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

/**
 * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á Items
 */
function getItemsData() {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(ITEMS_SHEET);
   
    if (!sheet) {
      Logger.log('Sheet "' + ITEMS_SHEET + '" not found');
      return [];
    }
   
    const data = sheet.getDataRange().getValues();
    if (!data || data.length <= 1) {
      Logger.log('No data in Items sheet');
      return [];
    }
    
    const headers = data[0];
    const rows = data.slice(1);
   
    const result = [];
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const item = {};
      for (let j = 0; j < headers.length; j++) {
        item['column' + String.fromCharCode(65 + j)] = row[j] || '';
      }
      result.push(item);
    }
    
    return result;
  } catch (error) {
    Logger.log('Error getting items data: ' + error.toString());
    return [];
  }
}
/**
 * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡∫™‡∫∂‡∫Å‡∫™‡∫≤‡∫•‡∫≤‡∫Ñ‡∫≤‡∫ï‡∫ª‡ªâ‡∫ô‡∫ó‡∫∂‡∫ô (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: Debug ‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)
 */
function getPriceStudyData() {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(PRICE_STUDY_SHEET);
   
    if (!sheet) {
      Logger.log('‚ùå Sheet "' + PRICE_STUDY_SHEET + '" not found');
      return [];
    }
   
    const lastRow = sheet.getLastRow();
    const lastCol = sheet.getLastColumn();
    
    Logger.log('üìä Sheet: ' + PRICE_STUDY_SHEET);
    Logger.log('üìè Last Row: ' + lastRow);
    Logger.log('üìè Last Column: ' + lastCol);
    
    if (lastRow <= 1) {
      Logger.log('‚ö†Ô∏è No data rows found');
      return [];
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const data = sheet.getRange(1, 1, lastRow, lastCol).getValues();
    const headers = data[0];
    
    Logger.log('üìã Headers: ' + JSON.stringify(headers));
    
    const rows = data.slice(1);
    const result = [];
    
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Column B (index 1) ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      if (!row[1] || row[1].toString().trim() === '') {
        continue; // ‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á
      }
      
      const item = {
        columnA: row[0] ? row[0].toString().trim() : '',
        columnB: row[1] ? row[1].toString().trim() : '', // Barcode (KEY)
        columnC: row[2] ? row[2].toString().trim() : '',
        columnD: row[3] ? row[3].toString().trim() : '',
        columnE: row[4] ? row[4].toString().trim() : '',
        columnF: row[5] ? row[5].toString().trim() : '', // ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô
        columnG: row[6] ? row[6].toString() : '',
        columnH: row[7] ? parseFloat(row[7]) : 0,        // ‡∏£‡∏≤‡∏Ñ‡∏≤
        columnI: row[8] ? row[8].toString() : '',
        columnJ: row[9] ? row[9].toString() : ''
      };
      
      result.push(item);
      
      // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 3 ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å
      if (i < 3) {
        Logger.log('Sample Row ' + (i + 1) + ':');
        Logger.log('  Barcode (B): ' + item.columnB);
        Logger.log('  Store (F): ' + item.columnF);
        Logger.log('  Price (H): ' + item.columnH);
      }
    }
    
    Logger.log('‚úÖ Total items loaded: ' + result.length);
    return result;
    
  } catch (error) {
    Logger.log('‚ùå Error: ' + error.toString());
    Logger.log('Stack: ' + error.stack);
    return [];
  }
}

/**
 * ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Column F
 */
function getStoreList() {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(PRICE_STUDY_SHEET);
   
    if (!sheet) {
      Logger.log('Sheet "' + PRICE_STUDY_SHEET + '" not found');
      return [];
    }
   
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      return [];
    }
    
    const data = sheet.getRange('F2:F' + lastRow).getValues();
    const storesSet = {};
    
    for (let i = 0; i < data.length; i++) {
      const store = data[i][0];
      if (store && store.toString().trim()) {
        storesSet[store.toString().trim()] = true;
      }
    }
    
    const stores = Object.keys(storesSet).sort();
    return stores;
  } catch (error) {
    Logger.log('Error getting store list: ' + error.toString());
    return [];
  }
}

/**
 * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏•‡∏∞‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°)
 */
function saveOrder(orderData) {
  try {
    const ss = SpreadsheetApp.openById(ORDER_SHEET_ID);
    let sheet = ss.getSheetByName(ORDER_SHEET);
    
    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ sheet ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
    if (!sheet) {
      sheet = ss.insertSheet(ORDER_SHEET);
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á header
      sheet.appendRow(['‡∫ß‡∫±‡∫ô‡∫ó‡∫µ', '‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ', '‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤', '‡∫ä‡∫∑‡ªà‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤', '‡∫´‡∫ª‡∫ß‡ªú‡ªà‡∫ß‡∫ç', '‡∫à‡∫≥‡∫ô‡∫ß‡∫ô', '‡∫•‡∫≤‡∫Ñ‡∫≤/‡ªú‡ªà‡∫ß‡∫ç', '‡∫•‡∫ß‡∫°‡ªÄ‡∫á‡∫¥‡∫ô', '‡∫ß‡∫¥‡∫ó‡∫µ‡∫Å‡∫≤‡∫ô']);
    }
    
    const orderNumber = orderData.orderNumber;
    const method = orderData.method;
    const isUpdate = orderData.isUpdate || false; // ‡πÄ‡∏û‡∏¥‡πà‡∏° flag ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó
    
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô
    if (isUpdate) {
      deleteOrderRows(sheet, orderNumber);
    }
    
    const timestamp = new Date();
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    const items = orderData.items;
    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      sheet.appendRow([
        timestamp,
        orderNumber,
        item.barcode,
        item.itemName,
        item.unit,
        item.quantity,
        item.price,
        item.total,
        method
      ]);
    }
    
    return { success: true, orderNumber: orderNumber };
  } catch (error) {
    Logger.log('Error saving order: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

/**
 * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏î‡∏¥‡∏°
 */
function loadOrder(orderNumber) {
  try {
    const ss = SpreadsheetApp.openById(ORDER_SHEET_ID);
    const sheet = ss.getSheetByName(ORDER_SHEET);
    
    if (!sheet) {
      return { success: false, items: [] };
    }
    
    const data = sheet.getDataRange().getValues();
    if (!data || data.length <= 1) {
      return { success: false, items: [] };
    }
    
    const headers = data[0];
    const rows = data.slice(1);
    
    // ‡πÄ‡∏õ‡∏¥‡∏î Items sheet ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
    const itemsSS = SpreadsheetApp.openById(SPREADSHEET_ID);
    const itemsSheet = itemsSS.getSheetByName(ITEMS_SHEET);
    const itemsData = itemsSheet ? itemsSheet.getDataRange().getValues() : [];
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Map ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å barcode
    const itemsImageMap = {};
    if (itemsData.length > 1) {
      for (let i = 1; i < itemsData.length; i++) {
        const barcode = itemsData[i][0]; // Column A
        const image = itemsData[i][10]; // Column K (index 10)
        if (barcode) {
          itemsImageMap[barcode.toString().trim()] = image || '';
        }
      }
    }
    
    const orderItems = [];
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      if (row[1] === orderNumber) {
        const barcode = row[2];
        const image = itemsImageMap[barcode.toString().trim()] || ''; // ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å Items sheet
        
       orderItems.push({
    barcode: barcode || '',
    itemName: row[3] || '‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫ä‡∫∑‡ªà',
    unit: row[4] || '‡∫ä‡∫¥‡ªâ‡∫ô',
    quantity: parseFloat(row[5]) || 0,
    price: parseFloat(row[6]) || 0,
    total: parseFloat(row[7]) || 0,
    image: image || ''
});
      }
    }
    
    return { success: true, items: orderItems };
  } catch (error) {
    Logger.log('Error loading order: ' + error.toString());
    return { success: false, items: [] };
  }
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà
 */
function generateOrderNumber() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const time = String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0');
  
  return 'PO-' + year + month + day + '-' + time;
}

function debugPriceStudy() {
  try {
    const ss = SpreadsheetApp.openById('10SgCZ2H-4d37-3Slcj-riBK2SDgAbYpXW6SZvgSFUa8');
    Logger.log('Spreadsheet opened: ' + ss.getName());
    
    const sheet = ss.getSheetByName('‡∫™‡∫∂‡∫Å‡∫™‡∫≤‡∫•‡∫≤‡∫Ñ‡∫≤‡∫ï‡∫ª‡ªâ‡∫ô‡∫ó‡∫∂‡∫ô');
    Logger.log('Sheet found: ' + (sheet ? 'YES' : 'NO'));
    
    if (sheet) {
      Logger.log('Last Row: ' + sheet.getLastRow());
      Logger.log('Last Column: ' + sheet.getLastColumn());
      
      const data = sheet.getDataRange().getValues();
      Logger.log('Data rows: ' + data.length);
      Logger.log('First row: ' + JSON.stringify(data[0]));
    }
    
    const result = getPriceStudyData();
    Logger.log('getPriceStudyData result length: ' + result.length);
    Logger.log('First item: ' + JSON.stringify(result[0]));
    
  } catch (error) {
    Logger.log('ERROR: ' + error.toString());
  }
}
/**
 * ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function deleteOrderRows(sheet, orderNumber) {
  try {
    const data = sheet.getDataRange().getValues();
    const rowsToDelete = [];
    
    // ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö orderNumber (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 2 ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß 1 ‡πÄ‡∏õ‡πá‡∏ô header)
    for (let i = 1; i < data.length; i++) {
      if (data[i][1] === orderNumber) { // Column B (index 1) ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
        rowsToDelete.push(i + 1); // +1 ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ array ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 0 ‡πÅ‡∏ï‡πà row ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 1
      }
    }
    
    // ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ index ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô
    for (let i = rowsToDelete.length - 1; i >= 0; i--) {
      sheet.deleteRow(rowsToDelete[i]);
    }
    
    Logger.log('Deleted ' + rowsToDelete.length + ' rows for order: ' + orderNumber);
  } catch (error) {
    Logger.log('Error deleting order rows: ' + error.toString());
  }
}
/**
 * ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà + ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà)
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
/**
 * ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà + ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà + ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
 * ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
 */
function getOrderList() {
  try {
    const ss = SpreadsheetApp.openById(ORDER_SHEET_ID);
    const sheet = ss.getSheetByName(ORDER_SHEET);
    
    if (!sheet) {
      return [];
    }
    
    const data = sheet.getDataRange().getValues();
    if (!data || data.length <= 1) {
      return [];
    }
    
    const ordersMap = {};
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß 2 (‡∏Ç‡πâ‡∏≤‡∏° header)
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const date = row[0]; // Column A - ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
      const orderNumber = row[1]; // Column B - ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
      
      if (orderNumber) {
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
        if (!ordersMap[orderNumber]) {
          const dateStr = Utilities.formatDate(new Date(date), Session.getScriptTimeZone(), 'dd/MM/yyyy HH:mm');
          ordersMap[orderNumber] = {
            orderNumber: orderNumber,
            date: dateStr,
            itemCount: 0, // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            displayText: '' // ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á
          };
        }
        
        // ‚≠ê ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        ordersMap[orderNumber].itemCount++;
      }
    }
    
    // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô array ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á displayText
    const orderList = Object.values(ordersMap).map(function(order) {
      // ‚≠ê ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà - ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà - X ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô
      order.displayText = order.date + ' - ' + order.orderNumber + ' - ' + order.itemCount + ' ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô';
      return order;
    });
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
    orderList.sort(function(a, b) {
      return b.orderNumber.localeCompare(a.orderNumber);
    });
    
    return orderList;
  } catch (error) {
    Logger.log('Error getting order list: ' + error.toString());
    return [];
  }
}
/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Drive
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Drive (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ Google Docs)
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function createPDFAndUploadToDrive(htmlContent, orderNumber) {
  try {
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Google Doc ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    const tempDoc = DocumentApp.create('Temp_' + orderNumber);
    const docId = tempDoc.getId();
    const doc = DocumentApp.openById(docId);
    const body = doc.getBody();
    
    // ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏î‡∏¥‡∏°
    body.clear();
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Header
    const header = body.appendParagraph('‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤');
    header.setHeading(DocumentApp.ParagraphHeading.HEADING1);
    header.setAlignment(DocumentApp.HorizontalAlignment.CENTER);
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
    body.appendParagraph('‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ: ' + orderNumber);
    body.appendParagraph('‡∫ß‡∫±‡∫ô‡∫ó‡∫µ: ' + Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'dd/MM/yyyy HH:mm:ss'));
    body.appendParagraph(''); // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å orderItems)
    // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á orderItems ‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢
    
    doc.saveAndClose();
    
    // ‡πÅ‡∏õ‡∏•‡∏á Google Doc ‡πÄ‡∏õ‡πá‡∏ô PDF
    const docFile = DriveApp.getFileById(docId);
    const pdfBlob = docFile.getAs('application/pdf');
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå
    const fileName = '‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ_' + orderNumber + '_' + Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyyMMdd_HHmmss') + '.pdf';
    
    // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Google Drive folder
    const folder = DriveApp.getFolderById('1jmglJOSJFAD-1eQbtpY2Etu69fA9jtLv');
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF ‡πÉ‡∏ô Drive
    const file = folder.createFile(pdfBlob);
    file.setName(fileName);
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÉ‡∏Ñ‡∏£‡∏Å‡πá‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    // ‡∏•‡∏ö Google Doc ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    docFile.setTrashed(true);
    
    // ‡∏î‡∏∂‡∏á URL ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå
    const fileId = file.getId();
    const directUrl = 'https://drive.google.com/file/d/' + fileId + '/view?usp=sharing';
    
    return {
      success: true,
      fileName: fileName,
      fileUrl: directUrl,
      fileId: fileId
    };
  } catch (error) {
    Logger.log('Error creating PDF: ' + error.toString());
    return {
      success: false,
      error: error.toString()
    };
  }
}
function createPDFFromOrderData(orderData) {
  try {
    const ss = SpreadsheetApp.create('Temp_Order_' + orderData.orderNumber);
    const sheet = ss.getActiveSheet();
    const ssId = ss.getId();

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î
    sheet.getRange('A:Z').setFontFamily('Noto Sans Lao').setFontSize(12);

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
    sheet.setColumnWidth(1, 50);
    sheet.setColumnWidth(2, 120);
    sheet.setColumnWidth(3, 80);
    sheet.setColumnWidth(4, 200);
    sheet.setColumnWidth(5, 80);
    sheet.setColumnWidth(6, 80);
    sheet.setColumnWidth(7, 100);
    sheet.setColumnWidth(8, 120);

    let currentRow = 1;

    // Header
    sheet.getRange(currentRow, 1, 1, 8).merge();
    const headerCell = sheet.getRange(currentRow, 1);
    headerCell.setValue('‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤')
      .setFontSize(20).setFontWeight('bold')
      .setHorizontalAlignment('center').setVerticalAlignment('middle')
      .setBackground('#25d366').setFontColor('#ffffff');
    sheet.setRowHeight(currentRow, 40);
    currentRow++;

    sheet.setRowHeight(currentRow, 10);
    currentRow++;

    sheet.getRange(currentRow, 1).setValue('‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ:').setFontWeight('bold');
    sheet.getRange(currentRow, 2, 1, 3).merge().setValue(orderData.orderNumber);
    sheet.setRowHeight(currentRow, 25);
    currentRow++;

    sheet.getRange(currentRow, 1).setValue('‡∫ß‡∫±‡∫ô‡∫ó‡∫µ:').setFontWeight('bold');
    sheet.getRange(currentRow, 2, 1, 3).merge().setValue(orderData.date);
    sheet.setRowHeight(currentRow, 25);
    currentRow++;

    sheet.setRowHeight(currentRow, 10);
    currentRow++;

    const headerRow = currentRow;
    const headers = ['‡∫•‡∫≥‡∫î‡∫±‡∫ö','‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤','‡∫Æ‡∫π‡∫ö','‡∫ä‡∫∑‡ªà‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤','‡∫´‡∫ª‡∫ß‡ªú‡ªà‡∫ß‡∫ç','‡∫à‡∫≥‡∫ô‡∫ß‡∫ô','‡∫•‡∫≤‡∫Ñ‡∫≤/‡ªú‡ªà‡∫ß‡∫ç','‡∫•‡∫ß‡∫°‡ªÄ‡∫á‡∫¥‡∫ô'];
    for (let i = 0; i < headers.length; i++) {
      const cell = sheet.getRange(headerRow, i+1);
      cell.setValue(headers[i]).setFontWeight('bold')
        .setBackground('#2c3e50').setFontColor('#ffffff')
        .setHorizontalAlignment('center').setVerticalAlignment('middle');
    }
    sheet.setRowHeight(headerRow, 35);
    currentRow++;

    orderData.items.forEach(function(item, index){
      sheet.setRowHeight(currentRow, 70);
      const rowRange = sheet.getRange(currentRow,1,1,8);
      rowRange.setVerticalAlignment('middle').setWrap(true);

      sheet.getRange(currentRow,1).setValue(index+1).setHorizontalAlignment('center');
      sheet.getRange(currentRow,2).setValue(item.barcode || '-');

      try {
        const imageCell = sheet.getRange(currentRow, 3);
        if(item.image && item.image.trim()!==''){
          const match = item.image.match(/id=([a-zA-Z0-9_-]+)/);
          if(match){
            const fileId = match[1];
            const file = DriveApp.getFileById(fileId);
            const blob = file.getBlob();

            const images = sheet.getImages();
            images.forEach(img => {
              const pos = img.getAnchorCell();
              if(pos.getRow()===currentRow && pos.getColumn()===3) img.remove();
            });

            const cellWidth = sheet.getColumnWidth(3);
            const cellHeight = sheet.getRowHeight(currentRow);
            const imgInserted = sheet.insertImage(blob, 3, currentRow);
            imgInserted.setAnchorCell(imageCell);
            imgInserted.setWidth(cellWidth);
            imgInserted.setHeight(cellHeight);
          } else {
            imageCell.setValue('');
          }
        } else {
          imageCell.setValue('');
        }
      } catch(e){
        sheet.getRange(currentRow,3).setValue('');
        Logger.log('Error inserting image row '+currentRow+': '+e.toString());
      }

      sheet.getRange(currentRow,4).setValue(item.itemName || '-');
      sheet.getRange(currentRow,5).setValue(item.unit || '-').setHorizontalAlignment('center');
      sheet.getRange(currentRow,6).setValue(item.quantity || '-').setHorizontalAlignment('center');
      sheet.getRange(currentRow,7).setValue(item.price ? item.price.toLocaleString() : '-').setHorizontalAlignment('right');
      sheet.getRange(currentRow,8).setValue(item.total ? item.total.toLocaleString() : '-').setHorizontalAlignment('right');

      currentRow++;
    });

    const lastDataRow = currentRow-1;

    sheet.setRowHeight(currentRow,35);
    sheet.getRange(currentRow,1,1,7).merge();
    const totalLabelCell = sheet.getRange(currentRow,1);
    totalLabelCell.setValue('‡∫•‡∫ß‡∫°‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î:').setFontWeight('bold')
      .setHorizontalAlignment('right').setVerticalAlignment('middle').setBackground('#f0f0f0');

    const totalValueCell = sheet.getRange(currentRow,8);
    totalValueCell.setValue(orderData.total ? orderData.total.toLocaleString()+' ‡∫Å‡∫µ‡∫ö':'-')
      .setFontWeight('bold').setHorizontalAlignment('right').setVerticalAlignment('middle').setBackground('#f0f0f0');

    const totalRow = currentRow;
    currentRow++;

    const maxRows = sheet.getMaxRows();
    if(maxRows>currentRow+5) sheet.deleteRows(currentRow+5,maxRows-currentRow-4);

    currentRow+=2;
    sheet.setRowHeight(currentRow,30);
    sheet.getRange(currentRow,1,1,4).merge()
      .setValue('‡∫•‡∫≤‡∫ç‡ªÄ‡∫ä‡∫±‡∫ô‡∫ú‡∫π‡ªâ‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ: _________________')
      .setHorizontalAlignment('center').setVerticalAlignment('middle');
    sheet.getRange(currentRow,5,1,4).merge()
      .setValue('‡∫•‡∫≤‡∫ç‡ªÄ‡∫ä‡∫±‡∫ô‡∫ú‡∫π‡ªâ‡∫≠‡∫∞‡∫ô‡∫∏‡∫°‡∫±‡∫î: _________________')
      .setHorizontalAlignment('center').setVerticalAlignment('middle');

    const dataRange = sheet.getRange(headerRow,1,totalRow-headerRow+1,8);
    dataRange.setBorder(true,true,true,true,true,true,'#000000',SpreadsheetApp.BorderStyle.SOLID);

    SpreadsheetApp.flush();
    Utilities.sleep(2000);

    const spreadsheetFile = DriveApp.getFileById(ssId);
    const pdfBlob = spreadsheetFile.getAs('application/pdf');

    const fileName = '‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ_'+orderData.orderNumber+'_'+Utilities.formatDate(new Date(), Session.getScriptTimeZone(),'yyyyMMdd_HHmmss')+'.pdf';

    const folder = DriveApp.getFolderById('1jmglJOSJFAD-1eQbtpY2Etu69fA9jtLv');

    // ‚≠ê ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ Order Number ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô
    const orderNumber = orderData.orderNumber;
    const searchPattern = '‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ_' + orderNumber + '_';
    const allFiles = folder.getFiles();

    while (allFiles.hasNext()) {
      const file = allFiles.next();
      const name = file.getName();
      
      if (name.indexOf(searchPattern) === 0) {
        Logger.log('Deleting old WhatsApp PDF: ' + name);
        file.setTrashed(true);
      }
    }

    const pdfFile = folder.createFile(pdfBlob);
    pdfFile.setName(fileName);
    pdfFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK,DriveApp.Permission.VIEW);

    spreadsheetFile.setTrashed(true);

    const fileId = pdfFile.getId();
    const directUrl = 'https://drive.google.com/file/d/'+fileId+'/view?usp=sharing';

    Logger.log('PDF created successfully: '+directUrl);

    return {success:true,fileName:fileName,fileUrl:directUrl,fileId:fileId};

  } catch (error) {
    Logger.log('Error creating PDF: '+error.toString());
    Logger.log('Stack trace: '+error.stack);
    return {success:false,error:error.toString()};
  }
}
/**
 * ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Column F ‡πÅ‡∏•‡∏∞ I
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function getPhoneNumberList() {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(PRICE_STUDY_SHEET);
    
    if (!sheet) {
      Logger.log('Sheet "' + PRICE_STUDY_SHEET + '" not found');
      return [];
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      return [];
    }
    
    // ‡∏î‡∏∂‡∏á Column F (‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô) ‡πÅ‡∏•‡∏∞ Column I (‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£)
    const dataF = sheet.getRange('F2:F' + lastRow).getValues();
    const dataI = sheet.getRange('I2:I' + lastRow).getValues();
    
    const phoneMap = {};
    
    for (let i = 0; i < dataF.length; i++) {
      const storeName = dataF[i][0];
      const phoneNumber = dataI[i][0];
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå
      if (storeName && phoneNumber) {
        const phoneStr = phoneNumber.toString().trim();
        const storeStr = storeName.toString().trim();
        
        // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡∏°‡∏µ 8-10 ‡∏´‡∏•‡∏±‡∏Å
        if (/^\d{8,10}$/.test(phoneStr)) {
          const key = phoneStr + '|' + storeStr;
          phoneMap[key] = {
            phone: phoneStr,
            store: storeStr
          };
        }
      }
    }
    
    // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Array ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô
    const phoneList = Object.values(phoneMap).sort(function(a, b) {
      return a.store.localeCompare(b.store);
    });
    
    Logger.log('Phone list loaded: ' + phoneList.length + ' entries');
    return phoneList;
    
  } catch (error) {
    Logger.log('Error getting phone number list: ' + error.toString());
    return [];
  }
}
/**
 * ‡∏£‡∏±‡∏ö PDF ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Base64 ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ Google Drive
 * (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
 */
function uploadPDFBase64(base64Data, fileName) {
  try {
    // ‡πÅ‡∏õ‡∏•‡∏á Base64 ‡πÄ‡∏õ‡πá‡∏ô Blob
    const blob = Utilities.newBlob(
      Utilities.base64Decode(base64Data),
      'application/pdf',
      fileName
    );
    
    // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Google Drive folder
    const folder = DriveApp.getFolderById('1jmglJOSJFAD-1eQbtpY2Etu69fA9jtLv');
    
    // ‚≠ê ‡∏î‡∏∂‡∏á Order Number ‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå
    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: "‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ_PO-20250110-1430_1736486723456.pdf"
    // ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏≤ "PO-20250110-1430"
    const orderNumberMatch = fileName.match(/_([A-Z]+-\d{8}-\d{4})_/);
    const orderNumber = orderNumberMatch ? orderNumberMatch[1] : null;
    
    if (orderNumber) {
      Logger.log('Order Number detected: ' + orderNumber);
      
      // ‚≠ê ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ Order Number ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
      const existingFiles = folder.getFilesByName(fileName);
      
      // ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡πÑ‡∏ü‡∏•‡πå
      while (existingFiles.hasNext()) {
        const oldFile = existingFiles.next();
        Logger.log('Deleting old file: ' + oldFile.getName());
        oldFile.setTrashed(true); // ‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞
      }
      
      // ‚≠ê ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏°‡∏µ Order Number ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡πÅ‡∏°‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á)
      const searchPattern = '‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ_' + orderNumber + '_';
      const allFiles = folder.getFiles();
      
      while (allFiles.hasNext()) {
        const file = allFiles.next();
        const name = file.getName();
        
        // ‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ Order Number ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
        if (name.indexOf(searchPattern) === 0) {
          Logger.log('Deleting related old file: ' + name);
          file.setTrashed(true); // ‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞
        }
      }
    }
    
    // ‚≠ê ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF ‡πÉ‡∏´‡∏°‡πà
    const file = folder.createFile(blob);
    file.setName(fileName);
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÉ‡∏Ñ‡∏£‡∏Å‡πá‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    // ‡∏î‡∏∂‡∏á URL ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå
    const fileId = file.getId();
    const directUrl = 'https://drive.google.com/file/d/' + fileId + '/view?usp=sharing';
    
    Logger.log('New PDF uploaded successfully: ' + directUrl);
    
    return {
      success: true,
      fileName: fileName,
      fileUrl: directUrl,
      fileId: fileId
    };
  } catch (error) {
    Logger.log('Error uploading PDF: ' + error.toString());
    return {
      success: false,
      error: error.toString()
    };
  }
}
/**
 * ========================================
 * ‚≠ê ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å Google Drive ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Base64
 * ========================================
 */

/**
 * ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å Google Drive ‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Base64
 * @param {Array} imageUrls - Array ‡∏Ç‡∏≠‡∏á URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
 * @return {Array} - Array ‡∏Ç‡∏≠‡∏á Base64 strings
 */
function getImagesAsBase64(imageUrls) {
  try {
    const results = [];
    
    imageUrls.forEach(function(url) {
      if (!url || url.trim() === '') {
        results.push(null);
        return;
      }
      
      try {
        // ‡∏î‡∏∂‡∏á File ID ‡∏à‡∏≤‡∏Å URL
        const match = url.match(/id=([a-zA-Z0-9_-]+)/);
        if (!match) {
          results.push(null);
          return;
        }
        
        const fileId = match[1];
        const file = DriveApp.getFileById(fileId);
        const blob = file.getBlob();
        
        // ‡∏¢‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏ñ‡πâ‡∏≤‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
        const contentType = blob.getContentType();
        let imageBlob = blob;
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 500KB ‡πÉ‡∏´‡πâ‡∏¢‡πà‡∏≠‡∏•‡∏á
        if (blob.getBytes().length > 500000) {
          // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Thumbnail ‡πÅ‡∏ó‡∏ô
          const thumbnail = Drive.Files.get(fileId, { 
            supportsAllDrives: true,
            fields: 'thumbnailLink'
          });
          
          if (thumbnail.thumbnailLink) {
            // ‡∏î‡∏∂‡∏á Thumbnail (‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤)
            const thumbUrl = thumbnail.thumbnailLink.replace('=s220', '=s400');
            const thumbResponse = UrlFetchApp.fetch(thumbUrl, {
              headers: { 'Authorization': 'Bearer ' + ScriptApp.getOAuthToken() }
            });
            imageBlob = thumbResponse.getBlob();
          }
        }
        
        // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Base64
        const base64 = Utilities.base64Encode(imageBlob.getBytes());
        const dataUrl = 'data:' + contentType + ';base64,' + base64;
        
        results.push(dataUrl);
        
      } catch (e) {
        Logger.log('Error processing image: ' + url + ' - ' + e.toString());
        results.push(null);
      }
    });
    
    return results;
    
  } catch (error) {
    Logger.log('Error in getImagesAsBase64: ' + error.toString());
    return [];
  }
}
/**
 * ‡∏î‡∏∂‡∏á URL ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå PDF ‡∏à‡∏≤‡∏Å Google Drive ‡∏ï‡∏≤‡∏° Order Number
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function getPDFUrlByOrderNumber(orderNumber) {
  try {
    const folder = DriveApp.getFolderById('1jmglJOSJFAD-1eQbtpY2Etu69fA9jtLv');
    
    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ Order Number ‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠
    const searchPattern = '‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ_' + orderNumber + '_';
    const files = folder.getFiles();
    
    while (files.hasNext()) {
      const file = files.next();
      const fileName = file.getName();
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Order Number
      if (fileName.indexOf(searchPattern) === 0 && fileName.endsWith('.pdf')) {
        const fileId = file.getId();
        const fileUrl = 'https://drive.google.com/file/d/' + fileId + '/view?usp=sharing';
        
        return {
          success: true,
          fileName: fileName,
          fileUrl: fileUrl,
          fileId: fileId
        };
      }
    }
    
    // ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå
    return {
      success: false,
      error: '‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡ªÑ‡∫ü‡∫•‡ªå PDF ‡∫™‡∫≥‡∫•‡∫±‡∫ö‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ‡∫ô‡∫µ‡ªâ'
    };
    
  } catch (error) {
    Logger.log('Error getting PDF URL: ' + error.toString());
    return {
      success: false,
      error: error.toString()
    };
  }
}
function testGetPriceStudyData() {
  const data = getPriceStudyData();
  Logger.log('Total items: ' + data.length);
  
  if (data.length > 0) {
    Logger.log('First 3 items:');
    for (let i = 0; i < Math.min(3, data.length); i++) {
      Logger.log(JSON.stringify(data[i]));
    }
  }
}



/**
 * ========================================
 * ‚≠ê ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
 * ========================================
 */

/**
 * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dropdown)
 */
function getUniqueColumnValues(columnLetter) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(ITEMS_SHEET);
    
    if (!sheet) {
      Logger.log('Sheet not found');
      return [];
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      return [];
    }
    
    // ‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (A=1, B=2, ...)
    const columnIndex = columnLetter.charCodeAt(0) - 64;
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
    const data = sheet.getRange(2, columnIndex, lastRow - 1, 1).getValues();
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Set ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥
    const uniqueValues = {};
    
    data.forEach(function(row) {
      const value = row[0];
      if (value && value.toString().trim() !== '') {
        uniqueValues[value.toString().trim()] = true;
      }
    });
    
    // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Array ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
    const result = Object.keys(uniqueValues).sort();
    
    Logger.log('Column ' + columnLetter + ': ' + result.length + ' unique values');
    return result;
    
  } catch (error) {
    Logger.log('Error getting unique values: ' + error.toString());
    return [];
  }
}

/**
 * ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ñ‡∏ß
 */
function updateMultipleItems(updates) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(ITEMS_SHEET);
    
    if (!sheet) {
      return { success: false, error: 'Sheet not found' };
    }
    
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    
    let updatedCount = 0;
    
    // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÅ‡∏ï‡πà‡∏•‡∏∞ update
    updates.forEach(function(update) {
      const barcode = update.barcode;
      
      // ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Barcode
      for (let i = 1; i < data.length; i++) {
        if (data[i][0].toString().trim() === barcode) {
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          if (update.columnB !== undefined) sheet.getRange(i + 1, 2).setValue(update.columnB);
          if (update.columnC !== undefined) sheet.getRange(i + 1, 3).setValue(update.columnC);
          if (update.columnD !== undefined) sheet.getRange(i + 1, 4).setValue(update.columnD);
          if (update.columnF !== undefined) sheet.getRange(i + 1, 6).setValue(update.columnF);
          if (update.columnH !== undefined) sheet.getRange(i + 1, 8).setValue(update.columnH);
          if (update.columnI !== undefined) sheet.getRange(i + 1, 9).setValue(update.columnI);
          if (update.columnK !== undefined) sheet.getRange(i + 1, 11).setValue(update.columnK);
          if (update.columnL !== undefined) sheet.getRange(i + 1, 12).setValue(update.columnL);
          if (update.columnM !== undefined) sheet.getRange(i + 1, 13).setValue(update.columnM);
          if (update.columnN !== undefined) sheet.getRange(i + 1, 14).setValue(update.columnN);
          
          updatedCount++;
          break;
        }
      }
    });
    
    Logger.log('Updated ' + updatedCount + ' items');
    
    return { 
      success: true, 
      updatedCount: updatedCount 
    };
    
  } catch (error) {
    Logger.log('Error updating items: ' + error.toString());
    return { 
      success: false, 
      error: error.toString() 
    };
  }
}
/**
 * ========================================
 * ‚≠ê ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å Thumbnail URL ‡πÄ‡∏õ‡πá‡∏ô Base64
 * ========================================
 */

/**
 * ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å Google Drive Thumbnail URL ‡πÄ‡∏õ‡πá‡∏ô Base64
 * @param {Array} thumbnailUrls - Array ‡∏Ç‡∏≠‡∏á Thumbnail URLs
 * @return {Array} - Array ‡∏Ç‡∏≠‡∏á Base64 strings
 */
function convertThumbnailUrlsToBase64(thumbnailUrls) {
  try {
    const results = [];
    
    Logger.log('üì∏ Converting ' + thumbnailUrls.length + ' thumbnail URLs...');
    
    thumbnailUrls.forEach(function(url, index) {
      if (!url || url.toString().trim() === '') {
        results.push(null);
        return;
      }
      
      try {
        // ‚≠ê ‡∏î‡∏∂‡∏á File ID ‡∏à‡∏≤‡∏Å Thumbnail URL
        // Format: https://drive.google.com/thumbnail?id=FILE_ID&sz=w400
        const match = url.match(/id=([a-zA-Z0-9_-]+)/);
        
        if (!match) {
          Logger.log('‚ö†Ô∏è Cannot extract file ID from URL: ' + url);
          results.push(null);
          return;
        }
        
        const fileId = match[1];
        
        // ‚≠ê ‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å Drive
        const file = DriveApp.getFileById(fileId);
        const blob = file.getBlob();
        const contentType = blob.getContentType();
        
        // ‚≠ê ‡∏¢‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏ñ‡πâ‡∏≤‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 300KB
        let imageBlob = blob;
        
        if (blob.getBytes().length > 300000) {
          try {
            const thumbnail = Drive.Files.get(fileId, { 
              supportsAllDrives: true,
              fields: 'thumbnailLink'
            });
            
            if (thumbnail.thumbnailLink) {
              const thumbUrl = thumbnail.thumbnailLink.replace('=s220', '=s300');
              const thumbResponse = UrlFetchApp.fetch(thumbUrl, {
                headers: { 'Authorization': 'Bearer ' + ScriptApp.getOAuthToken() }
              });
              imageBlob = thumbResponse.getBlob();
            }
          } catch (e) {
            Logger.log('‚ö†Ô∏è Cannot get thumbnail, using original: ' + e.toString());
          }
        }
        
        // ‚≠ê ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Base64
        const base64 = Utilities.base64Encode(imageBlob.getBytes());
        const dataUrl = 'data:' + contentType + ';base64,' + base64;
        
        results.push(dataUrl);
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡πÜ 10 ‡∏£‡∏π‡∏õ
        if ((index + 1) % 10 === 0) {
          Logger.log('‚úÖ Processed ' + (index + 1) + '/' + thumbnailUrls.length);
        }
        
      } catch (e) {
        Logger.log('‚ùå Error converting URL ' + url + ': ' + e.toString());
        results.push(null);
      }
    });
    
    Logger.log('‚úÖ Conversion complete: ' + results.length + ' results');
    return results;
    
  } catch (error) {
    Logger.log('‚ùå Error in convertThumbnailUrlsToBase64: ' + error.toString());
    return [];
  }
}

/**
 * ========================================
 * ‚≠ê ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å (‡πÉ‡∏´‡∏°‡πà)
 * ========================================
 */

/**
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏°‡∏µ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á Items ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 */
function checkBarcodeExists(barcode) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(ITEMS_SHEET);
    
    if (!sheet) {
      return { exists: false, data: null };
    }
    
    const data = sheet.getDataRange().getValues();
    
    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ô Column A (index 0)
    for (let i = 1; i < data.length; i++) {
      const rowBarcode = data[i][0] ? data[i][0].toString().trim() : '';
      
      if (rowBarcode === barcode.toString().trim()) {
        // ‡∏û‡∏ö‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î - ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ
        const itemData = {
          rowIndex: i + 1, // ‡πÄ‡∏Å‡πá‡∏ö index ‡πÅ‡∏ñ‡∏ß
          columnA: data[i][0] || '',
          columnB: data[i][1] || '',
          columnC: data[i][2] || '',
          columnD: data[i][3] || '',
          columnE: data[i][4] || '',
          columnF: data[i][5] || '',
          columnG: data[i][6] || '',
          columnH: data[i][7] || '',
          columnI: data[i][8] || '',
          columnJ: data[i][9] || '',
          columnK: data[i][10] || '',
          columnL: data[i][11] || '',
          columnM: data[i][12] || '',
          columnN: data[i][13] || ''
        };
        
        return { exists: true, data: itemData };
      }
    }
    
    // ‡πÑ‡∏°‡πà‡∏û‡∏ö
    return { exists: false, data: null };
    
  } catch (error) {
    Logger.log('Error in checkBarcodeExists: ' + error.toString());
    return { exists: false, data: null, error: error.toString() };
  }
}

/**
 * ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (Case B)
 */
function updateExistingStock(barcode, addQuantity) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(ITEMS_SHEET);
    
    if (!sheet) {
      return { success: false, error: 'Sheet not found' };
    }
    
    const data = sheet.getDataRange().getValues();
    let targetRow = -1;
    let columnJ = '';
    
    // ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î
    for (let i = 1; i < data.length; i++) {
      const rowBarcode = data[i][0] ? data[i][0].toString().trim() : '';
      
      if (rowBarcode === barcode.toString().trim()) {
        targetRow = i + 1; // +1 ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ array ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 0 ‡πÅ‡∏ï‡πà row ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 1
        columnJ = data[i][9] ? data[i][9].toString().trim() : ''; // Column J (index 9)
        break;
      }
    }
    
    if (targetRow === -1) {
      return { success: false, error: 'Barcode not found' };
    }
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà
    const columnI = parseFloat(data[targetRow - 1][8]) || 1; // Column I (‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡∫ï‡ªç‡ªà‡ªú‡ªà‡∫ß‡∫ç)
    const oldStockF = parseFloat(data[targetRow - 1][5]) || 0; // Column F ‡πÄ‡∏î‡∏¥‡∏°
    const addAmount = parseFloat(addQuantity) || 0;
    const newStockF = oldStockF + (addAmount * columnI);
    
    Logger.log('Updating stock: oldF=' + oldStockF + ', add=' + addAmount + ', columnI=' + columnI + ', newF=' + newStockF);
    
    // ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ Column J ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
    const rowsToUpdate = [];
    
    if (columnJ) {
      for (let i = 1; i < data.length; i++) {
        const rowColumnJ = data[i][9] ? data[i][9].toString().trim() : '';
        if (rowColumnJ === columnJ) {
          rowsToUpdate.push(i + 1);
        }
      }
    } else {
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Column J ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏Ñ‡πà‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ
      rowsToUpdate.push(targetRow);
    }
    
    Logger.log('Rows to update (same Column J): ' + rowsToUpdate.length);
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Column F ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ Column J ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
    rowsToUpdate.forEach(function(row) {
      sheet.getRange(row, 6).setValue(newStockF); // Column F
    });
    
    Logger.log('‚úÖ Stock updated successfully');
    
    return { 
      success: true, 
      updatedRows: rowsToUpdate.length,
      newStock: newStockF
    };
    
  } catch (error) {
    Logger.log('Error in updateExistingStock: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

/**
 * ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏õ Google Drive ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô URL
 */
function uploadImageToDrive(base64Data, fileName) {
  try {
    const folder = DriveApp.getFolderById('1EbWI_kYPdUxLjJbMuj2HyQsSP-QdpaSn');
    
    // ‡πÅ‡∏õ‡∏•‡∏á Base64 ‡πÄ‡∏õ‡πá‡∏ô Blob
    const contentType = base64Data.match(/data:([^;]+);/)[1];
    const base64String = base64Data.split(',')[1];
    const blob = Utilities.newBlob(
      Utilities.base64Decode(base64String),
      contentType,
      fileName
    );
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Drive
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Thumbnail URL
    const fileId = file.getId();
    const thumbnailUrl = 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w400';
    
    Logger.log('‚úÖ Image uploaded: ' + thumbnailUrl);
    
    return {
      success: true,
      url: thumbnailUrl,
      fileId: fileId,
      fileName: fileName
    };
    
  } catch (error) {
    Logger.log('Error in uploadImageToDrive: ' + error.toString());
    return {
      success: false,
      error: error.toString()
    };
  }
}

/**
 * ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏≤‡∏Å Google Drive
 */
function deleteOldImageFromDrive(imageUrl) {
  try {
    if (!imageUrl || imageUrl.trim() === '') {
      return { success: true, message: 'No image to delete' };
    }
    
    // ‡∏î‡∏∂‡∏á File ID ‡∏à‡∏≤‡∏Å URL
    const match = imageUrl.match(/id=([a-zA-Z0-9_-]+)/);
    if (!match) {
      return { success: false, error: 'Cannot extract file ID from URL' };
    }
    
    const fileId = match[1];
    const file = DriveApp.getFileById(fileId);
    file.setTrashed(true);
    
    Logger.log('‚úÖ Old image deleted: ' + fileId);
    
    return { success: true, fileId: fileId };
    
  } catch (error) {
    Logger.log('Error in deleteOldImageFromDrive: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

/**
 * ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á Items (Case A)
 */
function addNewItemsToStock(itemsArray) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(ITEMS_SHEET);
    
    if (!sheet) {
      return { success: false, error: 'Sheet not found' };
    }
    
    const data = sheet.getDataRange().getValues();
    let addedCount = 0;
    let replacedCount = 0;
    
    // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    itemsArray.forEach(function(item) {
      const barcode = item.columnA ? item.columnA.toString().trim() : '';
      
      if (!barcode) {
        Logger.log('‚ö†Ô∏è Skipping item with empty barcode');
        return;
      }
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      let existingRow = -1;
      let oldImageUrl = '';
      
      for (let i = 1; i < data.length; i++) {
        const rowBarcode = data[i][0] ? data[i][0].toString().trim() : '';
        
        if (rowBarcode === barcode) {
          existingRow = i + 1;
          oldImageUrl = data[i][10] || ''; // Column K (index 10)
          break;
        }
      }
      
      if (existingRow > -1) {
        // ‚≠ê ‡∏Å‡∏£‡∏ì‡∏µ‡∏ã‡πâ‡∏≥: ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡πÄ‡∏Å‡πà‡∏≤ + ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πà‡∏≤
        Logger.log('üîÑ Replacing existing item: ' + barcode);
        
        // ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏≤‡∏Å Drive
        if (oldImageUrl) {
          deleteOldImageFromDrive(oldImageUrl);
        }
        
        // ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡πÄ‡∏Å‡πà‡∏≤
        sheet.deleteRow(existingRow);
        
        replacedCount++;
      }
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà
      const newRow = [
        item.columnA || '',
        item.columnB || '',
        item.columnC || 0,
        item.columnD || 0,
        item.columnE || '', // ‚≠ê ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Column K)
        item.columnF || 0,
        item.columnG || '',
        item.columnH || '',
        item.columnI || 1,
        item.columnJ || '',
        item.columnK || '', // ‚≠ê ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
        item.columnL || '',
        item.columnM || '',
        item.columnN || 0
      ];
      
      sheet.appendRow(newRow);
      addedCount++;
      
      Logger.log('‚úÖ Item added: ' + barcode);
    });
    
    Logger.log('üìä Summary: Added=' + addedCount + ', Replaced=' + replacedCount);
    
    return {
      success: true,
      addedCount: addedCount,
      replacedCount: replacedCount
    };
    
  } catch (error) {
    Logger.log('Error in addNewItemsToStock: ' + error.toString());
    return {
      success: false,
      error: error.toString()
    };
  }
}


/**
 * ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ Column J ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
 */
function updateImagesForGroup(columnJ, newImageUrl) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(ITEMS_SHEET);
    
    if (!sheet) {
      return { success: false, error: 'Sheet not found' };
    }
    
    const data = sheet.getDataRange().getValues();
    const oldImages = [];
    let updatedCount = 0;
    
    // ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Column J
    for (let i = 1; i < data.length; i++) {
      const rowColumnJ = data[i][9] ? data[i][9].toString().trim() : '';
      
      if (rowColumnJ === columnJ.toString().trim()) {
        const oldImageK = data[i][10] || '';
        const oldImageE = data[i][4] || '';
        
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏ß‡πâ‡∏•‡∏ö (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà)
        if (oldImageK && oldImageK !== newImageUrl) {
          oldImages.push(oldImageK);
        }
        if (oldImageE && oldImageE !== newImageUrl) {
          oldImages.push(oldImageE);
        }
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Column E ‡πÅ‡∏•‡∏∞ K
        sheet.getRange(i + 1, 5).setValue(newImageUrl); // Column E
        sheet.getRange(i + 1, 11).setValue(newImageUrl); // Column K
        
        updatedCount++;
      }
    }
    
    // ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏≤‡∏Å Drive
    const deletedCount = 0;
    oldImages.forEach(function(imageUrl) {
      try {
        deleteOldImageFromDrive(imageUrl);
      } catch (e) {
        Logger.log('Cannot delete old image: ' + e.toString());
      }
    });
    
    Logger.log('‚úÖ Updated ' + updatedCount + ' rows, deleted ' + oldImages.length + ' old images');
    
    return {
      success: true,
      updatedCount: updatedCount,
      deletedImages: oldImages.length
    };
    
  } catch (error) {
    Logger.log('Error in updateImagesForGroup: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

















<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡ªÅ‡∫à‡ªâ‡∫á‡ªÄ‡∫ï‡∫∑‡∫≠‡∫ô‡∫™‡∫∞‡∫ï‡∫±‡∫≠‡∫Å‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</title>
    
<!-- ‚≠ê pdfMake ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏†‡∏≤‡∏©‡∏≤‡∏•‡∏≤‡∏ß -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>



<!-- ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô <head> ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå HTML ‡∏Å‡πà‡∏≠‡∏ô </head> -->

<!-- Cropper.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">

<!-- Cropper.js JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>






<script>
// ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏†‡∏≤‡∏©‡∏≤‡∏•‡∏≤‡∏ß‡πÉ‡∏´‡πâ pdfMake
pdfMake.fonts = {
    NotoSansLao: {
        normal: 'https://fonts.gstatic.com/s/notosanslao/v30/bx6lNx2Ol_ixgdYWLm9BwxM3NW6BOkuf763Clj73CiQ_J1Djx9pidOt4ccfdf5MK3riB2w.ttf',
        bold: 'https://fonts.gstatic.com/s/notosanslao/v30/bx6lNx2Ol_ixgdYWLm9BwxM3NW6BOkuf763Clj73CiQ_J1Djx9pidOt4ccfdf5MK3riB2w.ttf',
        italics: 'https://fonts.gstatic.com/s/notosanslao/v30/bx6lNx2Ol_ixgdYWLm9BwxM3NW6BOkuf763Clj73CiQ_J1Djx9pidOt4ccfdf5MK3riB2w.ttf',
        bolditalics: 'https://fonts.gstatic.com/s/notosanslao/v30/bx6lNx2Ol_ixgdYWLm9BwxM3NW6BOkuf763Clj73CiQ_J1Djx9pidOt4ccfdf5MK3riB2w.ttf'
    },
    // ‡∏™‡∏≥‡∏£‡∏≠‡∏á Roboto ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢
    Roboto: {
        normal: 'https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/fonts/Roboto/Roboto-Regular.ttf',
        bold: 'https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/fonts/Roboto/Roboto-Medium.ttf',
        italics: 'https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/fonts/Roboto/Roboto-Italic.ttf',
        bolditalics: 'https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/fonts/Roboto/Roboto-MediumItalic.ttf'
    }
};
</script>

    <style>
      
/* ========================================
   ‚≠ê Modal Crop ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÉ‡∏´‡∏°‡πà)
   ======================================== */

.image-crop-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.95);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10010;
    padding: 20px;
}

.image-crop-modal.show {
    display: flex;
}

.image-crop-content {
    background: white;
    border-radius: 20px;
    width: 95%;
    max-width: 900px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.image-crop-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.image-crop-title {
    font-size: 1.8rem;
    font-weight: bold;
}

.crop-close-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.5rem;
    color: white;
    transition: all 0.3s;
}

.crop-close-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}

.image-crop-body {
    flex: 1;
    overflow: auto;
    padding: 30px;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.crop-container {
    max-width: 100%;
    max-height: 500px;
    background: #f0f0f0;
    border-radius: 10px;
    overflow: hidden;
}

.crop-container img {
    max-width: 100%;
    display: block;
}

.crop-controls {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
}

.crop-control-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: bold;
    color: white;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
}

.crop-control-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.btn-crop-rotate-left { background: linear-gradient(135deg, #42a5f5 0%, #1976d2 100%); }
.btn-crop-rotate-right { background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%); }
.btn-crop-zoom-in { background: linear-gradient(135deg, #ab47bc 0%, #8e24aa 100%); }
.btn-crop-zoom-out { background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%); }
.btn-crop-reset { background: linear-gradient(135deg, #ef5350 0%, #e53935 100%); }

.image-crop-footer {
    padding: 20px 30px;
    background: #f8f9fa;
    border-top: 2px solid #e0e0e0;
    display: flex;
    justify-content: center;
    gap: 15px;
}

.btn-crop-confirm,
.btn-crop-cancel {
    padding: 15px 40px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 1.2rem;
    font-weight: bold;
    color: white;
    transition: all 0.3s;
}

.btn-crop-confirm {
    background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
}

.btn-crop-cancel {
    background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
}

.btn-crop-confirm:hover,
.btn-crop-cancel:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

/* ========================================
   ‚≠ê ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Edit Form ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
   ======================================== */

.edit-image-field {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.edit-image-preview-container {
    width: 100%;
    max-width: 300px;
    margin: 0 auto;
}

.edit-image-preview {
    width: 100%;
    max-height: 300px;
    object-fit: contain;
    border-radius: 10px;
    border: 3px solid #e0e0e0;
    background: #f9f9f9;
}

.edit-image-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.edit-image-btn {
    flex: 1;
    min-width: 140px;
    padding: 12px 20px;
    border: 2px solid #667eea;
    border-radius: 10px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: bold;
    color: #667eea;
    background: white;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.edit-image-btn:hover {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.edit-image-btn.danger {
    border-color: #f44336;
    color: #f44336;
}

.edit-image-btn.danger:hover {
    background: #f44336;
    color: white;
}

.no-image-placeholder {
    width: 100%;
    max-width: 300px;
    height: 200px;
    background: #f0f0f0;
    border: 3px dashed #ccc;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    color: #999;
    margin: 0 auto;
}

/* Responsive */
@media (max-width: 768px) {
    .image-crop-content {
        width: 100%;
        max-width: 100%;
        border-radius: 0;
    }
    
    .crop-controls {
        flex-direction: column;
    }
    
    .crop-control-btn {
        width: 100%;
    }
    
    .edit-image-buttons {
        flex-direction: column;
    }
    
    .edit-image-btn {
        width: 100%;
    }
}

/* ========================================
   ‚≠ê ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
   ======================================== */

.form-item-footer {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 2px dashed #e0e0e0;
    display: flex;
    justify-content: center;
    gap: 10px;
}

.btn-add-form-bottom {
    padding: 12px 30px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 1.1rem;
    font-weight: bold;
    color: white;
    background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
}

.btn-add-form-bottom:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
}

.btn-add-form-bottom:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.btn-delete-form-bottom {
    padding: 12px 30px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 1.1rem;
    font-weight: bold;
    color: white;
    background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
}

.btn-delete-form-bottom:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
}
      /* ========================================
   ‚≠ê Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô (‡πÉ‡∏´‡∏°‡πà)
   ======================================== */

.edit-choice-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10004;
    padding: 20px;
}

.edit-choice-modal.show {
    display: flex;
}

.edit-choice-content {
    background: white;
    border-radius: 20px;
    padding: 40px;
    max-width: 500px;
    width: 100%;
    text-align: center;
}

.edit-choice-title {
    font-size: 1.8rem;
    font-weight: bold;
    color: #4caf50;
    margin-bottom: 30px;
}

.edit-choice-buttons {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.edit-choice-btn {
    padding: 20px 30px;
    border: none;
    border-radius: 15px;
    cursor: pointer;
    font-size: 1.2rem;
    font-weight: bold;
    color: white;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.edit-choice-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}

.btn-choice-edit {
    background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
}

.btn-choice-add {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
}

.btn-choice-cancel {
    background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%);
    padding: 15px 30px;
    font-size: 1rem;
    margin-top: 10px;
}

/* ========================================
   ‚≠ê Modal ‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î (‡πÉ‡∏´‡∏°‡πà)
   ======================================== */

.scan-barcode-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10005;
    padding: 20px;
}

.scan-barcode-modal.show {
    display: flex;
}

.scan-barcode-content {
    background: white;
    border-radius: 20px;
    padding: 40px;
    max-width: 500px;
    width: 100%;
}

.scan-barcode-title {
    font-size: 1.8rem;
    font-weight: bold;
    color: #2196f3;
    margin-bottom: 20px;
    text-align: center;
}

.scan-barcode-input {
    width: 100%;
    padding: 15px;
    border: 3px solid #2196f3;
    border-radius: 10px;
    font-size: 1.3rem;
    text-align: center;
    margin-bottom: 20px;
    font-weight: bold;
}

.scan-barcode-input:focus {
    outline: none;
    border-color: #1976d2;
    box-shadow: 0 0 15px rgba(33, 150, 243, 0.5);
}

.scan-barcode-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
}

.btn-scan-confirm,
.btn-scan-cancel {
    padding: 12px 30px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 1.1rem;
    font-weight: bold;
    color: white;
    transition: all 0.3s;
}

.btn-scan-confirm {
    background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
}

.btn-scan-cancel {
    background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
}

.btn-scan-confirm:hover,
.btn-scan-cancel:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

/* ========================================
   ‚≠ê Dynamic Form ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÉ‡∏´‡∏°‡πà)
   ======================================== */

.add-items-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10006;
    padding: 20px;
    overflow-y: auto;
}

.add-items-modal.show {
    display: flex;
}

.add-items-content {
    background: white;
    border-radius: 20px;
    width: 95%;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 30px;
}

.add-items-header {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
    color: white;
    padding: 20px 30px;
    border-radius: 15px 15px 0 0;
    margin: -30px -30px 20px -30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.add-items-title {
    font-size: 1.8rem;
    font-weight: bold;
}

.add-close-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.5rem;
    color: white;
    transition: all 0.3s;
}

.add-close-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}

.dynamic-forms-container {
    display: flex;
    flex-direction: column;
    gap: 30px;
}

.dynamic-form-item {
    border: 3px solid #e0e0e0;
    border-radius: 15px;
    padding: 25px;
    background: #f8f9fa;
    position: relative;
    transition: all 0.3s;
}

.dynamic-form-item.form-error {
    border-color: #f44336;
    animation: formErrorBlink 1s infinite;
}

@keyframes formErrorBlink {
    0%, 100% { background: #ffebee; }
    50% { background: #ffcdd2; }
}

.form-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e0e0e0;
}

.form-item-number {
    font-size: 1.5rem;
    font-weight: bold;
    color: #2196f3;
}



.form-fields-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.form-field {
    display: flex;
    flex-direction: column;
}

.form-field.full-width {
    grid-column: 1 / -1;
}

.form-field-label {
    font-weight: bold;
    margin-bottom: 5px;
    color: #333;
    font-size: 0.95rem;
}

.form-field-label .required {
    color: #f44336;
    margin-left: 3px;
}

.form-field-input,
.form-field-select {
    padding: 10px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s;
}

.form-field-input:focus,
.form-field-select:focus {
    border-color: #2196f3;
    outline: none;
    box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
}

.form-field-input:disabled {
    background: #f0f0f0;
    cursor: not-allowed;
}

.form-field-input.error {
    border-color: #f44336;
    animation: inputErrorBlink 0.5s infinite;
}

@keyframes inputErrorBlink {
    0%, 100% { background: #ffebee; }
    50% { background: #ffcdd2; }
}

.image-upload-container {
    display: flex;
    gap: 10px;
    align-items: center;
}

.btn-upload-file,
.btn-take-photo {
    flex: 1;
    padding: 10px;
    border: 2px dashed #2196f3;
    border-radius: 8px;
    cursor: pointer;
    text-align: center;
    background: white;
    transition: all 0.3s;
    font-weight: bold;
    color: #2196f3;
}

.btn-upload-file:hover,
.btn-take-photo:hover {
    background: #e3f2fd;
    border-color: #1976d2;
}

.image-preview {
    width: 100%;
    max-width: 200px;
    max-height: 200px;
    object-fit: cover;
    border-radius: 10px;
    margin-top: 10px;
    border: 2px solid #e0e0e0;
}

.add-items-footer {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 3px solid #e0e0e0;
    display: flex;
    justify-content: center;
    gap: 15px;
}

.btn-save-all-items,
.btn-cancel-add-items {
    padding: 15px 40px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 1.2rem;
    font-weight: bold;
    color: white;
    transition: all 0.3s;
}

.btn-save-all-items {
    background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
}

.btn-cancel-add-items {
    background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
}

.btn-save-all-items:hover,
.btn-cancel-add-items:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.btn-save-all-items:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
}

/* ========================================
   ‚≠ê Modal ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà (Case B)
   ======================================== */

.existing-item-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10007;
    padding: 20px;
}

.existing-item-modal.show {
    display: flex;
}

.existing-item-content {
    background: white;
    border-radius: 20px;
    width: 95%;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 30px;
}

.existing-item-header {
    background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
    color: white;
    padding: 20px 30px;
    border-radius: 15px 15px 0 0;
    margin: -30px -30px 20px -30px;
    text-align: center;
}

.existing-item-title {
    font-size: 1.8rem;
    font-weight: bold;
    margin-bottom: 10px;
}

.existing-item-subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
}

.existing-item-table-wrapper {
    overflow-x: auto;
    margin-bottom: 20px;
}

.existing-item-table {
    width: 100%;
    border-collapse: collapse;
}

.existing-item-table thead {
    background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
    color: white;
}

.existing-item-table th,
.existing-item-table td {
    padding: 12px;
    border: 1px solid #e0e0e0;
    text-align: center;
}

.existing-item-table tbody tr:hover {
    background: #fff3e0;
}

.stock-add-section {
    background: #e3f2fd;
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 20px;
}

.stock-add-title {
    font-size: 1.3rem;
    font-weight: bold;
    color: #2196f3;
    margin-bottom: 15px;
    text-align: center;
}

.stock-add-input-wrapper {
    display: flex;
    gap: 15px;
    align-items: center;
    justify-content: center;
}

.stock-add-input {
    width: 150px;
    padding: 12px;
    border: 3px solid #2196f3;
    border-radius: 10px;
    font-size: 1.2rem;
    text-align: center;
    font-weight: bold;
}

.stock-add-input:focus {
    outline: none;
    border-color: #1976d2;
    box-shadow: 0 0 15px rgba(33, 150, 243, 0.5);
}

.stock-calculation {
    font-size: 1.1rem;
    color: #666;
}

.existing-item-actions {
    display: flex;
    justify-content: center;
    gap: 15px;
}

.btn-save-stock,
.btn-cancel-stock {
    padding: 15px 40px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 1.2rem;
    font-weight: bold;
    color: white;
    transition: all 0.3s;
}

.btn-save-stock {
    background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
}

.btn-cancel-stock {
    background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
}

.btn-save-stock:hover,
.btn-cancel-stock:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

/* Responsive */
@media (max-width: 768px) {
    .form-fields-grid {
        grid-template-columns: 1fr;
    }
    
    .edit-choice-content {
        padding: 30px 20px;
    }
    
    .add-items-content {
        padding: 20px;
    }
    
    .stock-add-input-wrapper {
        flex-direction: column;
    }
    
    .stock-add-input {
        width: 100%;
    }
}


      /* ========================================
   ‚≠ê Progress Steps ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PDF
   ======================================== */

.progress-steps-container {
    padding: 30px 40px;
    background: white;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    max-width: 700px;
    width: 90%;
}

.progress-steps-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: #4facfe;
    margin-bottom: 30px;
    text-align: center;
}

.progress-steps {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    position: relative;
}

.progress-line {
    position: absolute;
    top: 25px;
    left: 0;
    right: 0;
    height: 4px;
    background: #e0e0e0;
    z-index: 1;
}

.progress-line-fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    width: 0%;
    transition: width 0.5s ease;
}

.progress-step {
    position: relative;
    z-index: 2;
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
}

.progress-step-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #e0e0e0;
    border: 4px solid #e0e0e0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
    font-weight: bold;
    color: #999;
    transition: all 0.3s;
    margin-bottom: 10px;
}

.progress-step.active .progress-step-circle {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    border-color: #4facfe;
    color: white;
    animation: pulse-circle 1.5s infinite;
}

.progress-step.completed .progress-step-circle {
    background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
    border-color: #4caf50;
    color: white;
}

.progress-step-label {
    font-size: 0.9rem;
    font-weight: bold;
    color: #999;
    text-align: center;
    max-width: 120px;
}

.progress-step.active .progress-step-label {
    color: #4facfe;
}

.progress-step.completed .progress-step-label {
    color: #4caf50;
}

@keyframes pulse-circle {
    0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(79, 172, 254, 0.7);
    }
    50% {
        transform: scale(1.1);
        box-shadow: 0 0 0 10px rgba(79, 172, 254, 0);
    }
}

.progress-status-text {
    text-align: center;
    font-size: 1.1rem;
    color: #666;
    margin-top: 20px;
    min-height: 30px;
}

.progress-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #4facfe;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 20px auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.progress-success-icon {
    font-size: 4rem;
    color: #4caf50;
    animation: scaleIn 0.5s ease-out;
    margin: 20px 0;
}

@keyframes scaleIn {
    0% {
        transform: scale(0);
        opacity: 0;
    }
    50% {
        transform: scale(1.2);
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

/* Responsive */
@media (max-width: 768px) {
    .progress-steps-container {
        padding: 20px;
    }
    
    .progress-step-circle {
        width: 40px;
        height: 40px;
        font-size: 1.1rem;
    }
    
    .progress-step-label {
        font-size: 0.8rem;
        max-width: 80px;
    }
}

      /* ========================================
   ‚≠ê ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÉ‡∏´‡∏°‡πà: ‡∏õ‡∏∏‡πà‡∏°‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á + ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ã‡∏∑‡πâ‡∏≠
   ======================================== */

/* ‡∏õ‡∏∏‡πà‡∏°‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
.btn-clear-table {
    background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
    color: white;
}

.btn-clear-table:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
}

/* ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ã‡∏∑‡πâ‡∏≠ */
.btn-decision-buy {
    background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
    color: white;
}

.btn-decision-buy:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
}

.btn-decision-buy:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
}

/* ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö *//* ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö */
.store-column-header {
    background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%) !important;
    color: white !important;
    text-align: center !important;
    font-weight: bold !important;
    border-left: 3px solid #fff !important;
    min-width: 150px; /* ‚≠ê ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ */
    padding: 15px 10px !important; /* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° padding */
    white-space: nowrap; /* ‚≠ê ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà */
}

.store-price-cell {
    text-align: center !important;
    font-weight: bold !important;
    background: #ffffff !important; /* ‚≠ê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß */
    border-left: 2px solid #e0e0e0 !important; /* ‚≠ê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
    min-width: 120px;
    padding: 12px 10px !important;
}

.store-total-cell {
    text-align: center !important;
    font-weight: bold !important;
    background: #ffffff !important; /* ‚≠ê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß */
    border-left: 2px solid #e0e0e0 !important; /* ‚≠ê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
    min-width: 130px;
    padding: 12px 10px !important;
}

/* ‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏∏‡∏î - ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
.cheapest-store {
    background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%) !important; /* ‚≠ê ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏° */
    color: #ffffff !important; /* ‚≠ê ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß */
    border: 3px solid #1b5e20 !important; /* ‚≠ê ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏° */
    box-shadow: 0 0 15px rgba(27, 94, 32, 0.6) !important; /* ‚≠ê ‡πÄ‡∏á‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏° */
    font-weight: bold !important;
}

.cheapest-store::before {
    content: 'üü¢ ';
    font-size: 1.2rem;
}

/* ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∫ï‡∫≤‡∫ï‡∫∞‡∫•‡∫≤‡∫á‡∫´‡∫º‡∫±‡∫Å" */
.main-table-label {
    color: #999;
    font-size: 0.8em;
    font-style: italic;
    margin-left: 5px;
}

/* Summary Row ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
.summary-row {
    background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%) !important;
    font-weight: bold !important;
    font-size: 1.1rem !important;
    border-top: 4px solid #fbc02d !important;
}

.summary-store-cell {
    background: linear-gradient(135deg, #e1bee7 0%, #ce93d8 100%) !important;
    border-left: 3px solid #9c27b0 !important;
}

.summary-cheapest {
    background: linear-gradient(135deg, #a5d6a7 0%, #81c784 100%) !important;
    color: #1b5e20 !important;
    border: 3px solid #4caf50 !important;
    font-size: 1.2rem !important;
}

.summary-cheapest::before {
    content: 'üèÜ ';
}

/* ========================================
   ‚≠ê ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÉ‡∏´‡∏°‡πà: ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
   ======================================== */

/* ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ */
.edit-items-btn {
    position: fixed;
    top: 80px;
    left: 20px;
    background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 50px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: bold;
    box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
    z-index: 999;
    display: flex;
    align-items: center;
    gap: 8px;
    animation: editItemsPulse 1.5s infinite;
}

@keyframes editItemsPulse {
    0%, 100% {
        transform: scale(1);
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
    }
    50% {
        transform: scale(1.15);
        background: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%);
    }
}

/* Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ */
.edit-items-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10002;
    padding: 20px;
}

.edit-items-modal.show {
    display: flex;
}

.edit-items-content {
    background: white;
    border-radius: 20px;
    width: 95%;
    height: 95%;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.edit-items-header {
    background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
    color: white;
    padding: 20px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
}

.edit-header-buttons {
    display: flex;
    gap: 10px;
    align-items: center;
}

.edit-header-buttons .edit-action-btn {
    padding: 10px 20px;
    font-size: 0.95rem;
}

.edit-header-buttons .edit-close-btn {
    margin-left: 10px;
}

.edit-items-title {
    font-size: 1.8rem;
    font-weight: bold;
}

.edit-close-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.5rem;
    color: white;
    transition: all 0.3s;
}

.edit-close-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}

/* ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á */
.edit-filter-section {
    padding: 20px 30px;
    background: #f8f9fa;
    border-bottom: 2px solid #e0e0e0;
}

.filter-row {
    display: flex;
    gap: 15px;
    flex-wrap: nowrap;
}

.filter-item {
    flex: 1;
    min-width: 150px;
}

.filter-label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
    color: #333;
}

.filter-select,
.filter-input {
    width: 100%;
    padding: 10px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s;
}

.filter-select:focus,
.filter-input:focus {
    border-color: #4caf50;
    outline: none;
}

/* ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° */
.edit-action-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 15px;
}

.edit-action-btn {
    padding: 12px 25px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: bold;
    color: white;
    transition: all 0.3s;
}

.btn-show-filtered {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
}

.btn-edit-selected {
    background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
}

.btn-clear-filter {
    background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%);
}

.edit-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.edit-action-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
}

/* ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
.edit-table-section {
    flex: 1;
    overflow: auto;
    padding: 20px 30px;
}

.edit-items-table {
    width: 100%;
    border-collapse: collapse;
}

.edit-items-table thead {
    background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
    color: white;
    position: sticky;
    top: 0;
    z-index: 10;
}

.edit-items-table th {
    padding: 12px;
    text-align: left;
    font-weight: bold;
    border: 1px solid #45a049;
}

.edit-items-table td {
    padding: 10px 12px;
    border: 1px solid #e0e0e0;
}

.edit-items-table tbody tr {
    transition: background 0.2s;
    cursor: pointer;
}

.edit-items-table tbody tr:hover {
    background: #f0f8f0;
}

.edit-items-table tbody tr.selected {
    background: #c8e6c9;
}

.edit-table-img {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 5px;
}

/* Checkbox */
.edit-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

/* Modal ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç */
.edit-form-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10003;
    padding: 20px;
}

.edit-form-modal.show {
    display: flex;
}

.edit-form-content {
    background: white;
    border-radius: 20px;
    max-width: 700px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    padding: 30px;
}

.edit-form-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: #4caf50;
    margin-bottom: 20px;
    text-align: center;
}

.edit-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.edit-form-field {
    display: flex;
    flex-direction: column;
}

.edit-form-field.full-width {
    grid-column: 1 / -1;
}

.edit-form-label {
    font-weight: bold;
    margin-bottom: 5px;
    color: #333;
}

.edit-form-input {
    padding: 10px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1rem;
}

.edit-form-input:focus {
    border-color: #4caf50;
    outline: none;
}

.edit-form-input:disabled {
    background: #f0f0f0;
    cursor: not-allowed;
}

.edit-form-actions {
    display: flex;
    gap: 15px;
    margin-top: 25px;
    justify-content: center;
}

.btn-save-edit,
.btn-cancel-edit {
    padding: 12px 30px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.1rem;
    font-weight: bold;
    color: white;
    transition: all 0.3s;
}

.btn-save-edit {
    background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
}

.btn-cancel-edit {
    background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
}

.btn-save-edit:hover,
.btn-cancel-edit:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

@media (max-width: 768px) {
    .edit-items-btn {
        top: 60px;
        left: 10px;
        padding: 10px 15px;
        font-size: 0.9rem;
    }
    
    .filter-row {
        flex-direction: column;
    }
    
    .edit-form-grid {
        grid-template-columns: 1fr;
    }
}
/* ‚≠ê ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏î‡∏≥‡πÄ‡∏Ç‡πâ‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
.order-table tbody td {
    color: #000000 !important;
    font-weight: 700 !important;
}

.order-table tbody tr {
    color: #000000 !important;
}

.order-table td * {
    color: #000000 !important;
    font-weight: 700 !important;
}

/* ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞ input */
.order-quantity-input {
    color: #000000 !important;
    font-weight: 700 !important;
}
      .btn-download-order {
    background: linear-gradient(135deg, #42a5f5 0%, #1976d2 100%);
    color: white;
}

.btn-download-order:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(66, 165, 245, 0.4);
}

.badge-items {
    background: #f44336;
    color: white;
}

/* Badge ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤ */
.badge-price-study {
    background: #4caf50;
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: bold;
}

/* ‚≠ê Badge ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å (‡πÄ‡∏î‡∏¥‡∏°) */
.badge-main-table {
    background: #2196f3;
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: bold;
}


   /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô Order List */
.order-option-item {
    padding: 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
    background: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.order-option-item:hover {
    border-color: #667eea;
    background: #f0f4ff;
    transform: translateX(5px);
}

.order-display-text {
    font-size: 1.05rem;
    font-weight: bold;
    color: #333;
    flex: 1;
}

.order-item-count {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 5px 12px;
    border-radius: 15px;
    font-size: 0.9rem;
    font-weight: bold;
    margin-left: 10px;
} 

      /* Phone Dropdown Styles */
.phone-dropdown-item {
    padding: 12px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background 0.2s;
}

.phone-dropdown-item:hover {
    background: #e3f2fd !important;
}

.phone-dropdown-item:last-child {
    border-bottom: none;
}

/* Column Selection Modal Styles */
.column-checkbox-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.column-checkbox-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px;
    background: #f8f9fa;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 1rem;
}

.column-checkbox-item:hover {
    background: #e3f2fd;
    border-color: #4facfe;
}

.column-checkbox-item input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.column-checkbox-item span {
    flex: 1;
    font-weight: 500;
}


/* Saving Animation Styles */
.saving-animation-content {
    background: white;
    padding: 50px;
    border-radius: 20px;
    text-align: center;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    min-width: 300px;
}

.saving-spinner {
    width: 80px;
    height: 80px;
    border: 6px solid #f3f3f3;
    border-top: 6px solid #4facfe;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 25px;
}

.saving-text {
    font-size: 1.3rem;
    font-weight: bold;
    color: #4facfe;
    margin-bottom: 10px;
}

.saving-subtext {
    font-size: 1rem;
    color: #999;
}

.success-checkmark {
    font-size: 4rem;
    color: #4caf50;
    animation: scaleIn 0.5s ease-out;
}

@keyframes scaleIn {
    0% {
        transform: scale(0);
        opacity: 0;
    }
    50% {
        transform: scale(1.2);
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

.fade-out {
    animation: fadeOut 0.3s ease-out;
}

@keyframes fadeOut {
    from {
        opacity: 1;
    }
    to {
        opacity: 0;
    }
}

/* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô Modal */
.btn-confirm-stores {
    background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
    transition: all 0.3s;
}

.btn-confirm-stores:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
}




/* Loading Animation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 99999;
}

.loading-overlay.show {
    display: flex;
}

.loading-content {
    background: white;
    padding: 40px;
    border-radius: 20px;
    text-align: center;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.loading-spinner {
    width: 60px;
    height: 60px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    font-size: 1.2rem;
    font-weight: bold;
    color: #667eea;
    margin-top: 15px;
}

.loading-subtext {
    font-size: 0.9rem;
    color: #999;
    margin-top: 10px;
}


/* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ */
.order-option-item {
    padding: 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
    background: white;
}

.order-option-item:hover {
    border-color: #667eea;
    background: #f0f4ff;
    transform: translateX(5px);
}

.order-display-text {
    font-size: 1.05rem;
    font-weight: bold;
    color: #333;
}


/* ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) - ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
.data-mode-options {
    display: flex !important;
    flex-direction: row !important; /* ‚≠ê ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
    gap: 15px;
    margin-bottom: 20px;
    padding: 15px;
    background: linear-gradient(135deg, #fff5f5 0%, #f0fff4 100%);
    border-radius: 10px;
    border: 2px solid #e0e0e0;
    align-items: stretch; /* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô */
}

.data-mode-btn {
    flex: 1 1 50%; /* ‚≠ê ‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á 50% */
    padding: 15px 20px; /* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° padding */
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    font-size: 1.05rem; /* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ */
    font-weight: bold;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    white-space: nowrap; /* ‚≠ê ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ï‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
}

.data-mode-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.data-mode-btn.active.mode-low-stock {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    color: white;
    border-color: #ff6b6b;
}

.data-mode-btn.active.mode-all-items {
    background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
    color: white;
    border-color: #4caf50;
}

/* Responsive ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
@media (max-width: 768px) {
    .data-mode-options {
        flex-direction: column !important; /* ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        gap: 10px;
    }
    
    .data-mode-btn {
        flex: 1 1 100%;
        width: 100%;
    }
}

/* ‡∏™‡∏µ‡πÑ‡∏•‡πà‡πÇ‡∏ó‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô */
.product-item.color-1 { background: #fff3cd !important; }
.product-item.color-2 { background: #ffe4b5 !important; }
.product-item.color-3 { background: #e3f2fd !important; }
.product-item.color-4 { background: #c8e6c9 !important; }
.product-item.color-5 { background: #e1bee7 !important; }
.product-item.color-6 { background: #ffccbc !important; }

.selectable-item.color-1 { background: #fff3cd !important; }
.selectable-item.color-2 { background: #ffe4b5 !important; }
.selectable-item.color-3 { background: #e3f2fd !important; }
.selectable-item.color-4 { background: #c8e6c9 !important; }
.selectable-item.color-5 { background: #e1bee7 !important; }
.selectable-item.color-6 { background: #ffccbc !important; }

/* ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ */
.product-stock-detail {
    font-size: 0.85rem;
    color: #666;
    margin-top: 5px;
    line-height: 1.4;
}

.item-details-extended {
    font-size: 0.85rem;
    color: #666;
    line-height: 1.5;
}




     * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Noto Sans Lao', Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .header {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 30px;
        text-align: center;
    }

    .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
    }

    .data-status {
        margin-top: 20px;
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
    }

    .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(255,255,255,0.2);
        padding: 8px 15px;
        border-radius: 20px;
    }

    .status-icon {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .status-loading { background: #ffa726; animation: pulse 2s infinite; }
    .status-success { background: #4caf50; }
    .status-error { background: #f44336; }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .main-content {
        padding: 30px;
    }

    .loading-section {
        text-align: center;
        padding: 40px;
    }

    .loading-icon {
        width: 60px;
        height: 60px;
        border: 4px solid #e3f2fd;
        border-top: 4px solid #4facfe;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .low-stock-alert-btn {
        position: fixed;
        top: 20px;
        left: 20px;
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 50px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
        box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        z-index: 999;
        display: none;
        align-items: center;
        gap: 8px;
        animation: lowStockPulse 1.5s infinite;
    }

    .low-stock-alert-btn.show {
        display: flex;
    }

    @keyframes lowStockPulse {
        0%, 100% {
            transform: scale(1);
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }
        50% {
            transform: scale(1.15);
            background: linear-gradient(135deg, #ff4757 0%, #ff3838 100%);
        }
    }

    .stock-alert-badge {
        background: white;
        color: #ff4757;
        border-radius: 12px;
        padding: 4px 10px;
        font-size: 0.9rem;
        font-weight: bold;
    }

    .low-stock-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.85);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 20px;
    }

    .low-stock-modal.show {
        display: flex;
    }

    .low-stock-modal-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 900px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .low-stock-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 3px solid #f0f0f0;
    }

    .low-stock-modal-title {
        font-size: 2rem;
        font-weight: bold;
        color: #ff6b6b;
    }

    .stock-close-btn {
        background: #f0f0f0;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.5rem;
    }

    .zone-card {
        background: #f8f9fa;
        border: 3px solid #e1e5e9;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 15px;
        cursor: pointer;
    }

    .zone-card:hover {
        border-color: #ff6b6b;
    }

    .zone-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .zone-name {
        font-size: 1.5rem;
        font-weight: bold;
    }

    .zone-count {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        color: white;
        padding: 6px 15px;
        border-radius: 20px;
    }

    .zone-details {
        display: none;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid #dee2e6;
    }

    .zone-details.show {
        display: block;
    }

    .product-group {
        background: white;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 4px solid #ff6b6b;
    }

    .product-group-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
    }

    .product-stock-info {
        display: flex;
        gap: 15px;
    }

    .stock-alert-text {
        color: #ff6b6b;
        font-weight: bold;
    }

    .stock-remain-text {
        color: #ffa502;
        font-weight: bold;
    }

    .product-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 12px;
        background: #f8f9ff;
        border-radius: 10px;
        margin-bottom: 10px;
    }

    .product-icon {
        font-size: 1.5rem;
    }

    .product-image {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 8px;
    }

    .no-product-image {
        width: 60px;
        height: 60px;
        background: #f0f0f0;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: #999;
    }

    .product-info {
        flex: 1;
    }

    .product-name {
        font-size: 1.05rem;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .product-details {
        font-size: 0.9rem;
        color: #666;
    }

    .stock-empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
    }

    .stock-empty-state i {
        font-size: 4rem;
        color: #4caf50;
    }

    .order-section {
        margin-top: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 15px;
    }

    .order-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .order-number-display {
        font-size: 1.3rem;
        font-weight: bold;
        color: #4facfe;
    }

    .order-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .order-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
        transition: all 0.3s;
    }

    .btn-load-order {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-compare-price {
        background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
        color: white;
    }

    .btn-compare-price:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

.order-table-wrapper {
    background: white;
    border-radius: 12px;
    overflow-x: auto; /* ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° Scrollbar ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
    overflow-y: visible;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    max-width: 100%;
}

/* ‚≠ê ‡∏ï‡∏≤‡∏£‡∏≤‡∏á - ‡πÑ‡∏°‡πà‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î */
.order-table {
    width: 100%;
    min-width: 1200px; /* ‚≠ê ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ */
    border-collapse: collapse;
}

/* ‚≠ê ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏£‡πâ‡∏≤‡∏ô ‚Üí ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
.order-table.with-stores {
    min-width: 1800px; /* ‚≠ê ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ã‡∏∑‡πâ‡∏≠ */
}

/* ‚≠ê Scrollbar ‡∏™‡∏ß‡∏¢‡πÜ */
.order-table-wrapper::-webkit-scrollbar {
    height: 12px;
    background: #f0f0f0;
    border-radius: 10px;
}

.order-table-wrapper::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    border-radius: 10px;
    border: 2px solid #f0f0f0;
}

.order-table-wrapper::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

    .order-table {
        width: 100%;
        border-collapse: collapse;
    }

    .order-table thead {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }

    .order-table th {
        padding: 15px;
        text-align: left;
        font-weight: bold;
    }

    .order-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #f0f0f0;
    }

    .order-table tbody tr {
        transition: background 0.2s;
    }

    .order-table tbody tr:hover {
        background: #f8f9ff;
    }

    .order-table-img {
        width: 120px;
        height: 100px;
        object-fit: contain;
        border-radius: 8px;
    }

    .no-order-img {
        width: 120px;
        height: 100px;
        background: #f0f0f0;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .order-quantity-input {
        width: 80px;
        padding: 8px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        text-align: center;
        font-size: 1rem;
    }

    .order-quantity-input:focus {
        border-color: #4facfe;
        outline: none;
    }

    .btn-delete-item {
        background: #f44336;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
    }

    .btn-delete-item:hover {
        background: #d32f2f;
    }

    .order-footer {
        padding: 20px;
        background: #f8f9fa;
        border-top: 3px solid #4facfe;
    }

    .order-total {
        text-align: right;
        font-size: 1.5rem;
        font-weight: bold;
        color: #4facfe;
        margin-bottom: 15px;
    }

    .order-submit-actions {
        display: flex;
        justify-content: flex-end;
        gap: 15px;
    }

    .btn-save-print,
    .btn-save-whatsapp {
        padding: 15px 30px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-size: 1.1rem;
        font-weight: bold;
        color: white;
        transition: all 0.3s;
    }

    .btn-save-print {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
    }

    .btn-save-whatsapp {
        background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
    }

    .btn-save-print:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
    }

    .btn-save-whatsapp:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(37, 211, 102, 0.4);
    }

    .compare-section {
        margin-top: 20px;
    }

    .compare-table-container {
        margin-bottom: 20px;
        background: white;
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .compare-table-header {
        font-size: 1.2rem;
        font-weight: bold;
        color: #ffa726;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 2px solid #ffa726;
    }

    .item-highlighted {
        background: #fff3cd !important;
        border-left: 4px solid #ffc107;
    }

    .item-source-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: bold;
    }

    .badge-items {
        background: #f44336;
        color: white;
    }

   

    .store-selector-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.85);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        padding: 20px;
    }

    .store-selector-modal.show {
        display: flex;
    }

    .store-selector-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 600px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .store-selector-header {
        font-size: 1.8rem;
        font-weight: bold;
        color: #ffa726;
        margin-bottom: 20px;
    }

    .store-search-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        margin-bottom: 15px;
    }

    .store-search-input:focus {
        border-color: #ffa726;
        outline: none;
    }

    .store-list {
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 20px;
    }

    .store-item {
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .store-item:hover {
        border-color: #ffa726;
        background: #fff8e1;
    }

    .store-item.selected {
        background: #ffa726;
        color: white;
        border-color: #ffa726;
    }

    .store-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }

    .store-selector-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .btn-confirm-stores,
    .btn-cancel-stores {
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
    }

    .btn-confirm-stores {
        background: #ffa726;
        color: white;
    }

    .btn-cancel-stores {
        background: #e0e0e0;
        color: #333;
    }

    .search-options {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px;
        background: #f0f0f0;
        border-radius: 10px;
    }

    .search-option-btn {
        flex: 1;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
        transition: all 0.3s;
    }

    .search-option-btn.active {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        border-color: #4facfe;
    }

    .search-input-container {
        margin-bottom: 20px;
    }

    .search-input {
        width: 100%;
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 1.1rem;
    }

    .search-input:focus {
        border-color: #4facfe;
        outline: none;
    }

    .search-results {
        max-height: 400px;
        overflow-y: auto;
    }

    .selectable-item {
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .selectable-item:hover {
        border-color: #4facfe;
        background: #f0f8ff;
    }

    .selectable-item.selected {
        background: #fff3cd;
        border-color: #ffc107;
    }

    .item-checkbox {
        width: 24px;
        height: 24px;
        cursor: pointer;
    }

    .item-image-small {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 8px;
    }

    .item-info-block {
        flex: 1;
    }

    .item-name-large {
        font-size: 1.1rem;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .item-details-small {
        font-size: 0.9rem;
        color: #666;
    }

    .item-quantity-container {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .quantity-label {
        font-weight: bold;
    }

    .quantity-input {
        width: 80px;
        padding: 8px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        text-align: center;
        font-size: 1rem;
    }

    .confirm-selection-btn {
        margin-top: 20px;
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
    }

    .confirm-selection-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
    }

    @media print {
        body * {
            visibility: hidden;
        }
        
        .print-area,
        .print-area * {
            visibility: visible;
        }
        
        .print-area {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
        
        .order-actions,
        .order-submit-actions,
        .btn-delete-item {
            display: none !important;
        }
    }

    @media (max-width: 768px) {
        .low-stock-alert-btn {
            top: 10px;
            left: 10px;
            padding: 10px 15px;
            font-size: 0.9rem;
        }

        .product-item {
            flex-direction: column;
            text-align: center;
        }

        .order-header {
            flex-direction: column;
            gap: 15px;
        }
        
        .order-table {
            font-size: 0.9rem;
        }
        
        .order-table th,
        .order-table td {
            padding: 8px;
        }
        
        .order-submit-actions {
            flex-direction: column;
        }
        
        .btn-save-print,
        .btn-save-whatsapp {
            width: 100%;
        }
    }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîî ‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡ªÅ‡∫à‡ªâ‡∫á‡ªÄ‡∫ï‡∫∑‡∫≠‡∫ô‡∫™‡∫∞‡∫ï‡∫±‡∫≠‡∫Å‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</h1>
            <p>‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡∫ï‡∫¥‡∫î‡∫ï‡∫≤‡∫°‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡ªÉ‡∫Å‡ªâ‡ªù‡∫ª‡∫î‡∫≠‡∫±‡∫î‡∫ï‡∫∞‡ªÇ‡∫ô‡∫°‡∫±‡∫î</p>
            
            <div class="data-status">
                <div class="status-indicator" id="itemsStatus">
                    <div class="status-icon status-loading"></div>
                    <span>Items: ‡∫Å‡ªç‡∫≤‡∫•‡∫±‡∫á‡ªÇ‡∫´‡∫º‡∫î...</span>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div id="loadingSection" class="loading-section">
                <div class="loading-icon"></div>
                <h3>‡∫Å‡ªç‡∫≤‡∫•‡∫±‡∫á‡ªÇ‡∫´‡∫º‡∫î‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô...</h3>
                <p>‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫•‡ªç‡∫ñ‡ªâ‡∫≤‡∫™‡∫±‡∫Å‡∫Ñ‡∫π‡ªà</p>
                <div style="margin-top: 15px; color: #666;">
                    <div id="dataCount">0 ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô</div>
                </div>
            </div>

            <div id="orderSection" class="order-section" style="display: none;">
                <div class="order-header">
                    <div class="order-number-display">
                        üßæ ‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ: <span id="currentOrderNumber" data-is-loaded="false">-</span>
                    </div>
                 <div class="order-actions">
    <button class="order-btn btn-load-order" onclick="showLoadOrderModal()">
        üîÑ ‡∫î‡∫∂‡∫á‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ‡ªÄ‡∫Å‡∫ª‡ªà‡∫≤
    </button>
    <button class="order-btn btn-download-order" onclick="showDownloadOrderModal()">
        üì• ‡∫î‡∫≤‡∫ß‡ªÇ‡∫´‡∫º‡∫î‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ
    </button>
    <!-- ‚≠ê ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
    <button class="order-btn btn-clear-table" onclick="clearOrderTable()">
        üóëÔ∏è ‡∫•‡ªâ‡∫≤‡∫á‡∫ï‡∫≤‡∫ï‡∫∞‡∫•‡∫≤‡∫á
    </button>
    <!-- ‚≠ê ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ã‡∏∑‡πâ‡∏≠ -->
    <button class="order-btn btn-decision-buy" id="decisionBuyBtn" onclick="showDecisionBuyModal()" disabled>
        ‚úÖ ‡∫ï‡∫±‡∫î‡∫™‡∫¥‡∫ô‡ªÉ‡∫à‡∫ä‡∫∑‡ªâ
    </button>
    <button class="order-btn btn-compare-price" id="comparePriceBtn" onclick="showStoreSelectorModal()" disabled>
        ‚öñÔ∏è ‡∫õ‡∫Ω‡∫ö‡∫ó‡∫Ω‡∫ö‡∫•‡∫≤‡∫Ñ‡∫≤
    </button>
</div>
                </div>

                <div class="order-table-wrapper">
                    <table class="order-table">
                        <thead>
                            <tr>
                                <th>‡∫•‡∫≥‡∫î‡∫±‡∫ö</th>
                                <th>‡∫•‡∫∞‡∫´‡∫±‡∫î</th>
                                <th>‡∫Æ‡∫π‡∫ö</th>
                                <th>‡∫ä‡∫∑‡ªà‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</th>
                                <th>‡∫´‡∫ª‡∫ß‡ªú‡ªà‡∫ß‡∫ç</th>
                                <th>‡∫à‡∫≥‡∫ô‡∫ß‡∫ô</th>
                                <th>‡∫•‡∫≤‡∫Ñ‡∫≤/‡ªú‡ªà‡∫ß‡∫ç</th>
                                <th>‡∫•‡∫ß‡∫°‡ªÄ‡∫á‡∫¥‡∫ô</th>
                                <th>‡∫•‡∫ª‡∫ö</th>
                            </tr>
                        </thead>
                        <tbody id="orderTableBody">
                        </tbody>
                    </table>
                </div>

                <div class="order-footer">
                    <div class="order-total">
                        üí∞ ‡∫•‡∫ß‡∫°‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î: <span id="orderTotalAmount">0</span> ‡∫Å‡∫µ‡∫ö
                    </div>
                    <div class="order-submit-actions">
                        <button class="btn-save-print" onclick="saveAndPrint()">
                            üñ®Ô∏è ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å + PRINT
                        </button>
                        <button class="btn-save-whatsapp" onclick="saveAndWhatsapp()">
                            üì± ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å + WhatsApp
                        </button>
                    </div>
                </div>

                <div id="compareSection" class="compare-section" style="display: none;">
                </div>
            </div>
        </div>
    </div>

    <script>
    let itemsData = new Map();
    let priceStudyData = new Map();
    let itemsImageUrlCache = new Map(); // ‚≠ê ‡πÄ‡∏Å‡πá‡∏ö URL ‡∏£‡∏π‡∏õ
    let storeList = [];
    let phoneNumberList = []; // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
     let searchDebounceTimer = null; // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    let dataLoaded = { items: false, priceStudy: false };
    let loadStartTime = Date.now();
    let lowStockData = [];
    let lowStockModal = null;
    let currentOrderNumber = '';
    let orderItems = [];
    let selectedItemsForOrder = new Set();
   
    let currentSearchMode = 'zone';
let currentDataMode = 'lowStock'; // ‡πÉ‡∏´‡∏°‡πà: ‡πÇ‡∏´‡∏°‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (lowStock / allItems)
let allItemsDataCache = []; // ‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

    window.onload = function() {
        loadAllData();
    };

  async function loadAllData() {
    await Promise.all([
        loadItemsData(),
        loadPriceStudyData(),
        loadStoreList(),
        loadPhoneNumberList()  // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    ]);
}
async function loadPhoneNumberList() {
    return new Promise((resolve) => {
        google.script.run
            .withSuccessHandler((phones) => {
                phoneNumberList = phones;
                console.log('Phone numbers loaded:', phoneNumberList.length);
                resolve();
            })
            .withFailureHandler((error) => {
                console.error('Error loading phone numbers:', error);
                resolve();
            })
            .getPhoneNumberList();
    });
}

   /**
 * ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• + ‡πÄ‡∏Å‡πá‡∏ö URL ‡∏£‡∏π‡∏õ
 */
async function loadItemsData() {
    updateDataStatus('items', 'loading');
    
    return new Promise(function(resolve) {
        google.script.run
            .withSuccessHandler(function(data) {
                itemsData.clear();
                itemsImageUrlCache.clear(); // ‚≠ê ‡∏•‡πâ‡∏≤‡∏á Cache
                
                if (!data || !Array.isArray(data)) {
                    console.error('Invalid data received from getItemsData');
                    updateDataStatus('items', 'error');
                    dataLoaded.items = true;
                    checkAndInitialize();
                    resolve();
                    return;
                }
                
                console.log('üì¶ Loading ' + data.length + ' items with image URLs...');
                
                data.forEach(function(item) {
                    if (item.columnA) {
                        const barcode = item.columnA.toString().trim();
                        
                        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å
                        itemsData.set(barcode, item);
                        
                        // ‚≠ê ‡πÄ‡∏Å‡πá‡∏ö URL ‡∏£‡∏π‡∏õ Column K
                        if (item.columnK) {
                            const imageUrl = item.columnK.toString().trim();
                            if (imageUrl) {
                                itemsImageUrlCache.set(barcode, imageUrl);
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Items loaded:', itemsData.size);
                console.log('üñºÔ∏è Image URLs cached:', itemsImageUrlCache.size);
                
                updateDataStatus('items', 'success', itemsData.size);
                dataLoaded.items = true;
                checkAndInitialize();
                resolve();
            })
            .withFailureHandler(function(error) {
                console.error('Error in loadItemsData:', error);
                updateDataStatus('items', 'error');
                dataLoaded.items = true;
                checkAndInitialize();
                resolve();
            })
            .getItemsData(); // ‚≠ê ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°
    });
}

  async function loadPriceStudyData() {
    return new Promise(function(resolve) {
        google.script.run
            .withSuccessHandler(function(data) {
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                console.log('üì• Received data from getPriceStudyData()');
                console.log('üìä Data type:', typeof data);
                console.log('üìä Is Array:', Array.isArray(data));
                console.log('üìä Length:', data ? data.length : 0);
                
                priceStudyData.clear();
                
                if (!data || !Array.isArray(data) || data.length === 0) {
                    console.warn('‚ö†Ô∏è No price study data received');
                    dataLoaded.priceStudy = true;
                    checkAndInitialize();
                    resolve();
                    return;
                }
                
                console.log('üîÑ Processing ' + data.length + ' items...');
                
                let processedCount = 0;
                
                // ‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                data.forEach(function(item, idx) {
                    if (!item || !item.columnB) {
                        console.warn('‚ö†Ô∏è Item ' + idx + ' missing columnB:', item);
                        return;
                    }
                    
                    const barcode = item.columnB.toString().trim();
                    const store = item.columnF ? item.columnF.toString().trim() : '';
                    const price = parseFloat(item.columnH) || 0;
                    
                    if (!barcode) {
                        console.warn('‚ö†Ô∏è Empty barcode at index ' + idx);
                        return;
                    }
                    
                    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Map
                    if (!priceStudyData.has(barcode)) {
                        priceStudyData.set(barcode, []);
                    }
                    
                    priceStudyData.get(barcode).push({
                        barcode: barcode,
                        store: store,
                        price: price,
                        rawData: item
                    });
                    
                    processedCount++;
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å
                    if (idx < 5) {
                        console.log('  ‚úì Item ' + (idx + 1) + ':', barcode, '|', store, '|', price);
                    }
                });
                
                console.log('‚úÖ Processed: ' + processedCount + ' items');
                console.log('‚úÖ Unique barcodes: ' + priceStudyData.size);
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
                console.log('\nüìã Sample stored data:');
                let sampleCount = 0;
                priceStudyData.forEach(function(items, barcode) {
                    if (sampleCount < 3) {
                        console.log('üîë Barcode:', barcode, '(' + items.length + ' stores)');
                        items.forEach(function(item, idx) {
                            console.log('  ' + (idx + 1) + '. Store:', item.store, '| Price:', item.price);
                        });
                        sampleCount++;
                    }
                });
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');
                
                dataLoaded.priceStudy = true;
                checkAndInitialize();
                resolve();
            })
            .withFailureHandler(function(error) {
                console.error('‚ùå Error loading price study data:', error);
                dataLoaded.priceStudy = true;
                checkAndInitialize();
                resolve();
            })
            .getPriceStudyData();
    });
}

    async function loadStoreList() {
        return new Promise((resolve) => {
            google.script.run
                .withSuccessHandler((stores) => {
                    storeList = stores;
                    resolve();
                })
                .withFailureHandler((error) => {
                    console.error('Error loading store list:', error);
                    resolve();
                })
                .getStoreList();
        });
    }

    function checkAndInitialize() {
        if (dataLoaded.items && dataLoaded.priceStudy) {
            initializeUI();
        }
    }

    function updateDataStatus(type, status, count = 0) {
        const statusElement = document.getElementById(type + 'Status');
        if (!statusElement) return;
        
        const icon = statusElement.querySelector('.status-icon');
        const text = statusElement.querySelector('span');
        
        if (icon) icon.className = 'status-icon status-' + status;
        
        if (text) {
            if (status === 'success') {
                text.textContent = 'Items: ' + count.toLocaleString() + ' ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô ‚úì';
            } else if (status === 'error') {
                text.textContent = 'Items: ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î ‚úó';
            }
        }
    }

    function initializeUI() {
        const loadingSection = document.getElementById('loadingSection');
        const orderSection = document.getElementById('orderSection');
        
        if (loadingSection) loadingSection.style.display = 'none';
        if (orderSection) orderSection.style.display = 'block';
        
        currentOrderNumber = generateOrderNumber();
        document.getElementById('currentOrderNumber').textContent = currentOrderNumber;

        createLowStockAlertButton();
        checkLowStockAndShowAlert();
    }

    function generateOrderNumber() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        
        return 'PO-' + year + month + day + '-' + hours + minutes;
    }

    function createLowStockAlertButton() {
        if (document.getElementById('lowStockAlertBtn')) return;

        const alertButton = document.createElement('button');
        alertButton.id = 'lowStockAlertBtn';
        alertButton.className = 'low-stock-alert-btn';
        alertButton.innerHTML = 'üîî ‡ªÅ‡∫à‡ªâ‡∫á‡ªÄ‡∫ï‡∫∑‡∫≠‡∫ô‡∫™‡∫∞‡∫ï‡∫±‡∫≠‡∫Å & üõí‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤ <span class="stock-alert-badge" id="stockAlertBadge">0</span>';
        alertButton.onclick = showLowStockModal;
        document.body.appendChild(alertButton);

        createLowStockModal();
    }

function createLowStockModal() {
    const modal = document.createElement('div');
    modal.id = 'lowStockModal';
    modal.className = 'low-stock-modal';
    
    const content = '<div class="low-stock-modal-content">' +
        '<div class="low-stock-modal-header">' +
        '<h2 class="low-stock-modal-title">üîî ‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</h2>' +
        '<button class="stock-close-btn" onclick="closeLowStockModal()">√ó</button>' +
        '</div>' +
        // ‚≠ê ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ class="data-mode-options"
        '<div class="data-mode-options">' +
        '<button class="data-mode-btn mode-all-items active" onclick="setDataMode(\'allItems\')">üì¶ ‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î</button>' +
        '<button class="data-mode-btn mode-low-stock" onclick="setDataMode(\'lowStock\')">üî¥ ‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡ªÉ‡∫Å‡ªâ‡ªú‡∫ª‡∫î</button>' +
        '</div>' +
        '<div class="search-options">' +
        '<button class="search-option-btn active" onclick="setSearchMode(\'zone\')">üìç ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫ï‡∫≤‡∫°‡ªÇ‡∫ä‡∫ô</button>' +
        '<button class="search-option-btn" onclick="setSearchMode(\'scan\')">üì∑ ‡∫™‡∫∞‡ªÅ‡∫Å‡∫ô‡∫ö‡∫≤‡ªÇ‡∫Ñ‡∫î</button>' +
        '<button class="search-option-btn" onclick="setSearchMode(\'name\')">üîç ‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤‡∫ä‡∫∑‡ªà</button>' +
        '</div>' +
        '<div id="searchInputContainer" class="search-input-container" style="display: none;">' +
        '<input type="text" id="searchInput" class="search-input" placeholder="‡∫õ‡ªâ‡∫≠‡∫ô‡∫ö‡∫≤‡ªÇ‡∫Ñ‡∫î ‡∫´‡∫º‡∫∑ ‡∫ä‡∫∑‡ªà‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤...">' +
        '</div>' +
        '<div id="lowStockContent"></div>' +
        '<button id="confirmSelectionBtn" class="confirm-selection-btn" style="display: none;" onclick="confirmItemSelection()">‚úÖ ‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô‡∫Å‡∫≤‡∫ô‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å</button>' +
        '</div>';
    
    modal.innerHTML = content;
    document.body.appendChild(modal);
    lowStockModal = modal;
    
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', handleSearch);
    }
}
function setSearchMode(mode) {
    currentSearchMode = mode;
    
    document.querySelectorAll('.search-option-btn').forEach(function(btn) {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    const searchContainer = document.getElementById('searchInputContainer');
    const searchInput = document.getElementById('searchInput');
    const confirmBtn = document.getElementById('confirmSelectionBtn');
    
    if (mode === 'zone') {
        searchContainer.style.display = 'none';
        confirmBtn.style.display = 'block';
        displayZoneView();
    } else {
        searchContainer.style.display = 'block';
        confirmBtn.style.display = 'block';
        searchInput.value = '';
        searchInput.placeholder = mode === 'scan' ? '‡∫õ‡ªâ‡∫≠‡∫ô‡∫ö‡∫≤‡ªÇ‡∫Ñ‡∫î...' : '‡∫õ‡ªâ‡∫≠‡∫ô‡∫ä‡∫∑‡ªà‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤...';
        searchInput.focus();
        document.getElementById('lowStockContent').innerHTML = '<p style="text-align: center; color: #999;">‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫õ‡ªâ‡∫≠‡∫ô‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤</p>';
    }
}

 /**
 * ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏° Debounce + ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
 */
function handleSearch(e) {
    const query = e.target.value.trim().toLowerCase();
    
    // Clear timeout ‡πÄ‡∏î‡∏¥‡∏°
    if (searchDebounceTimer) {
        clearTimeout(searchDebounceTimer);
    }
    
    if (!query) {
        document.getElementById('lowStockContent').innerHTML = '<p style="text-align: center; color: #999;">‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫õ‡ªâ‡∫≠‡∫ô‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤</p>';
        return;
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á Loading
    document.getElementById('lowStockContent').innerHTML = '<p style="text-align: center; color: #4facfe;">üîç ‡∫Å‡ªç‡∫≤‡∫•‡∫±‡∫á‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤...</p>';
    
    // Debounce: ‡∏£‡∏≠ 300ms ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    searchDebounceTimer = setTimeout(function() {
        performSearch(query);
    }, 300);
}

/**
 * ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏£‡∏¥‡∏á (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function performSearch(query) {
    const results = [];
    const seenBarcodeBox = new Set();
    const sourceData = currentDataMode === 'lowStock' ? itemsData : itemsData;
    
    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß: Loop ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    sourceData.forEach(function(item, barcode) {
        const stockRemaining = parseFloat(item.columnF) || 0;
        const reorderPoint = parseFloat(item.columnD) || 0;
        
        const passStockCheck = currentDataMode === 'allItems' || 
                              (stockRemaining < reorderPoint && reorderPoint > 0);
        
        if (!passStockCheck) return;
        
        let matchFound = false;
        
        if (currentSearchMode === 'scan') {
            matchFound = barcode.toLowerCase().includes(query);
        } else if (currentSearchMode === 'name') {
            const itemName = (item.columnB || '').toLowerCase();
            matchFound = itemName.includes(query);
        }
        
        if (matchFound) {
            const barcodeBox = item.columnJ || barcode;
            
            // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ
            if (!seenBarcodeBox.has(barcodeBox)) {
                seenBarcodeBox.add(barcodeBox);
                
                // ‡∏î‡∏∂‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
                sourceData.forEach(function(relatedItem, relatedBarcode) {
                    const relatedBarcodeBox = relatedItem.columnJ || relatedBarcode;
                    
                    if (relatedBarcodeBox === barcodeBox) {
                        const relatedStock = parseFloat(relatedItem.columnF) || 0;
                        const relatedReorder = parseFloat(relatedItem.columnD) || 0;
                        
                        const relatedPassCheck = currentDataMode === 'allItems' || 
                                                (relatedStock < relatedReorder && relatedReorder > 0);
                        
                        if (relatedPassCheck) {
                            results.push({
                                barcode: relatedBarcode,
                                barcodeBox: relatedBarcodeBox,
                                itemName: relatedItem.columnB || '‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫ä‡∫∑‡ªà',
                                reorderPoint: relatedReorder,
                                stockRemaining: relatedStock,
                                unit: relatedItem.columnH || '‡∫ä‡∫¥‡ªâ‡∫ô',
                                quantityPerUnit: parseFloat(relatedItem.columnI) || 1,
                                image: relatedItem.columnK || '',
                                zone: relatedItem.columnM || '‡∫ö‡ªç‡ªà‡∫•‡∫∞‡∫ö‡∫∏‡ªÇ‡∫ä‡∫ô',
                                price: parseFloat(relatedItem.columnN) || 0
                            });
                        }
                    }
                });
            }
        }
    });
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    displaySearchResultsGrouped(results);
    
    // ‚≠ê ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏™‡πÅ‡∏Å‡∏ô: ‡∏ñ‡πâ‡∏≤‡∏û‡∏ö‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡∏Å‡∏•‡∏∏‡πà‡∏° ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    if (currentSearchMode === 'scan' && results.length > 0) {
        const uniqueGroups = new Set(results.map(item => item.barcodeBox));
        
        if (uniqueGroups.size === 1) {
            // ‡∏û‡∏ö‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡∏Å‡∏•‡∏∏‡πà‡∏° ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            autoAddSearchResultsToOrder(results);
            
            // ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            document.getElementById('searchInput').value = '';
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            document.getElementById('lowStockContent').innerHTML = 
                '<p style="text-align: center; color: #4caf50; font-size: 1.2rem; padding: 30px;">' +
                '‚úÖ ‡ªÄ‡∫û‡∫µ‡ªà‡∫° ' + results.length + ' ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î!<br>' +
                '<span style="font-size: 0.9rem; color: #666;">‡∫™‡∫∞‡ªÅ‡∫Å‡∫ô‡∫ï‡ªç‡ªà‡ªÑ‡∫î‡ªâ‡ªÄ‡∫•‡∫µ‡∫ç</span>' +
                '</p>';
            
            // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏á 1.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            setTimeout(function() {
                document.getElementById('lowStockContent').innerHTML = 
                    '<p style="text-align: center; color: #999;">‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫õ‡ªâ‡∫≠‡∫ô‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤</p>';
            }, 1500);
        }
    }
}

/**
 * ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function autoAddSearchResultsToOrder(results) {
    let addedCount = 0;
    
    results.forEach(function(item) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å
        const isInOrder = orderItems.some(function(orderItem) {
            return orderItem.barcode === item.barcode;
        });
        
        if (!isInOrder) {
            const orderItem = {
                barcode: item.barcode,
                itemName: item.itemName,
                unit: item.unit,
                quantity: 1,
                price: item.price,
                image: item.image,
                total: item.price
            };
            
            orderItems.push(orderItem);
            addedCount++;
        }
    });
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å
    if (addedCount > 0) {
        updateOrderTable();
    }
}

    function displaySearchResults(results) {
        const content = document.getElementById('lowStockContent');
        
        if (results.length === 0) {
            content.innerHTML = '<p style="text-align: center; color: #999;">‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô</p>';
            return;
        }
        
        const uniqueResults = [];
        const seenBarcodes = new Set();
        
        results.forEach(function(item) {
            if (!seenBarcodes.has(item.barcode)) {
                seenBarcodes.add(item.barcode);
                uniqueResults.push(item);
            }
        });
        
        let html = '<div class="search-results">';
        
        uniqueResults.forEach(function(item) {
            const isSelected = selectedItemsForOrder.has(item.barcode);
            const quantity = isSelected ? getItemQuantityFromOrder(item.barcode) : 1;
            
            html += '<div class="selectable-item ' + (isSelected ? 'selected' : '') + '" data-barcode="' + item.barcode + '" onclick="handleItemCardClick(event, \'' + item.barcode + '\')">';
            html += '<input type="checkbox" class="item-checkbox" ' + (isSelected ? 'checked' : '') + ' onclick="event.stopPropagation(); toggleItemSelection(\'' + item.barcode + '\')">';
            
            if (item.image) {
                html += '<img src="' + item.image + '" class="item-image-small">';
            } else {
                html += '<div class="no-product-image">üì∑</div>';
            }
            
            html += '<div class="item-info-block">';
            html += '<div class="item-name-large">' + item.itemName + '</div>';
            html += '<div class="item-details-small">‡∫•‡∫∞‡∫´‡∫±‡∫î: ' + item.barcode + ' | ‡ªÇ‡∫ä‡∫ô: ' + item.zone + '</div>';
            html += '</div>';
            html += '<div class="item-quantity-container">';
            html += '<span class="quantity-label">‡∫à‡∫≥‡∫ô‡∫ß‡∫ô:</span>';
            html += '<input type="number" class="quantity-input" value="' + quantity + '" min="1" onclick="event.stopPropagation()" onchange="updateItemQuantity(\'' + item.barcode + '\', this.value)">';
            html += '</div>';
            html += '</div>';
        });
        
        html += '</div>';
        content.innerHTML = html;
    }

    function handleItemCardClick(event, barcode) {
        if (event.target.classList.contains('quantity-input') || 
            event.target.classList.contains('item-checkbox')) {
            return;
        }
        
        toggleItemSelection(barcode);
    }

function displayZoneView() {
    const dataSource = currentDataMode === 'lowStock' ? lowStockData : allItemsDataCache;
    
    if (currentDataMode === 'allItems' && Object.keys(allItemsDataCache).length === 0) {
        loadAllItemsData();
    }
    
    const content = document.getElementById('lowStockContent');
    
    if (!dataSource || Object.keys(dataSource).length === 0) {
        if (currentDataMode === 'lowStock') {
            content.innerHTML = '<div class="stock-empty-state"><i>‚úÖ</i><h3>‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡ªÉ‡∫Å‡ªâ‡ªú‡∫ª‡∫î‡∫™‡∫∞‡∫ï‡∫±‡∫≠‡∫Å</h3></div>';
        } else {
            content.innerHTML = '<div class="stock-empty-state"><i>üì¶</i><h3>‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</h3></div>';
        }
        return;
    }

    const sortedZones = Object.entries(dataSource).sort(function(a, b) {
        return a[0].localeCompare(b[0]);
    });

    let html = '';
    sortedZones.forEach(function(zoneEntry) {
        const zoneName = zoneEntry[0];
        const zoneData = zoneEntry[1];
        const productCount = Object.keys(zoneData.products).length;
        const zoneId = 'zone_' + zoneName.replace(/\W/g, '');

        html += '<div class="zone-card" onclick="toggleZoneDetails(\'' + zoneId + '\')">';
        html += '<div class="zone-card-header">';
        html += '<div class="zone-name">üìç ‡ªÇ‡∫ä‡∫ô: ' + zoneName + '</div>';
        html += '<div class="zone-count">' + productCount + ' ‡∫Å‡∫∏‡ªà‡∫°‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</div>';
        html += '</div>';
        html += '<div id="' + zoneId + '" class="zone-details">';
        html += generateZoneDetailsHTMLEnhanced(zoneData);
        html += '</div>';
        html += '</div>';
    });

    content.innerHTML = html;
}

   

    function toggleItemSelection(barcode) {
        const item = itemsData.get(barcode);
        if (!item) return;
        
        if (selectedItemsForOrder.has(barcode)) {
            selectedItemsForOrder.delete(barcode);
        } else {
            selectedItemsForOrder.add(barcode);
        }
        
        const elements = document.querySelectorAll('[data-barcode="' + barcode + '"]');
        elements.forEach(function(el) {
            const checkbox = el.querySelector('.item-checkbox');
            const isSelected = selectedItemsForOrder.has(barcode);
            
            if (checkbox) {
                checkbox.checked = isSelected;
            }
            
            if (isSelected) {
                el.classList.add('selected');
            } else {
                el.classList.remove('selected');
            }
        });
    }

    function updateItemQuantity(barcode, quantity) {
        const qty = parseInt(quantity) || 1;
        
        if (!selectedItemsForOrder.has(barcode)) {
            selectedItemsForOrder.add(barcode);
        }
        
        const existingIndex = orderItems.findIndex(function(item) {
            return item.barcode === barcode;
        });
        if (existingIndex >= 0) {
            orderItems[existingIndex].quantity = qty;
        }
    }

    function getItemQuantityFromOrder(barcode) {
        const item = orderItems.find(function(i) {
            return i.barcode === barcode;
        });
        return item ? item.quantity : 1;
    }

  /**
 * ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î Modal)
 */
function confirmItemSelection() {
    if (selectedItemsForOrder.size === 0) {
        alert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡∫Å‡ªà‡∫≠‡∫ô');
        return;
    }
    
    let addedCount = 0;
    
    selectedItemsForOrder.forEach(function(barcode) {
        const item = itemsData.get(barcode);
        if (!item) return;
        
        const existingIndex = orderItems.findIndex(function(i) {
            return i.barcode === barcode;
        });
        
        const quantityInputs = document.querySelectorAll('[data-barcode="' + barcode + '"] .quantity-input');
        let quantity = 1;
        
        for (let i = 0; i < quantityInputs.length; i++) {
            const val = parseInt(quantityInputs[i].value);
            if (val && val > 0) {
                quantity = val;
                break;
            }
        }
        
        const orderItem = {
            barcode: barcode,
            itemName: item.columnB || '‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫ä‡∫∑‡ªà',
            unit: item.columnH || '‡∫ä‡∫¥‡ªâ‡∫ô',
            quantity: quantity,
            price: parseFloat(item.columnN) || 0,
            image: item.columnK || '',
            total: quantity * (parseFloat(item.columnN) || 0)
        };
        
        if (existingIndex >= 0) {
            orderItems[existingIndex] = orderItem;
        } else {
            orderItems.push(orderItem);
            addedCount++;
        }
    });
    
    // ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    selectedItemsForOrder.clear();
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å
    updateOrderTable();
    
    // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä Modal
    if (currentSearchMode === 'zone') {
        displayZoneView();
    } else {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.value = '';
            document.getElementById('lowStockContent').innerHTML = '<p style="text-align: center; color: #999;">‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫õ‡ªâ‡∫≠‡∫ô‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤</p>';
        }
    }
    
    // ‚≠ê ‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î Modal - ‡πÉ‡∏´‡πâ‡∏™‡πÅ‡∏Å‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ
    // closeLowStockModal(); // ‡∏•‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    if (addedCount > 0) {
        // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ö‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
        const content = document.getElementById('lowStockContent');
        const originalHTML = content.innerHTML;
        
        content.innerHTML = '<p style="text-align: center; color: #4caf50; font-size: 1.2rem; padding: 30px;">‚úÖ ‡ªÄ‡∫û‡∫µ‡ªà‡∫° ' + addedCount + ' ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î!</p>';
        
        setTimeout(function() {
            if (currentSearchMode === 'zone') {
                displayZoneView();
            } else {
                content.innerHTML = '<p style="text-align: center; color: #999;">‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫õ‡ªâ‡∫≠‡∫ô‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤</p>';
            }
        }, 1500);
    }
}

    function checkLowStockAndShowAlert() {
        if (!itemsData || itemsData.size === 0) return;

        const lowStockItems = [];

        itemsData.forEach(function(item) {
            const stockRemaining = parseFloat(item.columnF) || 0;
            const reorderPoint = parseFloat(item.columnD) || 0;

            if (stockRemaining < reorderPoint && reorderPoint > 0) {
                lowStockItems.push({
                    barcode: item.columnA || '',
                    barcodeBox: item.columnJ || '',
                    itemName: item.columnB || '‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫ä‡∫∑‡ªà',
                    reorderPoint: reorderPoint,
                    stockRemaining: stockRemaining,
                    unit: item.columnH || '‡∫ä‡∫¥‡ªâ‡∫ô',
                    quantityPerUnit: parseFloat(item.columnI) || 1,
                    image: item.columnK || '',
                    zone: item.columnM || '‡∫ö‡ªç‡ªà‡∫•‡∫∞‡∫ö‡∫∏‡ªÇ‡∫ä‡∫ô',
                    price: parseFloat(item.columnN) || 0
                });
            }
        });

        if (lowStockItems.length > 0) {
            lowStockData = groupLowStockByZone(lowStockItems);
            
            const alertBtn = document.getElementById('lowStockAlertBtn');
            if (alertBtn) {
                alertBtn.classList.add('show');
                
                const totalItems = Object.values(lowStockData).reduce(function(sum, zone) {
                    return sum + Object.keys(zone.products).length;
                }, 0);
                
                const badge = document.getElementById('stockAlertBadge');
                if (badge) badge.textContent = totalItems;
            }
        }
    }

    function groupLowStockByZone(items) {
        const grouped = {};

        items.forEach(function(item) {
            const zone = item.zone;
            const barcodeBox = item.barcodeBox || item.barcode;

            if (!grouped[zone]) {
                grouped[zone] = { zoneName: zone, products: {} };
            }

            if (!grouped[zone].products[barcodeBox]) {
                grouped[zone].products[barcodeBox] = {
                    barcodeBox: barcodeBox,
                    reorderPoint: item.reorderPoint,
                    stockRemaining: item.stockRemaining,
                    items: []
                };
            }

            grouped[zone].products[barcodeBox].items.push(item);
        });

        return grouped;
    }

/**
 * ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏°‡∏î "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")
 */
function showLowStockModal() {
    if (!lowStockModal) return;
    
    // ‚≠ê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
    currentSearchMode = 'zone';
    currentDataMode = 'allItems'; // ‚≠ê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å 'lowStock' ‡πÄ‡∏õ‡πá‡∏ô 'allItems'
    
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    document.querySelectorAll('.search-option-btn').forEach(function(btn) {
        btn.classList.remove('active');
    });
    document.querySelectorAll('.search-option-btn')[0].classList.add('active');
    
    // ‚≠ê ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏°‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
    document.querySelectorAll('.data-mode-btn').forEach(function(btn) {
        btn.classList.remove('active');
    });
    document.querySelector('.data-mode-btn.mode-all-items').classList.add('active');
    
    // ‡∏ã‡πà‡∏≠‡∏ô input ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
    document.getElementById('searchInputContainer').style.display = 'none';
    document.getElementById('confirmSelectionBtn').style.display = 'block';
    
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    if (Object.keys(allItemsDataCache).length === 0) {
        loadAllItemsData();
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á View
    displayZoneView();
    lowStockModal.classList.add('show');
}
    function toggleZoneDetails(zoneId) {
        const element = document.getElementById(zoneId);
        if (element) {
            element.classList.toggle('show');
            
            if (element.classList.contains('show')) {
                setTimeout(function() {
                    element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            }
        }
    }

    function closeLowStockModal() {
        if (lowStockModal) lowStockModal.classList.remove('show');
    }

    function updateOrderTable() {
        const tbody = document.getElementById('orderTableBody');
        const comparePriceBtn = document.getElementById('comparePriceBtn');
        
        if (!tbody) return;
        
        if (orderItems.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #999;">‡∫ç‡∫±‡∫á‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ<br>‡∫Å‡∫ª‡∫î‡∫õ‡∫∏‡ªà‡∫° "üîî ‡ªÅ‡∫à‡ªâ‡∫á‡ªÄ‡∫ï‡∫∑‡∫≠‡∫ô‡∫™‡∫∞‡∫ï‡∫±‡∫≠‡∫Å" ‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</td></tr>';
            comparePriceBtn.disabled = true;
            updateOrderTotal();
            return;
        }
        
        comparePriceBtn.disabled = false;
        
        let html = '';
        orderItems.forEach(function(item, index) {
            const highlightClass = selectedItemsForOrder.has(item.barcode) ? 'item-highlighted' : '';
            const imgHtml = item.image ? '<img src="' + item.image + '" class="order-table-img">' : '<div class="no-order-img">üì∑</div>';
            
            html += '<tr class="' + highlightClass + '">';
            html += '<td>' + (index + 1) + '</td>';
            html += '<td>' + item.barcode + '</td>';
            html += '<td>' + imgHtml + '</td>';
            html += '<td>' + item.itemName + '</td>';
            html += '<td>' + item.unit + '</td>';
            html += '<td><input type="number" class="order-quantity-input" value="' + item.quantity + '" min="1" onchange="updateOrderItemQuantity(' + index + ', this.value)"></td>';
            html += '<td>' + item.price.toLocaleString() + '</td>';
            html += '<td>' + (item.quantity * item.price).toLocaleString() + '</td>';
            html += '<td><button class="btn-delete-item" onclick="deleteOrderItem(' + index + ')">‚ùå</button></td>';
            html += '</tr>';
        });
        
        tbody.innerHTML = html;
        updateOrderTotal();
    }

    function updateOrderItemQuantity(index, quantity) {
        const qty = parseInt(quantity) || 1;
        orderItems[index].quantity = qty;
        orderItems[index].total = qty * orderItems[index].price;
        updateOrderTable();
    }

 function deleteOrderItem(index) {
    const item = orderItems[index];
    selectedItemsForOrder.delete(item.barcode);
    orderItems.splice(index, 1);
    updateOrderTable();
    
    // ‡∏ñ‡πâ‡∏≤ Modal ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
    if (lowStockModal && lowStockModal.classList.contains('show')) {
        if (currentSearchMode === 'zone') {
            displayZoneView();
        } else {
            const searchInput = document.getElementById('searchInput');
            if (searchInput && searchInput.value.trim()) {
                handleSearch({ target: searchInput });
            }
        }
    }
}

    function updateOrderTotal() {
        const total = orderItems.reduce(function(sum, item) {
            return sum + item.total;
        }, 0);
        document.getElementById('orderTotalAmount').textContent = total.toLocaleString();
    }

    function showStoreSelectorModal() {
        if (orderItems.length === 0) {
            alert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡∫•‡∫ª‡∫á‡ªÉ‡∫ô‡∫ï‡∫≤‡∫ï‡∫∞‡∫•‡∫≤‡∫á‡∫Å‡ªà‡∫≠‡∫ô');
            return;
        }
        
        const modal = document.createElement('div');
        modal.id = 'storeSelectorModal';
        modal.className = 'store-selector-modal show';
        
        modal.innerHTML = '<div class="store-selector-content">' +
            '<div class="store-selector-header">‚öñÔ∏è ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫Æ‡ªâ‡∫≤‡∫ô‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫õ‡∫Ω‡∫ö‡∫ó‡∫Ω‡∫ö‡∫•‡∫≤‡∫Ñ‡∫≤</div>' +
            '<input type="text" id="storeSearchInput" class="store-search-input" placeholder="‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤‡∫Æ‡ªâ‡∫≤‡∫ô..." onkeyup="filterStores()">' +
            '<div class="store-list" id="storeListContainer">' + generateStoreListHTML() + '</div>' +
            '<div class="store-selector-actions">' +
            '<button class="btn-cancel-stores" onclick="closeStoreSelectorModal()">‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>' +
            '<button class="btn-confirm-stores" onclick="confirmStoreSelection()">‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô</button>' +
            '</div>' +
            '</div>';
        
        document.body.appendChild(modal);
        
        modal.addEventListener('click', function(e) {
            if (e.target === modal) closeStoreSelectorModal();
        });
    }

    function generateStoreListHTML() {
        if (!storeList || storeList.length === 0) {
            return '<p style="text-align: center; color: #999;">‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫Æ‡ªâ‡∫≤‡∫ô</p>';
        }
        
        let html = '';
        storeList.forEach(function(store) {
            html += '<div class="store-item" onclick="toggleStoreSelection(\'' + store + '\')">';
            html += '<input type="checkbox" class="store-checkbox" value="' + store + '" onchange="event.stopPropagation(); toggleStoreSelection(\'' + store + '\')">';
            html += '<span>' + store + '</span>';
            html += '</div>';
        });
        
        return html;
    }

    function filterStores() {
        const input = document.getElementById('storeSearchInput');
        const filter = input.value.toLowerCase();
        const container = document.getElementById('storeListContainer');
        const items = container.getElementsByClassName('store-item');
        
        for (let i = 0; i < items.length; i++) {
            const text = items[i].textContent || items[i].innerText;
            if (text.toLowerCase().indexOf(filter) > -1) {
                items[i].style.display = '';
            } else {
                items[i].style.display = 'none';
            }
        }
    }

    function toggleStoreSelection(storeName) {
        const item = event.currentTarget;
        const checkbox = item.querySelector('.store-checkbox');
        
        item.classList.toggle('selected');
        checkbox.checked = !checkbox.checked;
    }

    function confirmStoreSelection() {
        const checkboxes = document.querySelectorAll('.store-checkbox:checked');
        const selectedStores = Array.from(checkboxes).map(function(cb) {
            return cb.value;
        });
        
        if (selectedStores.length === 0) {
            alert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫Æ‡ªâ‡∫≤‡∫ô‡∫¢‡ªà‡∫≤‡∫á‡ªú‡ªâ‡∫≠‡∫ç 1 ‡∫Æ‡ªâ‡∫≤‡∫ô');
            return;
        }
        
        closeStoreSelectorModal();
        generateComparisonTables(selectedStores);
    }

    function closeStoreSelectorModal() {
        const modal = document.getElementById('storeSelectorModal');
        if (modal) modal.remove();
    }

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏£‡πâ‡∏≤‡∏ô (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°)
 */
function generateComparisonTables(stores) {
    console.log('=== generateComparisonTables START ===');
    console.log('Selected Stores:', stores);

    const compareSection = document.getElementById('compareSection');
    if (!compareSection) {
        console.error('‚ùå compareSection not found!');
        return;
    }

    compareSection.style.display = 'block';
    compareSection.innerHTML = '<h3 style="color: #ffa726; margin-bottom: 20px;">üìä ‡∫ï‡∫≤‡∫ï‡∫∞‡∫•‡∫≤‡∫á‡∫õ‡∫Ω‡∫ö‡∫ó‡∫Ω‡∫ö‡∫•‡∫≤‡∫Ñ‡∫≤</h3>';

    if (!orderItems || orderItems.length === 0) {
        console.warn('‚ö†Ô∏è orderItems is empty');
        orderItems = [];
        itemsData.forEach((item, key) => {
            orderItems.push({
                barcode: key,
                itemName: item.itemName || '',
                unit: item.unit || '',
                quantity: item.quantity || 1,
                image: item.image || '',
                price: item.price || 0
            });
        });
        console.log('‚úÖ Generated orderItems from itemsData:', orderItems.length);
    }

    console.log('Order Items:', orderItems);

    // ‚≠ê ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å
    const mainTableTotal = orderItems.reduce(function(sum, item) {
        return sum + (item.quantity * item.price);
    }, 0);

    console.log('üí∞ Main Table Total:', mainTableTotal);

    // ‚≠ê ‡πÄ‡∏Å‡πá‡∏ö‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô
    const storeTotals = {};

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô
    stores.forEach(function(storeName) {
        console.log('Generating table for store:', storeName);
        const tableResult = generateSingleComparisonTableWithTotal(storeName);
        compareSection.innerHTML += tableResult.html;
        storeTotals[storeName] = tableResult.total;
    });

    // ‚≠ê ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô
    const summaryHTML = createTotalSummary(mainTableTotal, storeTotals);
    
    // ‡πÅ‡∏ó‡∏£‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á compareSection
    const summaryDiv = document.createElement('div');
    summaryDiv.innerHTML = summaryHTML;
    compareSection.insertBefore(summaryDiv, compareSection.firstChild.nextSibling);

    console.log('=== generateComparisonTables END ===');
}
/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å Column H ‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏£‡πâ‡∏≤‡∏ô)
 */
function generateSingleComparisonTable(storeName) {
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log('üè™ Generating table for store:', storeName);
    console.log('üìä Order Items:', orderItems.length);
    console.log('üóÑÔ∏è Items Data:', itemsData.size);
    console.log('üí∞ Price Study Data:', priceStudyData.size);
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

    let html = '<div class="compare-table-container">' +
        '<div class="compare-table-header">üè™ ' + storeName + '</div>' +
        '<div class="order-table-wrapper">' +
        '<table class="order-table">' +
        '<thead><tr>' +
        '<th>‡∫•‡∫≥‡∫î‡∫±‡∫ö</th><th>‡∫•‡∫∞‡∫´‡∫±‡∫î</th><th>‡∫Æ‡∫π‡∫ö</th><th>‡∫ä‡∫∑‡ªà‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</th>' +
        '<th>‡∫´‡∫ª‡∫ß‡ªú‡ªà‡∫ß‡∫ç</th><th>‡∫à‡∫≥‡∫ô‡∫ß‡∫ô</th><th>‡∫•‡∫≤‡∫Ñ‡∫≤/‡ªú‡ªà‡∫ß‡∫ç</th><th>‡∫•‡∫ß‡∫°‡ªÄ‡∫á‡∫¥‡∫ô</th><th>‡ªÅ‡∫´‡∫º‡ªà‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô</th>' +
        '</tr></thead><tbody>';

    let totalAmount = 0;

    // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    orderItems.forEach(function(orderItem, index) {
        const barcodeFromOrder = orderItem.barcode.toString().trim();
        
        console.log('\nüì¶ Item ' + (index + 1) + ': ' + orderItem.itemName);
        console.log('üîë Barcode:', barcodeFromOrder);

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å (Items)
        const mainItem = itemsData.get(barcodeFromOrder);
        
        if (!mainItem) {
            console.warn('‚ö†Ô∏è Not found in Items table');
            
            // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å orderItem
            const itemTotal = orderItem.quantity * (orderItem.price || 0);
            totalAmount += itemTotal;
            
            const imgHtml = orderItem.image ? 
                '<img src="' + orderItem.image + '" class="order-table-img">' : 
                '<div class="no-order-img">üì∑</div>';
            
            html += '<tr style="background: #ffe0e0;">';
            html += '<td>' + (index + 1) + '</td>';
            html += '<td>' + barcodeFromOrder + '</td>';
            html += '<td>' + imgHtml + '</td>';
            html += '<td>' + orderItem.itemName + '</td>';
            html += '<td>' + orderItem.unit + '</td>';
            html += '<td>' + orderItem.quantity + '</td>';
            html += '<td>' + (orderItem.price || 0).toLocaleString() + '</td>';
            html += '<td>' + itemTotal.toLocaleString() + '</td>';
            html += '<td><span class="item-source-badge badge-main-table">‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÄ‡∫î‡∫µ‡∫°</span></td>';
            html += '</tr>';
            return;
        }

        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å
        const baseData = {
            barcode: barcodeFromOrder,
            itemName: mainItem.columnB || orderItem.itemName,
            unit: mainItem.columnH || orderItem.unit,
            quantity: orderItem.quantity,
            image: mainItem.columnK || orderItem.image,
            priceFromMainTable: parseFloat(mainItem.columnN) || 0
        };

        console.log('‚úÖ Found in Items table');
        console.log('üìã Item Name:', baseData.itemName);
        console.log('üíµ Main Table Price (Column N):', baseData.priceFromMainTable);

        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡∫™‡∫∂‡∫Å‡∫™‡∫≤‡∫•‡∫≤‡∫Ñ‡∫≤‡∫ï‡∫ª‡ªâ‡∫ô‡∫ó‡∫∂‡∫ô
        const priceStudyItems = priceStudyData.get(barcodeFromOrder);
        
        let finalPrice = baseData.priceFromMainTable;
        let source = 'main-table';
        let priceSource = '‡∫ï‡∫≤‡∫ï‡∫∞‡∫•‡∫≤‡∫á‡∫´‡∫º‡∫±‡∫Å';

        if (priceStudyItems && priceStudyItems.length > 0) {
            console.log('üîç Found ' + priceStudyItems.length + ' price study entries for this barcode');
            
            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
            const matchedItem = priceStudyItems.find(function(item) {
                const storeMatch = item.store.toLowerCase() === storeName.toLowerCase().trim();
                console.log('  ‚Üí Comparing: "' + item.store + '" === "' + storeName + '" ? ' + storeMatch + ' (Price: ' + item.price + ')');
                return storeMatch;
            });
            
            if (matchedItem) {
                console.log('‚úÖ MATCH FOUND!');
                console.log('üè™ Store:', matchedItem.store);
                console.log('üí∞ Price (Column H):', matchedItem.price);
                
                if (matchedItem.price > 0) {
                    finalPrice = matchedItem.price;
                    source = 'price-study';
                    priceSource = '‡∫™‡∫∂‡∫Å‡∫™‡∫≤‡∫•‡∫≤‡∫Ñ‡∫≤‡∫ï‡∫ª‡ªâ‡∫ô‡∫ó‡∫∂‡∫ô';
                } else {
                    console.warn('‚ö†Ô∏è Price is 0 or invalid, using main table price');
                }
            } else {
                console.log('‚ùå No matching store found, using main table price');
            }
        } else {
            console.log('‚ùå No price study data for this barcode');
        }

        console.log('üìä Final Price:', finalPrice);
        console.log('üìå Source:', priceSource);

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
        const itemTotal = baseData.quantity * finalPrice;
        totalAmount += itemTotal;

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML
        const imgHtml = baseData.image ? 
            '<img src="' + baseData.image + '" class="order-table-img">' : 
            '<div class="no-order-img">üì∑</div>';

        const badgeClass = source === 'price-study' ? 'badge-price-study' : 'badge-main-table';
        const rowStyle = source === 'main-table' ? ' style="background: #e3f2fd;"' : '';

        html += '<tr' + rowStyle + '>';
        html += '<td>' + (index + 1) + '</td>';
        html += '<td>' + baseData.barcode + '</td>';
        html += '<td>' + imgHtml + '</td>';
        html += '<td>' + baseData.itemName + '</td>';
        html += '<td>' + baseData.unit + '</td>';
        html += '<td>' + baseData.quantity + '</td>';
        html += '<td>' + (finalPrice > 0 ? finalPrice.toLocaleString() : '-') + '</td>';
        html += '<td>' + (itemTotal > 0 ? itemTotal.toLocaleString() : '-') + '</td>';
        html += '<td><span class="item-source-badge ' + badgeClass + '">' + priceSource + '</span></td>';
        html += '</tr>';
    });

    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log('üí∞ Total Amount:', totalAmount.toLocaleString());
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');

    html += '</tbody></table></div>' +
        '<div class="order-footer">' +
        '<div class="order-total">üí∞ ‡∫•‡∫ß‡∫°‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î: ' + totalAmount.toLocaleString() + ' ‡∫Å‡∫µ‡∫ö</div>' +
        '</div></div>';

    return html;
}


 function saveAndPrint() {
    if (orderItems.length === 0) {
        alert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡∫•‡∫ª‡∫á‡ªÉ‡∫ô‡∫ï‡∫≤‡∫ï‡∫∞‡∫•‡∫≤‡∫á‡∫Å‡ªà‡∫≠‡∫ô');
        return;
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Å‡πà‡∏≠‡∏ô
    showColumnSelectionModal();
}
/**
 * ‡πÅ‡∏™‡∏î‡∏á Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô Print
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function showColumnSelectionModal() {
    const modal = document.createElement('div');
    modal.id = 'columnSelectionModal';
    modal.className = 'store-selector-modal show';
    
    modal.innerHTML = '<div class="store-selector-content" style="max-width: 500px;">' +
        '<div class="store-selector-header">üñ®Ô∏è ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫Ñ‡ªç‡∫•‡ªç‡∫≤‡∫ó‡∫µ‡ªà‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫õ‡∫¥‡∫î‡∫ö‡∫±‡∫á</div>' +
        '<div style="padding: 20px;">' +
        '<p style="margin-bottom: 15px; color: #666;">‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫Ñ‡ªç‡∫•‡ªç‡∫≤‡∫ó‡∫µ‡ªà‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫á‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫õ‡∫∂‡∫°:</p>' +
        '<div class="column-checkbox-list">' +
        '<label class="column-checkbox-item">' +
        '<input type="checkbox" value="index"> <span>‡∫•‡∫≥‡∫î‡∫±‡∫ö</span>' +
        '</label>' +
        '<label class="column-checkbox-item">' +
        '<input type="checkbox" value="barcode"> <span>‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</span>' +
        '</label>' +
        '<label class="column-checkbox-item">' +
        '<input type="checkbox" value="image"> <span>‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö</span>' +
        '</label>' +
        '<label class="column-checkbox-item">' +
        '<input type="checkbox" value="itemName"> <span>‡∫ä‡∫∑‡ªà‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</span>' +
        '</label>' +
        '<label class="column-checkbox-item">' +
        '<input type="checkbox" value="quantity"> <span>‡∫à‡∫≥‡∫ô‡∫ß‡∫ô</span>' +
        '</label>' +
        '<label class="column-checkbox-item">' +
        '<input type="checkbox" value="price"> <span>‡∫•‡∫≤‡∫Ñ‡∫≤/‡ªú‡ªà‡∫ß‡∫ç</span>' +
        '</label>' +
        '<label class="column-checkbox-item">' +
        '<input type="checkbox" value="total"> <span>‡∫•‡∫ß‡∫°‡ªÄ‡∫á‡∫¥‡∫ô</span>' +
        '</label>' +
        '</div>' +
        '</div>' +
        '<div class="store-selector-actions">' +
        '<button class="btn-cancel-stores" onclick="closeColumnSelectionModal()">‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>' +
        '<button class="btn-confirm-stores" onclick="confirmColumnSelectionAndPrint()">‚úÖ ‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô ‡ªÅ‡∫•‡∫∞ ‡∫õ‡∫∂‡∫°</button>' +
        '</div>' +
        '</div>';
    
    document.body.appendChild(modal);
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) closeColumnSelectionModal();
    });
}
/**
 * ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function closeColumnSelectionModal() {
    const modal = document.getElementById('columnSelectionModal');
    if (modal) modal.remove();
}
function confirmColumnSelectionAndPrint() {
    const checkboxes = document.querySelectorAll('#columnSelectionModal input[type="checkbox"]:checked');
    const hiddenColumns = [];
    
    checkboxes.forEach(function(checkbox) {
        hiddenColumns.push(checkbox.value);
    });
    
    closeColumnSelectionModal();
    
    // ‚≠ê ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• hiddenColumns ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô sessionStorage
    sessionStorage.setItem('printHiddenColumns', JSON.stringify(hiddenColumns));
    
    executePrint(hiddenColumns);
}
/**
 * ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Print ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô)
 */
function executePrint(hiddenColumns) {
    // ‡πÅ‡∏™‡∏î‡∏á Loading Animation - ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
    showImageLoadingAnimation();
    
    // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
    waitForAllImagesToLoad(function() {
        // ‡∏ã‡πà‡∏≠‡∏ô Loading Animation
        hideImageLoadingAnimation();
        
        // ‚≠ê ‡∏£‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å 300ms ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏¥‡πâ‡∏ô
        setTimeout(function() {
            proceedWithPrint(hiddenColumns);
        }, 300);
    });
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function waitForAllImagesToLoad(callback) {
    const orderTableBody = document.getElementById('orderTableBody');
    if (!orderTableBody) {
        callback();
        return;
    }
    
    // ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    const images = orderTableBody.querySelectorAll('.order-table-img');
    
    if (images.length === 0) {
        // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ ‡πÉ‡∏´‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        callback();
        return;
    }
    
    let loadedCount = 0;
    let totalImages = images.length;
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    function checkAllLoaded() {
        loadedCount++;
        updateImageLoadingProgress(loadedCount, totalImages);
        
        if (loadedCount >= totalImages) {
            // ‡∏£‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å 500ms ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏£‡∏π‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ñ‡∏£‡∏ö
            setTimeout(callback, 500);
        }
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏π‡∏õ
    images.forEach(function(img) {
        if (img.complete && img.naturalHeight !== 0) {
            // ‡∏£‡∏π‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
            checkAllLoaded();
        } else {
            // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
            img.onload = checkAllLoaded;
            img.onerror = function() {
                console.warn('Image failed to load:', img.src);
                checkAllLoaded(); // ‡∏ô‡∏±‡∏ö‡πÅ‡∏°‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            };
        }
    });
}

/**
 * ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ Print ‡∏à‡∏£‡∏¥‡∏á (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà - ‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å executePrint)
 */
/**
 * ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ Print ‡∏à‡∏£‡∏¥‡∏á (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Print ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô)
 */
function proceedWithPrint(hiddenColumns) {
    const now = new Date();
    const dateStr = now.toLocaleDateString('lo-LA');
    const timeStr = now.toLocaleTimeString('lo-LA');
    const total = orderItems.reduce(function(sum, item) {
        return sum + item.total;
    }, 0);
    
    const hideIndex = hiddenColumns.includes('index');
    const hideBarcode = hiddenColumns.includes('barcode');
    const hideImage = hiddenColumns.includes('image');
    const hideItemName = hiddenColumns.includes('itemName');
    const hideQuantity = hiddenColumns.includes('quantity');
    const hidePrice = hiddenColumns.includes('price');
    const hideTotal = hiddenColumns.includes('total');
    
    let tableHeader = '<tr>' +
        '<th style="width: 50px;">‡∫•‡∫≥‡∫î‡∫±‡∫ö</th>' +
        '<th style="width: 120px;">‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</th>' +
        '<th style="width: 80px;">‡∫Æ‡∫π‡∫ö</th>' +
        '<th>‡∫ä‡∫∑‡ªà‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</th>' +
        '<th style="width: 100px;">‡∫à‡∫≥‡∫ô‡∫ß‡∫ô</th>' +
        '<th style="width: 100px;">‡∫•‡∫≤‡∫Ñ‡∫≤/‡ªú‡ªà‡∫ß‡∫ç</th>' +
        '<th style="width: 120px;">‡∫•‡∫ß‡∫°‡ªÄ‡∫á‡∫¥‡∫ô</th>' +
        '</tr>';
    
    let itemsRows = '';
    orderItems.forEach(function(item, index) {
        const imgTag = item.image ? 
            '<img src="' + item.image + '" class="order-table-img" style="width: 60px; height: 60px; object-fit: cover; border-radius: 5px;">' : 
            '<div style="width: 60px; height: 60px; background: #f0f0f0; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üì∑</div>';
        
        itemsRows += '<tr>';
        itemsRows += '<td style="text-align: center; padding: 10px; border: 1px solid #ddd;">' + (hideIndex ? '&nbsp;' : (index + 1)) + '</td>';
        itemsRows += '<td style="padding: 10px; border: 1px solid #ddd;">' + (hideBarcode ? '&nbsp;' : item.barcode) + '</td>';
        itemsRows += '<td style="text-align: center; padding: 10px; border: 1px solid #ddd;">' + (hideImage ? '&nbsp;' : imgTag) + '</td>';
        itemsRows += '<td style="padding: 10px; border: 1px solid #ddd;">' + (hideItemName ? '&nbsp;' : item.itemName) + '</td>';
        itemsRows += '<td style="text-align: center; padding: 10px; border: 1px solid #ddd;">' + (hideQuantity ? '&nbsp;' : (item.quantity + ' ' + item.unit)) + '</td>';
        itemsRows += '<td style="text-align: right; padding: 10px; border: 1px solid #ddd;">' + (hidePrice ? '&nbsp;' : item.price.toLocaleString()) + '</td>';
        itemsRows += '<td style="text-align: right; padding: 10px; border: 1px solid #ddd;">' + (hideTotal ? '&nbsp;' : item.total.toLocaleString()) + '</td>';
        itemsRows += '</tr>';
    });
    
    let totalRow = '<tr class="total-row">' +
        '<td colspan="6" style="text-align: right; padding: 15px;">‡∫•‡∫ß‡∫°‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î:</td>' +
        '<td style="text-align: right; padding: 15px;">' + (hideTotal ? '&nbsp;' : (total.toLocaleString() + ' ‡∫Å‡∫µ‡∫ö')) + '</td>' +
        '</tr>';
    
    // ‚≠ê ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏û‡∏£‡πâ‡∏≠‡∏° Script ‡∏£‡∏≠‡∏£‡∏π‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏ö
    const printContent = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤ - ' + currentOrderNumber + '</title><style>body { font-family: "Noto Sans Lao", Arial, sans-serif; padding: 20px; }.header { text-align: center; margin-bottom: 30px; }.header h1 { color: #4facfe; margin: 0; font-size: 2rem; }.info-section { margin-bottom: 20px; }.info-section p { margin: 5px 0; font-size: 1rem; }table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }thead { background: #2c3e50 !important; color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }th { padding: 12px; border: 1px solid #ddd; font-weight: bold; color: white !important; background: #2c3e50 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }td { padding: 10px; border: 1px solid #ddd; }tbody tr:nth-child(even) { background: #f9f9f9; }.total-row { background: #f0f0f0; font-weight: bold; font-size: 1.2em; }.signature-section { margin-top: 50px; display: flex; justify-content: space-around; }.signature-box { text-align: center; }.signature-line { margin-top: 50px; border-top: 1px solid #333; padding-top: 5px; }@media print { body { padding: 10px; }thead { background: #2c3e50 !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }th { background: #2c3e50 !important; color: white !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }}</style></head><body><div class="header"><h1>üè¢ ‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</h1></div><div class="info-section"><p><strong>‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ:</strong> ' + currentOrderNumber + '</p><p><strong>‡∫ß‡∫±‡∫ô‡∫ó‡∫µ:</strong> ' + dateStr + ' ' + timeStr + '</p></div><table><thead>' + tableHeader + '</thead><tbody>' + itemsRows + totalRow + '</tbody></table><div class="signature-section"><div class="signature-box"><p>‡∫•‡∫≤‡∫ç‡ªÄ‡∫ä‡∫±‡∫ô‡∫ú‡∫π‡ªâ‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ</p><div class="signature-line">_________________</div></div><div class="signature-box"><p>‡∫•‡∫≤‡∫ç‡ªÄ‡∫ä‡∫±‡∫ô‡∫ú‡∫π‡ªâ‡∫≠‡∫∞‡∫ô‡∫∏‡∫°‡∫±‡∫î</p><div class="signature-line">_________________</div></div></div>' +
    '<script>' +
    'function waitForImagesToLoad() {' +
        'var images = document.querySelectorAll(".order-table-img");' +
        'if (images.length === 0) {' +
            'setTimeout(function() { window.print(); }, 500);' +
            'return;' +
        '}' +
        'var loadedCount = 0;' +
        'var totalImages = images.length;' +
        'function checkIfAllLoaded() {' +
            'loadedCount++;' +
            'if (loadedCount >= totalImages) {' +
                'setTimeout(function() { window.print(); }, 800);' +
            '}' +
        '}' +
        'for (var i = 0; i < images.length; i++) {' +
            'if (images[i].complete && images[i].naturalHeight !== 0) {' +
                'checkIfAllLoaded();' +
            '} else {' +
                'images[i].onload = checkIfAllLoaded;' +
                'images[i].onerror = checkIfAllLoaded;' +
            '}' +
        '}' +
    '}' +
    'window.onload = function() { setTimeout(waitForImagesToLoad, 300); };' +
    '<\/script></body></html>';
    
    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
    const printWindow = window.open('', '_blank');
    printWindow.document.open();
    printWindow.document.write(printContent);
    printWindow.document.close();
    
    // ‡∏£‡∏≠ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
    setTimeout(function() {
        try {
            printWindow.close();
        } catch(e) {
            console.log('Cannot close print window:', e);
        }
        
        showPrintConfirmationModal();
    }, 3000);
}
/**
 * ‡πÅ‡∏™‡∏î‡∏á Animation ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function showImageLoadingAnimation() {
    const existingOverlay = document.getElementById('imageLoadingOverlay');
    if (existingOverlay) {
        existingOverlay.remove();
    }
    
    const overlay = document.createElement('div');
    overlay.id = 'imageLoadingOverlay';
    overlay.className = 'loading-overlay show';
    
    overlay.innerHTML = '<div class="loading-content">' +
        '<div class="loading-spinner"></div>' +
        '<div class="loading-text">üñºÔ∏è ‡∫Å‡∫≥‡∫•‡∫±‡∫á‡ªÇ‡∫´‡∫º‡∫î‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö...</div>' +
        '<div id="imageLoadingProgress" class="loading-subtext">0 / 0 ‡∫Æ‡∫π‡∫ö</div>' +
        '</div>';
    
    document.body.appendChild(overlay);
}

/**
 * ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function updateImageLoadingProgress(loaded, total) {
    const progressElement = document.getElementById('imageLoadingProgress');
    if (progressElement) {
        progressElement.textContent = loaded + ' / ' + total + ' ‡∫Æ‡∫π‡∫ö';
    }
}

/**
 * ‡∏ã‡πà‡∏≠‡∏ô Animation ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function hideImageLoadingAnimation() {
    const overlay = document.getElementById('imageLoadingOverlay');
    if (overlay) {
        overlay.classList.add('fade-out');
        setTimeout(function() {
            overlay.remove();
        }, 300);
    }
}

function saveAndWhatsapp() {
    if (orderItems.length === 0) {
        alert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡∫•‡∫ª‡∫á‡ªÉ‡∫ô‡∫ï‡∫≤‡∫ï‡∫∞‡∫•‡∫≤‡∫á‡∫Å‡ªà‡∫≠‡∫ô');
        return;
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö Print)
    showColumnSelectionModalForWhatsApp();
}
/**
 * ‡πÅ‡∏™‡∏î‡∏á Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á WhatsApp
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function showColumnSelectionModalForWhatsApp() {
    const modal = document.createElement('div');
    modal.id = 'columnSelectionModalWhatsApp';
    modal.className = 'store-selector-modal show';
    
    modal.innerHTML = '<div class="store-selector-content" style="max-width: 500px;">' +
        '<div class="store-selector-header">üì± ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫Ñ‡ªç‡∫•‡ªç‡∫≤‡∫ó‡∫µ‡ªà‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫õ‡∫¥‡∫î‡∫ö‡∫±‡∫á (WhatsApp)</div>' +
        '<div style="padding: 20px;">' +
        '<p style="margin-bottom: 15px; color: #666;">‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫Ñ‡ªç‡∫•‡ªç‡∫≤‡∫ó‡∫µ‡ªà‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫á‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫™‡∫ª‡ªà‡∫á WhatsApp:</p>' +
        '<div class="column-checkbox-list">' +
        '<label class="column-checkbox-item">' +
        '<input type="checkbox" value="index"> <span>‡∫•‡∫≥‡∫î‡∫±‡∫ö</span>' +
        '</label>' +
        '<label class="column-checkbox-item">' +
        '<input type="checkbox" value="barcode"> <span>‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</span>' +
        '</label>' +
        '<label class="column-checkbox-item">' +
        '<input type="checkbox" value="image"> <span>‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö</span>' +
        '</label>' +
        '<label class="column-checkbox-item">' +
        '<input type="checkbox" value="itemName"> <span>‡∫ä‡∫∑‡ªà‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</span>' +
        '</label>' +
        '<label class="column-checkbox-item">' +
        '<input type="checkbox" value="quantity"> <span>‡∫à‡∫≥‡∫ô‡∫ß‡∫ô</span>' +
        '</label>' +
        '<label class="column-checkbox-item">' +
        '<input type="checkbox" value="price"> <span>‡∫•‡∫≤‡∫Ñ‡∫≤/‡ªú‡ªà‡∫ß‡∫ç</span>' +
        '</label>' +
        '<label class="column-checkbox-item">' +
        '<input type="checkbox" value="total"> <span>‡∫•‡∫ß‡∫°‡ªÄ‡∫á‡∫¥‡∫ô</span>' +
        '</label>' +
        '</div>' +
        '</div>' +
        '<div class="store-selector-actions">' +
        '<button class="btn-cancel-stores" onclick="closeColumnSelectionModalForWhatsApp()">‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>' +
        '<button class="btn-confirm-stores" onclick="confirmColumnSelectionForWhatsApp()">‚úÖ ‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô ‡ªÅ‡∫•‡∫∞ ‡∫™‡∫ª‡ªà‡∫á WhatsApp</button>' +
        '</div>' +
        '</div>';
    
    document.body.appendChild(modal);
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) closeColumnSelectionModalForWhatsApp();
    });
}
/**
 * ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö WhatsApp
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function closeColumnSelectionModalForWhatsApp() {
    const modal = document.getElementById('columnSelectionModalWhatsApp');
    if (modal) modal.remove();
}
/**
 * ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á Modal ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function confirmColumnSelectionForWhatsApp() {
    // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∞‡∏ã‡πà‡∏≠‡∏ô
    const checkboxes = document.querySelectorAll('#columnSelectionModalWhatsApp input[type="checkbox"]:checked');
    const hiddenColumns = [];
    
    checkboxes.forEach(function(checkbox) {
        hiddenColumns.push(checkbox.value);
    });
    
    closeColumnSelectionModalForWhatsApp();
    
    // ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô
    showWhatsAppPhoneModalWithColumns(hiddenColumns);
}
/**
 * ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö WhatsApp ‡∏û‡∏£‡πâ‡∏≠‡∏° Auto-Complete (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏° Dropdown)
 */
function showWhatsAppPhoneModalWithColumns(hiddenColumns) {
    const modal = document.createElement('div');
    modal.id = 'whatsappPhoneModal';
    modal.className = 'store-selector-modal show';
    
    modal.innerHTML = '<div class="store-selector-content" style="max-width: 450px;">' +
        '<div class="store-selector-header">üì± ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÉ‡∫™‡ªà‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö WhatsApp</div>' +
        '<div style="margin: 20px 0; position: relative;">' +
        '<div style="display: flex; gap: 10px; align-items: center;">' +
        '<div style="background: #25d366; color: white; padding: 12px 15px; border-radius: 8px; font-size: 1.1rem; font-weight: bold;">+856</div>' +
        '<input type="tel" id="whatsappPhoneInput" class="store-search-input" placeholder="‡∫û‡∫¥‡∫°‡ªÄ‡∫ö‡∫µ ‡∫´‡∫º‡∫∑ ‡∫ä‡∫∑‡ªà‡∫Æ‡ªâ‡∫≤‡∫ô..." maxlength="10" style="flex: 1; margin: 0;" autocomplete="off">' +
        '</div>' +
        '<div id="phoneDropdown" style="display: none; position: absolute; top: 100%; left: 50px; right: 0; background: white; border: 2px solid #25d366; border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 1000; margin-top: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>' +
        '<div style="margin-top: 10px; font-size: 0.9rem; color: #666;">‡∫ï‡∫ª‡∫ß‡∫¢‡ªà‡∫≤‡∫á: 2055512345 (10 ‡∫ï‡∫ª‡∫ß‡ªÄ‡∫•‡∫Å)</div>' +
        '</div>' +
        '<div class="store-selector-actions">' +
        '<button class="btn-cancel-stores" onclick="closeWhatsAppPhoneModal()">‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>' +
        '<button id="confirmWhatsAppBtn" class="btn-confirm-stores" onclick="confirmWhatsAppSendWithPDF()" disabled>‡∫™‡∫ª‡ªà‡∫á WhatsApp</button>' +
        '</div>' +
        '</div>';
    
    document.body.appendChild(modal);
    
    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ
    modal.dataset.hiddenColumns = JSON.stringify(hiddenColumns);
    
    const phoneInput = document.getElementById('whatsappPhoneInput');
    const phoneDropdown = document.getElementById('phoneDropdown');
    const confirmBtn = document.getElementById('confirmWhatsAppBtn');
    
    // Focus ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå
    setTimeout(function() {
        phoneInput.focus();
    }, 100);
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á Dropdown
    function filterAndShowDropdown() {
        const query = phoneInput.value.trim().toLowerCase();
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°
        validatePhoneNumber();
        
        if (!query) {
            phoneDropdown.style.display = 'none';
            return;
        }
        
        // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const filtered = phoneNumberList.filter(function(item) {
            const phoneMatch = item.phone.includes(query);
            const storeMatch = item.store.toLowerCase().includes(query);
            return phoneMatch || storeMatch;
        });
        
        if (filtered.length === 0) {
            phoneDropdown.style.display = 'none';
            return;
        }
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dropdown
        let dropdownHTML = '';
        filtered.forEach(function(item) {
            dropdownHTML += '<div class="phone-dropdown-item" data-phone="' + item.phone + '" style="padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background 0.2s;">' +
                '<div style="font-weight: bold; color: #333;">' + item.store + '</div>' +
                '<div style="font-size: 0.9rem; color: #666;">üìû ' + item.phone + '</div>' +
                '</div>';
        });
        
        phoneDropdown.innerHTML = dropdownHTML;
        phoneDropdown.style.display = 'block';
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        const items = phoneDropdown.querySelectorAll('.phone-dropdown-item');
        items.forEach(function(item) {
            item.addEventListener('mouseenter', function() {
                this.style.background = '#e3f2fd';
            });
            item.addEventListener('mouseleave', function() {
                this.style.background = 'white';
            });
            item.addEventListener('click', function() {
                const selectedPhone = this.dataset.phone;
                phoneInput.value = selectedPhone;
                phoneDropdown.style.display = 'none';
                validatePhoneNumber();
                phoneInput.focus();
            });
        });
    }
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Validate ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£
    function validatePhoneNumber() {
        const phone = phoneInput.value.trim();
        const isValid = /^\d{10}$/.test(phone);
        
        if (isValid) {
            confirmBtn.disabled = false;
            confirmBtn.style.opacity = '1';
            confirmBtn.style.cursor = 'pointer';
            phoneInput.style.borderColor = '#25d366';
        } else {
            confirmBtn.disabled = true;
            confirmBtn.style.opacity = '0.5';
            confirmBtn.style.cursor = 'not-allowed';
            phoneInput.style.borderColor = '#e0e0e0';
        }
    }
    
    // Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Input
    phoneInput.addEventListener('input', filterAndShowDropdown);
    
    // Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Enter
    phoneInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !confirmBtn.disabled) {
            confirmWhatsAppSendWithPDF();
        }
    });
    
    // ‡∏õ‡∏¥‡∏î Dropdown ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å Modal
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeWhatsAppPhoneModal();
        }
        if (!phoneDropdown.contains(e.target) && e.target !== phoneInput) {
            phoneDropdown.style.display = 'none';
        }
    });
}
/**
 * ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á WhatsApp ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á PDF
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function confirmWhatsAppSendWithPDF() {
    const phoneInput = document.getElementById('whatsappPhoneInput');
    const phoneNumber = phoneInput.value.trim();
    
    if (!phoneNumber) {
        alert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÉ‡∫™‡ªà‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö');
        phoneInput.focus();
        return;
    }
    
    if (!/^\d+$/.test(phoneNumber)) {
        alert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÉ‡∫™‡ªà‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö‡ªÄ‡∫õ‡∫±‡∫ô‡∫ï‡∫ª‡∫ß‡ªÄ‡∫•‡∫Å‡ªÄ‡∫ó‡∫ª‡ªà‡∫≤‡∫ô‡∫±‡ªâ‡∫ô');
        phoneInput.focus();
        return;
    }
    
    if (phoneNumber.length < 8 || phoneNumber.length > 10) {
        alert('‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö‡∫ï‡ªâ‡∫≠‡∫á‡∫°‡∫µ 8-10 ‡∫ï‡∫ª‡∫ß‡ªÄ‡∫•‡∫Å');
        phoneInput.focus();
        return;
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô
    const modal = document.getElementById('whatsappPhoneModal');
    const hiddenColumns = JSON.parse(modal.dataset.hiddenColumns || '[]');
    
    closeWhatsAppPhoneModal();
    
    const fullPhoneNumber = '856' + phoneNumber;
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ PDF ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á WhatsApp
    generatePDFAndSendWhatsApp(fullPhoneNumber, hiddenColumns);
}
/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô WhatsApp (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ pdfMake ‡πÅ‡∏ó‡∏ô)
 */
function generatePDFAndSendWhatsApp(phoneNumber, hiddenColumns) {
    const pdfWindow = window.open('', 'pdfWindow');
    
    const loadingContent = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫™‡ªâ‡∫≤‡∫á PDF...</title><style>body { font-family: "Noto Sans Lao", Arial, sans-serif; padding: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; margin: 0; }.container { background: white; border-radius: 20px; padding: 40px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 600px; }.loading-spinner { width: 80px; height: 80px; border: 6px solid #f3f3f3; border-top: 6px solid #25d366; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 30px; }@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }.loading-text { font-size: 1.5rem; font-weight: bold; color: #25d366; margin-bottom: 15px; }.loading-subtext { font-size: 1rem; color: #666; }.success-content { display: none; }.success-icon { font-size: 5rem; margin-bottom: 20px; }.success-title { font-size: 1.8rem; font-weight: bold; color: #4caf50; margin-bottom: 15px; }.pdf-info { background: #f0f0f0; padding: 15px; border-radius: 10px; margin: 20px 0; font-size: 0.95rem; color: #333; }.whatsapp-btn { display: inline-block; padding: 15px 40px; background: linear-gradient(135deg, #25d366 0%, #128c7e 100%); color: white; text-decoration: none; border-radius: 10px; font-size: 1.2rem; font-weight: bold; margin-top: 20px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4); cursor: pointer; border: none; }.whatsapp-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(37, 211, 102, 0.6); }</style></head><body><div class="container"><div id="loadingContent"><div class="loading-spinner"></div><div class="loading-text">‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫™‡ªâ‡∫≤‡∫á‡ªÑ‡∫ü‡∫•‡ªå PDF...</div><div class="loading-subtext">‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫•‡ªç‡∫ñ‡ªâ‡∫≤‡∫™‡∫±‡∫Å‡∫Ñ‡∫π‡ªà</div></div><div id="successContent" class="success-content"><div class="success-icon">‚úÖ</div><div class="success-title">‡∫™‡ªâ‡∫≤‡∫á PDF ‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î!</div><div class="pdf-info"><strong>‡∫ä‡∫∑‡ªà‡ªÑ‡∫ü‡∫•‡ªå:</strong> <span id="pdfFileName"></span><br><strong>‡∫ö‡ªà‡∫≠‡∫ô‡ªÄ‡∫Å‡∫±‡∫ö‡ªÑ‡∫ß‡ªâ:</strong> Google Drive</div><button id="whatsappBtn" class="whatsapp-btn">üì± ‡ªÄ‡∫õ‡∫µ‡∫î WhatsApp Web ‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫™‡∫ª‡ªà‡∫á‡ªÑ‡∫ü‡∫•‡ªå</button></div></div></body></html>';
    
    pdfWindow.document.open();
    pdfWindow.document.write(loadingContent);
    pdfWindow.document.close();
    
    // ‚≠ê ‡πÉ‡∏ä‡πâ pdfMake ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF
    createPDFFromTableData(hiddenColumns, function(result) {
        if (!result.success) {
            alert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫™‡ªâ‡∫≤‡∫á PDF');
            pdfWindow.close();
            return;
        }
        
        // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î PDF ‡πÑ‡∏õ Drive
        uploadPDFToDrive(result.blob, result.fileName, function(uploadResult) {
            if (uploadResult.success) {
                const loadingDiv = pdfWindow.document.getElementById('loadingContent');
                const successDiv = pdfWindow.document.getElementById('successContent');
                const fileNameSpan = pdfWindow.document.getElementById('pdfFileName');
                const whatsappBtn = pdfWindow.document.getElementById('whatsappBtn');
                
                if (loadingDiv) loadingDiv.style.display = 'none';
                if (successDiv) successDiv.style.display = 'block';
                if (fileNameSpan) fileNameSpan.textContent = uploadResult.fileName;
                
                const now = new Date();
                const dateStr = now.toLocaleDateString('lo-LA');
                const timeStr = now.toLocaleTimeString('lo-LA');
                
                const message = 'üì± ‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤\n' +
                    '‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ: ' + currentOrderNumber + '\n' +
                    '‡∫ß‡∫±‡∫ô‡∫ó‡∫µ: ' + dateStr + ' ' + timeStr + '\n\n' +
                    'üìÑ ‡ªÄ‡∫ö‡∫¥‡ªà‡∫á‡ªÑ‡∫ü‡∫•‡ªå PDF: ' + uploadResult.fileUrl;
                
                const whatsappUrl = 'https://web.whatsapp.com/send?phone=' + phoneNumber + '&text=' + encodeURIComponent(message);
                
                if (whatsappBtn) {
                    whatsappBtn.onclick = function() {
                        window.open(whatsappUrl, '_blank');
                        
                        setTimeout(function() {
                            pdfWindow.close();
                        }, 500);
                        
                        setTimeout(function() {
                            if (window.opener) {
                                window.opener.showWhatsAppConfirmationModal();
                            } else {
                                showWhatsAppConfirmationModal();
                            }
                        }, 1000);
                    };
                }
            } else {
                alert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫≠‡∫±‡∫ö‡ªÇ‡∫´‡∫º‡∫î PDF: ' + uploadResult.error);
                pdfWindow.close();
            }
        });
    });
}
/**
 * ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏™‡πà‡∏á WhatsApp
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function showWhatsAppConfirmationModal() {
    const modal = document.createElement('div');
    modal.id = 'whatsappConfirmModal';
    modal.className = 'store-selector-modal show';
    
    modal.innerHTML = '<div class="store-selector-content" style="max-width: 450px;">' +
        '<div class="store-selector-header">‚úÖ ‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô‡∫Å‡∫≤‡∫ô‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å</div>' +
        '<div style="padding: 20px; text-align: center;">' +
        '<p style="font-size: 1.1rem; margin-bottom: 20px;">‡∫™‡∫ª‡ªà‡∫á WhatsApp ‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î‡ªÅ‡∫•‡ªâ‡∫ß‡∫ö‡ªç?</p>' +
        '<p style="font-size: 0.95rem; color: #666;">‡∫Å‡∫ª‡∫î‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫•‡∫ª‡∫á‡ªÉ‡∫ô‡∫•‡∫∞‡∫ö‡∫ª‡∫ö</p>' +
        '</div>' +
        '<div class="store-selector-actions">' +
        '<button class="btn-cancel-stores" onclick="closeWhatsAppConfirmationModal()">‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>' +
        '<button class="btn-confirm-stores" onclick="confirmWhatsAppSave()">‚úÖ ‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å</button>' +
        '</div>' +
        '</div>';
    
    document.body.appendChild(modal);
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) closeWhatsAppConfirmationModal();
    });
}
/**
 * ‡∏õ‡∏¥‡∏î Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å WhatsApp
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function closeWhatsAppConfirmationModal() {
    const modal = document.getElementById('whatsappConfirmModal');
    if (modal) modal.remove();
}
/**
 * ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏™‡πà‡∏á WhatsApp
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function confirmWhatsAppSave() {
    closeWhatsAppConfirmationModal();
    
    showSavingAnimation();
    
    const isLoadedOrder = document.getElementById('currentOrderNumber').dataset.isLoaded === 'true';
    
    const orderData = {
        orderNumber: currentOrderNumber,
        items: orderItems,
        method: 'WHATSAPP',
        isUpdate: isLoadedOrder
    };
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                showSuccessAnimation();
                
                setTimeout(function() {
                    hideSavingAnimation();
                    
                    orderItems = [];
                    selectedItemsForOrder.clear();
                    updateOrderTable();
                    
                    const compareSection = document.getElementById('compareSection');
                    if (compareSection) compareSection.style.display = 'none';
                    
                    currentOrderNumber = generateOrderNumber();
                    const orderNumberElement = document.getElementById('currentOrderNumber');
                    orderNumberElement.textContent = currentOrderNumber;
                    orderNumberElement.dataset.isLoaded = 'false';
                }, 2000);
            } else {
                hideSavingAnimation();
                alert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î: ' + result.error);
            }
        })
        .withFailureHandler(function(error) {
            hideSavingAnimation();
            alert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å: ' + error.message);
        })
        .saveOrder(orderData);
}

/**
 * ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö WhatsApp
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function showWhatsAppPhoneModal() {
    const modal = document.createElement('div');
    modal.id = 'whatsappPhoneModal';
    modal.className = 'store-selector-modal show';
    
    modal.innerHTML = '<div class="store-selector-content" style="max-width: 450px;">' +
        '<div class="store-selector-header">üì± ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÉ‡∫™‡ªà‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö WhatsApp</div>' +
        '<div style="margin: 20px 0;">' +
        '<div style="display: flex; gap: 10px; align-items: center;">' +
        '<div style="background: #25d366; color: white; padding: 12px 15px; border-radius: 8px; font-size: 1.1rem; font-weight: bold;">+856</div>' +
        '<input type="tel" id="whatsappPhoneInput" class="store-search-input" placeholder="20 XXXX XXXX" maxlength="10" style="flex: 1; margin: 0;">' +
        '</div>' +
        '<div style="margin-top: 10px; font-size: 0.9rem; color: #666;">‡∫ï‡∫ª‡∫ß‡∫¢‡ªà‡∫≤‡∫á: 2055512345 (‡∫ö‡ªç‡ªà‡∫ï‡ªâ‡∫≠‡∫á‡ªÉ‡∫™‡ªà 856)</div>' +
        '</div>' +
        '<div class="store-selector-actions">' +
        '<button class="btn-cancel-stores" onclick="closeWhatsAppPhoneModal()">‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>' +
        '<button class="btn-confirm-stores" onclick="confirmWhatsAppSend()">‡∫™‡∫ª‡ªà‡∫á WhatsApp</button>' +
        '</div>' +
        '</div>';
    
    document.body.appendChild(modal);
    
    // Focus ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå
    setTimeout(function() {
        document.getElementById('whatsappPhoneInput').focus();
    }, 100);
    
    // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏î Enter
    document.getElementById('whatsappPhoneInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            confirmWhatsAppSend();
        }
    });
    
    // ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å content
    modal.addEventListener('click', function(e) {
        if (e.target === modal) closeWhatsAppPhoneModal();
    });
}
/**
 * ‡∏õ‡∏¥‡∏î Modal ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå WhatsApp
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function closeWhatsAppPhoneModal() {
    const modal = document.getElementById('whatsappPhoneModal');
    if (modal) modal.remove();
}
/**
 * ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á WhatsApp
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function confirmWhatsAppSend() {
    const phoneInput = document.getElementById('whatsappPhoneInput');
    const phoneNumber = phoneInput.value.trim();
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£
    if (!phoneNumber) {
        alert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÉ‡∫™‡ªà‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö');
        phoneInput.focus();
        return;
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    if (!/^\d+$/.test(phoneNumber)) {
        alert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÉ‡∫™‡ªà‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö‡ªÄ‡∫õ‡∫±‡∫ô‡∫ï‡∫ª‡∫ß‡ªÄ‡∫•‡∫Å‡ªÄ‡∫ó‡∫ª‡ªà‡∫≤‡∫ô‡∫±‡ªâ‡∫ô');
        phoneInput.focus();
        return;
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß (8-10 ‡∏´‡∏•‡∏±‡∏Å)
    if (phoneNumber.length < 8 || phoneNumber.length > 10) {
        alert('‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö‡∫ï‡ªâ‡∫≠‡∫á‡∫°‡∫µ 8-10 ‡∫ï‡∫ª‡∫ß‡ªÄ‡∫•‡∫Å');
        phoneInput.focus();
        return;
    }
    
    // ‡∏õ‡∏¥‡∏î Modal
    closeWhatsAppPhoneModal();
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏ï‡πá‡∏°: 856 + ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å
    const fullPhoneNumber = '856' + phoneNumber;
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    const message = generateWhatsAppMessage();
    const whatsappUrl = 'https://wa.me/' + fullPhoneNumber + '?text=' + encodeURIComponent(message);
    
    // ‡πÄ‡∏õ‡∏¥‡∏î WhatsApp
    window.open(whatsappUrl, '_blank');
    
    // ‡∏ñ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    setTimeout(function() {
        if (confirm('‡∫™‡∫ª‡ªà‡∫á WhatsApp ‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î‡ªÅ‡∫•‡ªâ‡∫ß‡∫ö‡ªç? ‡∫Å‡∫ª‡∫î‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô')) {
            saveOrderToSheet('WHATSAPP');
        }
    }, 2000);
}

    function generateWhatsAppMessage() {
        const total = orderItems.reduce(function(sum, item) {
            return sum + item.total;
        }, 0);
        const now = new Date();
        const dateStr = now.toLocaleDateString('lo-LA');
        
        let message = 'üßæ *‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤*\n';
        message += '‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ: ' + currentOrderNumber + '\n';
        message += '‡∫ß‡∫±‡∫ô‡∫ó‡∫µ: ' + dateStr + '\n\n';
        message += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
        
        orderItems.forEach(function(item, index) {
            message += (index + 1) + 'Ô∏è‚É£ ' + item.itemName + '\n';
            message += '   ‚Ä¢ ‡∫•‡∫∞‡∫´‡∫±‡∫î: ' + item.barcode + '\n';
            message += '   ‚Ä¢ ‡∫à‡∫≥‡∫ô‡∫ß‡∫ô: ' + item.quantity + ' ' + item.unit + '\n';
            message += '   ‚Ä¢ ‡∫•‡∫≤‡∫Ñ‡∫≤: ' + item.total.toLocaleString() + ' ‡∫Å‡∫µ‡∫ö\n\n';
        });
        
        message += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
        message += 'üí∞ *‡∫•‡∫ß‡∫°‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î: ' + total.toLocaleString() + ' ‡∫Å‡∫µ‡∫ö*';
        
        return message;
    }

  function saveOrderToSheet(method) {
    if (orderItems.length === 0) {
        alert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡∫•‡∫ª‡∫á‡ªÉ‡∫ô‡∫ï‡∫≤‡∫ï‡∫∞‡∫•‡∫≤‡∫á‡∫Å‡ªà‡∫≠‡∫ô');
        return;
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á Saving Animation
    showSavingAnimation();
    
    const isLoadedOrder = document.getElementById('currentOrderNumber').dataset.isLoaded === 'true';
    
    const orderData = {
        orderNumber: currentOrderNumber,
        items: orderItems,
        method: method,
        isUpdate: isLoadedOrder
    };
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                // ‡πÅ‡∏™‡∏î‡∏á Success Animation
                showSuccessAnimation();
                
                // ‡∏£‡∏≠ 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                setTimeout(function() {
                    hideSavingAnimation();
                    
                    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    orderItems = [];
                    selectedItemsForOrder.clear();
                    updateOrderTable();
                    
                    const compareSection = document.getElementById('compareSection');
                    if (compareSection) compareSection.style.display = 'none';
                    
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                    currentOrderNumber = generateOrderNumber();
                    const orderNumberElement = document.getElementById('currentOrderNumber');
                    orderNumberElement.textContent = currentOrderNumber;
                    orderNumberElement.dataset.isLoaded = 'false';
                }, 2000);
            } else {
                hideSavingAnimation();
                alert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î: ' + result.error);
            }
        })
        .withFailureHandler(function(error) {
            hideSavingAnimation();
            alert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å: ' + error.message);
        })
        .saveOrder(orderData);
}

function showLoadOrderModal() {
    // ‡πÅ‡∏™‡∏î‡∏á Loading
    showLoadingOverlay('‡∫Å‡ªç‡∫≤‡∫•‡∫±‡∫á‡ªÇ‡∫´‡∫º‡∫î‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô...', '‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫•‡ªç‡∫ñ‡ªâ‡∫≤‡∫™‡∫±‡∫Å‡∫Ñ‡∫π‡ªà');
    
    // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
    google.script.run
        .withSuccessHandler(function(orderList) {
            hideLoadingOverlay();
            
            if (!orderList || orderList.length === 0) {
                alert('‡∫ö‡ªç‡ªà‡∫°‡∫µ‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ‡ªÄ‡∫Å‡∫ª‡ªà‡∫≤');
                return;
            }
            
            displayOrderSelectionModal(orderList);
        })
        .withFailureHandler(function(error) {
            hideLoadingOverlay();
            alert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î: ' + error.message);
        })
        .getOrderList();
}

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        if (lowStockModal && lowStockModal.classList.contains('show')) {
            closeLowStockModal();
        }
        
        const storeModal = document.getElementById('storeSelectorModal');
        if (storeModal) {
            closeStoreSelectorModal();
        }
    }
});

    /**
 * ========================================
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà - Copy ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô window.onload
 * ========================================
 */

/**
 * ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
 */
function setDataMode(mode) {
    currentDataMode = mode;
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó UI ‡∏õ‡∏∏‡πà‡∏°
    document.querySelectorAll('.data-mode-btn').forEach(function(btn) {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    selectedItemsForOrder.clear();
    
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
    if (mode === 'lowStock') {
        checkLowStockAndShowAlert();
    } else {
        loadAllItemsData();
    }
    
    // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä view
    if (currentSearchMode === 'zone') {
        displayZoneView();
    } else {
        document.getElementById('lowStockContent').innerHTML = '<p style="text-align: center; color: #999;">‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫õ‡ªâ‡∫≠‡∫ô‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤</p>';
        document.getElementById('searchInput').value = '';
    }
}

/**
 * ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç)
 */
function loadAllItemsData() {
    if (!itemsData || itemsData.size === 0) return;
    
    const allItems = [];
    
    itemsData.forEach(function(item) {
        const stockRemaining = parseFloat(item.columnF) || 0;
        const reorderPoint = parseFloat(item.columnD) || 0;
        
        // ‡∏î‡∏∂‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
        allItems.push({
            barcode: item.columnA || '',
            barcodeBox: item.columnJ || item.columnA || '',
            itemName: item.columnB || '‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫ä‡∫∑‡ªà',
            reorderPoint: reorderPoint,
            stockRemaining: stockRemaining,
            unit: item.columnH || '‡∫ä‡∫¥‡ªâ‡∫ô',
            quantityPerUnit: parseFloat(item.columnI) || 1,
            image: item.columnK || '',
            zone: item.columnM || '‡∫ö‡ªç‡ªà‡∫•‡∫∞‡∫ö‡∫∏‡ªÇ‡∫ä‡∫ô',
            price: parseFloat(item.columnN) || 0
        });
    });
    
    allItemsDataCache = groupItemsByZone(allItems);
}

/**
 * ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡πÇ‡∏ã‡∏ô
 */
function groupItemsByZone(items) {
    const grouped = {};
    
    items.forEach(function(item) {
        const zone = item.zone;
        const barcodeBox = item.barcodeBox || item.barcode;
        
        if (!grouped[zone]) {
            grouped[zone] = { zoneName: zone, products: {} };
        }
        
        if (!grouped[zone].products[barcodeBox]) {
            grouped[zone].products[barcodeBox] = {
                barcodeBox: barcodeBox,
                reorderPoint: item.reorderPoint,
                stockRemaining: item.stockRemaining,
                items: []
            };
        }
        
        grouped[zone].products[barcodeBox].items.push(item);
    });
    
    return grouped;
}

/**
 * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢
 */
function calculateQuantityWithUnit(value, quantityPerUnit, unit) {
    if (!value || !quantityPerUnit || quantityPerUnit === 0) {
        return '0 ' + unit;
    }
    
    const result = value / quantityPerUnit;
    const formatted = result % 1 === 0 ? result.toFixed(0) : result.toFixed(2);
    
    return formatted + ' ' + unit;
}

/**
 * ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°
 */
function displaySearchResultsGrouped(results) {
    const content = document.getElementById('lowStockContent');
    
    if (results.length === 0) {
        content.innerHTML = '<p style="text-align: center; color: #999;">‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô</p>';
        return;
    }
    
    // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏° barcodeBox
    const grouped = {};
    results.forEach(function(item) {
        const key = item.barcodeBox;
        if (!grouped[key]) {
            grouped[key] = [];
        }
        grouped[key].push(item);
    });
    
    let html = '<div class="search-results">';
    const colors = ['color-1', 'color-2', 'color-3', 'color-4', 'color-5', 'color-6'];
    
    Object.keys(grouped).forEach(function(barcodeBox, groupIndex) {
        const group = grouped[barcodeBox];
        
        html += '<div class="product-group">';
        html += '<div class="product-group-header">';
        html += '<strong>üì¶ ‡∫•‡∫∞‡∫´‡∫±‡∫î‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡ªÇ‡∫ç‡∫á: ' + barcodeBox + '</strong>';
        html += '</div>';
        
        group.forEach(function(item, itemIndex) {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            const isInOrder = orderItems.some(function(orderItem) {
                return orderItem.barcode === item.barcode;
            });
            
            // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á
            if (isInOrder) return;
            
            const isSelected = selectedItemsForOrder.has(item.barcode);
            const quantity = isSelected ? getItemQuantityFromOrder(item.barcode) : 1;
            const colorClass = colors[itemIndex % colors.length];
            
            const stockDisplay = calculateQuantityWithUnit(item.stockRemaining, item.quantityPerUnit, item.unit);
            const reorderDisplay = calculateQuantityWithUnit(item.reorderPoint, item.quantityPerUnit, item.unit);
            
            html += '<div class="selectable-item ' + colorClass + ' ' + (isSelected ? 'selected' : '') + '" data-barcode="' + item.barcode + '" onclick="handleItemCardClick(event, \'' + item.barcode + '\')">';
            html += '<input type="checkbox" class="item-checkbox" ' + (isSelected ? 'checked' : '') + ' onclick="event.stopPropagation(); toggleItemSelection(\'' + item.barcode + '\')">';
            
            if (item.image) {
                html += '<img src="' + item.image + '" class="item-image-small">';
            } else {
                html += '<div class="no-product-image">üì∑</div>';
            }
            
            html += '<div class="item-info-block">';
            html += '<div class="item-name-large">' + item.itemName + ' - ‡∫´‡∫ª‡∫ß‡ªú‡ªà‡∫ß‡∫ç: ' + item.unit + '</div>';
            html += '<div class="item-details-extended">';
            html += '‡∫•‡∫∞‡∫´‡∫±‡∫î: ' + item.barcode + ' | ‡ªÇ‡∫ä‡∫ô: ' + item.zone + '<br>';
            html += '‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡∫Ñ‡∫ª‡∫á‡ªÄ‡∫´‡∫º‡∫∑‡∫≠: ' + stockDisplay + ' | ';
            html += '‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡ªÅ‡∫à‡ªâ‡∫á‡ªÄ‡∫ï‡∫∑‡∫≠‡∫ô: ' + reorderDisplay;
            html += '</div>';
            html += '</div>';
            
            html += '<div class="item-quantity-container">';
            html += '<span class="quantity-label">‡∫à‡∫≥‡∫ô‡∫ß‡∫ô:</span>';
            html += '<input type="number" class="quantity-input" value="' + quantity + '" min="1" onclick="event.stopPropagation()" onchange="updateItemQuantity(\'' + item.barcode + '\', this.value)">';
            html += '</div>';
            html += '</div>';
        });
        
        html += '</div>';
    });
    
    html += '</div>';
    content.innerHTML = html;
}
/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÇ‡∏ã‡∏ô (‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á)
 */
function generateZoneDetailsHTMLEnhanced(zoneData) {
    let html = '';
    let itemNumber = 1;
    const colors = ['color-1', 'color-2', 'color-3', 'color-4', 'color-5', 'color-6'];

    Object.entries(zoneData.products).forEach(function(entry) {
        const barcodeBox = entry[0];
        const productGroup = entry[1];
        
        html += '<div class="product-group">';
        html += '<div class="product-group-header">';
        html += '<strong>' + itemNumber + '. ‡∫•‡∫∞‡∫´‡∫±‡∫î‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡ªÇ‡∫ç‡∫á: ' + barcodeBox + '</strong>';
        html += '</div>';

        productGroup.items.forEach(function(item, index) {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            const isInOrder = orderItems.some(function(orderItem) {
                return orderItem.barcode === item.barcode;
            });
            
            // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á
            if (isInOrder) return;
            
            const isSelected = selectedItemsForOrder.has(item.barcode);
            const orderQty = isSelected ? getItemQuantityFromOrder(item.barcode) : 1;
            const colorClass = colors[index % colors.length];
            
            const stockDisplay = calculateQuantityWithUnit(item.stockRemaining, item.quantityPerUnit, item.unit);
            const reorderDisplay = calculateQuantityWithUnit(item.reorderPoint, item.quantityPerUnit, item.unit);

            html += '<div class="product-item selectable-item ' + colorClass + ' ' + (isSelected ? 'selected' : '') + '" data-barcode="' + item.barcode + '" onclick="event.stopPropagation()">';
            html += '<input type="checkbox" class="item-checkbox" ' + (isSelected ? 'checked' : '') + ' onclick="event.stopPropagation(); toggleItemSelection(\'' + item.barcode + '\')">';
            
            if (item.image) {
                html += '<img src="' + item.image + '" class="product-image">';
            } else {
                html += '<div class="no-product-image">üì∑</div>';
            }
            
            html += '<div class="product-info">';
            html += '<div class="product-name">' + item.itemName + ' - ‡∫´‡∫ª‡∫ß‡ªú‡ªà‡∫ß‡∫ç: ' + item.unit + '</div>';
            html += '<div class="product-details">‡∫•‡∫∞‡∫´‡∫±‡∫î: ' + item.barcode + '</div>';
            html += '<div class="product-stock-detail">';
            html += '‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡∫Ñ‡∫ª‡∫á‡ªÄ‡∫´‡∫º‡∫∑‡∫≠: ' + stockDisplay + ' | ';
            html += '‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡ªÅ‡∫à‡ªâ‡∫á‡ªÄ‡∫ï‡∫∑‡∫≠‡∫ô: ' + reorderDisplay;
            html += '</div>';
            html += '</div>';
            
            html += '<div class="item-quantity-container">';
            html += '<span class="quantity-label">‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ:</span>';
            html += '<input type="number" class="quantity-input" value="' + orderQty + '" min="1" onclick="event.stopPropagation()" onchange="updateItemQuantity(\'' + item.barcode + '\', this.value)">';
            html += '</div>';
            html += '</div>';
        });

        html += '</div>';
        itemNumber++;
    });

    return html;
}
/**
 * ‡πÅ‡∏™‡∏î‡∏á Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Dropdown ‡πÅ‡∏ö‡∏ö Autocomplete)
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
/**
 * ‡πÅ‡∏™‡∏î‡∏á Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
 */
function displayOrderSelectionModal(orderList) {
    const modal = document.createElement('div');
    modal.id = 'orderSelectionModal';
    modal.className = 'store-selector-modal show';
    
    let optionsHTML = '';
    orderList.forEach(function(order) {
        optionsHTML += '<div class="order-option-item" data-order="' + order.orderNumber + '" onclick="selectOrderFromList(\'' + order.orderNumber + '\')">' +
            '<div class="order-display-text">' + order.date + ' - ' + order.orderNumber + '</div>' +
            '<div class="order-item-count">' + order.itemCount + ' ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô</div>' +
            '</div>';
    });
    
    modal.innerHTML = '<div class="store-selector-content">' +
        '<div class="store-selector-header">üîÑ ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ‡ªÄ‡∫Å‡∫ª‡ªà‡∫≤</div>' +
        '<input type="text" id="orderSearchInput" class="store-search-input" placeholder="‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ ‡∫´‡∫º‡∫∑ ‡∫ß‡∫±‡∫ô‡∫ó‡∫µ..." onkeyup="filterOrderList()">' +
        '<div class="store-list" id="orderListContainer">' + optionsHTML + '</div>' +
        '<div class="store-selector-actions">' +
        '<button class="btn-cancel-stores" onclick="closeOrderSelectionModal()">‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>' +
        '</div>' +
        '</div>';
    
    document.body.appendChild(modal);
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) closeOrderSelectionModal();
    });
}

/**
 * ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function filterOrderList() {
    const input = document.getElementById('orderSearchInput');
    const filter = input.value.toLowerCase();
    const container = document.getElementById('orderListContainer');
    const items = container.getElementsByClassName('order-option-item');
    
    for (let i = 0; i < items.length; i++) {
        const text = items[i].textContent || items[i].innerText;
        if (text.toLowerCase().indexOf(filter) > -1) {
            items[i].style.display = '';
        } else {
            items[i].style.display = 'none';
        }
    }
}
/**
 * ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */

/**
 * ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö alert ‡∏≠‡∏≠‡∏Å)
 */
function selectOrderFromList(orderNumber) {
    closeOrderSelectionModal();
    
    // ‡πÅ‡∏™‡∏î‡∏á Loading
    showLoadingOverlay('‡∫Å‡ªç‡∫≤‡∫•‡∫±‡∫á‡∫î‡∫∂‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô...', '‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫•‡ªç‡∫ñ‡ªâ‡∫≤‡∫™‡∫±‡∫Å‡∫Ñ‡∫π‡ªà');
    
    google.script.run
        .withSuccessHandler(function(result) {
            hideLoadingOverlay();
            
            if (result.success && result.items.length > 0) {
                // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
                orderItems = [];
                selectedItemsForOrder.clear();
                
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                orderItems = result.items;
                
                result.items.forEach(function(item) {
                    selectedItemsForOrder.add(item.barcode);
                });
                
                // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡∏¥‡∏°
                currentOrderNumber = orderNumber;
                const orderNumberElement = document.getElementById('currentOrderNumber');
                orderNumberElement.textContent = currentOrderNumber;
                orderNumberElement.dataset.isLoaded = 'true'; // ‡∏ï‡∏±‡πâ‡∏á flag ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏Å‡πà‡∏≤
                
                updateOrderTable();
                // ‡∏•‡∏ö alert ‡∏≠‡∏≠‡∏Å - ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏•‡∏¢
            } else {
                alert('‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ‡∫ô‡∫µ‡ªâ');
            }
        })
        .withFailureHandler(function(error) {
            hideLoadingOverlay();
            alert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î: ' + error.message);
        })
        .loadOrder(orderNumber);
}
/**
 * ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function closeOrderSelectionModal() {
    const modal = document.getElementById('orderSelectionModal');
    if (modal) modal.remove();
}

/**
 * ‡πÅ‡∏™‡∏î‡∏á Loading Overlay
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function showLoadingOverlay(mainText, subText) {
    // ‡∏•‡∏ö overlay ‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    const existingOverlay = document.getElementById('loadingOverlay');
    if (existingOverlay) {
        existingOverlay.remove();
    }
    
    const overlay = document.createElement('div');
    overlay.id = 'loadingOverlay';
    overlay.className = 'loading-overlay show';
    
    overlay.innerHTML = '<div class="loading-content">' +
        '<div class="loading-spinner"></div>' +
        '<div class="loading-text">' + mainText + '</div>' +
        '<div class="loading-subtext">' + subText + '</div>' +
        '</div>';
    
    document.body.appendChild(overlay);
}
/**
 * ‡∏ã‡πà‡∏≠‡∏ô Loading Overlay
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function hideLoadingOverlay() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.remove();
    }
}
/**
 * ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏•‡∏±‡∏á Print
 */
function showPrintConfirmationModal() {
    const modal = document.createElement('div');
    modal.id = 'printConfirmModal';
    modal.className = 'store-selector-modal show';
    
    modal.innerHTML = '<div class="store-selector-content" style="max-width: 450px;">' +
        '<div class="store-selector-header">‚úÖ ‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô‡∫Å‡∫≤‡∫ô‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å</div>' +
        '<div style="padding: 20px; text-align: center;">' +
        '<p style="font-size: 1.1rem; margin-bottom: 20px;">‡∫õ‡∫∂‡∫°‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î‡ªÅ‡∫•‡ªâ‡∫ß‡∫ö‡ªç?</p>' +
        '<p style="font-size: 0.95rem; color: #666;">‡∫Å‡∫ª‡∫î‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫•‡∫ª‡∫á‡ªÉ‡∫ô‡∫•‡∫∞‡∫ö‡∫ª‡∫ö</p>' +
        '</div>' +
        '<div class="store-selector-actions">' +
        '<button class="btn-cancel-stores" onclick="closePrintConfirmationModal()">‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>' +
        '<button class="btn-confirm-stores" onclick="confirmPrintSave()">‚úÖ ‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å</button>' +
        '</div>' +
        '</div>';
    
    document.body.appendChild(modal);
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) closePrintConfirmationModal();
    });
}

/**
 * ‡∏õ‡∏¥‡∏î Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
 */
function closePrintConfirmationModal() {
    const modal = document.getElementById('printConfirmModal');
    if (modal) modal.remove();
}
/**
 * ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ Progress Steps
 */
function confirmPrintSave() {
    closePrintConfirmationModal();
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ã‡∏∑‡πâ‡∏≠
    if (decisionTableVisible && selectedStoresForDecision.length > 0) {
        alert('‚ö†Ô∏è ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫•‡ªâ‡∫≤‡∫á‡∫ï‡∫≤‡∫ï‡∫∞‡∫•‡∫≤‡∫á‡∫Å‡ªà‡∫≠‡∫ô‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å\n\n‡∫Å‡∫ª‡∫î‡∫õ‡∫∏‡ªà‡∫° "üóëÔ∏è ‡∫•‡ªâ‡∫≤‡∫á‡∫ï‡∫≤‡∫ï‡∫∞‡∫•‡∫≤‡∫á" ‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫•‡ªâ‡∫≤‡∫á‡∫Ñ‡ªç‡∫•‡ªç‡∫≤‡∫Æ‡ªâ‡∫≤‡∫ô\n‡∫´‡∫º‡∫∑ ‡∫Å‡∫ª‡∫î‡∫õ‡∫∏‡ªà‡∫° "üîÑ ‡∫î‡∫∂‡∫á‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ‡ªÄ‡∫Å‡∫ª‡ªà‡∫≤" ‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡ªÉ‡ªù‡ªà');
        return;
    }
    
    showProgressSteps();
    
    const isLoadedOrder = document.getElementById('currentOrderNumber').dataset.isLoaded === 'true';
    const hiddenColumns = JSON.parse(sessionStorage.getItem('printHiddenColumns') || '[]');
    
    // ‚≠ê Step 1: ‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫î‡∫∂‡∫á‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö
    updateProgressStep(1, 'active');
    updateProgressStatus('‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫î‡∫∂‡∫á‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö...');
    
    createPDFFromTableData(hiddenColumns, function(result) {
        if (!result.success) {
            hideProgressSteps();
            alert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫™‡ªâ‡∫≤‡∫á PDF');
            return;
        }
        
        // ‚≠ê Step 1: ‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î
        updateProgressStep(1, 'completed');
        updateProgressLine(33);
        
        // ‚≠ê Step 2: ‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫≠‡∫±‡∫ö‡ªÇ‡∫´‡∫º‡∫î PDF
        updateProgressStep(2, 'active');
        updateProgressStatus('‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫≠‡∫±‡∫ö‡ªÇ‡∫´‡∫º‡∫î PDF...');
        
        uploadPDFToDrive(result.blob, result.fileName, function(uploadResult) {
            if (uploadResult.success) {
                // ‚≠ê Step 2: ‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î
                updateProgressStep(2, 'completed');
                updateProgressLine(66);
                
                // ‚≠ê Step 3: ‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫ª‡∫á Sheet
                updateProgressStep(3, 'active');
                updateProgressStatus('‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫ª‡∫á Sheet...');
                
                const orderData = {
                    orderNumber: currentOrderNumber,
                    items: orderItems,
                    method: 'PRINT',
                    isUpdate: isLoadedOrder
                };
                
                google.script.run
                    .withSuccessHandler(function(saveResult) {
                        if (saveResult.success) {
                            // ‚≠ê Step 3: ‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î
                            updateProgressStep(3, 'completed');
                            updateProgressLine(100);
                            
                            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                            showProgressSuccess();
                            
                            setTimeout(function() {
                                hideProgressSteps();
                                
                                orderItems = [];
                                selectedItemsForOrder.clear();
                                updateOrderTable();
                                
                                const compareSection = document.getElementById('compareSection');
                                if (compareSection) compareSection.style.display = 'none';
                                
                                currentOrderNumber = generateOrderNumber();
                                const orderNumberElement = document.getElementById('currentOrderNumber');
                                orderNumberElement.textContent = currentOrderNumber;
                                orderNumberElement.dataset.isLoaded = 'false';
                                
                                sessionStorage.removeItem('printHiddenColumns');
                            }, 2000);
                        } else {
                            hideProgressSteps();
                            alert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å: ' + saveResult.error);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideProgressSteps();
                        alert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å: ' + error.message);
                    })
                    .saveOrder(orderData);
            } else {
                hideProgressSteps();
                alert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫≠‡∫±‡∫ö‡ªÇ‡∫´‡∫º‡∫î PDF: ' + uploadResult.error);
            }
        });
    });
}


/**
 * ‡∏ã‡πà‡∏≠‡∏ô Animation ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function hideSavingAnimation() {
    const overlay = document.getElementById('savingAnimationOverlay');
    if (overlay) {
        overlay.classList.add('fade-out');
        setTimeout(function() {
            overlay.remove();
        }, 300);
    }
}
/**
 * ‡πÅ‡∏™‡∏î‡∏á Animation ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function showSuccessAnimation() {
    const statusText = document.getElementById('savingStatusText');
    const spinner = document.querySelector('.saving-spinner');
    
    if (statusText) {
        statusText.innerHTML = '‚úÖ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î!';
        statusText.style.color = '#4caf50';
    }
    
    if (spinner) {
        spinner.innerHTML = '<div class="success-checkmark">‚úì</div>';
        spinner.style.border = 'none';
        spinner.style.animation = 'none';
    }
}
/**
 * ‡πÅ‡∏™‡∏î‡∏á Animation ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function showSavingAnimation() {
    const existingOverlay = document.getElementById('savingAnimationOverlay');
    if (existingOverlay) {
        existingOverlay.remove();
    }
    
    const overlay = document.createElement('div');
    overlay.id = 'savingAnimationOverlay';
    overlay.className = 'loading-overlay show';
    
    overlay.innerHTML = '<div class="saving-animation-content">' +
        '<div class="saving-spinner"></div>' +
        '<div id="savingStatusText" class="saving-text">‡∫Å‡ªç‡∫≤‡∫•‡∫±‡∫á‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô...</div>' +
        '<div class="saving-subtext">‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫•‡ªç‡∫ñ‡ªâ‡∫≤‡∫™‡∫±‡∫Å‡∫Ñ‡∫π‡ªà</div>' +
        '</div>';
    
    document.body.appendChild(overlay);
}
/**
 * ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ Backend ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ CORS)
 */
function createPDFFromTableData(hiddenColumns, callback) {
    console.log('üöÄ Starting PDF creation...');
    console.log('üìä Order items:', orderItems.length);
    console.log('üîí Hidden columns:', hiddenColumns);
    
    const now = new Date();
    const dateStr = now.toLocaleDateString('lo-LA');
    const timeStr = now.toLocaleTimeString('lo-LA');
    const total = orderItems.reduce(function(sum, item) {
        return sum + (item.total || 0);
    }, 0);
    
    // ‚≠ê ‡∏î‡∏∂‡∏á URL ‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å Cache
    const imageUrls = [];
    
    orderItems.forEach(function(item) {
        const barcode = item.barcode.toString().trim();
        const cachedUrl = itemsImageUrlCache.get(barcode);
        
        if (cachedUrl) {
            imageUrls.push(cachedUrl);
        } else {
            imageUrls.push(null);
        }
    });
    
    console.log('üì∏ Converting ' + imageUrls.length + ' images via Backend...');
    
    const statusText = document.getElementById('savingStatusText');
    if (statusText) {
        statusText.textContent = '‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫î‡∫∂‡∫á‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö...';
    }
    
    // ‚≠ê ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Backend ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ
    google.script.run
        .withSuccessHandler(function(base64Images) {
            console.log('‚úÖ Images converted:', base64Images.length);
            
            if (statusText) {
                statusText.textContent = '‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫™‡ªâ‡∫≤‡∫á PDF...';
            }
            
            setTimeout(function() {
                buildPDFWithImages(base64Images);
            }, 300);
        })
        .withFailureHandler(function(error) {
            console.error('‚ùå Error converting images:', error);
            
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î Error ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ
            const emptyImages = imageUrls.map(function() { return null; });
            
            if (statusText) {
                statusText.textContent = '‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫™‡ªâ‡∫≤‡∫á PDF (‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Æ‡∫π‡∫ö)...';
            }
            
            setTimeout(function() {
                buildPDFWithImages(emptyImages);
            }, 300);
        })
        .convertThumbnailUrlsToBase64(imageUrls);
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á PDF
    function buildPDFWithImages(base64Images) {
        console.log('üé® Building PDF...');
        
        const tableHeaders = [];
        
        if (!hiddenColumns.includes('index')) {
            tableHeaders.push({ 
                text: '‡∫•‡∫≥‡∫î‡∫±‡∫ö', 
                style: 'tableHeader', 
                alignment: 'center',
                margin: [0, 8, 0, 8]
            });
        }
        if (!hiddenColumns.includes('barcode')) {
            tableHeaders.push({ 
                text: '‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤', 
                style: 'tableHeader', 
                alignment: 'center',
                margin: [0, 8, 0, 8]
            });
        }
        if (!hiddenColumns.includes('image')) {
            tableHeaders.push({ 
                text: '‡∫Æ‡∫π‡∫ö', 
                style: 'tableHeader', 
                alignment: 'center',
                margin: [0, 8, 0, 8]
            });
        }
        if (!hiddenColumns.includes('itemName')) {
            tableHeaders.push({ 
                text: '‡∫ä‡∫∑‡ªà‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤', 
                style: 'tableHeader', 
                alignment: 'center',
                margin: [0, 8, 0, 8]
            });
        }
        if (!hiddenColumns.includes('quantity')) {
            tableHeaders.push({ 
                text: '‡∫à‡∫≥‡∫ô‡∫ß‡∫ô', 
                style: 'tableHeader', 
                alignment: 'center',
                margin: [0, 8, 0, 8]
            });
        }
        if (!hiddenColumns.includes('price')) {
            tableHeaders.push({ 
                text: '‡∫•‡∫≤‡∫Ñ‡∫≤/‡ªú‡ªà‡∫ß‡∫ç', 
                style: 'tableHeader', 
                alignment: 'center',
                margin: [0, 8, 0, 8]
            });
        }
        if (!hiddenColumns.includes('total')) {
            tableHeaders.push({ 
                text: '‡∫•‡∫ß‡∫°‡ªÄ‡∫á‡∫¥‡∫ô', 
                style: 'tableHeader', 
                alignment: 'center',
                margin: [0, 8, 0, 8]
            });
        }
        
        if (tableHeaders.length === 0) {
            callback({ success: false, error: '‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫¢‡ªà‡∫≤‡∫á‡ªú‡ªâ‡∫≠‡∫ç 1 ‡∫Ñ‡ªç‡∫•‡ªç‡∫≤' });
            return;
        }
        
        const tableBody = [tableHeaders];
        
        orderItems.forEach(function(item, index) {
            const row = [];
            
            if (!hiddenColumns.includes('index')) {
                row.push({ 
                    text: (index + 1).toString(), 
                    alignment: 'center',
                    bold: true,
                    color: '#000000',
                    fontSize: 12,
                    margin: [0, 8, 0, 8]  // ‚≠ê ‡∏•‡∏î‡∏à‡∏≤‡∏Å 12 ‡πÄ‡∏õ‡πá‡∏ô 8
                });
            }
            
            if (!hiddenColumns.includes('barcode')) {
                row.push({ 
                    text: (item.barcode || '-').toString(),
                    alignment: 'center',
                    bold: true,
                    color: '#000000',
                    fontSize: 12,
                    margin: [0, 12, 0, 12]
                });
            }
            
            if (!hiddenColumns.includes('image')) {
                const base64Image = base64Images[index];
                
                if (base64Image && typeof base64Image === 'string' && base64Image.trim() !== '') {
                  row.push({ 
    image: base64Image, 
    width: 60,        // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 50 ‡πÄ‡∏õ‡πá‡∏ô 60
    height: 60,       // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 50 ‡πÄ‡∏õ‡πá‡∏ô 60
    alignment: 'center',
    margin: [0, 2, 0, 2],  // ‚≠ê ‡∏•‡∏î margin
    fit: [60, 60]     // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° fit ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°
});
                } else {
                    row.push({ 
                        text: 'üì∑', 
                        alignment: 'center', 
                        fontSize: 20,
                        color: '#666666',
                        margin: [0, 12, 0, 12]
                    });
                }
            }
            
            if (!hiddenColumns.includes('itemName')) {
                row.push({ 
                    text: (item.itemName || '‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫ä‡∫∑‡ªà').toString(),
                    alignment: 'center',
                    bold: true,
                    color: '#000000',
                    fontSize: 12,
                    margin: [0, 12, 0, 12]
                });
            }
            
            if (!hiddenColumns.includes('quantity')) {
                const qty = (item.quantity || 0).toString();
                const unit = (item.unit || '‡∫ä‡∫¥‡ªâ‡∫ô').toString();
                row.push({ 
                    text: qty + ' ' + unit,
                    alignment: 'center',
                    bold: true,
                    color: '#000000',
                    fontSize: 12,
                    margin: [0, 12, 0, 12]
                });
            }
            
            if (!hiddenColumns.includes('price')) {
                const price = parseFloat(item.price) || 0;
                row.push({ 
                    text: price.toLocaleString(),
                    alignment: 'center',
                    bold: true,
                    color: '#000000',
                    fontSize: 12,
                    margin: [0, 12, 0, 12]
                });
            }
            
            if (!hiddenColumns.includes('total')) {
                const itemTotal = parseFloat(item.total) || 0;
                row.push({ 
                    text: itemTotal.toLocaleString(),
                    alignment: 'center',
                    bold: true,
                    color: '#000000',
                    fontSize: 12,
                    margin: [0, 12, 0, 12]
                });
            }
            
            if (row.length === tableHeaders.length) {
                tableBody.push(row);
            }
        });
        
        const totalRow = [];
        const colSpan = tableHeaders.length - 1;
        
        if (colSpan > 0) {
            totalRow.push({ 
                text: '‡∫•‡∫ß‡∫°‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î:', 
                colSpan: colSpan, 
                alignment: 'center', 
                bold: true, 
                fillColor: '#e8f5e9',
                color: '#000000',
                fontSize: 13,
                margin: [0, 10, 0, 10]
            });
            
            for (let i = 1; i < colSpan; i++) {
                totalRow.push({});
            }
            
            if (!hiddenColumns.includes('total')) {
                totalRow.push({ 
                    text: total.toLocaleString() + ' ‡∫Å‡∫µ‡∫ö',
                    alignment: 'center', 
                    bold: true, 
                    fillColor: '#e8f5e9',
                    color: '#000000',
                    fontSize: 13,
                    margin: [0, 10, 0, 10]
                });
            } else {
                totalRow.push({});
            }
            
            tableBody.push(totalRow);
        }
        
        const colWidths = [];
        if (!hiddenColumns.includes('index')) colWidths.push(37);
        if (!hiddenColumns.includes('barcode')) colWidths.push(90);
        if (!hiddenColumns.includes('image')) colWidths.push(63);
        if (!hiddenColumns.includes('itemName')) colWidths.push('*');
        if (!hiddenColumns.includes('quantity')) colWidths.push(70);
        if (!hiddenColumns.includes('price')) colWidths.push(85);
        if (!hiddenColumns.includes('total')) colWidths.push(85);
        
       const docDefinition = {
    pageSize: 'A4',
    pageOrientation: 'portrait',
    pageMargins: [25, 55, 25, 55],
    content: [
        { text: '‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤', alignment: 'center', bold: true, fontSize: 22, color: '#2e7d32' },
        { text: '\n' },
        { text: '‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ: ' + currentOrderNumber, bold: true, fontSize: 13, color: '#000000', margin: [0, 3] },
        { text: '‡∫ß‡∫±‡∫ô‡∫ó‡∫µ: ' + dateStr + ' ' + timeStr, bold: true, fontSize: 13, color: '#000000', margin: [0, 3] },
        { text: '\n' },
        {
            table: {
                headerRows: 1,
                widths: colWidths,
                body: tableBody,
                dontBreakRows: false,  // ‚≠ê ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡πà‡∏á‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤
                keepWithHeaderRows: 1  // ‚≠ê ‡∏£‡∏±‡∏Å‡∏©‡∏≤ header ‡πÑ‡∏ß‡πâ‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤
            },
            layout: {
                fillColor: function (rowIndex) {
                    return (rowIndex === 0) ? '#66bb6a' : ((rowIndex % 2 === 0) ? '#fafafa' : null);
                },
                hLineWidth: function() { return 1.2; },
                vLineWidth: function() { return 1.2; },
                hLineColor: function() { return '#bdbdbd'; },
                vLineColor: function() { return '#bdbdbd'; },
                paddingLeft: function() { return 6; },
                paddingRight: function() { return 6; },
                paddingTop: function() { return 8; },      // ‚≠ê ‡∏•‡∏î‡∏à‡∏≤‡∏Å 10 ‡πÄ‡∏õ‡πá‡∏ô 8
                paddingBottom: function() { return 8; }    // ‚≠ê ‡∏•‡∏î‡∏à‡∏≤‡∏Å 10 ‡πÄ‡∏õ‡πá‡∏ô 8
            }
        },
        { text: '\n\n' },
        {
            columns: [
                { text: '‡∫•‡∫≤‡∫ç‡ªÄ‡∫ä‡∫±‡∫ô‡∫ú‡∫π‡ªâ‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ\n\n_________________', alignment: 'center', width: '50%', bold: true, fontSize: 12, color: '#000000' },
                { text: '‡∫•‡∫≤‡∫ç‡ªÄ‡∫ä‡∫±‡∫ô‡∫ú‡∫π‡ªâ‡∫≠‡∫∞‡∫ô‡∫∏‡∫°‡∫±‡∫î\n\n_________________', alignment: 'center', width: '50%', bold: true, fontSize: 12, color: '#000000' }
            ]
        }
    ],
    styles: {
        tableHeader: { bold: true, fontSize: 13, color: '#ffffff', fillColor: '#66bb6a' }
    },
    defaultStyle: {
        font: 'NotoSansLao',
        fontSize: 11,
        color: '#000000',
        lineHeight: 1.2  // ‚≠ê ‡∏•‡∏î‡∏à‡∏≤‡∏Å 1.3 ‡πÄ‡∏õ‡πá‡∏ô 1.2
    }
};
        
        try {
            const pdfDocGenerator = pdfMake.createPdf(docDefinition);
            pdfDocGenerator.getBlob(function(blob) {
                const fileName = '‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ_' + currentOrderNumber + '_' + new Date().getTime() + '.pdf';
                console.log('‚úÖ PDF created:', fileName);
                callback({ success: true, blob: blob, fileName: fileName });
            });
        } catch (error) {
            console.error('‚ùå PDF Error:', error);
            callback({ success: false, error: error.toString() });
        }
    }
}

/**
 * ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î PDF Blob ‡πÑ‡∏õ Google Drive
 */
function uploadPDFToDrive(pdfBlob, fileName, callback) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const base64Data = e.target.result.split(',')[1];
        
        google.script.run
            .withSuccessHandler(callback)
            .withFailureHandler(function(error) {
                callback({ success: false, error: error.message });
            })
            .uploadPDFBase64(base64Data, fileName);
    };
    reader.readAsDataURL(pdfBlob);
}
/**
 * ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function showDownloadOrderModal() {
    // ‡πÅ‡∏™‡∏î‡∏á Loading
    showLoadingOverlay('‡∫Å‡ªç‡∫≤‡∫•‡∫±‡∫á‡ªÇ‡∫´‡∫º‡∫î‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô...', '‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫•‡ªç‡∫ñ‡ªâ‡∫≤‡∫™‡∫±‡∫Å‡∫Ñ‡∫π‡ªà');
    
    // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
    google.script.run
        .withSuccessHandler(function(orderList) {
            hideLoadingOverlay();
            
            if (!orderList || orderList.length === 0) {
                alert('‡∫ö‡ªç‡ªà‡∫°‡∫µ‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ');
                return;
            }
            
            displayDownloadOrderModal(orderList);
        })
        .withFailureHandler(function(error) {
            hideLoadingOverlay();
            alert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î: ' + error.message);
        })
        .getOrderList();
}

/**
 * ‡πÅ‡∏™‡∏î‡∏á Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function displayDownloadOrderModal(orderList) {
    const modal = document.createElement('div');
    modal.id = 'downloadOrderModal';
    modal.className = 'store-selector-modal show';
    
    let optionsHTML = '';
    orderList.forEach(function(order) {
        optionsHTML += '<div class="order-option-item" data-order="' + order.orderNumber + '" onclick="downloadOrderPDF(\'' + order.orderNumber + '\')" style="cursor: pointer;">' +
            '<div class="order-display-text">' + order.date + ' - ' + order.orderNumber + '</div>' +
            '<div class="order-item-count">üì• ' + order.itemCount + ' ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô</div>' +
            '</div>';
    });
    
    modal.innerHTML = '<div class="store-selector-content">' +
        '<div class="store-selector-header">üì• ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫î‡∫≤‡∫ß‡ªÇ‡∫´‡∫º‡∫î PDF</div>' +
        '<input type="text" id="downloadOrderSearchInput" class="store-search-input" placeholder="‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ ‡∫´‡∫º‡∫∑ ‡∫ß‡∫±‡∫ô‡∫ó‡∫µ..." onkeyup="filterDownloadOrderList()">' +
        '<div class="store-list" id="downloadOrderListContainer">' + optionsHTML + '</div>' +
        '<div class="store-selector-actions">' +
        '<button class="btn-cancel-stores" onclick="closeDownloadOrderModal()">‡∫õ‡∫¥‡∫î</button>' +
        '</div>' +
        '</div>';
    
    document.body.appendChild(modal);
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) closeDownloadOrderModal();
    });
}

/**
 * ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function filterDownloadOrderList() {
    const input = document.getElementById('downloadOrderSearchInput');
    const filter = input.value.toLowerCase();
    const container = document.getElementById('downloadOrderListContainer');
    const items = container.getElementsByClassName('order-option-item');
    
    for (let i = 0; i < items.length; i++) {
        const text = items[i].textContent || items[i].innerText;
        if (text.toLowerCase().indexOf(filter) > -1) {
            items[i].style.display = '';
        } else {
            items[i].style.display = 'none';
        }
    }
}

/**
 * ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå PDF ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function downloadOrderPDF(orderNumber) {
    closeDownloadOrderModal();
    
    // ‡πÅ‡∏™‡∏î‡∏á Loading
    showLoadingOverlay('‡∫Å‡ªç‡∫≤‡∫•‡∫±‡∫á‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤‡ªÑ‡∫ü‡∫•‡ªå PDF...', '‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫•‡ªç‡∫ñ‡ªâ‡∫≤‡∫™‡∫±‡∫Å‡∫Ñ‡∫π‡ªà');
    
    google.script.run
        .withSuccessHandler(function(result) {
            hideLoadingOverlay();
            
            if (result.success) {
                // ‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà
                window.open(result.fileUrl, '_blank');
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                setTimeout(function() {
                    alert('‚úÖ ‡ªÄ‡∫õ‡∫µ‡∫î‡ªÑ‡∫ü‡∫•‡ªå PDF ‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î!\n\n‡∫ä‡∫∑‡ªà‡ªÑ‡∫ü‡∫•‡ªå: ' + result.fileName + '\n\n‡∫Ñ‡∫∏‡∫ô‡∫™‡∫≤‡∫°‡∫≤‡∫î‡∫î‡∫≤‡∫ß‡ªÇ‡∫´‡∫º‡∫î‡ªÑ‡∫î‡ªâ‡∫à‡∫≤‡∫Å‡ªú‡ªâ‡∫≤‡∫ï‡ªà‡∫≤‡∫á‡∫ó‡∫µ‡ªà‡ªÄ‡∫õ‡∫µ‡∫î‡∫Ç‡∫∂‡ªâ‡∫ô‡∫°‡∫≤');
                }, 500);
            } else {
                alert('‚ùå ' + result.error);
            }
        })
        .withFailureHandler(function(error) {
            hideLoadingOverlay();
            alert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î: ' + error.message);
        })
        .getPDFUrlByOrderNumber(orderNumber);
}

/**
 * ‡∏õ‡∏¥‡∏î Modal ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function closeDownloadOrderModal() {
    const modal = document.getElementById('downloadOrderModal');
    if (modal) modal.remove();
}



console.log('üìä priceStudyData size:', priceStudyData.size);
console.log('üîç Sample data:');
let count = 0;
priceStudyData.forEach((items, barcode) => {
    if (count < 5) {
        console.log('Barcode:', barcode, '| Items:', items);
        count++;
    }
});
/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
 */
function generateSingleComparisonTableWithTotal(storeName) {
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log('üè™ Generating table for store:', storeName);

    let html = '<div class="compare-table-container">' +
        '<div class="compare-table-header">üè™ ' + storeName + '</div>' +
        '<div class="order-table-wrapper">' +
        '<table class="order-table">' +
        '<thead><tr>' +
        '<th>‡∫•‡∫≥‡∫î‡∫±‡∫ö</th><th>‡∫•‡∫∞‡∫´‡∫±‡∫î</th><th>‡∫Æ‡∫π‡∫ö</th><th>‡∫ä‡∫∑‡ªà‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</th>' +
        '<th>‡∫´‡∫ª‡∫ß‡ªú‡ªà‡∫ß‡∫ç</th><th>‡∫à‡∫≥‡∫ô‡∫ß‡∫ô</th><th>‡∫•‡∫≤‡∫Ñ‡∫≤/‡ªú‡ªà‡∫ß‡∫ç</th><th>‡∫•‡∫ß‡∫°‡ªÄ‡∫á‡∫¥‡∫ô</th><th>‡ªÅ‡∫´‡∫º‡ªà‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô</th>' +
        '</tr></thead><tbody>';

    let totalAmount = 0;

    orderItems.forEach(function(orderItem, index) {
        const barcodeFromOrder = orderItem.barcode.toString().trim();
        
        console.log('\nüì¶ Item ' + (index + 1) + ': ' + orderItem.itemName);
        console.log('üîë Barcode:', barcodeFromOrder);

        const mainItem = itemsData.get(barcodeFromOrder);
        
        if (!mainItem) {
            console.warn('‚ö†Ô∏è Not found in Items table');
            
            const itemTotal = orderItem.quantity * (orderItem.price || 0);
            totalAmount += itemTotal;
            
            const imgHtml = orderItem.image ? 
                '<img src="' + orderItem.image + '" class="order-table-img">' : 
                '<div class="no-order-img">üì∑</div>';
            
            html += '<tr style="background: #ffe0e0;">';
            html += '<td>' + (index + 1) + '</td>';
            html += '<td>' + barcodeFromOrder + '</td>';
            html += '<td>' + imgHtml + '</td>';
            html += '<td>' + orderItem.itemName + '</td>';
            html += '<td>' + orderItem.unit + '</td>';
            html += '<td>' + orderItem.quantity + '</td>';
            html += '<td>' + (orderItem.price || 0).toLocaleString() + '</td>';
            html += '<td>' + itemTotal.toLocaleString() + '</td>';
            html += '<td><span class="item-source-badge badge-main-table">‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÄ‡∫î‡∫µ‡∫°</span></td>';
            html += '</tr>';
            return;
        }

        const baseData = {
            barcode: barcodeFromOrder,
            itemName: mainItem.columnB || orderItem.itemName,
            unit: mainItem.columnH || orderItem.unit,
            quantity: orderItem.quantity,
            image: mainItem.columnK || orderItem.image,
            priceFromMainTable: parseFloat(mainItem.columnN) || 0
        };

        const priceStudyItems = priceStudyData.get(barcodeFromOrder);
        
        let finalPrice = baseData.priceFromMainTable;
        let source = 'main-table';
        let priceSource = '‡∫ï‡∫≤‡∫ï‡∫∞‡∫•‡∫≤‡∫á‡∫´‡∫º‡∫±‡∫Å';

        if (priceStudyItems && priceStudyItems.length > 0) {
            const matchedItem = priceStudyItems.find(function(item) {
                return item.store.toLowerCase() === storeName.toLowerCase().trim();
            });
            
            if (matchedItem && matchedItem.price > 0) {
                finalPrice = matchedItem.price;
                source = 'price-study';
                priceSource = '‡∫™‡∫∂‡∫Å‡∫™‡∫≤‡∫•‡∫≤‡∫Ñ‡∫≤‡∫ï‡∫ª‡ªâ‡∫ô‡∫ó‡∫∂‡∫ô';
            }
        }

        const itemTotal = baseData.quantity * finalPrice;
        totalAmount += itemTotal;

        const imgHtml = baseData.image ? 
            '<img src="' + baseData.image + '" class="order-table-img">' : 
            '<div class="no-order-img">üì∑</div>';

        const badgeClass = source === 'price-study' ? 'badge-price-study' : 'badge-main-table';
        const rowStyle = source === 'main-table' ? ' style="background: #e3f2fd;"' : '';

        html += '<tr' + rowStyle + '>';
        html += '<td>' + (index + 1) + '</td>';
        html += '<td>' + baseData.barcode + '</td>';
        html += '<td>' + imgHtml + '</td>';
        html += '<td>' + baseData.itemName + '</td>';
        html += '<td>' + baseData.unit + '</td>';
        html += '<td>' + baseData.quantity + '</td>';
        html += '<td>' + (finalPrice > 0 ? finalPrice.toLocaleString() : '-') + '</td>';
        html += '<td>' + (itemTotal > 0 ? itemTotal.toLocaleString() : '-') + '</td>';
        html += '<td><span class="item-source-badge ' + badgeClass + '">' + priceSource + '</span></td>';
        html += '</tr>';
    });

    console.log('üí∞ Store Total:', totalAmount.toLocaleString());
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');

    html += '</tbody></table></div>' +
        '<div class="order-footer">' +
        '<div class="order-total">üí∞ ‡∫•‡∫ß‡∫°‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î: ' + totalAmount.toLocaleString() + ' ‡∫Å‡∫µ‡∫ö</div>' +
        '</div></div>';

    return {
        html: html,
        total: totalAmount
    };
}
/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function createTotalSummary(mainTotal, storeTotals) {
    let html = '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; padding: 25px; margin: 20px 0; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);">';
    
    html += '<h3 style="color: white; margin: 0 0 20px 0; font-size: 1.5rem; text-align: center;">üìä ‡∫™‡∫∞‡∫´‡∫º‡∫∏‡∫ö‡∫ç‡∫≠‡∫î‡ªÄ‡∫á‡∫¥‡∫ô‡∫•‡∫ß‡∫°</h3>';
    
    html += '<div style="background: white; border-radius: 12px; padding: 20px;">';
    
    // ‡πÅ‡∏ñ‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å
    html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; margin-bottom: 10px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 8px; box-shadow: 0 2px 8px rgba(79, 172, 254, 0.3);">';
    html += '<div style="display: flex; align-items: center; gap: 10px;">';
    html += '<span style="font-size: 1.3rem;">üìã</span>';
    html += '<span style="font-weight: bold; color: white; font-size: 1.05rem;">‡∫ï‡∫≤‡∫ï‡∫∞‡∫•‡∫≤‡∫á‡∫´‡∫º‡∫±‡∫Å</span>';
    html += '</div>';
    html += '<span style="font-weight: bold; color: white; font-size: 1.15rem;">' + mainTotal.toLocaleString() + ' ‡∫Å‡∫µ‡∫ö</span>';
    html += '</div>';
    
    // ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô
    Object.keys(storeTotals).forEach(function(storeName, index) {
        const storeTotal = storeTotals[storeName];
        const difference = storeTotal - mainTotal;
        const isLower = difference < 0;
        const icon = isLower ? 'üìâ' : (difference > 0 ? 'üìà' : '‚ûñ');
        const bgColor = isLower ? 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)' : 
                        (difference > 0 ? 'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)' : 
                        'linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%)');
        const shadowColor = isLower ? 'rgba(76, 175, 80, 0.3)' : 
                            (difference > 0 ? 'rgba(255, 107, 107, 0.3)' : 'rgba(149, 165, 166, 0.3)');
        
        html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; margin-bottom: 10px; background: ' + bgColor + '; border-radius: 8px; box-shadow: 0 2px 8px ' + shadowColor + ';">';
        html += '<div style="display: flex; align-items: center; gap: 10px;">';
        html += '<span style="font-size: 1.3rem;">üè™</span>';
        html += '<span style="font-weight: bold; color: white; font-size: 1.05rem;">' + storeName + '</span>';
        html += '</div>';
        html += '<div style="text-align: right;">';
        html += '<div style="font-weight: bold; color: white; font-size: 1.15rem;">' + storeTotal.toLocaleString() + ' ‡∫Å‡∫µ‡∫ö</div>';
        
        if (difference !== 0) {
            const diffText = isLower ? '‡∫ï‡ªà‡∫≥‡∫Å‡∫ß‡ªà‡∫≤' : '‡∫™‡∫π‡∫á‡∫Å‡∫ß‡ªà‡∫≤';
            html += '<div style="font-size: 0.9rem; color: white; opacity: 0.9; margin-top: 3px;">' + icon + ' ' + diffText + ' ' + Math.abs(difference).toLocaleString() + ' ‡∫Å‡∫µ‡∫ö</div>';
        }
        
        html += '</div>';
        html += '</div>';
    });
    
    html += '</div>';
    html += '</div>';
    
    return html;
}

/**
 * ========================================
 * ‚≠ê JavaScript ‡πÉ‡∏´‡∏°‡πà: ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
 * ========================================
 */

let editItemsModal = null;
let editFormModal = null;
let selectedItemsForEdit = new Set();
let filteredItemsData = [];
let uniqueZones = [];
let uniqueCategories = [];
let uniqueUnits = [];

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
 */
function createEditItemsButton() {
    if (document.getElementById('editItemsBtn')) return;
    
    const button = document.createElement('button');
    button.id = 'editItemsBtn';
    button.className = 'edit-items-btn';
    button.innerHTML = '‚úèÔ∏è ‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤ & ‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡∫™‡∫∞‡∫ï‡∫±‡∫≠‡∫Å';
    button.onclick = showEditItemsModal;
    document.body.appendChild(button);
    
    createEditItemsModal();
    createEditFormModal();
}


/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á Modal ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
 */
function createEditFormModal() {
    const modal = document.createElement('div');
    modal.id = 'editFormModal';
    modal.className = 'edit-form-modal';
    
    modal.innerHTML = '<div class="edit-form-content">' +
        '<h3 class="edit-form-title">‚úèÔ∏è ‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</h3>' +
        '<div id="editFormFields"></div>' +
        '<div class="edit-form-actions">' +
        '<button class="btn-save-edit" onclick="saveEditedItems()">üíæ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å</button>' +
        '<button class="btn-cancel-edit" onclick="closeEditFormModal()">‚ùå ‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>' +
        '</div>' +
        '</div>';
    
    document.body.appendChild(modal);
    editFormModal = modal;
}

/**
 * ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô
 */
function showEditItemsModal() {
    showEditChoiceModal(); // ‚≠ê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏£‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô
}

/**
 * ‡∏õ‡∏¥‡∏î Modal ‡∏´‡∏•‡∏±‡∏Å
 */
function closeEditItemsModal() {
    if (editItemsModal) {
        editItemsModal.classList.remove('show');
        clearEditFilters();
    }
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á Modal ‡∏´‡∏•‡∏±‡∏Å (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏° Auto-Search ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î)
 */
function createEditItemsModal() {
    const modal = document.createElement('div');
    modal.id = 'editItemsModal';
    modal.className = 'edit-items-modal';
    
    modal.innerHTML = '<div class="edit-items-content">' +
        '<div class="edit-items-header">' +
        '<h2 class="edit-items-title">‚úèÔ∏è ‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</h2>' +
        '<div class="edit-header-buttons">' +
        '<button class="edit-action-btn btn-show-filtered" onclick="showFilteredItems()">üìã ‡∫™‡∫∞‡ªÅ‡∫î‡∫á‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</button>' +
        '<button class="edit-action-btn btn-edit-selected" id="editSelectedBtn" onclick="editSelectedItems()" disabled>‚úèÔ∏è ‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç</button>' +
        '<button class="edit-action-btn btn-clear-filter" onclick="clearEditFilters()">üóëÔ∏è ‡∫•‡ªâ‡∫≤‡∫á</button>' +
        '<button class="edit-close-btn" onclick="closeEditItemsModal()">√ó</button>' +
        '</div>' +
        '</div>' +
        '<div class="edit-filter-section">' +
        '<div class="filter-row">' +
        '<div class="filter-item">' +
        '<label class="filter-label">üìç ‡ªÇ‡∫ä‡∫ô:</label>' +
        '<input list="zoneDatalist" id="filterZone" class="filter-input" placeholder="‡∫û‡∫¥‡∫° ‡∫´‡∫º‡∫∑ ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÇ‡∫ä‡∫ô...">' +
        '<datalist id="zoneDatalist"></datalist>' +
        '</div>' +
        '<div class="filter-item">' +
        '<label class="filter-label">üì¶ ‡ªù‡∫ß‡∫î‡ªù‡∫π‡ªà:</label>' +
        '<input list="categoryDatalist" id="filterCategory" class="filter-input" placeholder="‡∫û‡∫¥‡∫° ‡∫´‡∫º‡∫∑ ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªù‡∫ß‡∫î‡ªù‡∫π‡ªà...">' +
        '<datalist id="categoryDatalist"></datalist>' +
        '</div>' +
        '<div class="filter-item">' +
        '<label class="filter-label">üìè ‡∫´‡∫ª‡∫ß‡ªú‡ªà‡∫ß‡∫ç:</label>' +
        '<select id="filterUnit" class="filter-select">' +
        '<option value="">-- ‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î --</option>' +
        '</select>' +
        '</div>' +
        '<div class="filter-item">' +
        '<label class="filter-label">üîç ‡∫ä‡∫∑‡ªà‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤:</label>' +
        '<input type="text" id="filterName" class="filter-input" placeholder="‡∫û‡∫¥‡∫°‡∫ä‡∫∑‡ªà‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤..." oninput="handleRealtimeSearch()">' +
        '</div>' +
        '<div class="filter-item">' +
        '<label class="filter-label">üì∑ ‡∫™‡∫∞‡ªÅ‡∫Å‡∫ô‡∫ö‡∫≤‡ªÇ‡∫Ñ‡∫î:</label>' +
        // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° oninput ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Auto-Search
        '<input type="text" id="filterBarcode" class="filter-input" placeholder="‡∫™‡∫∞‡ªÅ‡∫Å‡∫ô ‡∫´‡∫º‡∫∑ ‡∫û‡∫¥‡∫°‡∫ö‡∫≤‡ªÇ‡∫Ñ‡∫î..." oninput="handleBarcodeAutoSearch()">' +
        '</div>' +
        '</div>' +
        '</div>' +
        '<div class="edit-table-section">' +
        '<div style="text-align: center; padding: 40px; color: #999;">' +
        '<p>‡∫Å‡∫ª‡∫î‡∫õ‡∫∏‡ªà‡∫° "üìã ‡∫™‡∫∞‡ªÅ‡∫î‡∫á‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤" ‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡∫ï‡∫ª‡ªâ‡∫ô</p>' +
        '</div>' +
        '</div>' +
        '</div>';
    
    document.body.appendChild(modal);
    editItemsModal = modal;
    
    // Event listeners
    modal.addEventListener('click', function(e) {
        if (e.target === modal) closeEditItemsModal();
    });
}

/**
 * ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Dropdown (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ datalist ‡πÅ‡∏ó‡∏ô option)
 */
function loadEditDropdownData() {
    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏à‡∏≤‡∏Å itemsData
    uniqueZones = [];
    uniqueCategories = [];
    uniqueUnits = [];
    
    const zonesSet = new Set();
    const categoriesSet = new Set();
    const unitsSet = new Set();
    
    itemsData.forEach(function(item) {
        if (item.columnM) zonesSet.add(item.columnM.toString().trim());
        if (item.columnL) categoriesSet.add(item.columnL.toString().trim());
        if (item.columnH) unitsSet.add(item.columnH.toString().trim());
    });
    
    uniqueZones = Array.from(zonesSet).sort();
    uniqueCategories = Array.from(categoriesSet).sort();
    uniqueUnits = Array.from(unitsSet).sort();
    
    // ‚≠ê ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô datalist
    const zoneDatalist = document.getElementById('zoneDatalist');
    const categoryDatalist = document.getElementById('categoryDatalist');
    const unitSelect = document.getElementById('filterUnit');
    
    if (zoneDatalist) {
        zoneDatalist.innerHTML = '';
        uniqueZones.forEach(function(zone) {
            zoneDatalist.innerHTML += '<option value="' + zone + '">';
        });
    }
    
    if (categoryDatalist) {
        categoryDatalist.innerHTML = '';
        uniqueCategories.forEach(function(cat) {
            categoryDatalist.innerHTML += '<option value="' + cat + '">';
        });
    }
    
    if (unitSelect) {
        unitSelect.innerHTML = '<option value="">-- ‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î --</option>';
        uniqueUnits.forEach(function(unit) {
            unitSelect.innerHTML += '<option value="' + unit + '">' + unit + '</option>';
        });
    }
}

// ‚≠ê ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Debounce
let realtimeSearchTimer = null;

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Real-time Search (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function handleRealtimeSearch() {
    // Clear timeout ‡πÄ‡∏î‡∏¥‡∏°
    if (realtimeSearchTimer) {
        clearTimeout(realtimeSearchTimer);
    }
    
    const filterName = document.getElementById('filterName').value.trim().toLowerCase();
    
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‚Üí ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
    if (!filterName) {
        return;
    }
    
    // Debounce: ‡∏£‡∏≠ 500ms ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    realtimeSearchTimer = setTimeout(function() {
        console.log('üîç Real-time search triggered for:', filterName);
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å showFilteredItems() ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        showFilteredItems();
    }, 500);
}
// ‚≠ê ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Debounce (Barcode)
let barcodeSearchTimer = null;

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Auto-Search ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function handleBarcodeAutoSearch() {
    // Clear timeout ‡πÄ‡∏î‡∏¥‡∏°
    if (barcodeSearchTimer) {
        clearTimeout(barcodeSearchTimer);
    }
    
    const filterBarcode = document.getElementById('filterBarcode').value.trim();
    
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î ‚Üí ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
    if (!filterBarcode) {
        return;
    }
    
    console.log('üì∑ Barcode detected:', filterBarcode);
    
    // ‚≠ê Debounce: ‡∏£‡∏≠ 500ms ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    // (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô)
    barcodeSearchTimer = setTimeout(function() {
        console.log('üîç Auto-searching by barcode:', filterBarcode);
        
        // ‚≠ê ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å showFilteredItems() ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        showFilteredItems();
        
        // ‚≠ê ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ)
        setTimeout(function() {
            document.getElementById('filterBarcode').value = '';
            document.getElementById('filterBarcode').focus(); // Focus ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô
        }, 300);
        
    }, 500); // ‡∏£‡∏≠ 500ms
}
/**
 * ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏î‡∏∂‡∏á‡∏ï‡∏≤‡∏° Column L)
 */
function showFilteredItems() {
    const filterZone = document.getElementById('filterZone').value.toLowerCase().trim();
    const filterCategory = document.getElementById('filterCategory').value.toLowerCase().trim();
    const filterUnit = document.getElementById('filterUnit').value.toLowerCase();
    const filterName = document.getElementById('filterName').value.toLowerCase().trim();
    const filterBarcode = document.getElementById('filterBarcode').value.trim();
    
    console.log('Filtering with:', { filterZone, filterCategory, filterUnit, filterName, filterBarcode });
    
    filteredItemsData = [];
    selectedItemsForEdit.clear();
    
    // ‚≠ê ‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡πÅ‡∏Å‡∏ô Barcode (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏î‡∏∂‡∏á‡∏ï‡∏≤‡∏° Column L ‡πÅ‡∏ó‡∏ô Column J)
    if (filterBarcode) {
        const scannedItem = itemsData.get(filterBarcode);
        
        if (scannedItem) {
            // ‚≠ê ‡∏î‡∏∂‡∏á Column L (‡ªù‡∫ß‡∫î‡ªù‡∫π‡ªà) ‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô
            const categoryOfScanned = (scannedItem.columnL || '').toString().trim();
            
            console.log('üîç Scanned barcode:', filterBarcode);
            console.log('üì¶ Category (Column L):', categoryOfScanned);
            
            if (categoryOfScanned) {
                // ‚≠ê ‡∏î‡∏∂‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ Column L ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
                itemsData.forEach(function(item, barcode) {
                    const itemCategory = (item.columnL || '').toString().trim();
                    
                    if (itemCategory === categoryOfScanned) {
                        filteredItemsData.push({
                            barcode: barcode,
                            data: item
                        });
                    }
                });
                
                console.log('‚úÖ Found items with same category:', filteredItemsData.length);
            } else {
                // ‚≠ê ‡∏ñ‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ Column L ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
                console.log('‚ö†Ô∏è Scanned item has no category, showing only this item');
                filteredItemsData.push({
                    barcode: filterBarcode,
                    data: scannedItem
                });
            }
        } else {
            console.log('‚ùå Barcode not found:', filterBarcode);
        }
    } else {
        // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
        itemsData.forEach(function(item, barcode) {
            let match = true;
            
            // Zone: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö contains
            if (filterZone && !(item.columnM || '').toString().toLowerCase().includes(filterZone)) {
                match = false;
            }
            
            // Category: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö contains
            if (filterCategory && !(item.columnL || '').toString().toLowerCase().includes(filterCategory)) {
                match = false;
            }
            
            // Unit: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö
            if (filterUnit && (item.columnH || '').toString().toLowerCase() !== filterUnit) {
                match = false;
            }
            
            // Name: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö contains
            if (filterName && !(item.columnB || '').toString().toLowerCase().includes(filterName)) {
                match = false;
            }
            
            if (match) {
                filteredItemsData.push({
                    barcode: barcode,
                    data: item
                });
            }
        });
    }
    
    // ‚≠ê ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 1 = Column J, ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 2 = Column L
    filteredItemsData.sort(function(a, b) {
        // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Column J (‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á)
        const columnJ_a = (a.data.columnJ || a.barcode || '').toString().trim();
        const columnJ_b = (b.data.columnJ || b.barcode || '').toString().trim();
        
        // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Column L (‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà)
        const columnL_a = (a.data.columnL || '').toString().trim();
        const columnL_b = (b.data.columnL || '').toString().trim();
        
        // ‚≠ê ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å: ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° Column J (A-Z)
        if (columnJ_a < columnJ_b) return -1;
        if (columnJ_a > columnJ_b) return 1;
        
        // ‚≠ê ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á: ‡∏ñ‡πâ‡∏≤ Column J ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° Column L (A-Z)
        if (columnL_a < columnL_b) return -1;
        if (columnL_a > columnL_b) return 1;
        
        return 0;
    });
    
    console.log('‚úÖ Filtered & Sorted items:', filteredItemsData.length);
    
    displayFilteredItemsTable();
}

/**
 * ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: Clear real-time timer ‡∏î‡πâ‡∏ß‡∏¢)
 */
function clearEditFilters() {
    // ‚≠ê Clear timer
    if (realtimeSearchTimer) {
        clearTimeout(realtimeSearchTimer);
        realtimeSearchTimer = null;
    }
    
    document.getElementById('filterZone').value = '';
    document.getElementById('filterCategory').value = '';
    document.getElementById('filterUnit').value = '';
    document.getElementById('filterName').value = '';
    document.getElementById('filterBarcode').value = '';
    
    filteredItemsData = [];
    selectedItemsForEdit.clear();
    
    const tableSection = document.querySelector('.edit-table-section');
    if (tableSection) {
        tableSection.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">' +
            '<p>‡∫Å‡∫ª‡∫î‡∫õ‡∫∏‡ªà‡∫° "üìã ‡∫™‡∫∞‡ªÅ‡∫î‡∫á‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤" ‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡∫ï‡∫ª‡ªâ‡∫ô</p>' +
            '</div>';
    }
    
    updateEditButtonState();
}



/**
 * ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
 */
function displayFilteredItemsTable() {
    const tableSection = document.querySelector('.edit-table-section');
    
    if (!tableSection) return;
    
    if (filteredItemsData.length === 0) {
        tableSection.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">' +
            '<h3>‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô</h3>' +
            '<p>‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫õ‡∫±‡∫ö‡ªÄ‡∫á‡∫∑‡ªà‡∫≠‡∫ô‡ªÑ‡∫Ç‡∫Å‡∫≤‡∫ô‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤</p>' +
            '</div>';
        return;
    }
    
    let html = '<table class="edit-items-table">' +
        '<thead><tr>' +
        '<th><input type="checkbox" class="edit-checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th>' +
        '<th>‡∫•‡∫∞‡∫´‡∫±‡∫î (A)</th>' +
        '<th>‡∫ä‡∫∑‡ªà‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô (B)</th>' +
        '<th>‡∫•‡∫≤‡∫Ñ‡∫≤‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤ (C)</th>' +
        '<th>‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡ªÅ‡∫à‡ªâ‡∫á‡ªÄ‡∫ï‡∫∑‡∫≠‡∫ô (D)</th>' +
        '<th>‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡ªÄ‡∫´‡∫º‡∫∑‡∫≠ (F)</th>' +
        '<th>‡∫´‡∫ª‡∫ß‡ªú‡ªà‡∫ß‡∫ç (H)</th>' +
        '<th>‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡∫ï‡ªç‡ªà‡ªú‡ªà‡∫ß‡∫ç (I)</th>' +
        '<th>‡∫Æ‡∫π‡∫ö (K)</th>' +
        '<th>‡ªù‡∫ß‡∫î‡ªù‡∫π‡ªà (L)</th>' +
        '<th>‡ªÇ‡∫ä‡∫ô (M)</th>' +
        '<th>‡∫•‡∫≤‡∫Ñ‡∫≤‡∫ï‡∫ª‡ªâ‡∫ô‡∫ó‡∫∂‡∫ô (N)</th>' +
        '</tr></thead><tbody>';
    
    filteredItemsData.forEach(function(itemObj) {
        const barcode = itemObj.barcode;
        const item = itemObj.data;
        const isSelected = selectedItemsForEdit.has(barcode);
        
        const imgHtml = item.columnK ? 
            '<img src="' + item.columnK + '" class="edit-table-img">' : 
            'üì∑';
        
        html += '<tr class="' + (isSelected ? 'selected' : '') + '" onclick="toggleItemSelectionForEdit(\'' + barcode + '\')">' +
    '<td onclick="event.stopPropagation()"><input type="checkbox" class="edit-checkbox item-checkbox" data-barcode="' + barcode + '" ' + (isSelected ? 'checked' : '') + ' onchange="toggleItemSelectionForEdit(\'' + barcode + '\')"></td>' +
            '<td>' + barcode + '</td>' +
            '<td>' + (item.columnB || '-') + '</td>' +
            '<td>' + (item.columnC || '-') + '</td>' +
            '<td>' + (item.columnD || '-') + '</td>' +
            '<td>' + (item.columnF || '-') + '</td>' +
            '<td>' + (item.columnH || '-') + '</td>' +
            '<td>' + (item.columnI || '-') + '</td>' +
            '<td>' + imgHtml + '</td>' +
            '<td>' + (item.columnL || '-') + '</td>' +
            '<td>' + (item.columnM || '-') + '</td>' +
            '<td>' + (item.columnN || '-') + '</td>' +
            '</tr>';
    });
    
    html += '</tbody></table>';
    
    tableSection.innerHTML = html;
    
    updateEditButtonState();
}
/**
 * Toggle ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
 */
function toggleItemSelectionForEdit(barcode) {
    if (selectedItemsForEdit.has(barcode)) {
        selectedItemsForEdit.delete(barcode);
    } else {
        selectedItemsForEdit.add(barcode);
    }
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó UI
    const checkbox = document.querySelector('.item-checkbox[data-barcode="' + barcode + '"]');
    if (checkbox) {
        checkbox.checked = selectedItemsForEdit.has(barcode);
    }
    
    const row = checkbox ? checkbox.closest('tr') : null;
    if (row) {
        if (selectedItemsForEdit.has(barcode)) {
            row.classList.add('selected');
        } else {
            row.classList.remove('selected');
        }
    }
    
    updateEditButtonState();
    updateSelectAllCheckbox();
}

/**
 * Toggle ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
 */
function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    
    if (!selectAllCheckbox) {
        console.error('selectAllCheckbox not found!');
        return;
    }
    
    const isChecked = selectAllCheckbox.checked;
    
    console.log('üîÑ toggleSelectAll called, isChecked:', isChecked);
    
    if (isChecked) {
        // ‚≠ê ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        console.log('‚úÖ Selecting all items...');
        filteredItemsData.forEach(function(itemObj) {
            selectedItemsForEdit.add(itemObj.barcode);
        });
    } else {
        // ‚≠ê ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        console.log('‚ùå Deselecting all items...');
        selectedItemsForEdit.clear();
    }
    
    console.log('üìä Selected items count:', selectedItemsForEdit.size);
    
    // ‚≠ê ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó UI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å displayFilteredItemsTable())
    const checkboxes = document.querySelectorAll('.item-checkbox');
    const rows = document.querySelectorAll('.edit-items-table tbody tr');
    
    checkboxes.forEach(function(checkbox) {
        const barcode = checkbox.dataset.barcode;
        if (barcode) {
            checkbox.checked = selectedItemsForEdit.has(barcode);
        }
    });
    
    rows.forEach(function(row) {
        const checkbox = row.querySelector('.item-checkbox');
        if (checkbox && checkbox.dataset.barcode) {
            const barcode = checkbox.dataset.barcode;
            if (selectedItemsForEdit.has(barcode)) {
                row.classList.add('selected');
            } else {
                row.classList.remove('selected');
            }
        }
    });
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    updateEditButtonState();
}


/**
 * ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ checkbox ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÅ‡∏Å‡πâ logic)
 */
function updateSelectAllCheckbox() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    if (!selectAllCheckbox) return;
    
    const totalItems = filteredItemsData.length;
    const selectedCount = selectedItemsForEdit.size;
    
    console.log('üîÑ updateSelectAllCheckbox: selected=' + selectedCount + ', total=' + totalItems);
    
    if (selectedCount === 0) {
        // ‚≠ê ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏¢
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (selectedCount === totalItems) {
        // ‚≠ê ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else {
        // ‚≠ê ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    }
}

/**
 * ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
 */
function updateEditButtonState() {
    const editBtn = document.getElementById('editSelectedBtn');
    if (!editBtn) return;
    
    if (selectedItemsForEdit.size > 0) {
        editBtn.disabled = false;
    } else {
        editBtn.disabled = true;
    }
}



/**
 * ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
 */
function editSelectedItems() {
    if (selectedItemsForEdit.size === 0) {
        alert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡∫Å‡ªà‡∫≠‡∫ô');
        return;
    }
    
    console.log('Editing items:', selectedItemsForEdit.size);
    
    displayEditForm();
}
/**
 * ========================================
 * ‚≠ê ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏û‡∏£‡πâ‡∏≠‡∏° Crop (‡πÉ‡∏´‡∏°‡πà)
 * ========================================
 */

let imageCropModal = null;
let cropperInstance = null;
let currentEditImageFile = null;
let currentEditImageUrl = null; // ‡πÄ‡∏Å‡πá‡∏ö URL ‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏°
let oldImagesToDelete = []; // ‡πÄ‡∏Å‡πá‡∏ö URL ‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á Modal Crop ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
 */
function createImageCropModal() {
    if (document.getElementById('imageCropModal')) return;
    
    const modal = document.createElement('div');
    modal.id = 'imageCropModal';
    modal.className = 'image-crop-modal';
    
    modal.innerHTML = '<div class="image-crop-content">' +
        '<div class="image-crop-header">' +
        '<h2 class="image-crop-title">‚úÇÔ∏è ‡∫ï‡∫±‡∫î‡ªÅ‡∫ï‡ªà‡∫á‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö</h2>' +
        '<button class="crop-close-btn" onclick="closeImageCropModal()">√ó</button>' +
        '</div>' +
        '<div class="image-crop-body">' +
        '<div class="crop-container">' +
        '<img id="cropImage" src="" alt="Crop Image">' +
        '</div>' +
        '<div class="crop-controls">' +
        '<button class="crop-control-btn btn-crop-rotate-left" onclick="rotateCropImage(-90)">‚Ü∂ ‡ªù‡∫∏‡∫ô‡∫ä‡ªâ‡∫≤‡∫ç</button>' +
        '<button class="crop-control-btn btn-crop-rotate-right" onclick="rotateCropImage(90)">‚Ü∑ ‡ªù‡∫∏‡∫ô‡∫Ç‡∫ß‡∫≤</button>' +
        '<button class="crop-control-btn btn-crop-zoom-in" onclick="zoomCropImage(0.1)">üîç+ ‡∫Ç‡∫∞‡∫´‡∫ç‡∫≤‡∫ç</button>' +
        '<button class="crop-control-btn btn-crop-zoom-out" onclick="zoomCropImage(-0.1)">üîç- ‡∫´‡∫º‡∫∏‡∫î</button>' +
        '<button class="crop-control-btn btn-crop-reset" onclick="resetCropImage()">üîÑ ‡∫£‡∫µ‡ªÄ‡∫ä‡∫±‡∫î</button>' +
        '</div>' +
        '</div>' +
        '<div class="image-crop-footer">' +
        '<button class="btn-crop-confirm" onclick="confirmCroppedImage()">‚úÖ ‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô</button>' +
        '<button class="btn-crop-cancel" onclick="closeImageCropModal()">‚ùå ‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>' +
        '</div>' +
        '</div>';
    
    document.body.appendChild(modal);
    imageCropModal = modal;
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            // ‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å
        }
    });
}

/**
 * ‡πÄ‡∏õ‡∏¥‡∏î Modal Crop ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
 */
function openImageCropModal(imageSource) {
    if (!imageCropModal) {
        createImageCropModal();
    }
    
    const cropImage = document.getElementById('cropImage');
    cropImage.src = imageSource;
    
    imageCropModal.classList.add('show');
    
    // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Cropper
    cropImage.onload = function() {
        // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ Cropper ‡πÄ‡∏Å‡πà‡∏≤
        if (cropperInstance) {
            cropperInstance.destroy();
        }
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Cropper ‡πÉ‡∏´‡∏°‡πà
        cropperInstance = new Cropper(cropImage, {
            aspectRatio: NaN, // ‡∏≠‡∏¥‡∏™‡∏£‡∏∞ ‡∏ï‡∏±‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô
            viewMode: 1,
            autoCropArea: 1,
            responsive: true,
            background: false,
            zoomable: true,
            movable: true,
            rotatable: true,
            scalable: true,
            guides: true,
            center: true,
            highlight: true,
            cropBoxResizable: true,
            cropBoxMovable: true,
            toggleDragModeOnDblclick: false
        });
    };
}

/**
 * ‡∏õ‡∏¥‡∏î Modal Crop ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
 */
function closeImageCropModal() {
    if (imageCropModal) {
        imageCropModal.classList.remove('show');
        
        // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ Cropper
        if (cropperInstance) {
            cropperInstance.destroy();
            cropperInstance = null;
        }
    }
}

/**
 * ‡∏´‡∏°‡∏∏‡∏ô‡∏£‡∏π‡∏õ
 */
function rotateCropImage(degree) {
    if (cropperInstance) {
        cropperInstance.rotate(degree);
    }
}

/**
 * ‡∏ã‡∏π‡∏°‡∏£‡∏π‡∏õ
 */
function zoomCropImage(ratio) {
    if (cropperInstance) {
        cropperInstance.zoom(ratio);
    }
}

/**
 * ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏π‡∏õ
 */
function resetCropImage() {
    if (cropperInstance) {
        cropperInstance.reset();
    }
}

/**
 * ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà Crop ‡πÅ‡∏•‡πâ‡∏ß
 */
function confirmCroppedImage() {
    if (!cropperInstance) {
        alert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫•‡∫≠‡∫á‡ªÉ‡ªù‡ªà‡∫≠‡∫µ‡∫Å‡∫Ñ‡∫±‡ªâ‡∫á');
        return;
    }
    
    // ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà Crop ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡πá‡∏ô Canvas
    const canvas = cropperInstance.getCroppedCanvas({
        maxWidth: 1200,
        maxHeight: 1200,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high'
    });
    
    if (!canvas) {
        alert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫ï‡∫±‡∫î‡∫Æ‡∫π‡∫ö');
        return;
    }
    
    // ‡πÅ‡∏õ‡∏•‡∏á Canvas ‡πÄ‡∏õ‡πá‡∏ô Blob
    canvas.toBlob(function(blob) {
        if (!blob) {
            alert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫™‡ªâ‡∫≤‡∫á‡∫Æ‡∫π‡∫ö');
            return;
        }
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á File ‡∏à‡∏≤‡∏Å Blob
        const fileName = 'cropped_' + new Date().getTime() + '.jpg';
        const croppedFile = new File([blob], fileName, { type: 'image/jpeg' });
        
        // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå
        currentEditImageFile = croppedFile;
        
        // ‡πÅ‡∏™‡∏î‡∏á Preview
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('editImagePreview');
            if (preview) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            }
            
            const placeholder = document.querySelector('.no-image-placeholder');
            if (placeholder) {
                placeholder.style.display = 'none';
            }
        };
        reader.readAsDataURL(croppedFile);
        
        closeImageCropModal();
        
    }, 'image/jpeg', 0.9);
}

/**
 * ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Edit Form)
 */
function selectImageFileForEdit() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    
    input.onchange = function(e) {
        const file = e.target.files[0];
        
        if (!file) return;
        
        if (!file.type.startsWith('image/')) {
            alert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÑ‡∫ü‡∫•‡ªå‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö‡ªÄ‡∫ó‡∫ª‡ªà‡∫≤‡∫ô‡∫±‡ªâ‡∫ô');
            return;
        }
        
        // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Base64
        const reader = new FileReader();
        reader.onload = function(e) {
            openImageCropModal(e.target.result);
        };
        reader.readAsDataURL(file);
    };
    
    input.click();
}

/**
 * ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Edit Form)
 */
function takePhotoForEdit() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.capture = 'environment'; // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á
    
    input.onchange = function(e) {
        const file = e.target.files[0];
        
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            openImageCropModal(e.target.result);
        };
        reader.readAsDataURL(file);
    };
    
    input.click();
}

/**
 * ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Edit Form)
 */
function deleteImageForEdit() {
    if (!confirm('‡∫ó‡ªà‡∫≤‡∫ô‡ªÅ‡∫ô‡ªà‡ªÉ‡∫à‡∫ö‡ªç‡ªà‡∫ß‡ªà‡∫≤‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫•‡∫ª‡∫ö‡∫Æ‡∫π‡∫ö‡∫ô‡∫µ‡ªâ?')) {
        return;
    }
    
    // ‡πÄ‡∏Å‡πá‡∏ö URL ‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏ß‡πâ‡∏•‡∏ö‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á
    if (currentEditImageUrl) {
        oldImagesToDelete.push(currentEditImageUrl);
    }
    
    // ‡∏•‡∏ö‡∏£‡∏π‡∏õ Preview
    const preview = document.getElementById('editImagePreview');
    if (preview) {
        preview.src = '';
        preview.style.display = 'none';
    }
    
    const placeholder = document.querySelector('.no-image-placeholder');
    if (placeholder) {
        placeholder.style.display = 'flex';
    }
    
    // ‡∏•‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå
    currentEditImageFile = null;
    currentEditImageUrl = '';
}

/**
 * ========================================
 * ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô displayEditForm() ‡πÄ‡∏î‡∏¥‡∏°
 * ========================================
 */

function displayEditForm() {
    const formFields = document.getElementById('editFormFields');
    if (!formFields) return;
    
    const isSingle = selectedItemsForEdit.size === 1;
    let sampleItem = null;
    
    if (isSingle) {
        const barcode = Array.from(selectedItemsForEdit)[0];
        sampleItem = itemsData.get(barcode);
        currentEditImageUrl = sampleItem ? (sampleItem.columnK || '') : '';
    } else {
        currentEditImageUrl = '';
    }
    
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£
    currentEditImageFile = null;
    oldImagesToDelete = [];
    
    // ‡πÄ‡∏Å‡πá‡∏ö URL ‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏ö‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà)
    selectedItemsForEdit.forEach(function(barcode) {
        const item = itemsData.get(barcode);
        if (item && item.columnK) {
            const url = item.columnK.toString().trim();
            if (url && oldImagesToDelete.indexOf(url) === -1) {
                oldImagesToDelete.push(url);
            }
        }
    });
    
    formFields.innerHTML = '<div class="edit-form-grid">' +
        '<div class="edit-form-field">' +
        '<label class="edit-form-label">‡∫•‡∫∞‡∫´‡∫±‡∫î (A):</label>' +
        '<input type="text" class="edit-form-input" value="' + (isSingle && sampleItem ? sampleItem.columnA : '-') + '" disabled>' +
        '</div>' +
        '<div class="edit-form-field">' +
        '<label class="edit-form-label">‡∫ä‡∫∑‡ªà‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô (B):</label>' +
        '<input type="text" id="editColumnB" class="edit-form-input" value="' + (isSingle && sampleItem ? sampleItem.columnB : '') + '" placeholder="‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÉ‡∫™‡ªà‡∫ä‡∫∑‡ªà...">' +
        '</div>' +
        '<div class="edit-form-field">' +
        '<label class="edit-form-label">‡∫•‡∫≤‡∫Ñ‡∫≤‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤ (C):</label>' +
        '<input type="number" id="editColumnC" class="edit-form-input" value="' + (isSingle && sampleItem ? sampleItem.columnC : '') + '" placeholder="0">' +
        '</div>' +
        '<div class="edit-form-field">' +
        '<label class="edit-form-label">‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡ªÅ‡∫à‡ªâ‡∫á‡ªÄ‡∫ï‡∫∑‡∫≠‡∫ô (D):</label>' +
        '<input type="number" id="editColumnD" class="edit-form-input" value="' + (isSingle && sampleItem ? sampleItem.columnD : '') + '" placeholder="0">' +
        '</div>' +
        '<div class="edit-form-field">' +
        '<label class="edit-form-label">‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡ªÄ‡∫´‡∫º‡∫∑‡∫≠ (F):</label>' +
        '<input type="number" id="editColumnF" class="edit-form-input" value="' + (isSingle && sampleItem ? sampleItem.columnF : '') + '" placeholder="0">' +
        '</div>' +
        '<div class="edit-form-field">' +
        '<label class="edit-form-label">‡∫´‡∫ª‡∫ß‡ªú‡ªà‡∫ß‡∫ç (H):</label>' +
        '<input list="editUnitDatalist" id="editColumnH" class="edit-form-input" value="' + (isSingle && sampleItem ? sampleItem.columnH : '') + '" placeholder="‡∫û‡∫¥‡∫° ‡∫´‡∫º‡∫∑ ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫´‡∫ª‡∫ß‡ªú‡ªà‡∫ß‡∫ç...">' +
        '<datalist id="editUnitDatalist">' + generateUnitOptions() + '</datalist>' +
        '</div>' +
        '<div class="edit-form-field">' +
        '<label class="edit-form-label">‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡∫ï‡ªç‡ªà‡ªú‡ªà‡∫ß‡∫ç (I):</label>' +
        '<input type="number" id="editColumnI" class="edit-form-input" value="' + (isSingle && sampleItem ? sampleItem.columnI : '') + '" placeholder="1">' +
        '</div>' +
        '<div class="edit-form-field">' +
        '<label class="edit-form-label">‡ªù‡∫ß‡∫î‡ªù‡∫π‡ªà (L):</label>' +
        '<input list="editCategoryDatalist" id="editColumnL" class="edit-form-input" value="' + (isSingle && sampleItem ? sampleItem.columnL : '') + '" placeholder="‡∫û‡∫¥‡∫° ‡∫´‡∫º‡∫∑ ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªù‡∫ß‡∫î‡ªù‡∫π‡ªà...">' +
        '<datalist id="editCategoryDatalist">' + generateCategoryOptionsForDatalist() + '</datalist>' +
        '</div>' +
        '<div class="edit-form-field">' +
        '<label class="edit-form-label">‡ªÇ‡∫ä‡∫ô (M):</label>' +
        '<input list="editZoneDatalist" id="editColumnM" class="edit-form-input" value="' + (isSingle && sampleItem ? sampleItem.columnM : '') + '" placeholder="‡∫û‡∫¥‡∫° ‡∫´‡∫º‡∫∑ ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÇ‡∫ä‡∫ô...">' +
        '<datalist id="editZoneDatalist">' + generateZoneOptionsForDatalist() + '</datalist>' +
        '</div>' +
        '<div class="edit-form-field full-width">' +
        '<label class="edit-form-label">‡∫•‡∫≤‡∫Ñ‡∫≤‡∫ï‡∫ª‡ªâ‡∫ô‡∫ó‡∫∂‡∫ô (N):</label>' +
        '<input type="number" id="editColumnN" class="edit-form-input" value="' + (isSingle && sampleItem ? sampleItem.columnN : '') + '" placeholder="0">' +
        '</div>' +
        // ‚≠ê ‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà
        '<div class="edit-form-field full-width edit-image-field">' +
        '<label class="edit-form-label">‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö (K):</label>' +
        '<div class="edit-image-preview-container">' +
        (currentEditImageUrl ? 
            '<img id="editImagePreview" src="' + currentEditImageUrl + '" class="edit-image-preview">' : 
            '<div class="no-image-placeholder">üì∑</div>') +
        '</div>' +
        '<div class="edit-image-buttons">' +
        '<button type="button" class="edit-image-btn" onclick="selectImageFileForEdit()">üìÅ ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÑ‡∫ü‡∫•‡ªå</button>' +
        '<button type="button" class="edit-image-btn" onclick="takePhotoForEdit()">üì∑ ‡∫ñ‡ªà‡∫≤‡∫ç‡∫Æ‡∫π‡∫ö</button>' +
        '<button type="button" class="edit-image-btn danger" onclick="deleteImageForEdit()">üóëÔ∏è ‡∫•‡∫ª‡∫ö‡∫Æ‡∫π‡∫ö</button>' +
        '</div>' +
        '</div>' +
        '</div>';
    
    editFormModal.classList.add('show');
}

/**
 * ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
 */
window.addEventListener('load', function() {
    const checkDataLoaded = setInterval(function() {
        if (dataLoaded.items) {
            clearInterval(checkDataLoaded);
            createImageCropModal();
        }
    }, 500);
});

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á Options ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Datalist ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function generateCategoryOptionsForDatalist() {
    if (!uniqueCategories || uniqueCategories.length === 0) {
        console.warn('‚ö†Ô∏è uniqueCategories is empty!');
        return '';
    }
    
    let html = '';
    uniqueCategories.forEach(function(cat) {
        html += '<option value="' + cat + '">';
    });
    
    console.log('üìã Generated ' + uniqueCategories.length + ' category options');
    return html;
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á Options ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Datalist ‡πÇ‡∏ã‡∏ô (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */

function generateZoneOptionsForDatalist() {
    if (!uniqueZones || uniqueZones.length === 0) {
        console.warn('‚ö†Ô∏è uniqueZones is empty!');
        return '';
    }
    
    let html = '';
    uniqueZones.forEach(function(zone) {
        html += '<option value="' + zone + '">';
    });
    
    console.log('üìã Generated ' + uniqueZones.length + ' zone options');
    return html;
}


/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á Options ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Datalist ‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function generateUnitOptions() {
    let html = '';
    uniqueUnits.forEach(function(unit) {
        html += '<option value="' + unit + '">';
    });
    return html;
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á Options ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dropdown ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
 */
function generateCategoryOptions(selectedValue) {
    let html = '';
    uniqueCategories.forEach(function(cat) {
        const selected = cat === selectedValue ? 'selected' : '';
        html += '<option value="' + cat + '" ' + selected + '>' + cat + '</option>';
    });
    return html;
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á Options ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dropdown ‡πÇ‡∏ã‡∏ô
 */
function generateZoneOptions(selectedValue) {
    let html = '';
    uniqueZones.forEach(function(zone) {
        const selected = zone === selectedValue ? 'selected' : '';
        html += '<option value="' + zone + '" ' + selected + '>' + zone + '</option>';
    });
    return html;
}

/**
 * ‡∏õ‡∏¥‡∏î‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
 */
function closeEditFormModal() {
    if (editFormModal) {
        editFormModal.classList.remove('show');
    }
}


/**
 * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á Alert ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô)
 */

function saveEditedItems() {
    if (selectedItemsForEdit.size === 0) {
        alert('‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡∫ó‡∫µ‡ªà‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å');
        return;
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
    const editedData = {
        columnB: document.getElementById('editColumnB').value.trim(),
        columnC: parseFloat(document.getElementById('editColumnC').value) || 0,
        columnD: parseFloat(document.getElementById('editColumnD').value) || 0,
        columnF: parseFloat(document.getElementById('editColumnF').value) || 0,
        columnH: document.getElementById('editColumnH').value.trim(),
        columnI: parseFloat(document.getElementById('editColumnI').value) || 1,
        columnL: document.getElementById('editColumnL').value.trim(),
        columnM: document.getElementById('editColumnM').value.trim(),
        columnN: parseFloat(document.getElementById('editColumnN').value) || 0
    };
    
    console.log('Edited data:', editedData);
    console.log('Has new image:', currentEditImageFile !== null);
    console.log('Old images to delete:', oldImagesToDelete);
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const hasChanges = editedData.columnB || 
                       editedData.columnC > 0 || 
                       editedData.columnD > 0 || 
                       editedData.columnF > 0 || 
                       editedData.columnH || 
                       editedData.columnI > 0 || 
                       editedData.columnL || 
                       editedData.columnM || 
                       editedData.columnN > 0 ||
                       currentEditImageFile !== null; // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
    
    if (!hasChanges) {
        alert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÉ‡∫™‡ªà‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ó‡∫µ‡ªà‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç');
        return;
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á Loading
    showSavingAnimation();
    
    // ‚≠ê ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà ‚Üí ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡πà‡∏≠‡∏ô
    if (currentEditImageFile) {
        console.log('üì∏ Uploading new image...');
        
        const fileName = 'edit_' + new Date().getTime() + '.jpg';
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const base64 = e.target.result;
            
            google.script.run
                .withSuccessHandler(function(uploadResult) {
                    if (uploadResult.success) {
                        console.log('‚úÖ Image uploaded:', uploadResult.url);
                        
                        // ‡πÄ‡∏û‡∏¥‡πà‡∏° URL ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô editedData
                        editedData.columnK = uploadResult.url;
                        editedData.columnE = uploadResult.url; // Column E ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
                        
                        // ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πà‡∏≤ + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        deleteOldImagesAndSave(editedData);
                    } else {
                        hideSavingAnimation();
                        alert('‚ùå ‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫≠‡∫±‡∫ö‡ªÇ‡∫´‡∫º‡∫î‡∫Æ‡∫π‡∫ö: ' + uploadResult.error);
                    }
                })
                .withFailureHandler(function(error) {
                    hideSavingAnimation();
                    alert('‚ùå ‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î: ' + error.message);
                })
                .uploadImageToDrive(base64, fileName);
        };
        
        reader.readAsDataURL(currentEditImageFile);
    } else {
        // ‚≠ê ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà ‚Üí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢
        console.log('‚ÑπÔ∏è No new image, saving data only...');
        proceedToSaveEditedItems(editedData);
    }
}

function deleteOldImagesAndSave(editedData) {
    if (oldImagesToDelete.length === 0) {
        console.log('‚ÑπÔ∏è No old images to delete');
        proceedToSaveEditedItems(editedData);
        return;
    }
    
    console.log('üóëÔ∏è Deleting ' + oldImagesToDelete.length + ' old images...');
    
    let deletedCount = 0;
    let failedCount = 0;
    
    oldImagesToDelete.forEach(function(imageUrl) {
        google.script.run
            .withSuccessHandler(function(result) {
                if (result.success) {
                    console.log('‚úÖ Deleted:', imageUrl);
                    deletedCount++;
                } else {
                    console.warn('‚ö†Ô∏è Failed to delete:', imageUrl);
                    failedCount++;
                }
                
                // ‡∏ñ‡πâ‡∏≤‡∏•‡∏ö‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                if (deletedCount + failedCount === oldImagesToDelete.length) {
                    console.log('üóëÔ∏è Delete complete: success=' + deletedCount + ', failed=' + failedCount);
                    proceedToSaveEditedItems(editedData);
                }
            })
            .withFailureHandler(function(error) {
                console.error('‚ùå Error deleting:', imageUrl, error);
                failedCount++;
                
                if (deletedCount + failedCount === oldImagesToDelete.length) {
                    proceedToSaveEditedItems(editedData);
                }
            })
            .deleteOldImageFromDrive(imageUrl);
    });
}

function proceedToSaveEditedItems(editedData) {
    console.log('üíæ Saving edited items...');
    
    const updates = [];
    
    selectedItemsForEdit.forEach(function(barcode) {
        const update = { barcode: barcode };
        
        if (editedData.columnB) update.columnB = editedData.columnB;
        if (editedData.columnC > 0) update.columnC = editedData.columnC;
        if (editedData.columnD > 0) update.columnD = editedData.columnD;
        if (editedData.columnF > 0) update.columnF = editedData.columnF;
        if (editedData.columnH) update.columnH = editedData.columnH;
        if (editedData.columnI > 0) update.columnI = editedData.columnI;
        if (editedData.columnL) update.columnL = editedData.columnL;
        if (editedData.columnM) update.columnM = editedData.columnM;
        if (editedData.columnN > 0) update.columnN = editedData.columnN;
        
        // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° URL ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà
        if (editedData.columnK) {
            update.columnK = editedData.columnK;
            update.columnE = editedData.columnE;
        }
        
        updates.push(update);
    });
    
    console.log('Sending updates:', updates.length);
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                console.log('Updated successfully:', result.updatedCount);
                
                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô itemsData
                selectedItemsForEdit.forEach(function(barcode) {
                    const item = itemsData.get(barcode);
                    if (item) {
                        if (editedData.columnB) item.columnB = editedData.columnB;
                        if (editedData.columnC > 0) item.columnC = editedData.columnC;
                        if (editedData.columnD > 0) item.columnD = editedData.columnD;
                        if (editedData.columnF > 0) item.columnF = editedData.columnF;
                        if (editedData.columnH) item.columnH = editedData.columnH;
                        if (editedData.columnI > 0) item.columnI = editedData.columnI;
                        if (editedData.columnL) item.columnL = editedData.columnL;
                        if (editedData.columnM) item.columnM = editedData.columnM;
                        if (editedData.columnN > 0) item.columnN = editedData.columnN;
                        
                        // ‚≠ê ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ
                        if (editedData.columnK) {
                            item.columnK = editedData.columnK;
                            item.columnE = editedData.columnE;
                        }
                    }
                });
                
                showSuccessAnimation();
                
                setTimeout(function() {
                    hideSavingAnimation();
                    closeEditFormModal();
                    
                    // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                    showFilteredItems();
                    
                    console.log('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', result.updatedCount, '‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô');
                }, 2000);
            } else {
                hideSavingAnimation();
                alert('‚ùå ‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î: ' + result.error);
            }
        })
        .withFailureHandler(function(error) {
            hideSavingAnimation();
            alert('‚ùå ‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î: ' + error.message);
        })
        .updateMultipleItems(updates);
}

/**
 * ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
 */
window.addEventListener('load', function() {
    // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
    const checkDataLoaded = setInterval(function() {
        if (dataLoaded.items) {
            clearInterval(checkDataLoaded);
            createEditItemsButton();
        }
    }, 500);
});
/**
 * ========================================
 * ‚≠ê ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ã‡∏∑‡πâ‡∏≠
 * ========================================
 */

let selectedStoresForDecision = [];
let decisionTableVisible = false;

/**
 * ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function clearOrderTable() {
    if (orderItems.length === 0) {
        alert('‡∫ï‡∫≤‡∫ï‡∫∞‡∫•‡∫≤‡∫á‡∫ß‡ªà‡∫≤‡∫á‡∫¢‡∫π‡ªà‡ªÅ‡∫•‡ªâ‡∫ß');
        return;
    }
    
    if (!confirm('‡∫ó‡ªà‡∫≤‡∫ô‡ªÅ‡∫ô‡ªà‡ªÉ‡∫à‡∫ö‡ªç‡ªà‡∫ß‡ªà‡∫≤‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫•‡ªâ‡∫≤‡∫á‡∫ï‡∫≤‡∫ï‡∫∞‡∫•‡∫≤‡∫á‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î?')) {
        return;
    }
    
    console.log('üóëÔ∏è Clearing order table...');
    
    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    orderItems = [];
    selectedItemsForOrder.clear();
    selectedStoresForDecision = [];
    decisionTableVisible = false;
    // ‚≠ê ‡∏•‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏£‡πâ‡∏≤‡∏ô + ‡∏•‡∏ö class
    const thead = document.querySelector('.order-table thead tr');
    const table = document.querySelector('.order-table');
    
    if (thead) {
        const existingStoreCols = thead.querySelectorAll('.store-column-header');
        existingStoreCols.forEach(col => col.remove());
    }
    
    if (table) {
        table.classList.remove('with-stores');
    }
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç PO ‡πÉ‡∏´‡∏°‡πà
    currentOrderNumber = generateOrderNumber();
    const orderNumberElement = document.getElementById('currentOrderNumber');
    orderNumberElement.textContent = currentOrderNumber;
    orderNumberElement.dataset.isLoaded = 'false';
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    updateOrderTable();
    
    // ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
    const compareSection = document.getElementById('compareSection');
    if (compareSection) compareSection.style.display = 'none';
    
    console.log('‚úÖ Table cleared, new PO:', currentOrderNumber);
}

/**
 * ‡πÅ‡∏™‡∏î‡∏á Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ã‡∏∑‡πâ‡∏≠)
 */
function showDecisionBuyModal() {
    if (orderItems.length === 0) {
        alert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡∫•‡∫ª‡∫á‡ªÉ‡∫ô‡∫ï‡∫≤‡∫ï‡∫∞‡∫•‡∫≤‡∫á‡∫Å‡ªà‡∫≠‡∫ô');
        return;
    }
    
    const modal = document.createElement('div');
    modal.id = 'decisionBuyModal';
    modal.className = 'store-selector-modal show';
    
    modal.innerHTML = '<div class="store-selector-content">' +
        '<div class="store-selector-header">‚úÖ ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫Æ‡ªâ‡∫≤‡∫ô‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫ï‡∫±‡∫î‡∫™‡∫¥‡∫ô‡ªÉ‡∫à‡∫ä‡∫∑‡ªâ</div>' +
        '<input type="text" id="decisionStoreSearchInput" class="store-search-input" placeholder="‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤‡∫Æ‡ªâ‡∫≤‡∫ô..." onkeyup="filterDecisionStores()">' +
        '<div class="store-list" id="decisionStoreListContainer">' + generateDecisionStoreListHTML() + '</div>' +
        '<div class="store-selector-actions">' +
        '<button class="btn-cancel-stores" onclick="closeDecisionBuyModal()">‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>' +
        '<button class="btn-confirm-stores" onclick="confirmDecisionStores()">‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô</button>' +
        '</div>' +
        '</div>';
    
    document.body.appendChild(modal);
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) closeDecisionBuyModal();
    });
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô
 */
function generateDecisionStoreListHTML() {
    if (!storeList || storeList.length === 0) {
        return '<p style="text-align: center; color: #999;">‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫Æ‡ªâ‡∫≤‡∫ô</p>';
    }
    
    let html = '';
    storeList.forEach(function(store) {
        const isSelected = selectedStoresForDecision.includes(store);
        html += '<div class="store-item ' + (isSelected ? 'selected' : '') + '" onclick="toggleDecisionStoreSelection(\'' + store + '\')">';
        html += '<input type="checkbox" class="store-checkbox" value="' + store + '" ' + (isSelected ? 'checked' : '') + ' onchange="event.stopPropagation(); toggleDecisionStoreSelection(\'' + store + '\')">';
        html += '<span>' + store + '</span>';
        html += '</div>';
    });
    
    return html;
}

/**
 * Toggle ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô
 */
function toggleDecisionStoreSelection(storeName) {
    const index = selectedStoresForDecision.indexOf(storeName);
    
    if (index > -1) {
        selectedStoresForDecision.splice(index, 1);
    } else {
        selectedStoresForDecision.push(storeName);
    }
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó UI
    const items = document.querySelectorAll('#decisionStoreListContainer .store-item');
    items.forEach(function(item) {
        const checkbox = item.querySelector('.store-checkbox');
        if (checkbox && checkbox.value === storeName) {
            checkbox.checked = selectedStoresForDecision.includes(storeName);
            if (selectedStoresForDecision.includes(storeName)) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        }
    });
}

/**
 * ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô
 */
function filterDecisionStores() {
    const input = document.getElementById('decisionStoreSearchInput');
    const filter = input.value.toLowerCase();
    const container = document.getElementById('decisionStoreListContainer');
    const items = container.getElementsByClassName('store-item');
    
    for (let i = 0; i < items.length; i++) {
        const text = items[i].textContent || items[i].innerText;
        if (text.toLowerCase().indexOf(filter) > -1) {
            items[i].style.display = '';
        } else {
            items[i].style.display = 'none';
        }
    }
}

/**
 * ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô
 */
function confirmDecisionStores() {
    if (selectedStoresForDecision.length === 0) {
        alert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫Æ‡ªâ‡∫≤‡∫ô‡∫¢‡ªà‡∫≤‡∫á‡ªú‡ªâ‡∫≠‡∫ç 1 ‡∫Æ‡ªâ‡∫≤‡∫ô');
        return;
    }
    
    console.log('‚úÖ Selected stores:', selectedStoresForDecision);
    
    closeDecisionBuyModal();
    generateDecisionTable();
}

/**
 * ‡∏õ‡∏¥‡∏î Modal
 */
function closeDecisionBuyModal() {
    const modal = document.getElementById('decisionBuyModal');
    if (modal) modal.remove();
}
/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ã‡∏∑‡πâ‡∏≠ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏î‡πâ‡∏ß‡∏¢)
 */
function generateDecisionTable() {
    console.log('üé® Generating decision table with stores:', selectedStoresForDecision);
    console.log('üìä priceStudyData size:', priceStudyData.size);
    
    const tbody = document.getElementById('orderTableBody');
    if (!tbody) return;
    
    // ‚≠ê ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô
    const storeData = [];
    
    selectedStoresForDecision.forEach(function(storeName) {
        console.log('\nüè™ Processing store:', storeName);
        
        const data = {
            storeName: storeName,
            items: [],
            total: 0
        };
        
        orderItems.forEach(function(orderItem, idx) {
            const barcode = orderItem.barcode.toString().trim();
            const quantity = orderItem.quantity;
            const mainPrice = orderItem.price; // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å
            
            console.log('  üì¶ Item ' + (idx + 1) + ':', orderItem.itemName, '| Barcode:', barcode);
            
            // ‚≠ê ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡∫™‡∫∂‡∫Å‡∫™‡∫≤‡∫•‡∫≤‡∫Ñ‡∫≤‡∫ï‡∫ª‡ªâ‡∫ô‡∫ó‡∫∂‡∫ô
            const priceStudyItems = priceStudyData.get(barcode);
            let storePrice = null;
            let source = 'main';
            
            if (priceStudyItems && priceStudyItems.length > 0) {
                console.log('    üîç Found price study data:', priceStudyItems.length, 'entries');
                
                // ‚≠ê ‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (‡πÉ‡∏ä‡πâ toLowerCase + trim)
                const matchedItem = priceStudyItems.find(function(item) {
                    const itemStore = (item.store || '').toString().toLowerCase().trim();
                    const targetStore = storeName.toLowerCase().trim();
                    
                    console.log('      Comparing:', itemStore, '===', targetStore, '?', itemStore === targetStore);
                    
                    return itemStore === targetStore;
                });
                
                if (matchedItem) {
                    console.log('    ‚úÖ MATCH FOUND!');
                    console.log('      Store:', matchedItem.store);
                    console.log('      Price (Column H):', matchedItem.price);
                    
                    if (matchedItem.price > 0) {
                        storePrice = matchedItem.price;
                        source = 'priceStudy';
                        console.log('    ‚úÖ Using price from ‡∫™‡∫∂‡∫Å‡∫™‡∫≤‡∫•‡∫≤‡∫Ñ‡∫≤‡∫ï‡∫ª‡ªâ‡∫ô‡∫ó‡∫∂‡∫ô:', storePrice);
                    } else {
                        console.log('    ‚ö†Ô∏è Price is 0, using main table');
                    }
                } else {
                    console.log('    ‚ùå No match found, using main table price');
                }
            } else {
                console.log('    ‚ùå No price study data for this barcode');
            }
            
            // ‚≠ê ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤ ‚Üí ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å
            if (storePrice === null) {
                storePrice = mainPrice;
                source = 'main';
                console.log('    üìã Using main table price:', storePrice);
            }
            
            const total = quantity * storePrice;
            
            data.items.push({
                price: storePrice,
                total: total,
                source: source,
                mainPrice: mainPrice, // ‚≠ê ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
                mainTotal: quantity * mainPrice
            });
            
            data.total += total;
            
            console.log('    üí∞ Final: price=' + storePrice + ', total=' + total + ', source=' + source);
        });
        
        console.log('  üè™ Store total:', data.total);
        storeData.push(data);
    });
    
    console.log('\nüìä All store data:', storeData);
    
    // ‚≠ê ‡∏´‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å)
const cheapestPerRow = [];

orderItems.forEach(function(orderItem, rowIdx) {
    // ‚≠ê ‡πÄ‡∏Å‡πá‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å)
    const storeTotals = [];
    
    storeData.forEach(function(store, storeIdx) {
        storeTotals.push({
            source: 'store_' + storeIdx,
            total: store.items[rowIdx].total
        });
    });
    
    // ‚≠ê ‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
    let minTotal = storeTotals[0].total;
    let cheapestSource = storeTotals[0].source;
    
    for (let i = 1; i < storeTotals.length; i++) {
        if (storeTotals[i].total < minTotal) {
            minTotal = storeTotals[i].total;
            cheapestSource = storeTotals[i].source;
        }
    }
    
    cheapestPerRow.push(cheapestSource);
    
    console.log('Row ' + rowIdx + ' cheapest store:', cheapestSource, 'with total:', minTotal);
});
    
   // ‚≠ê ‡∏´‡∏≤‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å)
const mainTotal = orderItems.reduce(function(sum, item) {
    return sum + (item.quantity * item.price);
}, 0);

// ‚≠ê ‡πÄ‡∏Å‡πá‡∏ö‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
const storeTotals = [];

storeData.forEach(function(store, idx) {
    storeTotals.push({
        source: 'store_' + idx,
        total: store.total
    });
});

// ‚≠ê ‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ñ‡∏π‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
let globalMinTotal = storeTotals[0].total;
let globalCheapestSource = storeTotals[0].source;

for (let i = 1; i < storeTotals.length; i++) {
    if (storeTotals[i].total < globalMinTotal) {
        globalMinTotal = storeTotals[i].total;
        globalCheapestSource = storeTotals[i].source;
    }
}

console.log('üèÜ Global cheapest store:', globalCheapestSource, 'with total:', globalMinTotal);
    
    // ‚≠ê ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML
    let html = '';
    
    orderItems.forEach(function(item, index) {
        const imgHtml = item.image ? 
            '<img src="' + item.image + '" class="order-table-img">' : 
            '<div class="no-order-img">üì∑</div>';
        
       // ‚≠ê ‡πÑ‡∏°‡πà‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏î‡πâ‡∏ß‡∏¢)
html += '<tr>';
html += '<td>' + (index + 1) + '</td>';
html += '<td>' + item.barcode + '</td>';
html += '<td>' + imgHtml + '</td>';
html += '<td>' + item.itemName + '</td>';
html += '<td>' + item.unit + '</td>';
html += '<td><input type="number" class="order-quantity-input" value="' + item.quantity + '" min="1" onchange="updateOrderItemQuantity(' + index + ', this.value)"></td>';
html += '<td>' + item.price.toLocaleString() + '</td>';
html += '<td>' + item.total.toLocaleString() + '</td>'; // ‚≠ê ‡πÑ‡∏°‡πà‡∏°‡∏µ class
        
        // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏£‡πâ‡∏≤‡∏ô
        storeData.forEach(function(store, storeIdx) {
            const itemData = store.items[index];
            const isStoreCheapest = cheapestPerRow[index] === 'store_' + storeIdx;
            
            // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏£‡∏≤‡∏Ñ‡∏≤
            const priceClass = isStoreCheapest ? 'store-price-cell cheapest-store' : 'store-price-cell';
            const sourceLabel = itemData.source === 'main' ? ' <span class="main-table-label">(‡∫ï‡∫≤‡∫ï‡∫∞‡∫•‡∫≤‡∫á‡∫´‡∫º‡∫±‡∫Å)</span>' : '';
            html += '<td class="' + priceClass + '">' + itemData.price.toLocaleString() + sourceLabel + '</td>';
            
            // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
            const totalClass = isStoreCheapest ? 'store-total-cell cheapest-store' : 'store-total-cell';
            html += '<td class="' + totalClass + '">' + itemData.total.toLocaleString() + '</td>';
        });
        
        html += '<td><button class="btn-delete-item" onclick="deleteOrderItem(' + index + ')">‚ùå</button></td>';
        html += '</tr>';
    });
    
    tbody.innerHTML = html;
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Header
    updateDecisionTableHeader();
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Summary (‡∏™‡πà‡∏á globalCheapestSource)
    updateDecisionSummary(storeData, globalCheapestSource, mainTotal);
    
    decisionTableVisible = true;
}
function updateDecisionTableHeader() {
    const thead = document.querySelector('.order-table thead tr');
    const table = document.querySelector('.order-table');
    if (!thead || !table) return;
    
    // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏° class ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á
    table.classList.add('with-stores');
    
    // ‡∏•‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    const existingStoreCols = thead.querySelectorAll('.store-column-header');
    existingStoreCols.forEach(col => col.remove());
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏£‡πâ‡∏≤‡∏ô
    selectedStoresForDecision.forEach(function(storeName) {
        const th1 = document.createElement('th');
        th1.className = 'store-column-header';
        th1.textContent = 'üè™ ' + storeName + ' (‡∫•‡∫≤‡∫Ñ‡∫≤)';
        thead.insertBefore(th1, thead.lastElementChild);
        
        const th2 = document.createElement('th');
        th2.className = 'store-column-header';
        th2.textContent = 'üè™ ' + storeName + ' (‡∫•‡∫ß‡∫°)';
        thead.insertBefore(th2, thead.lastElementChild);
    });
}

/**
 * ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Summary Row (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏î‡πâ‡∏ß‡∏¢)
 */
function updateDecisionSummary(storeData, globalCheapestSource, mainTotal) {
    const tbody = document.getElementById('orderTableBody');
    if (!tbody) return;
    
    // ‡∏•‡∏ö Summary Row ‡πÄ‡∏Å‡πà‡∏≤
    const existingSummary = tbody.querySelector('.summary-row');
    if (existingSummary) existingSummary.remove();
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Summary Row (‡πÑ‡∏°‡πà‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å)
let summaryHTML = '<tr class="summary-row">';
summaryHTML += '<td colspan="7" style="text-align: right;">üí∞ ‡∫•‡∫ß‡∫°‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î:</td>';
summaryHTML += '<td>' + mainTotal.toLocaleString() + ' ‡∫Å‡∫µ‡∫ö</td>'; // ‚≠ê ‡πÑ‡∏°‡πà‡∏°‡∏µ class
    
    storeData.forEach(function(store, idx) {
        const isStoreCheapest = globalCheapestSource === 'store_' + idx;
        const className = isStoreCheapest ? 'summary-store-cell summary-cheapest' : 'summary-store-cell';
        summaryHTML += '<td colspan="2" class="' + className + '">' + store.total.toLocaleString() + ' ‡∫Å‡∫µ‡∫ö</td>';
    });
    
    summaryHTML += '<td></td>';
    summaryHTML += '</tr>';
    
    tbody.insertAdjacentHTML('beforeend', summaryHTML);
    
    updateOrderTotal();
}

/**
 * ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó updateOrderTable() ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ã‡∏∑‡πâ‡∏≠ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
 */
// ‚≠ê ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô updateOrderTable() ‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ
function updateOrderTable() {
    const tbody = document.getElementById('orderTableBody');
    const comparePriceBtn = document.getElementById('comparePriceBtn');
    const decisionBuyBtn = document.getElementById('decisionBuyBtn');
    
    if (!tbody) return;
    
    if (orderItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #999;">‡∫ç‡∫±‡∫á‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ<br>‡∫Å‡∫ª‡∫î‡∫õ‡∫∏‡ªà‡∫° "üîî ‡ªÅ‡∫à‡ªâ‡∫á‡ªÄ‡∫ï‡∫∑‡∫≠‡∫ô‡∫™‡∫∞‡∫ï‡∫±‡∫≠‡∫Å" ‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</td></tr>';
        comparePriceBtn.disabled = true;
        decisionBuyBtn.disabled = true;
        updateOrderTotal();
        
        
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï Header
const thead = document.querySelector('.order-table thead tr');
const table = document.querySelector('.order-table');
if (thead) {
    const existingStoreCols = thead.querySelectorAll('.store-column-header');
    existingStoreCols.forEach(col => col.remove());
}
// ‚≠ê ‡∏•‡∏ö class ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á
if (table) {
    table.classList.remove('with-stores');
}
        decisionTableVisible = false;
        selectedStoresForDecision = [];
        return;
    }
    
    comparePriceBtn.disabled = false;
    decisionBuyBtn.disabled = false;
    
    // ‚≠ê ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ã‡∏∑‡πâ‡∏≠ ‚Üí ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©
    if (decisionTableVisible && selectedStoresForDecision.length > 0) {
        generateDecisionTable();
        return;
    }
    
    // ‚≠ê ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥
    let html = '';
    orderItems.forEach(function(item, index) {
        const highlightClass = selectedItemsForOrder.has(item.barcode) ? 'item-highlighted' : '';
        const imgHtml = item.image ? '<img src="' + item.image + '" class="order-table-img">' : '<div class="no-order-img">üì∑</div>';
        
        html += '<tr class="' + highlightClass + '">';
        html += '<td>' + (index + 1) + '</td>';
        html += '<td>' + item.barcode + '</td>';
        html += '<td>' + imgHtml + '</td>';
        html += '<td>' + item.itemName + '</td>';
        html += '<td>' + item.unit + '</td>';
        html += '<td><input type="number" class="order-quantity-input" value="' + item.quantity + '" min="1" onchange="updateOrderItemQuantity(' + index + ', this.value)"></td>';
        html += '<td>' + item.price.toLocaleString() + '</td>';
        html += '<td>' + (item.quantity * item.price).toLocaleString() + '</td>';
        html += '<td><button class="btn-delete-item" onclick="deleteOrderItem(' + index + ')">‚ùå</button></td>';
        html += '</tr>';
    });
    
    tbody.innerHTML = html;
    updateOrderTotal();
}
/**
 * ========================================
 * ‚≠ê ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: Progress Steps
 * ========================================
 */

/**
 * ‡πÅ‡∏™‡∏î‡∏á Progress Steps Modal
 */
function showProgressSteps() {
    const existingOverlay = document.getElementById('progressStepsOverlay');
    if (existingOverlay) {
        existingOverlay.remove();
    }
    
    const overlay = document.createElement('div');
    overlay.id = 'progressStepsOverlay';
    overlay.className = 'loading-overlay show';
    
    overlay.innerHTML = '<div class="progress-steps-container">' +
        '<div class="progress-steps-title">‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫î‡∫≥‡ªÄ‡∫ô‡∫µ‡∫ô‡∫Å‡∫≤‡∫ô...</div>' +
        '<div class="progress-steps">' +
        '<div class="progress-line">' +
        '<div class="progress-line-fill" id="progressLineFill"></div>' +
        '</div>' +
        '<div class="progress-step" id="step1">' +
        '<div class="progress-step-circle">1</div>' +
        '<div class="progress-step-label">‡∫î‡∫∂‡∫á‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö</div>' +
        '</div>' +
        '<div class="progress-step" id="step2">' +
        '<div class="progress-step-circle">2</div>' +
        '<div class="progress-step-label">‡∫≠‡∫±‡∫ö‡ªÇ‡∫´‡∫º‡∫î PDF</div>' +
        '</div>' +
        '<div class="progress-step" id="step3">' +
        '<div class="progress-step-circle">3</div>' +
        '<div class="progress-step-label">‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫•‡∫ª‡∫á‡∫ñ‡∫≤‡∫ô</div>' +
        '</div>' +
        '</div>' +
        '<div class="progress-spinner"></div>' +
        '<div class="progress-status-text" id="progressStatusText">‡∫Å‡∫≥‡∫•‡∫±‡∫á‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡∫ï‡∫ª‡ªâ‡∫ô...</div>' +
        '</div>';
    
    document.body.appendChild(overlay);
}

/**
 * ‡∏ã‡πà‡∏≠‡∏ô Progress Steps Modal
 */
function hideProgressSteps() {
    const overlay = document.getElementById('progressStepsOverlay');
    if (overlay) {
        overlay.classList.add('fade-out');
        setTimeout(function() {
            overlay.remove();
        }, 300);
    }
}

/**
 * ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á Step
 */
function updateProgressStep(stepNumber, status) {
    const step = document.getElementById('step' + stepNumber);
    if (!step) return;
    
    // ‡∏•‡∏ö class ‡πÄ‡∏Å‡πà‡∏≤
    step.classList.remove('active', 'completed');
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° class ‡πÉ‡∏´‡∏°‡πà
    if (status === 'active' || status === 'completed') {
        step.classList.add(status);
    }
}

/**
 * ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏™‡πâ‡∏ô Progress
 */
function updateProgressLine(percentage) {
    const line = document.getElementById('progressLineFill');
    if (line) {
        line.style.width = percentage + '%';
    }
}

/**
 * ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
 */
function updateProgressStatus(text) {
    const statusText = document.getElementById('progressStatusText');
    if (statusText) {
        statusText.textContent = text;
    }
}

/**
 * ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
 */
function showProgressSuccess() {
    const spinner = document.querySelector('.progress-spinner');
    const statusText = document.getElementById('progressStatusText');
    
    if (spinner) {
        spinner.style.display = 'none';
    }
    
    if (statusText) {
        statusText.innerHTML = '<div class="progress-success-icon">‚úÖ</div>' +
            '<div style="font-size: 1.3rem; font-weight: bold; color: #4caf50;">‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î!</div>';
    }
}


/**
 * ========================================
 * ‚≠ê ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å - Frontend (‡πÉ‡∏´‡∏°‡πà)
 * ========================================
 */

let editChoiceModal = null;
let scanBarcodeModal = null;
let addItemsModal = null;
let existingItemModal = null;
let dynamicFormsData = [];
let currentScannedBarcode = '';

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function createEditChoiceModal() {
    if (document.getElementById('editChoiceModal')) return;
    
    const modal = document.createElement('div');
    modal.id = 'editChoiceModal';
    modal.className = 'edit-choice-modal';
    
    modal.innerHTML = '<div class="edit-choice-content">' +
        '<h2 class="edit-choice-title">‚úèÔ∏è ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫ü‡∫±‡∫á‡∫ä‡∫±‡∫ô</h2>' +
        '<div class="edit-choice-buttons">' +
        '<button class="edit-choice-btn btn-choice-edit" onclick="openEditExistingItems()">‚úèÔ∏è ‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</button>' +
        '<button class="edit-choice-btn btn-choice-add" onclick="openScanBarcodeModal()">‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡∫™‡∫∞‡∫ï‡∫±‡∫≠‡∫Å</button>' +
        '<button class="edit-choice-btn btn-choice-cancel" onclick="closeEditChoiceModal()">‚ùå ‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>' +
        '</div>' +
        '</div>';
    
    document.body.appendChild(modal);
    editChoiceModal = modal;
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) closeEditChoiceModal();
    });
}

/**
 * ‡πÅ‡∏™‡∏î‡∏á Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function showEditChoiceModal() {
    if (!editChoiceModal) {
        createEditChoiceModal();
    }
    editChoiceModal.classList.add('show');
}

/**
 * ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function closeEditChoiceModal() {
    if (editChoiceModal) {
        editChoiceModal.classList.remove('show');
    }
}

/**
 * ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏° (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function openEditExistingItems() {
    closeEditChoiceModal();
    
    // ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏î‡∏¥‡∏°
    if (!editItemsModal) return;
    
    loadEditDropdownData();
    editItemsModal.classList.add('show');
}
/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á Modal ‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: Auto Confirm)
 */
function createScanBarcodeModal() {
    if (document.getElementById('scanBarcodeModal')) return;
    
    const modal = document.createElement('div');
    modal.id = 'scanBarcodeModal';
    modal.className = 'scan-barcode-modal';
    
    modal.innerHTML = '<div class="scan-barcode-content">' +
        '<h2 class="scan-barcode-title">üì∑ ‡∫™‡∫∞‡ªÅ‡∫Å‡∫ô‡∫ö‡∫≤‡ªÇ‡∫Ñ‡∫î‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤</h2>' +
        '<input type="text" id="scanBarcodeInput" class="scan-barcode-input" placeholder="‡∫™‡∫∞‡ªÅ‡∫Å‡∫ô ‡∫´‡∫º‡∫∑ ‡∫û‡∫¥‡∫°‡∫ö‡∫≤‡ªÇ‡∫Ñ‡∫î..." autofocus>' +
        '<div class="scan-barcode-actions">' +
        '<button class="btn-scan-cancel" onclick="closeScanBarcodeModal()">‚ùå ‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>' +
        '</div>' +
        '</div>';
    
    document.body.appendChild(modal);
    scanBarcodeModal = modal;
    
    // ‚≠ê ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏î Enter + Auto Confirm ‡∏´‡∏•‡∏±‡∏á 500ms
    const input = document.getElementById('scanBarcodeInput');
    let autoConfirmTimer = null;
    
    input.addEventListener('input', function() {
        // Clear timer ‡πÄ‡∏î‡∏¥‡∏°
        if (autoConfirmTimer) {
            clearTimeout(autoConfirmTimer);
        }
        
        const barcode = this.value.trim();
        
        if (barcode) {
            // ‚≠ê ‡∏£‡∏≠ 500ms ‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            autoConfirmTimer = setTimeout(function() {
                confirmScannedBarcode();
            }, 500);
        }
    });
    
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            // Clear timer
            if (autoConfirmTimer) {
                clearTimeout(autoConfirmTimer);
            }
            confirmScannedBarcode();
        }
    });
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) closeScanBarcodeModal();
    });
}

/**
 * ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function openScanBarcodeModal() {
    closeEditChoiceModal();
    
    if (!scanBarcodeModal) {
        createScanBarcodeModal();
    }
    
    scanBarcodeModal.classList.add('show');
    
    // Focus ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô
    setTimeout(function() {
        const input = document.getElementById('scanBarcodeInput');
        if (input) {
            input.value = '';
            input.focus();
        }
    }, 100);
}

/**
 * ‡∏õ‡∏¥‡∏î Modal ‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function closeScanBarcodeModal() {
    if (scanBarcodeModal) {
        scanBarcodeModal.classList.remove('show');
    }
}

/**
 * ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function confirmScannedBarcode() {
    const input = document.getElementById('scanBarcodeInput');
    const barcode = input.value.trim();
    
    if (!barcode) {
        alert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÉ‡∫™‡ªà‡∫ö‡∫≤‡ªÇ‡∫Ñ‡∫î');
        input.focus();
        return;
    }
    
    console.log('üì∑ Scanned barcode:', barcode);
    
    currentScannedBarcode = barcode;
    closeScanBarcodeModal();
    
    // ‡πÅ‡∏™‡∏î‡∏á Loading
    showLoadingOverlay('‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫Å‡∫ß‡∫î‡∫™‡∫≠‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô...', '‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫•‡ªç‡∫ñ‡ªâ‡∫≤‡∫™‡∫±‡∫Å‡∫Ñ‡∫π‡ªà');
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    google.script.run
        .withSuccessHandler(handleBarcodeCheckResult)
        .withFailureHandler(function(error) {
            hideLoadingOverlay();
            alert('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î: ' + error.message);
        })
        .checkBarcodeExists(barcode);
}

/**
 * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function handleBarcodeCheckResult(result) {
    hideLoadingOverlay();
    
    console.log('Check result:', result);
    
    if (result.exists) {
        // Case B: ‡∏°‡∏µ‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÅ‡∏™‡∏î‡∏á Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å
        showExistingItemModal(result.data);
    } else {
        // Case A: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î Dynamic Form
        openAddItemsModal(currentScannedBarcode);
    }
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á Modal Dynamic Form (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function createAddItemsModal() {
    if (document.getElementById('addItemsModal')) return;
    
    const modal = document.createElement('div');
    modal.id = 'addItemsModal';
    modal.className = 'add-items-modal';
    
    modal.innerHTML = '<div class="add-items-content">' +
        '<div class="add-items-header">' +
        '<h2 class="add-items-title">‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡∫™‡∫∞‡∫ï‡∫±‡∫≠‡∫Å</h2>' +
        '<button class="add-close-btn" onclick="closeAddItemsModal()">√ó</button>' +
        '</div>' +
        '<div id="dynamicFormsContainer" class="dynamic-forms-container"></div>' +
        '<div class="add-items-footer">' +
        '<button class="btn-save-all-items" onclick="saveAllDynamicForms()">üíæ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î</button>' +
        '<button class="btn-cancel-add-items" onclick="closeAddItemsModal()">‚ùå ‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>' +
        '</div>' +
        '</div>';
    
    document.body.appendChild(modal);
    addItemsModal = modal;
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            // ‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å Modal
        }
    });
}

/**
 * ‡πÄ‡∏õ‡∏¥‡∏î Modal Dynamic Form (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */

function openAddItemsModal(barcode) {
    if (!addItemsModal) {
        createAddItemsModal();
    }
    
    // ‚≠ê ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Dropdown ‡∏Å‡πà‡∏≠‡∏ô
    console.log('üìä Loading dropdown data for add items...');
    loadEditDropdownData(); // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    dynamicFormsData = [];
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏µ‡πà 1
    dynamicFormsData.push({
        formNumber: 1,
        columnA: barcode,
        columnB: '',
        columnC: '',
        columnD: '',
        columnE: '',
        columnF: '',
        columnH: '',
        columnI: '',
        columnJ: '',
        columnK: '',
        columnL: '',
        columnM: '',
        columnN: '',
        imageFile: null,
        imagePreview: null
    });
    
    console.log('‚úÖ Form data initialized');
    console.log('üìã Zones available:', uniqueZones.length);
    console.log('üìã Categories available:', uniqueCategories.length);
    
    renderDynamicForms();
    addItemsModal.classList.add('show');
}


/**
 * ‡∏õ‡∏¥‡∏î Modal Dynamic Form (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */

function closeAddItemsModal() {
    if (addItemsModal) {
        if (dynamicFormsData.length > 0) {
            if (!confirm('‡∫ó‡ªà‡∫≤‡∫ô‡ªÅ‡∫ô‡ªà‡ªÉ‡∫à‡∫ö‡ªç‡ªà‡∫ß‡ªà‡∫≤‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫õ‡∫¥‡∫î? ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ó‡∫µ‡ªà‡∫ö‡ªç‡ªà‡ªÑ‡∫î‡ªâ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫à‡∫∞‡∫™‡∫π‡∫ô‡∫´‡∫≤‡∫ç')) {
                return;
            }
        }
        
        // ‚≠ê ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        console.log('üßπ Cleaning up modal...');
        dynamicFormsData = [];
        currentScannedBarcode = '';
        lastRenderedState = null;
        
        // ‚≠ê ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå HTML ‡πÉ‡∏ô Container
        const container = document.getElementById('dynamicFormsContainer');
        if (container) {
            container.innerHTML = '';
        }
        
        addItemsModal.classList.remove('show');
        console.log('‚úÖ Modal closed and cleaned');
    }
}


/**
 * ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Dynamic Forms (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */

function renderDynamicForms() {
    const container = document.getElementById('dynamicFormsContainer');
    if (!container) return;
    
    console.log('üé® Rendering ' + dynamicFormsData.length + ' forms...');
    console.log('üìã Zones:', uniqueZones.length);
    console.log('üìã Categories:', uniqueCategories.length);
    
    container.innerHTML = '';
    
    dynamicFormsData.forEach(function(formData, index) {
        const formHTML = generateFormHTML(formData, index);
        container.insertAdjacentHTML('beforeend', formHTML);
    });
    
    // ‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Datalist ‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    setTimeout(function() {
        const testDatalist = document.getElementById('categoryDatalist_0');
        if (testDatalist) {
            console.log('‚úÖ Datalist created, options:', testDatalist.options.length);
        } else {
            console.error('‚ùå Datalist not found!');
        }
    }, 100);
    
    // Bind events
    bindDynamicFormEvents();
}
/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)
 */

function generateFormHTML(formData, index) {
    const formNumber = formData.formNumber;
    const isFirstForm = index === 0;
    const canAddMore = dynamicFormsData.length < 3;
    
    // ‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    const isComplete = checkFormComplete(formData);
    
    console.log('üìù Generating form ' + formNumber + ', isComplete:', isComplete, ', canAddMore:', canAddMore);
    
    let html = '<div class="dynamic-form-item" data-form-index="' + index + '">';
    
    // Header ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°)
    html += '<div class="form-item-header">';
    html += '<div class="form-item-number">üìù ‡∫ü‡∫≠‡∫£‡ªå‡∫ó‡∫µ ' + formNumber + '</div>';
    html += '</div>';
    
    html += '<div class="form-fields-grid">';
    
    // Column A - ‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤
    html += '<div class="form-field">';
    html += '<label class="form-field-label">‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤ (A) <span class="required">*</span></label>';
    if (isFirstForm) {
        html += '<input type="text" class="form-field-input" value="' + formData.columnA + '" disabled>';
    } else {
        html += '<input type="text" class="form-field-input" data-field="columnA" data-index="' + index + '" value="' + formData.columnA + '" placeholder="‡ªÉ‡∫™‡ªà‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤...">';
    }
    html += '</div>';
    
    // Column B - ‡∫ä‡∫∑‡ªà‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô
    html += '<div class="form-field">';
    html += '<label class="form-field-label">‡∫ä‡∫∑‡ªà‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô (B) <span class="required">*</span></label>';
    if (isFirstForm) {
        html += '<input type="text" class="form-field-input" data-field="columnB" data-index="' + index + '" value="' + formData.columnB + '" placeholder="‡ªÉ‡∫™‡ªà‡∫ä‡∫∑‡ªà‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤...">';
    } else {
        html += '<input type="text" class="form-field-input" value="' + formData.columnB + '" disabled>';
    }
    html += '</div>';
    
    // Column C - ‡∫•‡∫≤‡∫Ñ‡∫≤‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤
    html += '<div class="form-field">';
    html += '<label class="form-field-label">‡∫•‡∫≤‡∫Ñ‡∫≤‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤ (C) <span class="required">*</span></label>';
    html += '<input type="number" class="form-field-input" data-field="columnC" data-index="' + index + '" value="' + formData.columnC + '" placeholder="0" min="0">';
    html += '</div>';
    
    // Column D - ‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡ªÅ‡∫à‡ªâ‡∫á‡ªÄ‡∫ï‡∫∑‡∫≠‡∫ô (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
    html += '<div class="form-field">';
    html += '<label class="form-field-label">‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡ªÅ‡∫à‡ªâ‡∫á‡ªÄ‡∫ï‡∫∑‡∫≠‡∫ô (D)</label>';
    if (isFirstForm) {
        html += '<input type="number" class="form-field-input" data-field="columnD" data-index="' + index + '" value="' + formData.columnD + '" placeholder="0 (‡∫ö‡ªç‡ªà‡∫ö‡∫±‡∫á‡∫Ñ‡∫±‡∫ö)" min="0">';
    } else {
        html += '<input type="number" class="form-field-input" value="' + formData.columnD + '" disabled>';
    }
    html += '</div>';
    
    // Column F - ‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡ªÄ‡∫´‡∫º‡∫∑‡∫≠ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
    html += '<div class="form-field">';
    html += '<label class="form-field-label">‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡ªÄ‡∫´‡∫º‡∫∑‡∫≠ (F)</label>';
    if (isFirstForm) {
        html += '<input type="number" class="form-field-input" data-field="columnF" data-index="' + index + '" value="' + formData.columnF + '" placeholder="0 (‡∫ö‡ªç‡ªà‡∫ö‡∫±‡∫á‡∫Ñ‡∫±‡∫ö)" min="0">';
    } else {
        html += '<input type="number" class="form-field-input" value="' + formData.columnF + '" disabled>';
    }
    html += '</div>';
    
    // Column H - ‡∫´‡∫ª‡∫ß‡ªú‡ªà‡∫ß‡∫ç
    html += '<div class="form-field">';
    html += '<label class="form-field-label">‡∫´‡∫ª‡∫ß‡ªú‡ªà‡∫ß‡∫ç (H) <span class="required">*</span></label>';
    html += '<select class="form-field-select" data-field="columnH" data-index="' + index + '">';
    html += '<option value="">-- ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫´‡∫ª‡∫ß‡ªú‡ªà‡∫ß‡∫ç --</option>';
    
    if (isFirstForm) {
        html += '<option value="‡ªÅ‡∫Å‡∫±‡∫î"' + (formData.columnH === '‡ªÅ‡∫Å‡∫±‡∫î' ? ' selected' : '') + '>‡ªÅ‡∫Å‡∫±‡∫î</option>';
        html += '<option value="‡ªÅ‡∫û‡∫±‡∫Å"' + (formData.columnH === '‡ªÅ‡∫û‡∫±‡∫Å' ? ' selected' : '') + '>‡ªÅ‡∫û‡∫±‡∫Å</option>';
        html += '<option value="‡ªÄ‡∫õ‡∫±‡∫ô‡∫≠‡∫±‡∫ô"' + (formData.columnH === '‡ªÄ‡∫õ‡∫±‡∫ô‡∫≠‡∫±‡∫ô' ? ' selected' : '') + '>‡ªÄ‡∫õ‡∫±‡∫ô‡∫≠‡∫±‡∫ô</option>';
    } else {
        const prevUnit = dynamicFormsData[0].columnH;
        if (prevUnit === '‡ªÅ‡∫Å‡∫±‡∫î') {
            html += '<option value="‡ªÅ‡∫û‡∫±‡∫Å"' + (formData.columnH === '‡ªÅ‡∫û‡∫±‡∫Å' ? ' selected' : '') + '>‡ªÅ‡∫û‡∫±‡∫Å</option>';
            html += '<option value="‡ªÄ‡∫õ‡∫±‡∫ô‡∫≠‡∫±‡∫ô"' + (formData.columnH === '‡ªÄ‡∫õ‡∫±‡∫ô‡∫≠‡∫±‡∫ô' ? ' selected' : '') + '>‡ªÄ‡∫õ‡∫±‡∫ô‡∫≠‡∫±‡∫ô</option>';
        } else if (prevUnit === '‡ªÅ‡∫û‡∫±‡∫Å') {
            html += '<option value="‡ªÄ‡∫õ‡∫±‡∫ô‡∫≠‡∫±‡∫ô"' + (formData.columnH === '‡ªÄ‡∫õ‡∫±‡∫ô‡∫≠‡∫±‡∫ô' ? ' selected' : '') + '>‡ªÄ‡∫õ‡∫±‡∫ô‡∫≠‡∫±‡∫ô</option>';
        }
    }
    
    html += '</select>';
    html += '</div>';
    
    // Column I - ‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡∫ï‡ªç‡ªà‡ªú‡ªà‡∫ß‡∫ç
    html += '<div class="form-field">';
    html += '<label class="form-field-label">‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡∫ï‡ªç‡ªà‡ªú‡ªà‡∫ß‡∫ç (I) <span class="required">*</span></label>';
    html += '<input type="number" class="form-field-input" data-field="columnI" data-index="' + index + '" value="' + formData.columnI + '" placeholder="1" min="1">';
    html += '</div>';
    
    // Column J - ‡∫•‡∫∞‡∫´‡∫±‡∫î‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡ªÇ‡∫ç‡∫á
    html += '<div class="form-field">';
    html += '<label class="form-field-label">‡∫•‡∫∞‡∫´‡∫±‡∫î‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡ªÇ‡∫ç‡∫á (J) <span class="required">*</span></label>';
    if (isFirstForm) {
        html += '<input type="text" class="form-field-input" data-field="columnJ" data-index="' + index + '" value="' + formData.columnJ + '" placeholder="‡ªÉ‡∫™‡ªà‡∫•‡∫∞‡∫´‡∫±‡∫î‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡ªÇ‡∫ç‡∫á...">';
    } else {
        html += '<input type="text" class="form-field-input" value="' + formData.columnJ + '" disabled>';
    }
    html += '</div>';
    
    // Column K - ‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö
    html += '<div class="form-field full-width">';
    html += '<label class="form-field-label">‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö (K) <span class="required">*</span></label>';
    
    if (isFirstForm) {
        html += '<div class="image-upload-container">';
        html += '<input type="file" id="imageFileInput_' + index + '" accept="image/*" style="display: none;" onchange="handleImageFileSelect(' + index + ', event)">';
        html += '<button class="btn-upload-file" onclick="document.getElementById(\'imageFileInput_' + index + '\').click()">üìÅ ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÑ‡∫ü‡∫•‡ªå</button>';
        html += '<button class="btn-take-photo" onclick="openCameraForForm(' + index + ')">üì∑ ‡∫ñ‡ªà‡∫≤‡∫ç‡∫Æ‡∫π‡∫ö</button>';
        html += '</div>';
    }
    
    if (formData.imagePreview) {
        html += '<img src="' + formData.imagePreview + '" class="image-preview" id="imagePreview_' + index + '">';
    } else if (!isFirstForm) {
        html += '<div style="padding: 20px; text-align: center; color: #999; border: 2px dashed #e0e0e0; border-radius: 10px;">‡∫•‡ªç‡∫ñ‡ªâ‡∫≤‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö‡∫à‡∫≤‡∫Å‡∫ü‡∫≠‡∫£‡ªå‡∫ó‡∫µ 1...</div>';
    }
    
    html += '</div>';
    
    // Column L - ‡ªù‡∫ß‡∫î‡ªù‡∫π‡ªà‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤
    html += '<div class="form-field">';
    html += '<label class="form-field-label">‡ªù‡∫ß‡∫î‡ªù‡∫π‡ªà‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤ (L) <span class="required">*</span></label>';
    if (isFirstForm) {
        html += '<input list="categoryDatalist_' + index + '" class="form-field-input" data-field="columnL" data-index="' + index + '" value="' + formData.columnL + '" placeholder="‡∫û‡∫¥‡∫° ‡∫´‡∫º‡∫∑ ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªù‡∫ß‡∫î‡ªù‡∫π‡ªà...">';
        html += '<datalist id="categoryDatalist_' + index + '">' + generateCategoryOptionsForDatalist() + '</datalist>';
    } else {
        html += '<input type="text" class="form-field-input" value="' + formData.columnL + '" disabled>';
    }
    html += '</div>';
    
    // Column M - ‡ªÇ‡∫ä‡∫ô‡∫ß‡∫≤‡∫á‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤
    html += '<div class="form-field">';
    html += '<label class="form-field-label">‡ªÇ‡∫ä‡∫ô‡∫ß‡∫≤‡∫á‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤ (M) <span class="required">*</span></label>';
    if (isFirstForm) {
        html += '<input list="zoneDatalist_' + index + '" class="form-field-input" data-field="columnM" data-index="' + index + '" value="' + formData.columnM + '" placeholder="‡∫û‡∫¥‡∫° ‡∫´‡∫º‡∫∑ ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÇ‡∫ä‡∫ô...">';
        html += '<datalist id="zoneDatalist_' + index + '">' + generateZoneOptionsForDatalist() + '</datalist>';
    } else {
        html += '<input type="text" class="form-field-input" value="' + formData.columnM + '" disabled>';
    }
    html += '</div>';
    
    // Column N - ‡∫•‡∫≤‡∫Ñ‡∫≤‡∫ï‡∫ª‡ªâ‡∫ô‡∫ó‡∫∂‡∫ô
    html += '<div class="form-field full-width">';
    html += '<label class="form-field-label">‡∫•‡∫≤‡∫Ñ‡∫≤‡∫ï‡∫ª‡ªâ‡∫ô‡∫ó‡∫∂‡∫ô (N)</label>';
    html += '<input type="number" class="form-field-input" data-field="columnN" data-index="' + index + '" value="' + formData.columnN + '" placeholder="0 (‡∫ö‡ªç‡ªà‡∫ö‡∫±‡∫á‡∫Ñ‡∫±‡∫ö)" min="0">';
    html += '</div>';
    
    html += '</div>'; // form-fields-grid
    
    // ‚≠ê Footer: ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏°‡∏≠
    html += '<div class="form-item-footer">';
    
    // ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏£‡∏Å)
    if (!isFirstForm) {
        html += '<button class="btn-delete-form-bottom" onclick="deleteDynamicForm(' + index + ')">üóëÔ∏è ‡∫•‡∫ª‡∫ö‡∫ü‡∫≠‡∫£‡ªå‡∫ô‡∫µ‡ªâ</button>';
    }
    
    // ‚≠ê ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏™‡∏°‡∏≠ (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á 3 ‡∏ü‡∏≠‡∏£‡πå‡∏°)
    if (canAddMore) {
        if (isComplete) {
            // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö ‚Üí ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
            html += '<button class="btn-add-form-bottom" onclick="addNewDynamicForm(' + index + ')">‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫ü‡∫≠‡∫£‡ªå‡∫ï‡ªç‡ªà‡ªÑ‡∫õ</button>';
        } else {
            // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‚Üí ‡∏õ‡∏∏‡πà‡∏° Disabled
            html += '<button class="btn-add-form-bottom" onclick="addNewDynamicForm(' + index + ')" disabled style="opacity: 0.5; cursor: not-allowed;">‚ûï ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫Å‡¨∞‡∫≠‡∫Å‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÉ‡∫´‡ªâ‡∫Ñ‡∫ª‡∫ö‡∫Å‡ªà‡∫≠‡∫ô</button>';
        }
    }
    
    html += '</div>'; // form-item-footer
    
    html += '</div>'; // dynamic-form-item
    
    return html;
}

/**
 * Bind Events (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÑ‡∏°‡πà Re-render ‡∏Ç‡∏ì‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå)
 */
let formInputDebounceTimer = null;
let lastRenderedState = null; // ‚≠ê ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î

function bindDynamicFormEvents() {
    const inputs = document.querySelectorAll('.form-field-input, .form-field-select');
    
    inputs.forEach(function(input) {
        input.addEventListener('input', function() {
            const field = this.dataset.field;
            const index = parseInt(this.dataset.index);
            
            if (field && index >= 0) {
                dynamicFormsData[index][field] = this.value;
                
                // ‚≠ê ‡∏´‡∏ô‡πà‡∏ß‡∏¢ "‡ªÄ‡∫õ‡∫±‡∫ô‡∫≠‡∫±‡∫ô" ‚Üí Auto set I = 1
                if (field === 'columnH' && this.value === '‡ªÄ‡∫õ‡∫±‡∫ô‡∫≠‡∫±‡∫ô') {
                    dynamicFormsData[index].columnI = '1';
                }
                
                if (index === 0) {
                    syncFormDataFromFirstWithoutRender(field, this.value);
                }
                
                validateDynamicForm(index);
                
                // ‚≠ê ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (‡πÑ‡∏°‡πà Re-render)
                if (formInputDebounceTimer) {
                    clearTimeout(formInputDebounceTimer);
                }
                
                formInputDebounceTimer = setTimeout(function() {
                    const isComplete = checkFormComplete(dynamicFormsData[index]);
                    const currentState = JSON.stringify({ complete: isComplete, forms: dynamicFormsData.length });
                    
                    // ‚≠ê Re-render ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
                    if (currentState !== lastRenderedState) {
                        console.log('‚úÖ State changed, re-rendering...');
                        lastRenderedState = currentState;
                        renderDynamicForms();
                    }
                }, 1500); // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô 1.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            }
        });
        
        input.addEventListener('change', function() {
            const field = this.dataset.field;
            const index = parseInt(this.dataset.index);
            
            if (field && index >= 0) {
                dynamicFormsData[index][field] = this.value;
                
                // ‚≠ê ‡∏´‡∏ô‡πà‡∏ß‡∏¢ "‡ªÄ‡∫õ‡∫±‡∫ô‡∫≠‡∫±‡∫ô" ‚Üí Auto set I = 1
                if (field === 'columnH' && this.value === '‡ªÄ‡∫õ‡∫±‡∫ô‡∫≠‡∫±‡∫ô') {
                    dynamicFormsData[index].columnI = '1';
                }
                
                if (index === 0) {
                    syncFormDataFromFirstWithoutRender(field, this.value);
                }
                
                validateDynamicForm(index);
                
                if (formInputDebounceTimer) {
                    clearTimeout(formInputDebounceTimer);
                }
                
                const isComplete = checkFormComplete(dynamicFormsData[index]);
                const currentState = JSON.stringify({ complete: isComplete, forms: dynamicFormsData.length });
                
                if (currentState !== lastRenderedState) {
                    lastRenderedState = currentState;
                    renderDynamicForms();
                }
            }
        });
    });
}
/**
 * ‚≠ê Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏° 1 ‚Üí ‡∏ü‡∏≠‡∏£‡πå‡∏° 2, 3 (‡πÑ‡∏°‡πà Re-render)
 */
function syncFormDataFromFirstWithoutRender(field, value) {
    const syncFields = ['columnB', 'columnD', 'columnF', 'columnJ', 'columnL', 'columnM'];
    
    if (syncFields.indexOf(field) === -1) {
        return;
    }
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô memory ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÑ‡∏°‡πà Re-render)
    for (let i = 1; i < dynamicFormsData.length; i++) {
        dynamicFormsData[i][field] = value;
    }
}

/**
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: Debug + ‡πÅ‡∏Å‡πâ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç)
 */

function checkFormComplete(formData) {
    console.log('üîç Checking form completion...');
    console.log('Form data:', formData);
    
    // ‚≠ê ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö (‡∏•‡∏î‡∏•‡∏á)
    const required = ['columnA', 'columnB', 'columnC', 'columnH', 'columnI', 'columnJ', 'columnL', 'columnM'];
    
    for (let i = 0; i < required.length; i++) {
        const field = required[i];
        const value = formData[field];
        
        // ‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ 0 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)
        if (!value || value.toString().trim() === '') {
            console.log('‚ùå Field ' + field + ' is empty:', value);
            return false;
        }
    }
    
    // ‚≠ê ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏£‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏£‡∏π‡∏õ
    if (formData.formNumber === 1) {
        if (!formData.imageFile && !formData.imagePreview) {
            console.log('‚ùå Form 1 missing image');
            return false;
        }
    }
    
    console.log('‚úÖ Form is complete!');
    return true;
}

/**
 * Validate ‡∏ü‡∏≠‡∏£‡πå‡∏° Real-time (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function validateDynamicForm(index) {
    const formData = dynamicFormsData[index];
    const formElement = document.querySelector('.dynamic-form-item[data-form-index="' + index + '"]');
    
    if (!formElement) return;
    
    let hasError = false;
    
    // ‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ã‡πâ‡∏≥
    const barcode = formData.columnA;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö Items Table
    const existsInTable = itemsData.has(barcode);
    
    if (existsInTable && index === 0) {
        // ‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        formElement.classList.add('form-error');
        hasError = true;
    } else {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ã‡πâ‡∏≥‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
        const duplicateInForms = dynamicFormsData.some(function(otherForm, otherIndex) {
            return otherIndex !== index && otherForm.columnA === barcode;
        });
        
        if (duplicateInForms) {
            formElement.classList.add('form-error');
            hasError = true;
        }
    }
    
    // ‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
    if (dynamicFormsData.length > 1) {
        const priceC = parseFloat(formData.columnC) || 0;
        
        const duplicatePrice = dynamicFormsData.some(function(otherForm, otherIndex) {
            if (otherIndex === index) return false;
            const otherPrice = parseFloat(otherForm.columnC) || 0;
            return priceC > 0 && priceC === otherPrice;
        });
        
        if (duplicatePrice) {
            const priceInput = formElement.querySelector('[data-field="columnC"]');
            if (priceInput) {
                priceInput.classList.add('error');
            }
            hasError = true;
        }
    }
    
    // ‚≠ê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ü‡∏≠‡∏£‡πå‡∏° 1 > ‡∏ü‡∏≠‡∏£‡πå‡∏° 2 > ‡∏ü‡∏≠‡∏£‡πå‡∏° 3)
    if (index > 0) {
        const currentPrice = parseFloat(formData.columnC) || 0;
        const prevPrice = parseFloat(dynamicFormsData[index - 1].columnC) || 0;
        
        if (currentPrice > 0 && prevPrice > 0 && currentPrice >= prevPrice) {
            const priceInput = formElement.querySelector('[data-field="columnC"]');
            if (priceInput) {
                priceInput.classList.add('error');
            }
            hasError = true;
        }
    }
    
    if (!hasError) {
        formElement.classList.remove('form-error');
        
        const inputs = formElement.querySelectorAll('.form-field-input');
        inputs.forEach(function(input) {
            input.classList.remove('error');
        });
    }
}

/**
 * ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡∏°‡πà (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function addNewDynamicForm(currentIndex) {
    if (dynamicFormsData.length >= 3) {
        alert('‡∫™‡∫≤‡∫°‡∫≤‡∫î‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡ªÑ‡∫î‡ªâ‡∫™‡∫π‡∫á‡∫™‡∫∏‡∫î 3 ‡∫ü‡∫≠‡∫£‡ªå‡ªÄ‡∫ó‡∫ª‡ªà‡∫≤‡∫ô‡∫±‡ªâ‡∫ô');
        return;
    }
    
    const currentForm = dynamicFormsData[currentIndex];
    
    if (!checkFormComplete(currentForm)) {
        alert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫Å‡∏£‡∫≠‡∫Å‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÉ‡∫´‡ªâ‡∫Ñ‡∫ª‡∫ö‡∫Å‡ªà‡∫≠‡∫ô');
        return;
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const newForm = {
        formNumber: dynamicFormsData.length + 1,
        columnA: '', // ‚≠ê ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà
        columnB: currentForm.columnB,
        columnC: '', // ‚≠ê ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà
        columnD: currentForm.columnD,
        columnE: currentForm.columnE, // ‡∏£‡∏π‡∏õ
        columnF: currentForm.columnF,
        columnH: '', // ‚≠ê ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà
        columnI: '', // ‚≠ê ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà
        columnJ: currentForm.columnJ,
        columnK: currentForm.columnK, // ‡∏£‡∏π‡∏õ
        columnL: currentForm.columnL,
        columnM: currentForm.columnM,
        columnN: '',
        imageFile: currentForm.imageFile,
        imagePreview: currentForm.imagePreview
    };
    
    dynamicFormsData.push(newForm);
    renderDynamicForms();
}

/**
 * ‡∏•‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function deleteDynamicForm(index) {
    if (index === 0) {
        alert('‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡∫•‡∫ª‡∫ö‡∫ü‡∫≠‡∫£‡ªå‡∫ó‡∫µ 1 ‡ªÑ‡∫î‡ªâ');
        return;
    }
    
    if (!confirm('‡∫ó‡ªà‡∫≤‡∫ô‡ªÅ‡∫ô‡ªà‡ªÉ‡∫à‡∫ö‡ªç‡ªà‡∫ß‡ªà‡∫≤‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫•‡∫ª‡∫ö‡∫ü‡∫≠‡∫£‡ªå‡∫ô‡∫µ‡ªâ?')) {
        return;
    }
    
    dynamicFormsData.splice(index, 1);
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ü‡∏≠‡∏£‡πå‡∏°
    dynamicFormsData.forEach(function(form, idx) {
        form.formNumber = idx + 1;
    });
    
    renderDynamicForms();
}
/**
 * ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: Re-render ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ)
 */
function handleImageFileSelect(index, event) {
    const file = event.target.files[0];
    
    if (!file) return;
    
    console.log('üì∏ Image selected:', file.name);
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå
    if (!file.type.startsWith('image/')) {
        alert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÑ‡∫ü‡∫•‡ªå‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö‡ªÄ‡∫ó‡∫ª‡ªà‡∫≤‡∫ô‡∫±‡ªâ‡∫ô');
        return;
    }
    
    // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Base64
    const reader = new FileReader();
    
  reader.onload = function(e) {
        const base64 = e.target.result;
        
        dynamicFormsData[index].imageFile = file;
        dynamicFormsData[index].imagePreview = base64;
        
        // ‚≠ê Sync ‡∏£‡∏π‡∏õ‡πÑ‡∏õ‡∏ü‡∏≠‡∏£‡πå‡∏° 2, 3
        if (index === 0) {
            for (let i = 1; i < dynamicFormsData.length; i++) {
                dynamicFormsData[i].imageFile = file;
                dynamicFormsData[i].imagePreview = base64;
            }
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á Preview
        const preview = document.getElementById('imagePreview_' + index);
        if (preview) {
            preview.src = base64;
        } else {
            const container = document.querySelector('.dynamic-form-item[data-form-index="' + index + '"] .image-upload-container');
            if (container) {
                container.insertAdjacentHTML('afterend', '<img src="' + base64 + '" class="image-preview" id="imagePreview_' + index + '">');
            }
        }
        
        console.log('‚úÖ Image preview ready');
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á ‚Üí Re-render
        const isComplete = checkFormComplete(dynamicFormsData[index]);
        
        if (isComplete) {
            console.log('‚úÖ Form ' + (index + 1) + ' is complete after image upload, re-rendering...');
            renderDynamicForms();
        }
    };
    
    reader.readAsDataURL(file);
}
/**
 * ‚≠ê ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ü‡∏≠‡∏£‡πå‡∏° (‡πÉ‡∏´‡∏°‡πà)
 */
function debugFormStatus() {
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log('üìä Dynamic Forms Status:');
    console.log('Total Forms:', dynamicFormsData.length);
    
    dynamicFormsData.forEach(function(form, index) {
        console.log('\nüìù Form ' + (index + 1) + ':');
        console.log('  Complete:', checkFormComplete(form));
        console.log('  Data:', form);
    });
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');
}

// ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° Debug ‡πÉ‡∏ô Console (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ: debugFormStatus())
window.debugFormStatus = debugFormStatus;

/**
 * ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function openCameraForForm(index) {
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á input ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.capture = 'environment'; // ‚≠ê ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á
    
    input.onchange = function(e) {
        handleImageFileSelect(index, e);
    };
    
    input.click();
}
/**
 * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ Progress Steps + ‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
 */

function saveAllDynamicForms() {
    console.log('üíæ Saving all dynamic forms...');
    console.log('Total forms:', dynamicFormsData.length);
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏£‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    const firstForm = dynamicFormsData[0];
    
    if (!checkFormComplete(firstForm)) {
        alert('‡∫ü‡∫≠‡∫£‡ªå‡∫ó‡∫µ 1 ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫Å‡∫£‡∫≠‡∫Å‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÉ‡∫´‡ªâ‡∫Ñ‡∫ª‡∫ö:\n\n' +
            '‚úì ‡∫ö‡∫≤‡ªÇ‡∫Ñ‡∫î\n' +
            '‚úì ‡∫ä‡∫∑‡ªà‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤\n' +
            '‚úì ‡∫•‡∫≤‡∫Ñ‡∫≤\n' +
            '‚úì ‡∫´‡∫ª‡∫ß‡ªú‡ªà‡∫ß‡∫ç\n' +
            '‚úì ‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫ï‡ªç‡ªà‡ªú‡ªà‡∫ß‡∫ç\n' +
            '‚úì ‡∫•‡∫∞‡∫´‡∫±‡∫î‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡ªÇ‡∫ç‡∫á\n' +
            '‚úì ‡ªù‡∫ß‡∫î‡ªù‡∫π‡ªà\n' +
            '‚úì ‡ªÇ‡∫ä‡∫ô\n' +
            '‚úì ‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö');
        return;
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
    for (let i = 1; i < dynamicFormsData.length; i++) {
        if (!checkFormComplete(dynamicFormsData[i])) {
            alert('‡∫ü‡∫≠‡∫£‡ªå‡∫ó‡∫µ ' + (i + 1) + ' ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫Å‡∫£‡∫≠‡∫Å‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÉ‡∫´‡ªâ‡∫Ñ‡∫ª‡∫ö');
            return;
        }
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á Progress Steps
    showProgressSteps();
    updateProgressStep(1, 'active');
    updateProgressStatus('‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫≠‡∫±‡∫ö‡ªÇ‡∫´‡∫º‡∫î‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö...');
    
    // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡∏£‡∏π‡∏õ
    uploadSingleImageForAllForms(function(imageUrl) {
        // Step 1 Complete
        updateProgressStep(1, 'completed');
        updateProgressLine(50);
        
        // Step 2: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        updateProgressStep(2, 'active');
        updateProgressStatus('‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫•‡∫ª‡∫á‡∫ñ‡∫≤‡∫ô...');
        
        // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const itemsToSave = [];
        
        dynamicFormsData.forEach(function(formData) {
            itemsToSave.push({
                columnA: formData.columnA,
                columnB: formData.columnB,
                columnC: parseFloat(formData.columnC) || 0,
                columnD: parseFloat(formData.columnD) || 0,
                columnE: imageUrl,
                columnF: parseFloat(formData.columnF) || 0,
                columnG: '',
                columnH: formData.columnH,
                columnI: parseFloat(formData.columnI) || 1,
                columnJ: formData.columnJ,
                columnK: imageUrl,
                columnL: formData.columnL,
                columnM: formData.columnM,
                columnN: parseFloat(formData.columnN) || 0
            });
        });
        
        console.log('Items to save:', itemsToSave);
        
        // ‡∏™‡πà‡∏á‡πÑ‡∏õ Backend
        google.script.run
            .withSuccessHandler(function(result) {
                if (result.success) {
                    updateProgressStep(2, 'completed');
                    updateProgressLine(100);
                    showProgressSuccess();
                    
                    setTimeout(function() {
                        hideProgressSteps();
                        
                        // ‚≠ê ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î Modal
                        console.log('üßπ Clearing form data...');
                        dynamicFormsData = [];
                        currentScannedBarcode = '';
                        
                        // ‚≠ê ‡∏õ‡∏¥‡∏î Modal
                        closeAddItemsModal();
                        
                        // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        loadItemsData().then(function() {
                            console.log('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', result);
                        });
                    }, 2000);
                } else {
                    hideProgressSteps();
                    alert('‚ùå ‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î: ' + result.error);
                }
            })
            .withFailureHandler(function(error) {
                hideProgressSteps();
                alert('‚ùå ‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î: ' + error.message);
            })
            .addNewItemsToStock(itemsToSave);
    });
}

/**
 * ‚≠ê ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡∏£‡∏π‡∏õ (‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏° 1 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
 */
function uploadSingleImageForAllForms(callback) {
    const firstForm = dynamicFormsData[0];
    
    if (!firstForm.imageFile) {
        console.log('‚ö†Ô∏è No image to upload');
        callback('');
        return;
    }
    
    console.log('üì∏ Uploading single image...');
    
    const fileName = firstForm.columnA + '_' + new Date().getTime() + '.jpg';
    const file = firstForm.imageFile;
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
        const base64 = e.target.result;
        
        google.script.run
            .withSuccessHandler(function(result) {
                if (result.success) {
                    console.log('‚úÖ Image uploaded:', result.url);
                    callback(result.url);
                } else {
                    console.error('‚ùå Image upload failed:', result.error);
                    callback('');
                }
            })
            .withFailureHandler(function(error) {
                console.error('‚ùå Image upload error:', error);
                callback('');
            })
            .uploadImageToDrive(base64, fileName);
    };
    
    reader.readAsDataURL(file);
}


/**
 * ========================================
 * ‚≠ê Case B: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
 * ========================================
 */

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á Modal ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function createExistingItemModal() {
    if (document.getElementById('existingItemModal')) return;
    
    const modal = document.createElement('div');
    modal.id = 'existingItemModal';
    modal.className = 'existing-item-modal';
    
    modal.innerHTML = '<div class="existing-item-content">' +
        '<div class="existing-item-header">' +
        '<h2 class="existing-item-title">‚ö†Ô∏è ‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡∫°‡∫µ‡∫¢‡∫π‡ªà‡ªÉ‡∫ô‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡ªÅ‡∫•‡ªâ‡∫ß!</h2>' +
        '<p class="existing-item-subtitle">‡∫ó‡ªà‡∫≤‡∫ô‡∫™‡∫≤‡∫°‡∫≤‡∫î‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫™‡∫∞‡∫ï‡∫±‡∫≠‡∫Å‡ªÑ‡∫î‡ªâ</p>' +
        '</div>' +
        '<div id="existingItemTableContainer"></div>' +
        '<div class="stock-add-section">' +
        '<h3 class="stock-add-title">‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫™‡∫∞‡∫ï‡∫±‡∫≠‡∫Å</h3>' +
        '<div class="stock-add-input-wrapper">' +
        '<input type="number" id="stockAddQuantityInput" class="stock-add-input" placeholder="‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫ó‡∫µ‡ªà‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡ªÄ‡∫û‡∫µ‡ªà‡∫°" min="1" value="1">' +
        '<div class="stock-calculation" id="stockCalculation">√ó <span id="columnIDisplay">0</span> = <strong id="totalAddDisplay">0</strong></div>' +
        '</div>' +
        '</div>' +
        '<div class="existing-item-actions">' +
        '<button class="btn-save-stock" onclick="saveStockUpdate()">üíæ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å</button>' +
        '<button class="btn-cancel-stock" onclick="closeExistingItemModal()">‚ùå ‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>' +
        '</div>' +
        '</div>';
    
    document.body.appendChild(modal);
    existingItemModal = modal;
    
    // Event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
    setTimeout(function() {
        const input = document.getElementById('stockAddQuantityInput');
        if (input) {
            input.addEventListener('input', updateStockCalculation);
        }
    }, 100);
}
/**
 * ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ)
 */
function showExistingItemModal(itemData) {
    if (!existingItemModal) {
        createExistingItemModal();
    }
    
    console.log('Displaying existing item:', itemData);
    
    // ‚≠ê ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ Column J ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
    const relatedItems = findItemsByColumnJ(itemData.columnJ);
    const uniqueImages = getUniqueImages(relatedItems);
    
    console.log('Related items:', relatedItems.length);
    console.log('Unique images:', uniqueImages.length);
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û Column E
    const imageE_HTML = itemData.columnE ? 
        '<img src="' + itemData.columnE + '" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;">' : 
        '-';
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    const tableHTML = '<div class="existing-item-table-wrapper">' +
        '<table class="existing-item-table">' +
        '<thead><tr>' +
        '<th>‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤ (A)</th>' +
        '<th>‡∫ä‡∫∑‡ªà‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô (B)</th>' +
        '<th>‡∫•‡∫≤‡∫Ñ‡∫≤‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤ (C)</th>' +
        '<th>‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡ªÅ‡∫à‡ªâ‡∫á‡ªÄ‡∫ï‡∫∑‡∫≠‡∫ô (D)</th>' +
        '<th>‡∫Æ‡∫π‡∫ö (E)</th>' +
        '<th>‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡ªÄ‡∫´‡∫º‡∫∑‡∫≠ (F)</th>' +
        '<th>‡∫´‡∫ª‡∫ß‡ªú‡ªà‡∫ß‡∫ç (H)</th>' +
        '<th>‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡∫ï‡ªç‡ªà‡ªú‡ªà‡∫ß‡∫ç (I)</th>' +
        '<th>‡∫•‡∫∞‡∫´‡∫±‡∫î‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡ªÇ‡∫ç‡∫á (J)</th>' +
        '<th>‡ªù‡∫ß‡∫î‡ªù‡∫π‡ªà‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤ (L)</th>' +
        '<th>‡ªÇ‡∫ä‡∫ô‡∫ß‡∫≤‡∫á‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤ (M)</th>' +
        '<th>‡∫•‡∫≤‡∫Ñ‡∫≤‡∫ï‡∫ª‡ªâ‡∫ô‡∫ó‡∫∂‡∫ô (N)</th>' +
        '</tr></thead>' +
        '<tbody><tr>' +
        '<td>' + itemData.columnA + '</td>' +
        '<td>' + itemData.columnB + '</td>' +
        '<td>' + itemData.columnC + '</td>' +
        '<td>' + itemData.columnD + '</td>' +
        '<td>' + imageE_HTML + '</td>' +
        '<td>' + itemData.columnF + '</td>' +
        '<td>' + itemData.columnH + '</td>' +
        '<td>' + itemData.columnI + '</td>' +
        '<td>' + (itemData.columnJ || '-') + '</td>' +
        '<td>' + itemData.columnL + '</td>' +
        '<td>' + itemData.columnM + '</td>' +
        '<td>' + itemData.columnN + '</td>' +
        '</tr></tbody>' +
        '</table>' +
        '</div>';
    
    const container = document.getElementById('existingItemTableContainer');
    if (container) {
        container.innerHTML = tableHTML;
        
        // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏£‡∏π‡∏õ)
        if (uniqueImages.length > 1) {
            container.insertAdjacentHTML('beforeend', createImageSelectionHTML(uniqueImages, itemData.columnJ));
        }
    }
    
    const columnI = parseFloat(itemData.columnI) || 1;
    const unit = itemData.columnH || '‡∫ä‡∫¥‡ªâ‡∫ô';
    
    const columnIDisplay = document.getElementById('columnIDisplay');
    if (columnIDisplay) {
        columnIDisplay.textContent = columnI + ' (' + unit + ')';
    }
    
    existingItemModal.dataset.barcode = itemData.columnA;
    existingItemModal.dataset.columnI = columnI;
    existingItemModal.dataset.unit = unit;
    existingItemModal.dataset.columnJ = itemData.columnJ; // ‚≠ê ‡πÄ‡∏Å‡πá‡∏ö Column J
    
    updateStockCalculation();
    existingItemModal.classList.add('show');
    
    setTimeout(function() {
        const input = document.getElementById('stockAddQuantityInput');
        if (input) {
            input.value = '1';
            input.focus();
        }
    }, 100);
}
/**
 * ‚≠ê ‡∏´‡∏≤ Items ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ Column J ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
 */
function findItemsByColumnJ(columnJ) {
    if (!columnJ) return [];
    
    const results = [];
    
    itemsData.forEach(function(item, barcode) {
        const itemColumnJ = item.columnJ ? item.columnJ.toString().trim() : '';
        
        if (itemColumnJ === columnJ.toString().trim()) {
            results.push({
                barcode: barcode,
                columnK: item.columnK || '',
                data: item
            });
        }
    });
    
    return results;
}

/**
 * ‚≠ê ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
 */
function getUniqueImages(items) {
    const imageSet = {};
    const uniqueImages = [];
    
    items.forEach(function(item) {
        const imageUrl = item.columnK;
        
        if (imageUrl && imageUrl.trim() !== '' && !imageSet[imageUrl]) {
            imageSet[imageUrl] = true;
            uniqueImages.push(imageUrl);
        }
    });
    
    return uniqueImages;
}

/**
 * ‚≠ê ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ
 */
function createImageSelectionHTML(images, columnJ) {
    let html = '<div style="margin-top: 20px; padding: 20px; background: #fff3e0; border-radius: 15px; border: 2px solid #ff9800;">';
    html += '<h3 style="color: #ff9800; margin-bottom: 15px; text-align: center;">üñºÔ∏è ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö‡∫ó‡∫µ‡ªà‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡ªÉ‡∫ä‡ªâ</h3>';
    html += '<p style="text-align: center; color: #666; margin-bottom: 20px;">‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡ªÉ‡∫ô‡∫Å‡∫∏‡ªà‡∫°‡∫ô‡∫µ‡ªâ‡∫°‡∫µ‡∫Æ‡∫π‡∫ö‡ªÅ‡∫ï‡∫Å‡∫ï‡ªà‡∫≤‡∫á‡∫Å‡∫±‡∫ô ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫Æ‡∫π‡∫ö‡∫ó‡∫µ‡ªà‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô</p>';
    html += '<div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">';
    
    images.forEach(function(imageUrl, index) {
        html += '<div class="image-choice-item" data-image-url="' + imageUrl + '" data-column-j="' + columnJ + '" onclick="selectImageForGroup(this)" style="cursor: pointer; border: 3px solid #e0e0e0; border-radius: 10px; padding: 10px; transition: all 0.3s; text-align: center;">';
        html += '<img src="' + imageUrl + '" style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px; display: block; margin-bottom: 10px;">';
        html += '<div style="font-size: 0.9rem; color: #666;">‡∫Æ‡∫π‡∫ö‡∫ó‡∫µ ' + (index + 1) + '</div>';
        html += '</div>';
    });
    
    html += '</div></div>';
    
    return html;
}

/**
 * ‚≠ê ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Group
 */
function selectImageForGroup(element) {
    const imageUrl = element.dataset.imageUrl;
    const columnJ = element.dataset.columnJ;
    
    // Highlight ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    document.querySelectorAll('.image-choice-item').forEach(function(item) {
        item.style.borderColor = '#e0e0e0';
        item.style.background = 'white';
    });
    
    element.style.borderColor = '#4caf50';
    element.style.background = '#e8f5e9';
    
    if (!confirm('‡∫ó‡ªà‡∫≤‡∫ô‡ªÅ‡∫ô‡ªà‡ªÉ‡∫à‡∫ö‡ªç‡ªà‡∫ß‡ªà‡∫≤‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡ªÉ‡∫ä‡ªâ‡∫Æ‡∫π‡∫ö‡∫ô‡∫µ‡ªâ‡∫™‡∫≥‡∫•‡∫±‡∫ö‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î‡ªÉ‡∫ô‡∫Å‡∫∏‡ªà‡∫°?\n\n‡∫Æ‡∫π‡∫ö‡ªÄ‡∫Å‡∫ª‡ªà‡∫≤‡∫ó‡∫µ‡ªà‡ªÅ‡∫ï‡∫Å‡∫ï‡ªà‡∫≤‡∫á‡∫à‡∫∞‡∫ñ‡∫∑‡∫Å‡∫•‡∫ª‡∫ö‡∫≠‡∫≠‡∫Å')) {
        return;
    }
    
    console.log('üñºÔ∏è Selected image:', imageUrl);
    console.log('üì¶ Column J:', columnJ);
    
    // ‡πÅ‡∏™‡∏î‡∏á Loading
    showSavingAnimation();
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Group
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                showSuccessAnimation();
                
                setTimeout(function() {
                    hideSavingAnimation();
                    
                    // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á Alert)
                    loadItemsData().then(function() {
                        console.log('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', result);
                        
                        // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä Modal
                        const barcode = existingItemModal.dataset.barcode;
                        const checkResult = { exists: true, data: itemsData.get(barcode) };
                        handleBarcodeCheckResult(checkResult);
                    });
                }, 2000);
            } else {
                hideSavingAnimation();
                alert('‚ùå ‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î: ' + result.error);
            }
        })
        .withFailureHandler(function(error) {
            hideSavingAnimation();
            alert('‚ùå ‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î: ' + error.message);
        })
        .updateImagesForGroup(columnJ, imageUrl);
}

/**
 * ‡∏õ‡∏¥‡∏î Modal ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
 */
function closeExistingItemModal() {
    if (existingItemModal) {
        existingItemModal.classList.remove('show');
    }
}

/**
 * ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ï‡πá‡∏≠‡∏Å (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏™‡∏π‡∏ï‡∏£)
 */
function updateStockCalculation() {
    const input = document.getElementById('stockAddQuantityInput');
    const totalDisplay = document.getElementById('totalAddDisplay');
    
    if (!input || !totalDisplay) return;
    
    const quantity = parseFloat(input.value) || 0;
    const columnI = parseFloat(existingItemModal.dataset.columnI) || 1;
    const unit = existingItemModal.dataset.unit || '‡∫ä‡∫¥‡ªâ‡∫ô'; // ‚≠ê ‡∏î‡∏∂‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢
    const total = quantity * columnI;
    
    // ‚≠ê ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö
    const columnIDisplay = document.getElementById('columnIDisplay');
    if (columnIDisplay) {
        columnIDisplay.textContent = columnI + ' (' + unit + ')';
    }
    
    totalDisplay.textContent = total.toLocaleString();
}
/**
 * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ï‡πá‡∏≠‡∏Å (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡∏¥‡∏î Alert)
 */
function saveStockUpdate() {
    const barcode = existingItemModal.dataset.barcode;
    const input = document.getElementById('stockAddQuantityInput');
    const quantity = parseFloat(input.value) || 0;
    
    if (quantity <= 0) {
        alert('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÉ‡∫™‡ªà‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫ó‡∫µ‡ªà‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡ªÄ‡∫û‡∫µ‡ªà‡∫°');
        input.focus();
        return;
    }
    
    console.log('Updating stock: barcode=' + barcode + ', quantity=' + quantity);
    
    // ‡πÅ‡∏™‡∏î‡∏á Loading
    showSavingAnimation();
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                showSuccessAnimation();
                
                setTimeout(function() {
                    hideSavingAnimation();
                    closeExistingItemModal();
                    
                    // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á Alert)
                    loadItemsData().then(function() {
                        console.log('‚úÖ ‡∫≠‡∫±‡∫ö‡ªÄ‡∫î‡∫î‡∫™‡∫∞‡∫ï‡∫±‡∫≠‡∫Å‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î - ‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡ªÄ‡∫´‡∫º‡∫∑‡∫≠‡ªÉ‡ªù‡ªà:', result.newStock);
                        console.log('üìä ‡∫≠‡∫±‡∫ö‡ªÄ‡∫î‡∫î:', result.updatedRows, '‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô');
                    });
                }, 2000);
            } else {
                hideSavingAnimation();
                alert('‚ùå ‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î: ' + result.error);
            }
        })
        .withFailureHandler(function(error) {
            hideSavingAnimation();
            alert('‚ùå ‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î: ' + error.message);
        })
        .updateExistingStock(barcode, quantity);
}

/**
 * ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Modal ‡πÉ‡∏´‡∏°‡πà)
 */
window.addEventListener('load', function() {
    const checkDataLoaded = setInterval(function() {
        if (dataLoaded.items) {
            clearInterval(checkDataLoaded);
            createEditItemsButton();
            createEditChoiceModal(); // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
            createScanBarcodeModal(); // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
            createAddItemsModal(); // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
            createExistingItemModal(); // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
        }
    }, 500);
});

    </script>
</body>
</html>
