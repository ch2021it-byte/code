/**
 * ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - Google Apps Script Backend
 */

// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏∑‡πà‡∏≠ Spreadsheet ‡πÅ‡∏•‡∏∞ Sheet
const SPREADSHEET_ID = '10SgCZ2H-4d37-3Slcj-riBK2SDgAbYpXW6SZvgSFUa8';
const ITEMS_SHEET = 'Items';
const PRICE_STUDY_SHEET = '‡∫™‡∫∂‡∫Å‡∫™‡∫≤‡∫•‡∫≤‡∫Ñ‡∫≤‡∫ï‡∫ª‡ªâ‡∫ô‡∫ó‡∫∂‡∫ô';
const ORDER_SHEET_ID = '1zk7v8iClQjGf7WseWld_hwix4upAr7KoGqn-eo01fgk';
const ORDER_SHEET = '‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤';

const INITIAL_QUOTA = 20000;

/**
 * ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö HTML
 */
function doGet() {
  return HtmlService.createTemplateFromFile('index')
    .evaluate()
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

/**
 * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á Items
 */
function getItemsData() {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(ITEMS_SHEET);
   
    if (!sheet) {
      Logger.log('Sheet "' + ITEMS_SHEET + '" not found');
      return [];
    }
   
    const data = sheet.getDataRange().getValues();
    if (!data || data.length <= 1) {
      Logger.log('No data in Items sheet');
      return [];
    }
    
    const headers = data[0];
    const rows = data.slice(1);
   
    const result = [];
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const item = {};
      for (let j = 0; j < headers.length; j++) {
        item['column' + String.fromCharCode(65 + j)] = row[j] || '';
      }
      result.push(item);
    }
    
    return result;
  } catch (error) {
    Logger.log('Error getting items data: ' + error.toString());
    return [];
  }
}

/**
 * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡∫™‡∫∂‡∫Å‡∫™‡∫≤‡∫•‡∫≤‡∫Ñ‡∫≤‡∫ï‡∫ª‡ªâ‡∫ô‡∫ó‡∫∂‡∫ô
 */
function getPriceStudyData() {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(PRICE_STUDY_SHEET);
   
    if (!sheet) {
      Logger.log('Sheet "' + PRICE_STUDY_SHEET + '" not found - returning empty array');
      return [];
    }
   
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      Logger.log('Sheet "' + PRICE_STUDY_SHEET + '" has no data - returning empty array');
      return [];
    }
    
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    const rows = data.slice(1);
   
    const result = [];
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const item = {};
      for (let j = 0; j < headers.length; j++) {
        item['column' + String.fromCharCode(65 + j)] = row[j] || '';
      }
      result.push(item);
    }
    
    Logger.log('getPriceStudyData returning ' + result.length + ' items');
    return result;
  } catch (error) {
    Logger.log('Error getting price study data: ' + error.toString());
    return [];
  }
}

/**
 * ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Column F
 */
function getStoreList() {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(PRICE_STUDY_SHEET);
   
    if (!sheet) {
      Logger.log('Sheet "' + PRICE_STUDY_SHEET + '" not found');
      return [];
    }
   
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      return [];
    }
    
    const data = sheet.getRange('F2:F' + lastRow).getValues();
    const storesSet = {};
    
    for (let i = 0; i < data.length; i++) {
      const store = data[i][0];
      if (store && store.toString().trim()) {
        storesSet[store.toString().trim()] = true;
      }
    }
    
    const stores = Object.keys(storesSet).sort();
    return stores;
  } catch (error) {
    Logger.log('Error getting store list: ' + error.toString());
    return [];
  }
}

/**
 * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏•‡∏∞‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°)
 */
function saveOrder(orderData) {
  try {
    const ss = SpreadsheetApp.openById(ORDER_SHEET_ID);
    let sheet = ss.getSheetByName(ORDER_SHEET);
    
    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ sheet ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
    if (!sheet) {
      sheet = ss.insertSheet(ORDER_SHEET);
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á header
      sheet.appendRow(['‡∫ß‡∫±‡∫ô‡∫ó‡∫µ', '‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ', '‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤', '‡∫ä‡∫∑‡ªà‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤', '‡∫´‡∫ª‡∫ß‡ªú‡ªà‡∫ß‡∫ç', '‡∫à‡∫≥‡∫ô‡∫ß‡∫ô', '‡∫•‡∫≤‡∫Ñ‡∫≤/‡ªú‡ªà‡∫ß‡∫ç', '‡∫•‡∫ß‡∫°‡ªÄ‡∫á‡∫¥‡∫ô', '‡∫ß‡∫¥‡∫ó‡∫µ‡∫Å‡∫≤‡∫ô']);
    }
    
    const orderNumber = orderData.orderNumber;
    const method = orderData.method;
    const isUpdate = orderData.isUpdate || false; // ‡πÄ‡∏û‡∏¥‡πà‡∏° flag ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó
    
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô
    if (isUpdate) {
      deleteOrderRows(sheet, orderNumber);
    }
    
    const timestamp = new Date();
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    const items = orderData.items;
    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      sheet.appendRow([
        timestamp,
        orderNumber,
        item.barcode,
        item.itemName,
        item.unit,
        item.quantity,
        item.price,
        item.total,
        method
      ]);
    }
    
    return { success: true, orderNumber: orderNumber };
  } catch (error) {
    Logger.log('Error saving order: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

/**
 * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏î‡∏¥‡∏°
 */
function loadOrder(orderNumber) {
  try {
    const ss = SpreadsheetApp.openById(ORDER_SHEET_ID);
    const sheet = ss.getSheetByName(ORDER_SHEET);
    
    if (!sheet) {
      return { success: false, items: [] };
    }
    
    const data = sheet.getDataRange().getValues();
    if (!data || data.length <= 1) {
      return { success: false, items: [] };
    }
    
    const headers = data[0];
    const rows = data.slice(1);
    
    // ‡πÄ‡∏õ‡∏¥‡∏î Items sheet ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
    const itemsSS = SpreadsheetApp.openById(SPREADSHEET_ID);
    const itemsSheet = itemsSS.getSheetByName(ITEMS_SHEET);
    const itemsData = itemsSheet ? itemsSheet.getDataRange().getValues() : [];
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Map ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å barcode
    const itemsImageMap = {};
    if (itemsData.length > 1) {
      for (let i = 1; i < itemsData.length; i++) {
        const barcode = itemsData[i][0]; // Column A
        const image = itemsData[i][10]; // Column K (index 10)
        if (barcode) {
          itemsImageMap[barcode.toString().trim()] = image || '';
        }
      }
    }
    
    const orderItems = [];
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      if (row[1] === orderNumber) {
        const barcode = row[2];
        const image = itemsImageMap[barcode.toString().trim()] || ''; // ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å Items sheet
        
        orderItems.push({
          barcode: barcode,
          itemName: row[3],
          unit: row[4],
          quantity: row[5],
          price: row[6],
          total: row[7],
          image: image // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
        });
      }
    }
    
    return { success: true, items: orderItems };
  } catch (error) {
    Logger.log('Error loading order: ' + error.toString());
    return { success: false, items: [] };
  }
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà
 */
function generateOrderNumber() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const time = String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0');
  
  return 'PO-' + year + month + day + '-' + time;
}

function debugPriceStudy() {
  try {
    const ss = SpreadsheetApp.openById('10SgCZ2H-4d37-3Slcj-riBK2SDgAbYpXW6SZvgSFUa8');
    Logger.log('Spreadsheet opened: ' + ss.getName());
    
    const sheet = ss.getSheetByName('‡∫™‡∫∂‡∫Å‡∫™‡∫≤‡∫•‡∫≤‡∫Ñ‡∫≤‡∫ï‡∫ª‡ªâ‡∫ô‡∫ó‡∫∂‡∫ô');
    Logger.log('Sheet found: ' + (sheet ? 'YES' : 'NO'));
    
    if (sheet) {
      Logger.log('Last Row: ' + sheet.getLastRow());
      Logger.log('Last Column: ' + sheet.getLastColumn());
      
      const data = sheet.getDataRange().getValues();
      Logger.log('Data rows: ' + data.length);
      Logger.log('First row: ' + JSON.stringify(data[0]));
    }
    
    const result = getPriceStudyData();
    Logger.log('getPriceStudyData result length: ' + result.length);
    Logger.log('First item: ' + JSON.stringify(result[0]));
    
  } catch (error) {
    Logger.log('ERROR: ' + error.toString());
  }
}
/**
 * ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function deleteOrderRows(sheet, orderNumber) {
  try {
    const data = sheet.getDataRange().getValues();
    const rowsToDelete = [];
    
    // ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö orderNumber (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 2 ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß 1 ‡πÄ‡∏õ‡πá‡∏ô header)
    for (let i = 1; i < data.length; i++) {
      if (data[i][1] === orderNumber) { // Column B (index 1) ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
        rowsToDelete.push(i + 1); // +1 ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ array ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 0 ‡πÅ‡∏ï‡πà row ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 1
      }
    }
    
    // ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ index ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô
    for (let i = rowsToDelete.length - 1; i >= 0; i--) {
      sheet.deleteRow(rowsToDelete[i]);
    }
    
    Logger.log('Deleted ' + rowsToDelete.length + ' rows for order: ' + orderNumber);
  } catch (error) {
    Logger.log('Error deleting order rows: ' + error.toString());
  }
}
/**
 * ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà + ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà)
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function getOrderList() {
  try {
    const ss = SpreadsheetApp.openById(ORDER_SHEET_ID);
    const sheet = ss.getSheetByName(ORDER_SHEET);
    
    if (!sheet) {
      return [];
    }
    
    const data = sheet.getDataRange().getValues();
    if (!data || data.length <= 1) {
      return [];
    }
    
    const ordersMap = {};
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß 2 (‡∏Ç‡πâ‡∏≤‡∏° header)
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const date = row[0]; // Column A - ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
      const orderNumber = row[1]; // Column B - ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
      
      if (orderNumber) {
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
        if (!ordersMap[orderNumber]) {
          const dateStr = Utilities.formatDate(new Date(date), Session.getScriptTimeZone(), 'dd/MM/yyyy HH:mm');
          ordersMap[orderNumber] = {
            orderNumber: orderNumber,
            date: dateStr,
            displayText: dateStr + ' - ' + orderNumber
          };
        }
      }
    }
    
    // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô array ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
    const orderList = Object.values(ordersMap).sort(function(a, b) {
      return b.orderNumber.localeCompare(a.orderNumber);
    });
    
    return orderList;
  } catch (error) {
    Logger.log('Error getting order list: ' + error.toString());
    return [];
  }
}
/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Drive
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Drive (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ Google Docs)
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
 */
function createPDFAndUploadToDrive(htmlContent, orderNumber) {
  try {
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Google Doc ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    const tempDoc = DocumentApp.create('Temp_' + orderNumber);
    const docId = tempDoc.getId();
    const doc = DocumentApp.openById(docId);
    const body = doc.getBody();
    
    // ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏î‡∏¥‡∏°
    body.clear();
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Header
    const header = body.appendParagraph('‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤');
    header.setHeading(DocumentApp.ParagraphHeading.HEADING1);
    header.setAlignment(DocumentApp.HorizontalAlignment.CENTER);
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
    body.appendParagraph('‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ: ' + orderNumber);
    body.appendParagraph('‡∫ß‡∫±‡∫ô‡∫ó‡∫µ: ' + Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'dd/MM/yyyy HH:mm:ss'));
    body.appendParagraph(''); // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å orderItems)
    // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á orderItems ‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢
    
    doc.saveAndClose();
    
    // ‡πÅ‡∏õ‡∏•‡∏á Google Doc ‡πÄ‡∏õ‡πá‡∏ô PDF
    const docFile = DriveApp.getFileById(docId);
    const pdfBlob = docFile.getAs('application/pdf');
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå
    const fileName = '‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ_' + orderNumber + '_' + Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyyMMdd_HHmmss') + '.pdf';
    
    // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Google Drive folder
    const folder = DriveApp.getFolderById('1jmglJOSJFAD-1eQbtpY2Etu69fA9jtLv');
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF ‡πÉ‡∏ô Drive
    const file = folder.createFile(pdfBlob);
    file.setName(fileName);
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÉ‡∏Ñ‡∏£‡∏Å‡πá‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    // ‡∏•‡∏ö Google Doc ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    docFile.setTrashed(true);
    
    // ‡∏î‡∏∂‡∏á URL ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå
    const fileId = file.getId();
    const directUrl = 'https://drive.google.com/file/d/' + fileId + '/view?usp=sharing';
    
    return {
      success: true,
      fileName: fileName,
      fileUrl: directUrl,
      fileId: fileId
    };
  } catch (error) {
    Logger.log('Error creating PDF: ' + error.toString());
    return {
      success: false,
      error: error.toString()
    };
  }
}
function createPDFFromOrderData(orderData) {
  try {
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Google Sheet ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    const ss = SpreadsheetApp.create('Temp_Order_' + orderData.orderNumber);
    const sheet = ss.getActiveSheet();
    const ssId = ss.getId();

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏†‡∏≤‡∏©‡∏≤‡∏•‡∏≤‡∏ß
    sheet.getRange('A:Z').setFontFamily('Noto Sans Lao');
    sheet.getRange('A:Z').setFontSize(12);

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
    sheet.setColumnWidth(1, 50);  // ‡∫•‡∫≥‡∫î‡∫±‡∫ö
    sheet.setColumnWidth(2, 120); // ‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤
    sheet.setColumnWidth(3, 80);  // ‡∫Æ‡∫π‡∫ö
    sheet.setColumnWidth(4, 200); // ‡∫ä‡∫∑‡ªà‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤
    sheet.setColumnWidth(5, 80);  // ‡∫´‡∫ª‡∫ß‡ªú‡ªà‡∫ß‡∫ç
    sheet.setColumnWidth(6, 80);  // ‡∫à‡∫≥‡∫ô‡∫ß‡∫ô
    sheet.setColumnWidth(7, 100); // ‡∫•‡∫≤‡∫Ñ‡∫≤/‡ªú‡ªà‡∫ß‡∫ç
    sheet.setColumnWidth(8, 120); // ‡∫•‡∫ß‡∫°‡ªÄ‡∫á‡∫¥‡∫ô

    let currentRow = 1;

    // === Header ===
    sheet.getRange(currentRow, 1, 1, 8).merge();
    const headerCell = sheet.getRange(currentRow, 1);
    headerCell.setValue('‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤');
    headerCell.setFontSize(20);
    headerCell.setFontWeight('bold');
    headerCell.setHorizontalAlignment('center');
    headerCell.setVerticalAlignment('middle');
    headerCell.setBackground('#25d366');
    headerCell.setFontColor('#ffffff');
    sheet.setRowHeight(currentRow, 40);
    currentRow++;

    // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á
    sheet.setRowHeight(currentRow, 10);
    currentRow++;

    // === ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ===
    sheet.getRange(currentRow, 1).setValue('‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ:').setFontWeight('bold');
    sheet.getRange(currentRow, 2, 1, 3).merge().setValue(orderData.orderNumber);
    sheet.setRowHeight(currentRow, 25);
    currentRow++;

    sheet.getRange(currentRow, 1).setValue('‡∫ß‡∫±‡∫ô‡∫ó‡∫µ:').setFontWeight('bold');
    sheet.getRange(currentRow, 2, 1, 3).merge().setValue(orderData.date);
    sheet.setRowHeight(currentRow, 25);
    currentRow++;

    // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á
    sheet.setRowHeight(currentRow, 10);
    currentRow++;

    // === Header ‡∏ï‡∏≤‡∏£‡∏≤‡∏á ===
    const headerRow = currentRow;
    const headers = ['‡∫•‡∫≥‡∫î‡∫±‡∫ö', '‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤', '‡∫Æ‡∫π‡∫ö', '‡∫ä‡∫∑‡ªà‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤', '‡∫´‡∫ª‡∫ß‡ªú‡ªà‡∫ß‡∫ç', '‡∫à‡∫≥‡∫ô‡∫ß‡∫ô', '‡∫•‡∫≤‡∫Ñ‡∫≤/‡ªú‡ªà‡∫ß‡∫ç', '‡∫•‡∫ß‡∫°‡ªÄ‡∫á‡∫¥‡∫ô'];

    for (let i = 0; i < headers.length; i++) {
      const cell = sheet.getRange(headerRow, i + 1);
      cell.setValue(headers[i]);
      cell.setFontWeight('bold');
      cell.setBackground('#2c3e50');
      cell.setFontColor('#ffffff');
      cell.setHorizontalAlignment('center');
      cell.setVerticalAlignment('middle');
    }
    sheet.setRowHeight(headerRow, 35);
    currentRow++;

    // === ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ===
    const startDataRow = currentRow;

    orderData.items.forEach(function(item, index) {
      sheet.setRowHeight(currentRow, 70);

      const rowRange = sheet.getRange(currentRow, 1, 1, 8);
      rowRange.setVerticalAlignment('middle');
      rowRange.setWrap(true);

      // ‡∫•‡∫≥‡∫î‡∫±‡∫ö
      sheet.getRange(currentRow, 1)
        .setValue(index + 1)
        .setHorizontalAlignment('center');

      // ‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤
      sheet.getRange(currentRow, 2).setValue(item.barcode || '-');

      // === ‡πÅ‡∏ó‡∏£‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ===
      try {
        if (item.image && item.image.trim() !== '') {
          const response = UrlFetchApp.fetch(item.image, {
            muteHttpExceptions: true,
            validateHttpsCertificates: false
          });

          if (response.getResponseCode() === 200) {
            const blob = response.getBlob();
            const img = sheet.insertImage(blob, 3, currentRow);
            img.setAnchorCell(sheet.getRange(currentRow, 3));
            img.setAltTextTitle("image");
          } else {
            sheet.getRange(currentRow, 3).setValue('üì∑');
          }
        } else {
          sheet.getRange(currentRow, 3).setValue('üì∑');
        }
      } catch (err) {
        sheet.getRange(currentRow, 3).setValue('üì∑');
      }

      // ‡∫ä‡∫∑‡ªà‡∫™‡∫¥‡∫ô‡∫Ñ‡ªâ‡∫≤
      sheet.getRange(currentRow, 4).setValue(item.itemName || '-');

      // ‡∫´‡∫ª‡∫ß‡ªú‡ªà‡∫ß‡∫ç
      sheet.getRange(currentRow, 5)
        .setValue(item.unit || '-')
        .setHorizontalAlignment('center');

      // ‡∫à‡∫≥‡∫ô‡∫ß‡∫ô
      sheet.getRange(currentRow, 6)
        .setValue(item.quantity || '-')
        .setHorizontalAlignment('center');

      // ‡∫•‡∫≤‡∫Ñ‡∫≤/‡ªú‡ªà‡∫ß‡∫ç
      sheet.getRange(currentRow, 7)
        .setValue(item.price ? item.price.toLocaleString() : '-')
        .setHorizontalAlignment('right');

      // ‡∫•‡∫ß‡∫°‡ªÄ‡∫á‡∫¥‡∫ô
      sheet.getRange(currentRow, 8)
        .setValue(item.total ? item.total.toLocaleString() : '-')
        .setHorizontalAlignment('right');

      currentRow++;
    });

    const lastDataRow = currentRow - 1;

    // === ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ===
    sheet.setRowHeight(currentRow, 35);
    sheet.getRange(currentRow, 1, 1, 7).merge();
    const totalLabelCell = sheet.getRange(currentRow, 1);
    totalLabelCell.setValue('‡∫•‡∫ß‡∫°‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î:').setFontWeight('bold').setHorizontalAlignment('right');
    sheet.getRange(currentRow, 8)
      .setValue(orderData.total ? orderData.total.toLocaleString() + ' ‡∫Å‡∫µ‡∫ö' : '-')
      .setFontWeight('bold')
      .setHorizontalAlignment('right');
    const totalRow = currentRow;
    currentRow++;

    // === ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô ===
    sheet.setRowHeight(currentRow, 30);
    sheet.getRange(currentRow, 1, 1, 4).merge()
      .setValue('‡∫•‡∫≤‡∫ç‡ªÄ‡∫ä‡∫±‡∫ô‡∫ú‡∫π‡ªâ‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ: _________________')
      .setHorizontalAlignment('center');
    sheet.getRange(currentRow, 5, 1, 4).merge()
      .setValue('‡∫•‡∫≤‡∫ç‡ªÄ‡∫ä‡∫±‡∫ô‡∫ú‡∫π‡ªâ‡∫≠‡∫∞‡∫ô‡∫∏‡∫°‡∫±‡∫î: _________________')
      .setHorizontalAlignment('center');

    // === ‡πÄ‡∏™‡πâ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡∏£‡∏≠‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á ===
    const dataRange = sheet.getRange(headerRow, 1, totalRow - headerRow + 1, 8);
    dataRange.setBorder(true, true, true, true, true, true, '#000000', SpreadsheetApp.BorderStyle.SOLID);

    SpreadsheetApp.flush();

    // === ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô PDF ===
    const spreadsheetFile = DriveApp.getFileById(ssId);
    const pdfBlob = spreadsheetFile.getAs('application/pdf');

    const fileName = '‡ªÉ‡∫ö‡∫™‡∫±‡ªà‡∫á‡∫ä‡∫∑‡ªâ_' + orderData.orderNumber + '_' +
      Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyyMMdd_HHmmss') + '.pdf';

    const folder = DriveApp.getFolderById('1jmglJOSJFAD-1eQbtpY2Etu69fA9jtLv');
    const pdfFile = folder.createFile(pdfBlob);
    pdfFile.setName(fileName);
    pdfFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

    // ‡∏•‡∏ö‡∏ä‡∏µ‡∏ï‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    spreadsheetFile.setTrashed(true);

    const fileId = pdfFile.getId();
    const directUrl = 'https://drive.google.com/file/d/' + fileId + '/view?usp=sharing';

    return {
      success: true,
      fileName: fileName,
      fileUrl: directUrl,
      fileId: fileId
    };

  } catch (error) {
    Logger.log('Error creating PDF: ' + error.toString());
    return {
      success: false,
      error: error.toString()
    };
  }
}
