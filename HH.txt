<!DOCTYPE html>
<html lang="lo">
<head>
  <!-- Cropper.js CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />
  
  <!-- Cropper.js JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫õ‡∫∞‡∫ä‡∫≤‡∫Å‡∫≠‡∫ô</title>
  <style>

    /* ===== MOBILE TYPE SELECTION ===== */
.mobile-type-option > div:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  border-color: #667eea !important;
}

.mobile-type-option.selected > div {
  border-color: #667eea !important;
  box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
}

/* ===== HOUSEHOLD SELECTOR ===== */
.household-card {
  padding: 15px;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: all 0.3s;
  background: white;
}

.household-card:hover {
  border-color: #4caf50;
  background: #f1f8f4;
  transform: translateX(5px);
}

.household-card.selected {
  border-color: #4caf50;
  background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
  box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
}

.household-card-header {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 10px;
}

.household-card-photo {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid #4caf50;
}

.household-card-photo.placeholder {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: #e0e0e0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  border: 3px solid #e0e0e0;
}

.household-card-info h4 {
  margin: 0 0 5px 0;
  font-size: 18px;
  color: #333;
}

.household-card-info p {
  margin: 0;
  font-size: 13px;
  color: #666;
}

.household-card-details {
  padding-left: 75px;
  font-size: 13px;
  color: #777;
}

.household-card-details span {
  display: inline-block;
  margin-right: 15px;
}

/* ===== MOBILE MEMBER SECTION ===== */
.mobile-member-section {
  background: linear-gradient(135deg, #f8f9ff 0%, #fff 100%);
  border: 2px solid #667eea;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 20px;
  position: relative;
}

.mobile-member-section:nth-child(even) {
  background: linear-gradient(135deg, #fff9f0 0%, #fff 100%);
  border-left: 5px solid #ff9800;
}

.mobile-member-section h3::before {
  content: attr(data-member-number);
  position: absolute;
  left: -15px;
  top: 15px;
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: bold;
  box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4);
}

/* ===== RENTAL PERIODS (Dynamic Dates) ===== */
.rental-periods-container {
  border: 2px dashed #667eea;
  border-radius: 10px;
  padding: 15px;
  background: #f8f9ff;
  margin-top: 10px;
}

.rental-period-item {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
  padding: 10px;
  background: white;
  border-radius: 8px;
  border: 1px solid #e0e0e0;
}

.rental-period-item label {
  min-width: 80px;
  font-weight: 600;
  color: #667eea;
}

.rental-period-item input[type="text"],
.rental-period-item input[type="number"] {
  padding: 8px 12px;
  border: 2px solid #e0e0e0;
  border-radius: 5px;
  font-size: 14px;
}

.rental-period-item .date-input {
  flex: 1;
  max-width: 150px;
}

.rental-period-item .days-input {
  width: 100px;
}

.rental-period-item .end-date-display {
  flex: 1;
  padding: 8px 12px;
  background: #e8f5e9;
  border: 2px solid #4caf50;
  border-radius: 5px;
  font-weight: 600;
  color: #2e7d32;
}

.btn-add-period {
  width: 100%;
  padding: 10px;
  background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s;
  margin-top: 10px;
}

.btn-add-period:hover {
  background: linear-gradient(135deg, #66bb6a 0%, #81c784 100%);
  transform: translateY(-2px);
}

.btn-remove-period {
  padding: 8px 12px;
  background: #f44336;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.3s;
}

.btn-remove-period:hover {
  background: #da190b;
  transform: scale(1.05);
}

    .loading-counter {
  color: white;
  font-size: 48px;
  font-weight: bold;
  margin-top: 20px;
  font-family: 'Courier New', monospace;
  text-shadow: 0 0 20px rgba(102, 126, 234, 0.8);
  animation: counterPulse 1s infinite;
}

.loading-message {
  color: white;
  font-size: 18px;
  margin-top: 10px;
  opacity: 0.9;
}

@keyframes counterPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}
    /* ‡∏™‡∏µ‡πÑ‡∏•‡πà‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å */
.member-section:nth-child(odd) {
  background: linear-gradient(135deg, #f8f9ff 0%, #fff 100%) !important;
  border-left: 5px solid #667eea !important;
}

.member-section:nth-child(even) {
  background: linear-gradient(135deg, #fff9f0 0%, #fff 100%) !important;
  border-left: 5px solid #ff9800 !important;
}

.member-section:nth-child(3n) {
  background: linear-gradient(135deg, #f0fff4 0%, #fff 100%) !important;
  border-left: 5px solid #4caf50 !important;
}

.member-section:nth-child(4n) {
  background: linear-gradient(135deg, #fff0f5 0%, #fff 100%) !important;
  border-left: 5px solid #e91e63 !important;
}

.member-section:nth-child(5n) {
  background: linear-gradient(135deg, #f0f8ff 0%, #fff 100%) !important;
  border-left: 5px solid #2196f3 !important;
}

/* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏≤‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô */
.member-section {
  box-shadow: 0 3px 10px rgba(0,0,0,0.1) !important;
  transition: all 0.3s ease !important;
  position: relative;
  padding-left: 25px !important;
}

.member-section:hover {
  box-shadow: 0 5px 20px rgba(0,0,0,0.15) !important;
  transform: translateX(5px);
}

/* ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ü‡∏≠‡∏£‡πå‡∏° */
.member-section h3::before {
  content: attr(data-member-number);
  position: absolute;
  left: -15px;
  top: 15px;
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: bold;
  box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4);
  z-index: 10;
}

.member-section:nth-child(even) h3::before {
  background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
}

.member-section:nth-child(3n) h3::before {
  background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
}

.member-section:nth-child(4n) h3::before {
  background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
}

.member-section:nth-child(5n) h3::before {
  background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
}
/* Animation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Disease Tags */
/* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡∏ô‡∏≤‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô (‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡πâ‡∏≠ 2 ‡πÅ‡∏•‡∏∞ 3) */
input[type="date"] {
  min-width: 200px !important;
  width: 100% !important;
  padding: 12px !important;
  font-size: 16px !important;
}

.member-section input[type="date"] {
  min-width: 220px !important;
  width: 100% !important;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(-20px) scale(0.8);
  }
  to {
    opacity: 1;
    transform: translateX(0) scale(1);
  }
}
    /* Validation Styles */
.required-field {
  position: relative;
}

.required-field.invalid {
  border-color: #f44336 !important;
  animation: shake 0.5s, blink 1s infinite;
  background: #ffebee !important;
}

@keyframes blink {
  0%, 100% { 
    box-shadow: 0 0 10px rgba(244, 67, 54, 0.5);
  }
  50% { 
    box-shadow: 0 0 20px rgba(244, 67, 54, 0.8);
  }
}

.validation-error-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  border-radius: 15px;
  padding: 30px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  z-index: 10001;
  animation: popupAppear 0.3s ease-out;
}

@keyframes popupAppear {
  from {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.8);
  }
  to {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }
}

.validation-error-header {
  display: flex;
  align-items: center;
  gap: 10px;
  color: #f44336;
  font-size: 1.5rem;
  font-weight: bold;
  margin-bottom: 20px;
}

.validation-error-list {
  max-height: 300px;
  overflow-y: auto;
  margin-bottom: 20px;
}

.validation-error-item {
  padding: 10px;
  background: #ffebee;
  border-left: 4px solid #f44336;
  border-radius: 5px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 10px;
}
    /* Hide photo upload by default for new members */
.member-section .photo-upload-wrapper {
  display: none;
  opacity: 0;
  transition: all 0.5s ease;
  margin-bottom: 20px;
}

.member-section .photo-upload-wrapper.show {
  display: block;
  opacity: 1;
  animation: slideDown 0.5s ease;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Photo upload notice */
.photo-upload-notice {
  background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
  border: 2px solid #ffc107;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 14px;
  color: #856404;
  box-shadow: 0 3px 10px rgba(255, 193, 7, 0.2);
}

.photo-upload-notice.hidden {
  display: none;
}

.photo-upload-notice .icon {
  font-size: 28px;
  animation: bounce 2s infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-5px); }
}
    /* Beautiful custom marker styling */
.custom-beautiful-marker {
  z-index: 1000 !important;
}

.custom-map-marker {
  animation: markerBounce 0.5s ease-out;
  filter: drop-shadow(0 4px 8px rgba(244, 67, 54, 0.4));
  transition: all 0.3s ease;
}

.custom-map-marker:hover {
  filter: drop-shadow(0 6px 12px rgba(244, 67, 54, 0.6));
  transform: scale(1.1);
}

@keyframes markerBounce {
  0% {
    transform: translateY(-30px) scale(0.8);
    opacity: 0;
  }
  60% {
    transform: translateY(5px) scale(1.1);
  }
  100% {
    transform: translateY(0) scale(1);
    opacity: 1;
  }
}

/* Pulse animation for marker */
.custom-beautiful-marker .custom-map-marker {
  position: relative;
}

.custom-beautiful-marker .custom-map-marker::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 40px;
  height: 40px;
  margin: -20px 0 0 -20px;
  border-radius: 50%;
  background: rgba(244, 67, 54, 0.3);
  animation: markerPulse 2s infinite;
}

@keyframes markerPulse {
  0% {
    transform: scale(0.5);
    opacity: 1;
  }
  100% {
    transform: scale(2);
    opacity: 0;
  }
}

/* Marker drag state */
.leaflet-marker-draggable {
  cursor: move !important;
}

.leaflet-marker-draggable:active {
  cursor: grabbing !important;
}
    /* Disable interaction for auto-calculated fields */
#registryBookCount,
#registryNumber {
  pointer-events: none;
  user-select: none;
  cursor: not-allowed;
}

/* Make it visually clear these are auto-calculated */
#registryBookCount:focus,
#registryNumber:focus {
  outline: none;
  border-color: inherit;
  box-shadow: none;
}
/* Enhanced Registry Number Item Styling */
.registry-number-item {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 15px;
  padding: 15px;
  background: #f8f9ff;
  border-radius: 8px;
  border: 1px solid #e0e0e0;
  flex-wrap: wrap;
}

.registry-number-item label {
  min-width: 80px;
  font-weight: 600;
  color: #667eea;
}

.registry-input-group {
  display: flex;
  gap: 10px;
  flex: 1;
  align-items: center;
  flex-wrap: wrap;
  min-width: 500px;
}

.registry-input-group .number-input {
  flex: 1;
  min-width: 200px;
  padding: 10px;
  font-size: 16px;
}

.registry-number-item label {
  min-width: 70px;
  font-weight: 600;
  color: #667eea;
}

.registry-input-group {
  display: flex;
  gap: 10px;
  flex: 1;
  align-items: center;
}

.registry-input-group .number-input {
  flex: 1;
  max-width: 200px;
}

.registry-input-group .date-inputs {
  display: flex;
  gap: 5px;
  align-items: center;
}

.registry-input-group .date-inputs input {
  width: 80px;
  min-width: 80px;
  text-align: center;
  padding: 8px;
  font-size: 16px;
}

.registry-input-group .date-inputs input:last-child {
  width: 100px;
  min-width: 100px;
}

.registry-input-group .date-inputs span {
  color: #666;
  font-size: 14px;
}
    /* Participation Option Styling */
.participation-option > div:hover {
  border-color: #667eea !important;
  background: #f8f9ff;
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

.participation-option.selected > div {
  border-color: #667eea !important;
  background: #f0f0ff;
  box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
}

.participation-option input[type="radio"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
}

/* Participation Display Styling */
#participationDisplay {
  font-size: 16px;
  font-weight: 600;
  text-align: center;
}

#participationDisplay.excellent {
  background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%) !important;
  color: #1b5e20;
  border: 2px solid #4caf50;
}

#participationDisplay.verygood {
  background: linear-gradient(135deg, #f1f8e9 0%, #dcedc8 100%) !important;
  color: #33691e;
  border: 2px solid #689f38;
}

#participationDisplay.moderate {
  background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%) !important;
  color: #f57f17;
  border: 2px solid #ffc107;
}

#participationDisplay.lacking {
  background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%) !important;
  color: #b71c1c;
  border: 2px solid #f44336;
}
    /* Beautiful marker */
.beautiful-marker {
  z-index: 1000 !important;
  animation: markerPulse 2s ease-out infinite;
}

@keyframes markerPulse {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.1);
  }
  100% {
    transform: scale(1);
  }
}

/* My location button special style */
#btnMyLocation {
  background: linear-gradient(135deg, #4285F4 0%, #1976D2 100%);
  color: white;
}

#btnMyLocation:hover {
  background: linear-gradient(135deg, #1976D2 0%, #0D47A1 100%);
}

#btnMyLocation.active {
  background: linear-gradient(135deg, #4285F4 0%, #1976D2 100%);
}
    /* Large marker styling */
.custom-marker-large {
  filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.5));
  cursor: move;
  z-index: 1000 !important;
}

.custom-marker-large:hover {
  filter: drop-shadow(0 6px 12px rgba(0, 0, 0, 0.7));
}

/* Ensure marker is on top */
.leaflet-marker-pane {
  z-index: 700 !important;
}

.leaflet-marker-icon {
  z-index: 1000 !important;
}
/* Custom marker animation */
.custom-marker {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.2);
  }
  100% {
    transform: scale(1);
  }
}
.registry-modal {
  max-width: 900px;
  width: 95%;
  max-height: 90vh;
  overflow-y: auto;
}

.registry-option {
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 15px;
  transition: all 0.3s;
}

.registry-option.selected {
  border-color: #4caf50;
  background: #f1f8f4;
}

.registry-option-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
  cursor: pointer;
  user-select: none;
}

.registry-option-header input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
}

.registry-option-header label {
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  flex: 1;
}

.registry-details {
  display: none;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid #e0e0e0;
}

.registry-details.active {
  display: block;
}

.registry-count-input {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 15px;
}

.registry-count-input label {
  font-weight: 600;
  min-width: 80px;
}

.registry-count-input input {
  flex: 1;
  padding: 8px 12px;
  border: 2px solid #e0e0e0;
  border-radius: 5px;
  font-size: 16px;
  text-align: center;
}

.registry-numbers {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.registry-number-item {
  display: flex;
  align-items: center;
  gap: 10px;
}

.registry-number-item label {
  min-width: 60px;
  font-weight: 500;
}

.registry-number-item input {
  flex: 1;
  padding: 8px 12px;
  border: 2px solid #e0e0e0;
  border-radius: 5px;
  font-size: 14px;
}

.registry-summary {
  background: #e3f2fd;
  border: 2px solid #2196F3;
  border-radius: 10px;
  padding: 15px;
  margin-top: 20px;
}

.registry-summary h4 {
  color: #1565c0;
  margin-bottom: 10px;
}

.registry-summary-item {
  display: flex;
  justify-content: space-between;
  padding: 5px 0;
  border-bottom: 1px solid #90caf9;
}

.registry-summary-item:last-child {
  border-bottom: none;
  font-weight: 600;
  color: #1565c0;
}
/* ===== MAP LAYER SWITCHER ===== */
.map-layer-switcher {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 1000;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  overflow: hidden;
  display: flex;
}

.map-layer-btn {
  padding: 10px 20px;
  border: none;
  background: white;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s;
  border-right: 1px solid #e0e0e0;
}

.map-layer-btn:last-child {
  border-right: none;
}

.map-layer-btn.active {
  background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
  color: white;
}

.map-layer-btn:hover {
  background: #f0f0f0;
}

.map-layer-btn.active:hover {
  background: linear-gradient(135deg, #66bb6a 0%, #81c784 100%);
}
    /* ===== IMAGE CROP MODAL ===== */
.crop-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.95);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 10002;
}

.crop-modal.active {
  display: flex;
}

.crop-modal-content {
  background: white;
  border-radius: 15px;
  padding: 20px;
  max-width: 95%;
  max-height: 95%;
  width: 1200px;
  display: flex;
  flex-direction: column;
}

.crop-modal h2 {
  margin-bottom: 15px;
  color: #667eea;
  text-align: center;
}

.crop-container {
  flex: 1;
  max-height: 500px;
  margin-bottom: 15px;
  background: #f5f5f5;
  border-radius: 10px;
  overflow: hidden;
}

.crop-container img {
  max-width: 100%;
  display: block;
}

.crop-tools {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

.crop-tool-btn {
  padding: 10px 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 5px;
}

.crop-tool-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.crop-tool-btn:active {
  transform: translateY(0);
}

.crop-buttons {
  display: flex;
  gap: 10px;
}

.crop-buttons button {
  flex: 1;
}

.aspect-ratio-selector {
  display: flex;
  gap: 5px;
  margin-bottom: 15px;
  justify-content: center;
  flex-wrap: wrap;
}

.aspect-btn {
  padding: 8px 15px;
  background: #e0e0e0;
  border: 2px solid transparent;
  border-radius: 5px;
  cursor: pointer;
  transition: all 0.3s;
}

.aspect-btn.active {
  background: #667eea;
  color: white;
  border-color: #764ba2;
}

.aspect-btn:hover {
  background: #d0d0d0;
}

.aspect-btn.active:hover {
  background: #5568d3;
}
    /* ===== LOCATION PICKER BUTTON ===== */
.btn-location {
  padding: 12px 20px;
  background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 2px 5px rgba(76, 175, 80, 0.3);
}

.btn-location:hover {
  background: linear-gradient(135deg, #66bb6a 0%, #81c784 100%);
  transform: scale(1.1);
  box-shadow: 0 4px 10px rgba(76, 175, 80, 0.5);
}

/* ===== LOCATION PICKER MODAL ===== */
.location-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 10001;
}

.location-modal.active {
  display: flex;
}

.location-modal-content {
  background: white;
  border-radius: 15px;
  padding: 20px;
  max-width: 90%;
  max-height: 90%;
  width: 800px;
  height: 600px;
  display: flex;
  flex-direction: column;
}

.location-modal h2 {
  margin-bottom: 15px;
  color: #4caf50;
}

#map {
  flex: 1;
  border-radius: 10px;
  margin-bottom: 15px;
}

.location-info {
  background: #f5f5f5;
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 15px;
  font-family: monospace;
}

.location-buttons {
  display: flex;
  gap: 10px;
}

.location-buttons button {
  flex: 1;
}
/* ===== FIX MAP DISPLAY ===== */
#map {
  width: 100%;
  height: 400px;
  z-index: 1;
}

.location-modal-content {
  display: flex;
  flex-direction: column;
}

.location-buttons button {
  padding: 12px 24px;
}

/* Fix for Leaflet controls */
.leaflet-control-layers,
.leaflet-control-zoom {
  margin: 10px !important;
}

.leaflet-container {
  font-size: 14px;
  font-family: 'Phetsarath OT', 'Noto Sans Lao', Arial, sans-serif;
}
    /* ===== MEMBER HIGHLIGHT ===== */
.member-editing {
  background: linear-gradient(135deg, #fff3cd 0%, #fff8e1 100%);
  border: 3px solid #ffc107;
  animation: highlightPulse 1.5s infinite;
  scroll-margin-top: 100px;
}

@keyframes highlightPulse {
  0%, 100% { 
    box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7);
  }
  50% { 
    box-shadow: 0 0 0 10px rgba(255, 193, 7, 0);
  }
}

/* ===== HOUSEHOLD SECTION STYLING ===== */
.form-section.household-section {
  background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
  border: 3px solid #667eea;
}

.form-section.member-section {
  background: #f8f9ff;
  border: 2px solid #e0e0e0;
}

/* ===== IMAGE PREVIEW MODAL ===== */
.image-preview-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 10000;
  cursor: zoom-out;
}

.image-preview-modal.active {
  display: flex;
}

.image-preview-modal img {
  max-width: 90%;
  max-height: 90%;
  object-fit: contain;
  border-radius: 10px;
  box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
}

/* ===== PROFILE IMAGE CLICKABLE ===== */
.profile-img {
  cursor: pointer;
  transition: transform 0.3s;
}

.profile-img:hover {
  transform: scale(1.1);
}

/* ===== PAGINATION ===== */
.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
  margin: 20px 0;
  flex-wrap: wrap;
}

.pagination button {
  padding: 10px 15px;
  background: #667eea;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  transition: all 0.3s;
  min-width: 40px;
}

.pagination button:hover:not(:disabled) {
  background: #5568d3;
  transform: translateY(-2px);
}

.pagination button:disabled {
  background: #ccc;
  cursor: not-allowed;
  opacity: 0.5;
}

.pagination .page-info {
  padding: 10px 20px;
  background: #f0f0f0;
  border-radius: 5px;
  font-weight: 600;
}
/* ===== WHATSAPP BUTTON ===== */
.btn-whatsapp {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  background: #25D366;
  color: white;
  border-radius: 50%;
  text-decoration: none;
  transition: all 0.3s;
  box-shadow: 0 2px 5px rgba(37, 211, 102, 0.3);
}

.btn-whatsapp:hover {
  background: #128C7E;
  transform: scale(1.1);
  box-shadow: 0 4px 10px rgba(37, 211, 102, 0.5);
}

.btn-whatsapp svg {
  width: 24px;
  height: 24px;
}
    /* ===== DATALIST STYLING ===== */
input[list] {
  background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path fill="%23333" d="M6 9L1 4h10z"/></svg>');
  background-repeat: no-repeat;
  background-position: right 10px center;
  padding-right: 30px;
  cursor: pointer;
}

input[list]::-webkit-calendar-picker-indicator {
  opacity: 0;
  cursor: pointer;
}

input[list]:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

input[list]::placeholder {
  color: #999;
  font-size: 14px;
}

input[list]:disabled {
  background-color: #f5f5f5;
  cursor: not-allowed;
  opacity: 0.6;
}
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Phetsarath OT', 'Noto Sans Lao', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      width: 100%;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
      display: none;
    }

    .container.active {
      display: block;
    }

    /* ===== LOGIN MODAL ===== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: white;
      border-radius: 15px;
      padding: 40px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.7);
      transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal {
      transform: scale(1);
    }

    .modal h2 {
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
      font-size: 24px;
    }

    .form-group {
      margin-bottom: 20px;
      position: relative;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #e0e0e0;
      color: #333;
      margin-top: 10px;
    }

    .btn-secondary:hover {
      background: #d0d0d0;
    }

    /* ===== HEADER ===== */
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-name {
      font-size: 14px;
    }

    .btn-logout {
      padding: 8px 20px;
      background: rgba(255,255,255,0.2);
      border: 1px solid white;
      border-radius: 20px;
      color: white;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-logout:hover {
      background: white;
      color: #667eea;
    }

    /* ===== MENU ===== */
    .menu {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      padding: 40px;
    }

    .menu-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px 30px;
      border-radius: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .menu-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }

    .menu-card .icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .menu-card h3 {
      font-size: 20px;
    }

    /* ===== FORM MODAL ===== */
    .form-modal {
      max-width: 900px;
      max-height: 85vh;
    }

   /* ===== FORM SECTIONS ===== */
.form-section {
  border: 2px solid #667eea;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 20px;
  background: #f8f9ff;
}

/* HOUSEHOLD MAIN SECTION - ‡∏™‡∏µ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß */
.form-section.household-main-section {
  background: linear-gradient(135deg, #e8f5e9 0%, #fff9c4 50%, #ffe0b2 100%);
  border: 3px solid #4caf50;
  box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
  position: relative;
}

.form-section.household-main-section::before {
  content: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß‡∫´‡∫º‡∫±‡∫Å";
  position: absolute;
  top: -15px;
  left: 20px;
  background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
  color: white;
  padding: 5px 15px;
  border-radius: 20px;
  font-weight: 600;
  font-size: 14px;
  box-shadow: 0 3px 10px rgba(76, 175, 80, 0.4);
}

.form-section.household-main-section h3 {
  color: #2e7d32;
  margin-top: 10px;
}

/* MEMBER SECTIONS - ‡∏™‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å */
.form-section.member-section {
  background: linear-gradient(135deg, #f8f9ff 0%, #fff 100%);
  border: 2px solid #e0e0e0;
}

.form-section.member-section h3 {
  color: #667eea;
}


    .form-section h3 {
      color: #667eea;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .photo-upload {
      text-align: center;
      padding: 20px;
      border: 2px dashed #667eea;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .photo-upload:hover {
      background: #f0f0ff;
    }

    .photo-preview {
      width: 150px;
      height: 150px;
      margin: 0 auto 10px;
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f5f5;
    }

    .photo-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .photo-preview .placeholder {
      font-size: 60px;
      color: #ccc;
    }

    .btn-add-member {
      width: 100%;
      padding: 15px;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin: 20px 0;
    }

    .btn-add-member:hover {
      background: #45a049;
      transform: translateY(-2px);
    }

    .btn-delete-member {
      padding: 5px 15px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-delete-member:hover {
      background: #da190b;
    }

    .form-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .form-buttons button {
      flex: 1;
    }

    /* ===== DATA TABLE ===== */
    .data-container {
      padding: 40px;
      display: none;
    }

    .data-container.active {
      display: block;
    }

    .search-bar {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .search-bar input {
      flex: 1;
      min-width: 200px;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
    }

    .search-bar button {
      padding: 12px 30px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      white-space: nowrap;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .data-table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
    }

    .data-table td {
      padding: 15px;
      border-bottom: 1px solid #e0e0e0;
    }

    .data-table tr:hover {
      background: #f8f9ff;
    }

    .profile-img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #667eea;
    }

    .action-buttons {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .action-buttons button {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn-edit {
      background: #2196F3;
      color: white;
    }

    .btn-edit:hover {
      background: #0b7dda;
    }

    .btn-edit-family {
      background: #FF9800;
      color: white;
    }

    .btn-edit-family:hover {
      background: #e68900;
    }

    .btn-delete {
      background: #f44336;
      color: white;
    }

    .btn-delete:hover {
      background: #da190b;
    }

    .btn-delete-family {
      background: #9C27B0;
      color: white;
    }

    .btn-delete-family:hover {
      background: #7b1fa2;
    }

    .btn-back {
      margin-bottom: 20px;
      padding: 10px 20px;
      background: #607d8b;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .btn-back:hover {
      background: #546e7a;
    }

    /* ===== DELETE REASON MODAL ===== */
    .reason-modal {
      max-width: 400px;
    }

    .reason-options {
      margin: 20px 0;
    }

    .reason-option {
      display: flex;
      align-items: center;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .reason-option:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }

    .reason-option.selected {
      border-color: #667eea;
      background: #f0f0ff;
    }

    .reason-option input[type="radio"] {
      margin-right: 10px;
    }

    /* ===== LOADING ===== */
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .loading.active {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ===== TOAST NOTIFICATION ===== */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      z-index: 10000;
      display: none;
      animation: slideIn 0.3s ease;
    }

    .toast.active {
      display: block;
    }

    .toast.success {
      border-left: 4px solid #4caf50;
    }

    .toast.error {
      border-left: 4px solid #f44336;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* ===== IDLE WARNING ===== */
    .idle-warning {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #ff9800;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      z-index: 10000;
      display: none;
      animation: pulse 1s infinite;
    }

    .idle-warning.active {
      display: block;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* ===== DATE INPUTS ===== */
   .date-inputs {
  display: flex;
  gap: 8px;
  align-items: center;
  width: 100%;
}

.date-inputs input {
  padding: 12px 8px;
  text-align: center;
  font-size: 16px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-weight: 600;
}

.date-inputs input.birthDay {
  width: 80px;
  min-width: 80px;
}

.date-inputs input.birthMonth {
  width: 80px;
  min-width: 80px;
}

.date-inputs input.birthYear {
  width: 120px;
  min-width: 120px;
  flex: 1;
}

.date-inputs span {
  color: #666;
  font-size: 18px;
  font-weight: bold;
}


    /* ‚úÖ ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ 5: ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Auto fields */
    @keyframes greenPulse {
      0%, 100% { 
        background: #c8e6c9 !important;
        box-shadow: 0 0 10px rgba(76, 175, 80, 0.3) !important;
      }
      50% { 
        background: #a5d6a7 !important;
        box-shadow: 0 0 20px rgba(76, 175, 80, 0.6) !important;
      }
    }
    
    .auto-calculate-field {
      animation: greenPulse 1.5s infinite !important;
      background: #c8e6c9 !important;
      color: #2e7d32 !important;
      font-weight: 600 !important;
      border: 2px solid #4caf50 !important;
    }
    
    /* ‚úÖ ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ 6: Marker pulse animation */
    @keyframes markerPulse {
      0%, 100% { 
        transform: scale(1);
        opacity: 1;
      }
      50% { 
        transform: scale(1.2);
        opacity: 0.7;
      }
    }
    
    .location-marker {
      display: inline-block;
      animation: markerPulse 1s infinite;
      font-size: 28px;
      cursor: pointer;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .menu {
        grid-template-columns: 1fr;
        padding: 20px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .data-table {
        font-size: 12px;
      }

      .data-table th,
      .data-table td {
        padding: 8px;
      }

      .action-buttons {
        flex-direction: column;
      }

      .search-bar {
        flex-direction: column;
      }

      .search-bar input,
      .search-bar button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Spinner -->
  <div class="loading" id="loading">
  <div class="spinner"></div>
  <div class="loading-counter" id="loadingCounter">0</div>
  <div class="loading-message" id="loadingMessage">‡∫Å‡∫≥‡∫•‡∫±‡∫á‡ªÇ‡∫´‡∫•‡∫î‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô...</div>
</div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <!-- Idle Warning -->
  <div class="idle-warning" id="idleWarning">
    ‚ö†Ô∏è ‡∫ó‡ªà‡∫≤‡∫ô‡∫à‡∫∞‡∫ñ‡∫∑‡∫Å‡∫≠‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡ªÉ‡∫ô‡∫≠‡∫µ‡∫Å <span id="idleTimer">5</span> ‡∫ô‡∫≤‡∫ó‡∫µ
  </div>

  <!-- Login Modal -->
  <div class="modal-overlay active" id="loginModal">
    <div class="modal">
      <h2>üîê ‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡∫™‡∫π‡ªà‡∫•‡∫∞‡∫ö‡∫ª‡∫ö</h2>
      <form id="loginForm">
        <div class="form-group">
          <label>‡∫•‡∫∞‡∫´‡∫±‡∫î ‡∫≠‡∫™‡∫ö *</label>
          <input type="text" id="loginCode" required>
        </div>
       <div class="form-group">
  <label>‡∫ä‡∫∑‡ªà ‡ªÅ‡∫•‡∫∞ ‡∫ô‡∫≤‡∫°‡∫™‡∫∞‡∫Å‡∫∏‡∫ô *</label>
  <input type="text" id="loginName" list="loginNameList" required autocomplete="off" placeholder="‡∫û‡∫¥‡∫°‡∫ä‡∫∑‡ªà‡∫´‡∫º‡∫∑‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô">
  <datalist id="loginNameList"></datalist>
</div>
<div class="form-group">
  <label>‡ªÅ‡∫Ç‡∫ß‡∫á *</label>
  <input type="text" id="loginProvince" list="loginProvinceList" required autocomplete="off" placeholder="‡∫û‡∫¥‡∫°‡ªÅ‡∫Ç‡∫ß‡∫á‡∫´‡∫º‡∫∑‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô">
  <datalist id="loginProvinceList"></datalist>
</div>
<div class="form-group">
  <label>‡ªÄ‡∫°‡∫∑‡∫≠‡∫á *</label>
  <input type="text" id="loginDistrict" list="loginDistrictList" required autocomplete="off" placeholder="‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÅ‡∫Ç‡∫ß‡∫á‡∫Å‡ªà‡∫≠‡∫ô" disabled>
  <datalist id="loginDistrictList"></datalist>
</div>
<div class="form-group">
  <label>‡∫ö‡ªâ‡∫≤‡∫ô *</label>
  <input type="text" id="loginVillage" list="loginVillageList" required autocomplete="off" placeholder="‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÄ‡∫°‡∫∑‡∫≠‡∫á‡∫Å‡ªà‡∫≠‡∫ô" disabled>
  <datalist id="loginVillageList"></datalist>
</div>
        <button type="submit" class="btn btn-primary">‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡∫™‡∫π‡ªà‡∫•‡∫∞‡∫ö‡∫ª‡∫ö</button>

     
      </form>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container" id="mainContainer">
    <!-- Header -->
    <div class="header">
      <h1>üìä ‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫õ‡∫∞‡∫ä‡∫≤‡∫Å‡∫≠‡∫ô</h1>
      <div class="user-info">
        <div class="user-name">
          <div id="userName">üë§ ...</div>
          <div style="font-size: 12px; opacity: 0.9;" id="userLocation">üìç ...</div>
        </div>
        <button class="btn-logout" onclick="logout()">‡∫≠‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡∫•‡∫∞‡∫ö‡∫ª‡∫ö</button>
      </div>
    </div>

    <!-- Menu -->
    <div class="menu" id="menu">
      <div class="menu-card" onclick="openPopulation()">
        <div class="icon">üë•</div>
        <h3>‡∫õ‡∫∞‡∫ä‡∫≤‡∫Å‡∫≠‡∫ô‡∫Ñ‡∫ª‡∫á‡∫ó‡∫µ‡ªà</h3>
      </div>
     <div class="menu-card" onclick="openMobilePopulation()">
  <div class="icon">üö∂</div>
  <h3>‡∫õ‡∫∞‡∫ä‡∫≤‡∫Å‡∫≠‡∫ô‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫ô‡∫ó‡∫µ‡ªà</h3>
</div>
      <div class="menu-card" onclick="showToast('‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫û‡∫±‡∫î‡∫ó‡∫∞‡∫ô‡∫≤...', 'error')">
        <div class="icon">üèûÔ∏è</div>
        <h3>‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ó‡∫µ‡ªà‡∫î‡∫¥‡∫ô</h3>
      </div>
      <div class="menu-card" onclick="showToast('‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫û‡∫±‡∫î‡∫ó‡∫∞‡∫ô‡∫≤...', 'error')">
        <div class="icon">üöó</div>
        <h3>‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ç‡∫≤‡∫ô‡∫û‡∫≤‡∫´‡∫∞‡∫ô‡∫∞</h3>
      </div>
    </div>

    <!-- Data Container -->
    <div class="data-container" id="dataContainer">
      <button class="btn-back" onclick="backToMenu()">‚¨ÖÔ∏è ‡∫Å‡∫±‡∫ö‡∫Ñ‡∫∑‡∫ô‡ªÄ‡∫°‡∫ô‡∫π</button>
      
    <div class="search-bar">
  <input type="text" id="searchInput" placeholder="üîç ‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤‡∫ä‡∫∑‡ªà, ‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó, ‡∫ö‡ªâ‡∫≤‡∫ô..." onkeypress="if(event.key==='Enter') searchData()">
  <button onclick="searchData()">üîç ‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤</button>
  <button onclick="clearSearch()" style="background: #607d8b;">‚ùå ‡∫•‡ªâ‡∫≤‡∫á</button>
  <button class="btn-add-member" style="width: auto; margin: 0;" onclick="openHouseholdForm()">‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß‡ªÉ‡ªù‡ªà</button>
</div>

      <div style="overflow-x: auto;">
      <table class="data-table" id="dataTable">
          <thead>
            <tr>
              <th>‡∫Æ‡∫π‡∫ö</th>
              <th>‡∫ä‡∫∑‡ªà-‡∫ô‡∫≤‡∫°‡∫™‡∫∞‡∫Å‡∫∏‡∫ô</th>
              <th>‡ªÄ‡∫û‡∫î</th>
              <th>‡∫™‡∫≤‡∫ç‡∫û‡∫ª‡∫ß‡∫û‡∫±‡∫ô</th>
              <th>‡ªú‡ªà‡∫ß‡∫ç</th>
              <th>‡∫ï‡∫¥‡∫î‡∫ï‡ªç‡ªà</th>
              <th>‡∫Å‡∫≤‡∫ô‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô</th>
            </tr>
          </thead>
          <tbody id="dataTableBody">
            <tr>
              <td colspan="7" style="text-align: center; padding: 40px;">
                <div style="font-size: 48px; margin-bottom: 10px;">üìã</div>
                <div>‡∫Å‡∫≥‡∫•‡∫±‡∫á‡ªÇ‡∫´‡∫•‡∫î‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô...</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination" id="pagination">
        <button onclick="changePage('first')" id="btnFirst">‚èÆÔ∏è ‡ªú‡ªâ‡∫≤‡∫ó‡∫≥‡∫≠‡∫¥‡∫î</button>
        <button onclick="changePage('prev')" id="btnPrev">‚óÄÔ∏è ‡∫Å‡ªà‡∫≠‡∫ô‡ªú‡ªâ‡∫≤</button>
        <span class="page-info">
          ‡ªú‡ªâ‡∫≤ <span id="currentPage">1</span> / <span id="totalPages">1</span>
        </span>
        <button onclick="changePage('next')" id="btnNext">‚ñ∂Ô∏è ‡∫ï‡ªç‡ªà‡ªÑ‡∫õ</button>
        <button onclick="changePage('last')" id="btnLast">‡ªú‡ªâ‡∫≤‡∫™‡∫∏‡∫î‡∫ó‡ªâ‡∫≤‡∫ç ‚è≠Ô∏è</button>
      </div>
      
    </div>
    <!-- Mobile Population Container -->
<div class="data-container" id="mobileContainer">
  <button class="btn-back" onclick="backToMenu()">‚¨ÖÔ∏è ‡∫Å‡∫±‡∫ö‡∫Ñ‡∫∑‡∫ô‡ªÄ‡∫°‡∫ô‡∫π</button>
  
  <div class="search-bar">
    <input type="text" id="searchMobileInput" placeholder="üîç ‡∫ä‡∫∑‡ªà, ‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó, ‡ªÄ‡∫•‡∫Å‡∫´‡ªâ‡∫≠‡∫á..." onkeypress="if(event.key==='Enter') searchMobileData()">
    <button onclick="searchMobileData()">üîç ‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤</button>
    <button onclick="clearMobileSearch()" style="background: #607d8b;">‚ùå ‡∫•‡ªâ‡∫≤‡∫á</button>
    <button class="btn-add-member" style="width: auto; margin: 0;" onclick="openMobileTypeModal()">‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫õ‡∫∞‡∫ä‡∫≤‡∫Å‡∫≠‡∫ô‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫ô‡∫ó‡∫µ‡ªà</button>
  </div>

  <div style="overflow-x: auto;">
    <table class="data-table" id="mobileTable">
      <thead>
        <tr>
          <th>‡∫Æ‡∫π‡∫ö</th>
          <th>‡∫ä‡∫∑‡ªà-‡∫ô‡∫≤‡∫°‡∫™‡∫∞‡∫Å‡∫∏‡∫ô</th>
          <th>‡ªÄ‡∫û‡∫î</th>
          <th>‡ªÄ‡∫•‡∫Å‡∫´‡ªâ‡∫≠‡∫á</th>
          <th>‡∫õ‡∫∞‡ªÄ‡∫û‡∫î</th>
          <th>‡∫ï‡∫¥‡∫î‡∫ï‡ªç‡ªà</th>
          <th>‡∫Å‡∫≤‡∫ô‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô</th>
        </tr>
      </thead>
      <tbody id="mobileTableBody">
        <tr>
          <td colspan="7" style="text-align: center; padding: 40px;">
            <div style="font-size: 48px; margin-bottom: 10px;">üìã</div>
            <div>‡∫Å‡∫≥‡∫•‡∫±‡∫á‡ªÇ‡∫´‡∫•‡∫î‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô...</div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination" id="mobilePagination">
    <button onclick="changeMobilePage('first')" id="btnMobileFirst">‚èÆÔ∏è ‡ªú‡ªâ‡∫≤‡∫ó‡∫≥‡∫≠‡∫¥‡∫î</button>
    <button onclick="changeMobilePage('prev')" id="btnMobilePrev">‚óÄÔ∏è ‡∫Å‡ªà‡∫≠‡∫ô‡ªú‡ªâ‡∫≤</button>
    <span class="page-info">
      ‡ªú‡ªâ‡∫≤ <span id="currentMobilePage">1</span> / <span id="totalMobilePages">1</span>
    </span>
    <button onclick="changeMobilePage('next')" id="btnMobileNext">‚ñ∂Ô∏è ‡∫ï‡ªç‡ªà‡ªÑ‡∫õ</button>
    <button onclick="changeMobilePage('last')" id="btnMobileLast">‡ªú‡ªâ‡∫≤‡∫™‡∫∏‡∫î‡∫ó‡ªâ‡∫≤‡∫ç ‚è≠Ô∏è</button>
  </div>
</div>

  <!-- Household Form Modal -->
  <div class="modal-overlay" id="householdFormModal">
    <div class="modal form-modal">
      <h2 id="formTitle">‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß‡ªÉ‡ªù‡ªà</h2>
      <form id="householdForm">
        <!-- Household Section -->
       <div class="form-section household-main-section">
  <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß</h3>
  <input type="hidden" id="householdCode">
  
  <div class="form-group">
    <div class="photo-upload" onclick="document.getElementById('householdPhoto').click()">
      <div class="photo-preview" id="householdPhotoPreview">
        <div class="placeholder">‚ùì</div>
      </div>
      <p>üì∑ ‡∫≠‡∫±‡∫ö‡ªÇ‡∫´‡∫•‡∫î/‡∫ñ‡ªà‡∫≤‡∫ç‡∫Æ‡∫π‡∫ö</p>
      <p style="font-size: 12px; color: #666; margin-top: 5px;">üí° ‡∫Æ‡∫π‡∫ö‡∫ô‡∫µ‡ªâ‡∫à‡∫∞‡∫ñ‡∫∑‡∫Å‡∫Å‡∫±‡∫≠‡∫ö‡∫õ‡∫µ‡ªÑ‡∫õ‡ªÉ‡∫™‡ªà‡∫™‡∫∞‡∫°‡∫≤‡∫ä‡∫¥‡∫Å‡∫ó‡∫µ‡ªà‡ªÄ‡∫õ‡∫±‡∫ô "‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß" ‡∫≠‡∫±‡∫î‡∫ï‡∫∞‡ªÇ‡∫ô‡∫°‡∫±‡∫î</p>
      <input type="file" id="householdPhoto" accept="image/*" style="display: none" onchange="previewPhoto(this, 'householdPhotoPreview')">
    </div>
  </div>

  <!-- Row 1: Name, Phone, House Number -->
  <div class="form-row">
    <div class="form-group">
      <label>‡∫ä‡∫∑‡ªà ‡ªÅ‡∫•‡∫∞ ‡∫ô‡∫≤‡∫°‡∫™‡∫∞‡∫Å‡∫∏‡∫ô *</label>
      <input type="text" id="householdName" required>
    </div>
    <div class="form-group">
      <label>‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó‡∫•‡∫∞‡∫™‡∫±‡∫ö</label>
      <input type="tel" id="householdPhone" placeholder="20XXXXXXXX">
    </div>
    <div class="form-group">
      <label>‡ªÄ‡∫Æ‡∫∑‡∫≠‡∫ô‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ</label>
      <input type="text" id="houseNumber">
    </div>
  </div>

  <!-- Row 2: Roof Count, Household Count, Family Count -->
  <div class="form-row">
    <div class="form-group">
      <label>‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡∫´‡∫º‡∫±‡∫á‡∫Ñ‡∫≤‡ªÄ‡∫Æ‡∫∑‡∫≠‡∫ô *</label>
      <input type="number" id="roofCount" min="0" required>
    </div>
    <div class="form-group">
      <label>‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫Ñ‡∫ª‡∫ß‡ªÄ‡∫Æ‡∫∑‡∫≠‡∫ô *</label>
      <input type="number" id="householdCount" min="0" required>
    </div>
    <div class="form-group">
      <label>‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß *</label>
      <input type="number" id="familyCount" min="0" required>
    </div>
  </div>

  <!-- Row 3: Village, District, Province -->
  <div class="form-row">
    <div class="form-group">
      <label>‡∫ä‡∫∑‡ªà‡∫ö‡ªâ‡∫≤‡∫ô</label>
      <input type="text" id="village" readonly>
    </div>
    <div class="form-group">
      <label>‡ªÄ‡∫°‡∫∑‡∫≠‡∫á</label>
      <input type="text" id="district" readonly>
    </div>
    <div class="form-group">
      <label>‡ªÅ‡∫Ç‡∫ß‡∫á</label>
      <input type="text" id="province" readonly>
    </div>
  </div>

  <!-- Row 4: Rental Location, Unit, House Position -->
  <div class="form-row">
    <div class="form-group">
      <label>‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫ó‡∫µ‡ªà‡∫û‡∫±‡∫Å‡ªÄ‡∫ä‡∫ª‡ªà‡∫≤ *</label>
      <input type="text" id="rentalLocation" list="rentalLocationList" required>
      <datalist id="rentalLocationList"></datalist>
    </div>
    <div class="form-group">
      <label>‡ªú‡ªà‡∫ß‡∫ç *</label>
      <input type="text" id="unit" required>
    </div>
    <div class="form-group">
      <label>‡∫ï‡ªç‡∫≤‡ªÅ‡ªú‡ªà‡∫á‡ªÄ‡∫Æ‡∫∑‡∫≠‡∫ô (Latitude, Longitude)</label>
      <div style="display: flex; gap: 5px;">
        <input type="text" id="housePosition" placeholder="‰æã: 17.9757, 102.6331" style="flex: 1;">
        <button type="button" onclick="openLocationPicker()" class="btn-location" title="‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡ªÅ‡∫ú‡∫ô‡∫ó‡∫µ‡ªà">
          üìç
        </button>
      </div>
    </div>
  </div>

  <!-- Row 5: Registry Management -->
  <div class="form-row">
    <div class="form-group">
      <label>‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô‡∫™‡ªç‡∫≤‡∫°‡∫∞‡ªÇ‡∫ô‡∫Ñ‡∫ª‡∫ß *</label>
      <button type="button" class="btn btn-primary" onclick="openRegistryModal()" style="width: 100%; padding: 12px;">
        ‚öôÔ∏è ‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô‡∫™‡ªç‡∫≤‡∫°‡∫∞‡ªÇ‡∫ô‡∫Ñ‡∫ª‡∫ß
      </button>
    </div>
    <div class="form-group">
      <label>‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡∫õ‡∫∑‡ªâ‡∫°‡∫™‡ªç‡∫≤‡∫°‡∫∞‡ªÇ‡∫ô‡∫Ñ‡∫ª‡∫ß üìö (Auto)</label>
      <input type="number" id="registryBookCount" min="0" class="auto-calculate-field" readonly style="background: #e8f5e9; font-weight: 600; color: #2e7d32;">
    </div>
    <div class="form-group">
      <label>‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ‡∫™‡ªç‡∫≤‡∫°‡∫∞‡ªÇ‡∫ô‡∫Ñ‡∫ª‡∫ß üî¢ (Auto)</label>
      <textarea id="registryNumber" rows="2" class="auto-calculate-field" readonly style="background: #e3f2fd; font-weight: 600; color: #1565c0; resize: vertical; width: 100%; padding: 10px; border: 2px solid #90caf9; border-radius: 5px;"></textarea>
    </div>
  </div>

  <!-- Row 6: Family Member Count, Page Count -->
  <div class="form-row">
    <div class="form-group">
      <label>‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡∫Ñ‡∫ª‡∫ô‡ªÉ‡∫ô‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß üë• (Auto)</label>
      <input type="number" id="familyMemberCount" min="0" class="auto-calculate-field" readonly style="background: #e8f5e9; font-weight: 600; color: #2e7d32;">
    </div>
    <div class="form-group">
      <label>‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡∫°‡∫µ‡ªú‡ªâ‡∫≤‡ªÉ‡∫ô‡∫™‡ªç‡∫≤‡∫°‡∫∞‡ªÇ‡∫ô‡∫Ñ‡∫ª‡∫ß üìã (Auto)</label>
      <input type="number" id="pageCount" min="0" class="auto-calculate-field" readonly style="background: #e3f2fd; font-weight: 600; color: #1565c0;">
    </div>
  </div>

  <!-- Row 7: Village Participation -->
  <div class="form-row">
    <div class="form-group" style="grid-column: 1 / -1;">
      <label>‡∫Å‡∫≤‡∫ô‡∫°‡∫µ‡∫™‡ªà‡∫ß‡∫ô‡∫Æ‡ªà‡∫ß‡∫°‡∫Å‡∫±‡∫ö‡∫Å‡∫≤‡∫ô‡∫à‡∫±‡∫î‡∫ï‡∫±‡ªâ‡∫á‡∫ö‡ªâ‡∫≤‡∫ô *</label>
      <button type="button" class="btn btn-primary" onclick="openParticipationModal()" style="width: 100%; padding: 12px;">
        ü§ù ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫•‡∫∞‡∫î‡∫±‡∫ö‡∫Å‡∫≤‡∫ô‡∫°‡∫µ‡∫™‡ªà‡∫ß‡∫ô‡∫Æ‡ªà‡∫ß‡∫°
      </button>
      <input type="hidden" id="villageParticipation" required>
      <div id="participationDisplay" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px; display: none;">
        <span id="participationText"></span>
      </div>
    </div>
  </div>

  <!-- Hidden field for old monthly income (removed from UI) -->
  <input type="hidden" id="monthlyIncome" value="0">
</div>

        <!-- Members Container -->
        <div id="membersContainer"></div>

        <button type="button" class="btn-add-member" onclick="addMemberForm()">‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫™‡∫∞‡∫°‡∫≤‡∫ä‡∫¥‡∫Å‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß</button>

        <div class="form-buttons">
          <button type="submit" class="btn btn-primary">üíæ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î</button>
          <button type="button" class="btn btn-secondary" onclick="closeHouseholdForm()">‚ùå ‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>
        </div>
      </form>
    </div>
  </div>

 <!-- Delete Reason Modal -->
  <div class="modal-overlay" id="deleteReasonModal">
    <div class="modal reason-modal">
      <h2 id="deleteModalTitle">‚ö†Ô∏è ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫•‡∫∞‡∫ö‡∫∏‡ªÄ‡∫´‡∫î‡∫ú‡∫ª‡∫ô‡∫Å‡∫≤‡∫ô‡∫•‡∫ª‡∫ö</h2>
      <div class="reason-options" id="deleteReasonOptions">
        <!-- Options will be dynamically added here -->
      </div>
      <div class="form-buttons">
        <button type="button" class="btn btn-primary" id="confirmDeleteBtn" onclick="confirmDelete()" disabled>‚úÖ ‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô‡∫•‡∫ª‡∫ö</button>
        <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">‚ùå ‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>
      </div>
    </div>
  </div>
  <!-- Mobile Type Selection Modal -->
<div class="modal-overlay" id="mobileTypeModal">
  <div class="modal" style="max-width: 500px;">
    <h2>üö∂ ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫õ‡∫∞‡ªÄ‡∫û‡∫î‡∫õ‡∫∞‡∫ä‡∫≤‡∫Å‡∫≠‡∫ô‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫ô‡∫ó‡∫µ‡ªà</h2>
    
    <div style="margin: 30px 0;">
      <div class="mobile-type-option" onclick="selectMobileType('‡∫û‡∫±‡∫Å‡ªÄ‡∫ä‡∫ª‡∫≤‡∫Ñ‡∫ª‡∫á‡∫ó‡∫µ‡ªà')" data-type="‡∫û‡∫±‡∫Å‡ªÄ‡∫ä‡∫ª‡∫≤‡∫Ñ‡∫ª‡∫á‡∫ó‡∫µ‡ªà">
        <div style="display: flex; align-items: center; padding: 20px; border: 3px solid #e0e0e0; border-radius: 15px; cursor: pointer; transition: all 0.3s; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
          <div style="font-size: 48px; margin-right: 20px;">üè†</div>
          <div style="flex: 1;">
            <div style="font-size: 20px; font-weight: 600; color: #1976d2; margin-bottom: 5px;">‡∫û‡∫±‡∫Å‡ªÄ‡∫ä‡∫ª‡∫≤‡∫Ñ‡∫ª‡∫á‡∫ó‡∫µ‡ªà</div>
            <div style="font-size: 14px; color: #555;">‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß‡∫ó‡∫µ‡ªà‡∫°‡∫µ‡∫¢‡∫π‡ªà‡ªÅ‡∫•‡ªâ‡∫ß</div>
          </div>
        </div>
      </div>
      
      <div class="mobile-type-option" onclick="selectMobileType('‡∫û‡∫±‡∫Å‡ªÄ‡∫ä‡∫ª‡∫≤‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫ô‡∫ó‡∫µ‡ªà')" data-type="‡∫û‡∫±‡∫Å‡ªÄ‡∫ä‡∫ª‡∫≤‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫ô‡∫ó‡∫µ‡ªà" style="margin-top: 15px;">
        <div style="display: flex; align-items: center; padding: 20px; border: 3px solid #e0e0e0; border-radius: 15px; cursor: pointer; transition: all 0.3s; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);">
          <div style="font-size: 48px; margin-right: 20px;">üöó</div>
          <div style="flex: 1;">
            <div style="font-size: 20px; font-weight: 600; color: #f57c00; margin-bottom: 5px;">‡∫û‡∫±‡∫Å‡ªÄ‡∫ä‡∫ª‡∫≤‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫ô‡∫ó‡∫µ‡ªà</div>
            <div style="font-size: 14px; color: #555;">‡∫™‡ªâ‡∫≤‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÉ‡ªù‡ªà‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="form-buttons">
      <button type="button" class="btn btn-secondary" onclick="closeMobileTypeModal()">‚ùå ‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>
    </div>
  </div>
</div>

<!-- Household Selector Modal (for ‡∫û‡∫±‡∫Å‡ªÄ‡∫ä‡∫ª‡∫≤‡∫Ñ‡∫ª‡∫á‡∫ó‡∫µ‡ªà) -->
<div class="modal-overlay" id="householdSelectorModal">
  <div class="modal" style="max-width: 600px;">
    <h2>üè† ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß</h2>
    
    <div class="form-group">
      <label>‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤‡∫ä‡∫∑‡ªà‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß</label>
      <input type="text" id="householdSearchInput" list="householdNameList" placeholder="‡∫û‡∫¥‡∫°‡∫ä‡∫∑‡ªà‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤..." oninput="filterHouseholdList()">
      <datalist id="householdNameList"></datalist>
    </div>
    
    <div id="householdListContainer" style="max-height: 400px; overflow-y: auto; margin: 20px 0; border: 2px solid #e0e0e0; border-radius: 10px; padding: 10px;">
      <!-- Household cards will be inserted here -->
    </div>
    
    <div class="form-buttons">
      <button type="button" class="btn btn-secondary" onclick="closeHouseholdSelectorModal()">‚ùå ‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>
    </div>
  </div>
</div>

<!-- Mobile Form Modal -->
<div class="modal-overlay" id="mobileFormModal">
  <div class="modal form-modal">
    <h2 id="mobileFormTitle">‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫õ‡∫∞‡∫ä‡∫≤‡∫Å‡∫≠‡∫ô‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫ô‡∫ó‡∫µ‡ªà</h2>
    <form id="mobileForm">
      <input type="hidden" id="mobileCode">
      <input type="hidden" id="mobileType">
      
      <!-- Main Section -->
      <div class="form-section" style="background: linear-gradient(135deg, #e8f5e9 0%, #fff9c4 50%, #ffe0b2 100%); border: 3px solid #4caf50;">
        <h3>üìã ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫´‡∫º‡∫±‡∫Å</h3>
        
        <!-- Row 1: Owner Name, Household Code, Room Number -->
        <div class="form-row">
          <div class="form-group">
            <label>‡∫ä‡∫∑‡ªà‡ªÄ‡∫à‡∫ª‡ªâ‡∫≤‡∫Ç‡∫≠‡∫á‡∫´‡ªâ‡∫≠‡∫á‡ªÅ‡∫ñ‡∫ß *</label>
            <input type="text" id="mobileOwnerName" list="ownerNameList" required>
            <datalist id="ownerNameList"></datalist>
          </div>
          <div class="form-group">
            <label>‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫´‡ªâ‡∫≠‡∫á‡ªÅ‡∫ñ‡∫ß</label>
            <input type="text" id="mobileHouseholdCode" readonly style="background: #e8f5e9;">
          </div>
          <div class="form-group">
            <label>‡∫´‡ªâ‡∫≠‡∫á‡ªÄ‡∫ö‡∫µ‡∫ó‡∫µ *</label>
            <input type="number" id="mobileRoomNumber" required>
          </div>
        </div>
        
        <!-- Row 2: Province, District, Village -->
        <div class="form-row">
          <div class="form-group">
            <label>‡ªÅ‡∫Ç‡∫ß‡∫á‡∫õ‡∫∞‡∫à‡∫∏‡∫ö‡∫±‡∫ô</label>
            <input type="text" id="mobileProvince" readonly style="background: #e8f5e9;">
          </div>
          <div class="form-group">
            <label>‡ªÄ‡∫°‡∫∑‡∫≠‡∫á‡∫õ‡∫∞‡∫à‡∫∏‡∫ö‡∫±‡∫ô</label>
            <input type="text" id="mobileDistrict" readonly style="background: #e8f5e9;">
          </div>
          <div class="form-group">
            <label>‡∫ö‡ªâ‡∫≤‡∫ô‡∫¢‡∫π‡ªà‡∫õ‡∫∞‡∫à‡∫∏‡∫ö‡∫±‡∫ô</label>
            <input type="text" id="mobileVillage" readonly style="background: #e8f5e9;">
          </div>
        </div>
        
        <!-- Row 3: Unit, Position -->
        <div class="form-row">
          <div class="form-group">
            <label>‡ªú‡ªà‡∫ß‡∫ç *</label>
            <input type="text" id="mobileUnit" required>
          </div>
          <div class="form-group">
            <label>‡∫ï‡ªç‡∫≤‡ªÅ‡ªú‡ªà‡∫á‡∫ö‡ªà‡∫≠‡∫ô‡∫û‡∫±‡∫Å (Latitude, Longitude)</label>
            <div style="display: flex; gap: 5px;">
              <input type="text" id="mobilePosition" placeholder="‰æã: 17.9757, 102.6331" style="flex: 1;" readonly>
              <button type="button" onclick="openMobileLocationPicker()" class="btn-location" title="‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡ªÅ‡∫ú‡∫ô‡∫ó‡∫µ‡ªà">üìç</button>
            </div>
          </div>
          <div class="form-group">
            <label>‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô‡∫´‡ªâ‡∫≠‡∫á‡∫°‡∫µ‡∫Ñ‡∫ª‡∫ô‡∫¢‡∫π‡ªà üë• (Auto)</label>
            <input type="number" id="mobileRoomCount" readonly class="auto-calculate-field" style="background: #e8f5e9;">
          </div>
        </div>
      </div>
      
      <!-- Members Container -->
      <div id="mobileMembersContainer"></div>
      
      <button type="button" class="btn-add-member" onclick="addMobileMemberForm()">‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫™‡∫∞‡∫°‡∫≤‡∫ä‡∫¥‡∫Å</button>
      
      <div class="form-buttons">
        <button type="submit" class="btn btn-primary">üíæ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î</button>
        <button type="button" class="btn btn-secondary" onclick="closeMobileForm()">‚ùå ‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>
      </div>
    </form>
  </div>
</div>
  
<!-- Village Participation Modal -->
<div class="modal-overlay" id="participationModal">
  <div class="modal" style="max-width: 500px;">
    <h2>ü§ù ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫•‡∫∞‡∫î‡∫±‡∫ö‡∫Å‡∫≤‡∫ô‡∫°‡∫µ‡∫™‡ªà‡∫ß‡∫ô‡∫Æ‡ªà‡∫ß‡∫°‡∫Å‡∫±‡∫ö‡∫Å‡∫≤‡∫ô‡∫à‡∫±‡∫î‡∫ï‡∫±‡ªâ‡∫á‡∫ö‡ªâ‡∫≤‡∫ô</h2>
    
    <div class="participation-options" style="margin: 20px 0;">
      <div class="participation-option" onclick="selectParticipation('excellent')" data-value="excellent">
        <div style="display: flex; align-items: center; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s;">
          <input type="radio" name="participation" value="excellent" style="margin-right: 15px;">
          <div>
            <div style="font-weight: 600; color: #2e7d32;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê ‡∫°‡∫µ‡∫™‡ªà‡∫ß‡∫ô‡∫Æ‡ªà‡∫ß‡∫°‡∫î‡∫µ‡ªÄ‡∫•‡∫µ‡∫î</div>
            <div style="font-size: 14px; color: #666; margin-top: 5px;">‡∫Æ‡ªà‡∫ß‡∫°‡∫Å‡∫¥‡∫î‡∫à‡∫∞‡∫Å‡ªç‡∫≤‡∫ó‡∫∏‡∫Å‡∫Ñ‡∫±‡ªâ‡∫á, ‡ªÄ‡∫õ‡∫±‡∫ô‡∫ú‡∫π‡ªâ‡∫ô‡ªç‡∫≤‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫à‡∫±‡∫î‡∫ï‡∫±‡ªâ‡∫á</div>
          </div>
        </div>
      </div>
      
      <div class="participation-option" onclick="selectParticipation('verygood')" data-value="verygood">
        <div style="display: flex; align-items: center; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s;">
          <input type="radio" name="participation" value="verygood" style="margin-right: 15px;">
          <div>
            <div style="font-weight: 600; color: #388e3c;">‚≠ê‚≠ê‚≠ê‚≠ê ‡∫°‡∫µ‡∫™‡ªà‡∫ß‡∫ô‡∫Æ‡ªà‡∫ß‡∫°‡∫î‡∫µ‡∫´‡∫º‡∫≤‡∫ç</div>
            <div style="font-size: 14px; color: #666; margin-top: 5px;">‡∫Æ‡ªà‡∫ß‡∫°‡∫Å‡∫¥‡∫î‡∫à‡∫∞‡∫Å‡ªç‡∫≤‡ªÄ‡∫õ‡∫±‡∫ô‡∫™‡ªà‡∫ß‡∫ô‡ªÉ‡∫´‡∫ç‡ªà, ‡ªÉ‡∫´‡ªâ‡∫Å‡∫≤‡∫ô‡∫™‡∫∞‡ªú‡∫±‡∫ö‡∫™‡∫∞‡ªú‡∫π‡∫ô‡∫î‡∫µ</div>
          </div>
        </div>
      </div>
      
      <div class="participation-option" onclick="selectParticipation('moderate')" data-value="moderate">
        <div style="display: flex; align-items: center; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s;">
          <input type="radio" name="participation" value="moderate" style="margin-right: 15px;">
          <div>
            <div style="font-weight: 600; color: #f57c00;">‚≠ê‚≠ê‚≠ê ‡∫°‡∫µ‡∫™‡ªà‡∫ß‡∫ô‡∫Æ‡ªà‡∫ß‡∫°‡∫õ‡∫≤‡∫ô‡∫Å‡∫≤‡∫á</div>
            <div style="font-size: 14px; color: #666; margin-top: 5px;">‡∫Æ‡ªà‡∫ß‡∫°‡∫Å‡∫¥‡∫î‡∫à‡∫∞‡∫Å‡ªç‡∫≤‡∫ö‡∫≤‡∫á‡∫Ñ‡∫±‡ªâ‡∫á, ‡ªÉ‡∫´‡ªâ‡∫Å‡∫≤‡∫ô‡∫Æ‡ªà‡∫ß‡∫°‡∫°‡∫∑‡∫û‡ªç‡∫™‡∫ª‡∫°‡∫Ñ‡∫ß‡∫ô</div>
          </div>
        </div>
      </div>
      
      <div class="participation-option" onclick="selectParticipation('lacking')" data-value="lacking">
        <div style="display: flex; align-items: center; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s;">
          <input type="radio" name="participation" value="lacking" style="margin-right: 15px;">
          <div>
            <div style="font-weight: 600; color: #d32f2f;">‚≠ê ‡∫Ç‡∫≤‡∫î‡∫Å‡∫≤‡∫ô‡∫°‡∫µ‡∫™‡ªà‡∫ß‡∫ô‡∫Æ‡ªà‡∫ß‡∫°</div>
            <div style="font-size: 14px; color: #666; margin-top: 5px;">‡∫ö‡ªç‡ªà‡∫Ñ‡ªà‡∫≠‡∫ç‡∫Æ‡ªà‡∫ß‡∫°‡∫Å‡∫¥‡∫î‡∫à‡∫∞‡∫Å‡ªç‡∫≤, ‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫Å‡∫≤‡∫ô‡∫ä‡∫∏‡∫Å‡∫ç‡∫π‡ªâ</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="form-buttons">
      <button type="button" class="btn btn-primary" onclick="confirmParticipation()" disabled id="confirmParticipationBtn">‚úÖ ‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô</button>
      <button type="button" class="btn btn-secondary" onclick="closeParticipationModal()">‚ùå ‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>
    </div>
  </div>
</div>
  <!-- Registry Management Modal -->
  <div class="modal-overlay" id="registryModal">
  <div class="modal registry-modal">
    <h2>‚öôÔ∏è ‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô‡∫™‡ªç‡∫≤‡∫°‡∫∞‡ªÇ‡∫ô‡∫Ñ‡∫ª‡∫ß</h2>
    
    <!-- Option 1: Old Registry -->
    <div class="registry-option" id="oldRegistryOption">
      <div class="registry-option-header" onclick="toggleRegistryOption('old')">
        <input type="checkbox" id="chkOldRegistry" onchange="toggleRegistryOption('old')">
        <label for="chkOldRegistry">üìï ‡∫™‡ªç‡∫≤‡∫°‡∫∞‡ªÇ‡∫ô‡∫Ñ‡∫ª‡∫ß‡ªÄ‡∫Å‡∫ª‡ªà‡∫≤</label>
      </div>
      <div class="registry-details" id="oldRegistryDetails">
        <div class="registry-count-input">
          <label>‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô:</label>
          <input type="number" id="oldRegistryCount" min="0" value="0" oninput="updateOldRegistryNumbers()">
          <span>‡∫õ‡∫∑‡ªâ‡∫°</span>
        </div>
        <div class="registry-numbers" id="oldRegistryNumbers"></div>
      </div>
    </div>
    
    <!-- Option 2: New Registry -->
    <div class="registry-option" id="newRegistryOption">
      <div class="registry-option-header" onclick="toggleRegistryOption('new')">
        <input type="checkbox" id="chkNewRegistry" onchange="toggleRegistryOption('new')">
        <label for="chkNewRegistry">üìó ‡∫™‡ªç‡∫≤‡∫°‡∫∞‡ªÇ‡∫ô‡∫Ñ‡∫ª‡∫ß‡ªÉ‡ªù‡ªà</label>
      </div>
      <div class="registry-details" id="newRegistryDetails">
        <div class="registry-count-input">
          <label>‡∫à‡ªç‡∫≤‡∫ô‡∫ß‡∫ô:</label>
          <input type="number" id="newRegistryCount" min="0" value="0" oninput="updateNewRegistryNumbers()">
          <span>‡∫õ‡∫∑‡ªâ‡∫°</span>
        </div>
        <div class="registry-numbers" id="newRegistryNumbers"></div>
      </div>
    </div>
    
    <!-- Option 3: No Registry -->
    <div class="registry-option" id="noRegistryOption">
      <div class="registry-option-header" onclick="toggleRegistryOption('none')">
        <input type="checkbox" id="chkNoRegistry" onchange="toggleRegistryOption('none')">
        <label for="chkNoRegistry">‚ùå ‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫™‡ªç‡∫≤‡∫°‡∫∞‡ªÇ‡∫ô‡∫Ñ‡∫ª‡∫ß</label>
      </div>
    </div>
    
    <!-- Summary -->
    <div class="registry-summary">
      <h4>üìä ‡∫™‡∫∞‡∫´‡∫º‡∫∏‡∫ö</h4>
      <div class="registry-summary-item">
        <span>‡∫™‡ªç‡∫≤‡∫°‡∫∞‡ªÇ‡∫ô‡∫Ñ‡∫ª‡∫ß‡ªÄ‡∫Å‡∫ª‡ªà‡∫≤:</span>
        <span id="summaryOldCount">0 ‡∫õ‡∫∑‡ªâ‡∫°</span>
      </div>
      <div class="registry-summary-item">
        <span>‡∫™‡ªç‡∫≤‡∫°‡∫∞‡ªÇ‡∫ô‡∫Ñ‡∫ª‡∫ß‡ªÉ‡ªù‡ªà:</span>
        <span id="summaryNewCount">0 ‡∫õ‡∫∑‡ªâ‡∫°</span>
      </div>
      <div class="registry-summary-item">
        <span>‡∫•‡∫ß‡∫°‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î:</span>
        <span id="summaryTotalCount">0 ‡∫õ‡∫∑‡ªâ‡∫°</span>
      </div>
    </div>
    
    <!-- Buttons -->
    <div class="form-buttons">
      <button type="button" class="btn btn-primary" onclick="confirmRegistry()">‚úÖ ‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô</button>
      <button type="button" class="btn btn-secondary" onclick="closeRegistryModal()">‚ùå ‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>
    </div>
  </div>
</div>
  <!-- Image Crop Modal -->
  <div class="crop-modal" id="cropModal">
    <div class="crop-modal-content">
      <h2>‚úÇÔ∏è ‡∫ï‡∫±‡∫î ‡ªÅ‡∫•‡∫∞ ‡∫õ‡∫±‡∫ö‡ªÅ‡∫ï‡ªà‡∫á‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö</h2>
      
      <!-- Aspect Ratio Selector -->
      <div class="aspect-ratio-selector">
        <button class="aspect-btn active" data-ratio="1" onclick="setAspectRatio(1)">‚¨õ 1:1</button>
        <button class="aspect-btn" data-ratio="0.75" onclick="setAspectRatio(0.75)">üì± 3:4</button>
        <button class="aspect-btn" data-ratio="1.33" onclick="setAspectRatio(1.33)">üñºÔ∏è 4:3</button>
        <button class="aspect-btn" data-ratio="NaN" onclick="setAspectRatio(NaN)">üÜì Free</button>
      </div>
      
      <!-- Crop Container -->
      <div class="crop-container">
        <img id="cropImage" src="" alt="Crop">
      </div>
      
      <!-- Crop Tools -->
      <div class="crop-tools">
        <button class="crop-tool-btn" onclick="rotateCropImage(-90)" title="‡ªù‡∫∏‡∫ô‡∫ä‡ªâ‡∫≤‡∫ç 90¬∞">
          ‚Ü∫ ‡ªù‡∫∏‡∫ô‡∫ä‡ªâ‡∫≤‡∫ç
        </button>
        <button class="crop-tool-btn" onclick="rotateCropImage(90)" title="‡ªù‡∫∏‡∫ô‡∫Ç‡∫ß‡∫≤ 90¬∞">
          ‚Üª ‡ªù‡∫∏‡∫ô‡∫Ç‡∫ß‡∫≤
        </button>
        <button class="crop-tool-btn" onclick="flipCropImage('horizontal')" title="‡∫û‡∫¥‡∫î‡∫•‡∫ß‡∫á‡∫ô‡∫≠‡∫ô">
          ‚áÑ ‡∫û‡∫¥‡∫î‡∫ô‡∫≠‡∫ô
        </button>
        <button class="crop-tool-btn" onclick="flipCropImage('vertical')" title="‡∫û‡∫¥‡∫î‡∫•‡∫ß‡∫á‡∫ï‡∫±‡ªâ‡∫á">
          ‚áÖ ‡∫û‡∫¥‡∫î‡∫ï‡∫±‡ªâ‡∫á
        </button>
        <button class="crop-tool-btn" onclick="zoomCropImage(0.1)" title="‡∫Ç‡∫∞‡∫´‡∫ç‡∫≤‡∫ç">
          üîç+ ‡∫Ç‡∫∞‡∫´‡∫ç‡∫≤‡∫ç
        </button>
        <button class="crop-tool-btn" onclick="zoomCropImage(-0.1)" title="‡∫´‡∫ç‡ªç‡ªâ">
          üîç- ‡∫´‡∫ç‡ªç‡ªâ
        </button>
        <button class="crop-tool-btn" onclick="resetCrop()" title="‡∫£‡∫µ‡ªÄ‡∫ä‡∫±‡∫î">
          üîÑ ‡∫£‡∫µ‡ªÄ‡∫ä‡∫±‡∫î
        </button>
      </div>
      
      <!-- Action Buttons -->
      <div class="crop-buttons">
        <button type="button" class="btn btn-primary" onclick="confirmCrop()">‚úÖ ‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô</button>
        <button type="button" class="btn btn-secondary" onclick="closeCropModal()">‚ùå ‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>
      </div>
    </div>
  </div>
 <!-- Location Picker Modal -->
<div class="location-modal" id="locationModal">
  <div class="location-modal-content">
    <h2>üìç ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫ï‡ªç‡∫≤‡ªÅ‡ªú‡ªà‡∫á‡ªÄ‡∫Æ‡∫∑‡∫≠‡∫ô</h2>
    <div class="location-info">
      <div><strong>üìå ‡∫ï‡ªç‡∫≤‡ªÅ‡ªú‡ªà‡∫á‡∫ó‡∫µ‡ªà‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å:</strong></div>
      <div id="selectedLocation">‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫Å‡∫ª‡∫î‡ªÄ‡∫ó‡∫¥‡∫á‡ªÅ‡∫ú‡∫ô‡∫ó‡∫µ‡ªà‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫ï‡ªç‡∫≤‡ªÅ‡ªú‡ªà‡∫á</div>
    </div>
    <div style="position: relative;">
      <div id="map"></div>
      <div class="map-layer-switcher">
  <button class="map-layer-btn" id="btnStreetMap" onclick="switchMapLayer('street')">
    üó∫Ô∏è ‡ªÅ‡∫ú‡∫ô‡∫ó‡∫µ‡ªà
  </button>
  <button class="map-layer-btn active" id="btnSatellite" onclick="switchMapLayer('satellite')">
    üõ∞Ô∏è ‡∫î‡∫≤‡∫ß‡∫ó‡∫Ω‡∫°
  </button>
  <button class="map-layer-btn" id="btnMyLocation" onclick="goToMyLocation()">
    üìç ‡∫ï‡∫≥‡ªÅ‡ªú‡ªà‡∫á‡∫Ç‡∫≠‡∫á‡∫Ç‡ªâ‡∫≠‡∫ç
  </button>
</div>
    </div>
    <div class="location-buttons">
      <button type="button" class="btn btn-primary" onclick="confirmLocation()">‚úÖ ‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô‡∫ï‡ªç‡∫≤‡ªÅ‡ªú‡ªà‡∫á</button>
      <button type="button" class="btn btn-secondary" onclick="closeLocationPicker()">‚ùå ‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>
    </div>
  </div>
</div>
  <!-- Image Preview Modal -->
  <div class="image-preview-modal" id="imagePreviewModal" onclick="closeImagePreview()">
    <img src="" alt="Preview" id="imagePreviewImg">
  </div>

  <!-- Datalists for options -->
  <datalist id="genderList"></datalist>
  <datalist id="occupationList"></datalist>
  <datalist id="insuranceList"></datalist>
  <datalist id="educationList"></datalist>
  <datalist id="maritalStatusList"></datalist>
  <datalist id="diseaseList"></datalist>
  <datalist id="ethnicityList"></datalist>
  <datalist id="relationshipList"></datalist>
  <datalist id="religionList"></datalist>
  <datalist id="bodyCompleteList"></datalist>
  <datalist id="actualResidentList"></datalist>
  <datalist id="inRegistryList"></datalist>

  <script>
    // ===================================
    // GLOBAL VARIABLES
    // ===================================
    let currentUser = null;
    let loginData = null;
    let optionsData = null;
    let householdsData = [];
    let mobilesData = [];
let currentMobileType = null; // '‡∫û‡∫±‡∫Å‡ªÄ‡∫ä‡∫ª‡∫≤‡∫Ñ‡∫ª‡∫á‡∫ó‡∫µ‡ªà' or '‡∫û‡∫±‡∫Å‡ªÄ‡∫ä‡∫ª‡∫≤‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫ô‡∫ó‡∫µ‡ªà'
let mobileMemberCounter = 0;
let currentMobilePage = 1;
const mobileRowsPerPage = 30;
let totalMobileRows = 0;
let selectedHouseholdForMobile = null;
    let idleTimer = null;
    let idleWarningTimer = null;
    let memberCounter = 0;
    let deleteTarget = null;
    let selectedReason = null;
    let villageSheetId = null; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö Sheet ID ‡∏Ç‡∏≠‡∏á‡∏ö‡πâ‡∏≤‡∏ô
    // Image Crop variables
    let cropper = null;
    let currentCropTarget = null;
    let currentCropPreviewId = null;
    // Registry management
    let registryData = {
      old: { enabled: false, count: 0, numbers: [] },
      new: { enabled: false, count: 0, numbers: [] },
      none: false
    };
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ
    let currentPage = 1;
    const rowsPerPage = 30;
    let totalRows = 0;

    // IndexedDB
    let db = null;
    const DB_NAME = 'PopulationDB';
    const DB_VERSION = 1;

    // ===================================
    // INITIALIZE
    // ===================================
 window.onload = function() {
  console.log('=== Initializing App ===');
  
  try {
    // Initialize IndexedDB
    initIndexedDB();
    console.log('‚úÖ IndexedDB initialized');
  } catch (e) {
    console.error('‚ùå IndexedDB error:', e);
  }
  
  try {
    // Setup idle timer
    resetIdleTimer();
    
    // ‚úÖ ‡πÉ‡∏ä‡πâ passive listeners ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
    document.addEventListener('click', resetIdleTimer, { passive: true });
    document.addEventListener('keypress', resetIdleTimer, { passive: true });
    
    // ‚úÖ Throttle mousemove (‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á)
    let mouseMoveTimeout;
    document.addEventListener('mousemove', function() {
      if (mouseMoveTimeout) return;
      mouseMoveTimeout = setTimeout(function() {
        resetIdleTimer();
        mouseMoveTimeout = null;
      }, 1000); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    }, { passive: true });
    
    console.log('‚úÖ Idle timer setup');
  } catch (e) {
    console.error('‚ùå Idle timer error:', e);
  }
};

    // ===================================
    // INDEXEDDB SETUP
    // ===================================
    function initIndexedDB() {
      const request = indexedDB.open(DB_NAME, DB_VERSION);
      
      request.onerror = function() {
        console.error('IndexedDB error:', request.error);
        showToast('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡ªÄ‡∫õ‡∫µ‡∫î‡∫ñ‡∫≤‡∫ô‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô', 'error');
      };
      
      request.onsuccess = function() {
        db = request.result;
        loadInitialData();
      };
      
      request.onupgradeneeded = function(e) {
        db = e.target.result;
        
        if (!db.objectStoreNames.contains('loginData')) {
          db.createObjectStore('loginData', { keyPath: 'id' });
        }
        if (!db.objectStoreNames.contains('optionsData')) {
          db.createObjectStore('optionsData', { keyPath: 'id' });
        }
        if (!db.objectStoreNames.contains('households')) {
          db.createObjectStore('households', { keyPath: 'householdCode' });
        }
        if (!db.objectStoreNames.contains('mobiles')) {
  db.createObjectStore('mobiles', { keyPath: 'mobileCode' });
}
        if (!db.objectStoreNames.contains('syncQueue')) {
          const syncStore = db.createObjectStore('syncQueue', { keyPath: 'id', autoIncrement: true });
          syncStore.createIndex('timestamp', 'timestamp', { unique: false });
        }
      };
    }

    // ===================================
// LOAD INITIAL DATA
// ===================================
function loadInitialData() {
  console.log('=== Loading Initial Data ===');
  
  // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î Login Data ‡∏Å‡πà‡∏≠‡∏ô (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
  fetchLoginData();
  
  // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î Options (‡πÑ‡∏°‡πà‡∏£‡∏≠ login data)
  setTimeout(function() {
    loadFromIndexedDB('optionsData', 'optionsData').then(function(data) {
      if (data) {
        console.log('‚úÖ Options loaded from IndexedDB');
        optionsData = data;
      } else {
        console.log('üì• Fetching options from server...');
        fetchOptionsData();
      }
    });
  }, 500);
  
  // ‚úÖ ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î Households ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏£‡∏≠‡∏à‡∏ô login ‡πÅ‡∏•‡πâ‡∏ß)
  console.log('‚è∏Ô∏è Households will load after login');
}
function fetchLoginData() {
  console.log('=== Fetching login data ===');
  const startTime = new Date().getTime();
  
  showLoading(0, '‡∫Å‡∫≥‡∫•‡∫±‡∫á‡ªÇ‡∫´‡∫•‡∫î‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡∫™‡∫π‡ªà‡∫•‡∫∞‡∫ö‡∫ª‡∫ö...');
  
  // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á timeout (‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô)
  const timeoutId = setTimeout(function() {
    console.warn('‚ö†Ô∏è Login data loading is taking longer than expected...');
    const messageDiv = document.getElementById('loadingMessage');
    if (messageDiv) {
      messageDiv.textContent = '‚è≥ ‡∫Å‡∫≥‡∫•‡∫±‡∫á‡ªÇ‡∫´‡∫•‡∫î... ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫•‡ªç‡∫ñ‡ªâ‡∫≤';
      messageDiv.style.color = '#ffc107';
    }
  }, 30000); // 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  
  google.script.run
    .withSuccessHandler(function(data) {
      clearTimeout(timeoutId);
      
      const endTime = new Date().getTime();
      const timeTaken = ((endTime - startTime) / 1000).toFixed(2);
      console.log('‚úÖ Login data received in ' + timeTaken + ' seconds');
      
      hideLoading();
      
      if (!data) {
        console.error('‚ùå ERROR: Data is null or undefined');
        showToast('‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡ªÇ‡∫´‡∫•‡∫î‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÑ‡∫î‡ªâ', 'error');
        return;
      }
      
      if (!data.provinces || !Array.isArray(data.provinces)) {
        console.error('‚ùå ERROR: Invalid data structure');
        showToast('‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ö‡ªç‡ªà‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á', 'error');
        return;
      }
      
      if (data.provinces.length === 0) {
        console.error('‚ùå ERROR: No provinces data');
        showToast('‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÅ‡∫Ç‡∫ß‡∫á‡ªÉ‡∫ô‡∫•‡∫∞‡∫ö‡∫ª‡∫ö', 'error');
        return;
      }
      
      console.log('‚úÖ Provinces:', data.provinces.length);
      console.log('‚úÖ Users:', data.users ? data.users.length : 0);
      
      loginData = data;
      
      // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á IndexedDB (async)
      saveToIndexedDB('loginData', { id: 'loginData', data: data })
        .then(function() {
          console.log('‚úÖ Login data saved to IndexedDB');
        })
        .catch(function(err) {
          console.error('‚ö†Ô∏è Failed to save to IndexedDB:', err);
        });
      
      // ‚úÖ Populate form
      populateLoginForm();
      
      showToast('‡ªÇ‡∫´‡∫•‡∫î‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î (' + timeTaken + 's)', 'success');
    })
    .withFailureHandler(function(error) {
      clearTimeout(timeoutId);
      
      const endTime = new Date().getTime();
      const timeTaken = ((endTime - startTime) / 1000).toFixed(2);
      
      console.error('‚ùå ERROR fetching login data:', error);
      console.error('Time taken:', timeTaken + 's');
      
      hideLoading();
      showToast('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î: ' + error.message, 'error');
      
      // ‚úÖ ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å IndexedDB
      console.log('üì¶ Trying to load from IndexedDB...');
      loadFromIndexedDB('loginData', 'loginData').then(function(data) {
        if (data) {
          console.log('‚úÖ Loaded login data from IndexedDB');
          loginData = data;
          populateLoginForm();
          showToast('‡ªÇ‡∫´‡∫•‡∫î‡∫à‡∫≤‡∫Å‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÄ‡∫Å‡∫ª‡ªà‡∫≤ (Offline)', 'success');
        } else {
          console.error('‚ùå No data in IndexedDB either');
          showToast('‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ó‡∫±‡∫á‡ªÉ‡∫ô‡ªÄ‡∫ä‡∫µ‡∫ö‡ªÄ‡∫ß‡∫µ‡ªÅ‡∫•‡∫∞ Offline', 'error');
        }
      });
    })
    .getLoginData();
}
// ‚úÖ Retry mechanism ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
function retryFetchLoginData(retryCount) {
  retryCount = retryCount || 0;
  const maxRetries = 3;
  
  if (retryCount >= maxRetries) {
    console.error('‚ùå Max retries reached');
    showToast('‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡∫ï‡ªç‡ªà‡ªÄ‡∫ä‡∫µ‡∫ö‡ªÄ‡∫ß‡∫µ‡ªÑ‡∫î‡ªâ', 'error');
    hideLoading();
    return;
  }
  
  console.log('üîÑ Retry attempt: ' + (retryCount + 1) + '/' + maxRetries);
  
  const messageDiv = document.getElementById('loadingMessage');
  if (messageDiv) {
    messageDiv.textContent = 'üîÑ ‡∫•‡∫≠‡∫á‡ªÉ‡ªù‡ªà... ‡∫Ñ‡∫±‡ªâ‡∫á‡∫ó‡∫µ‡ªà ' + (retryCount + 1);
  }
  
  setTimeout(function() {
    google.script.run
      .withSuccessHandler(function(data) {
        hideLoading();
        if (data && data.provinces) {
          loginData = data;
          populateLoginForm();
          showToast('‡ªÇ‡∫´‡∫•‡∫î‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î!', 'success');
        } else {
          retryFetchLoginData(retryCount + 1);
        }
      })
      .withFailureHandler(function(error) {
        console.error('Retry failed:', error);
        retryFetchLoginData(retryCount + 1);
      })
      .getLoginData();
  }, 2000 * (retryCount + 1)); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
}

    function fetchOptionsData() {
      google.script.run
        .withSuccessHandler(function(data) {
          optionsData = data;
          saveToIndexedDB('optionsData', { id: 'optionsData', data: data });
        })
        .withFailureHandler(function(error) {
          console.error('Error fetching options:', error);
        })
        .getOptionsData();
    }
function fetchHouseholdsData() {
  console.log('>>> Fetching households and mobile data from server...');
  console.log('>>> Using villageSheetId:', villageSheetId);
  
  if (!villageSheetId) {
    console.error('ERROR: villageSheetId is null or undefined!');
    showToast('‡∫ö‡ªç‡ªà‡∫°‡∫µ Sheet ID ‡∫Ç‡∫≠‡∫á‡∫ö‡ªâ‡∫≤‡∫ô', 'error');
    hideLoading();
    return;
  }
  
  // ‡πÅ‡∏™‡∏î‡∏á Loading ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
  showLoading(0, '‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫î‡∫∂‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î...');
  
  // ===== ‡∫î‡∫∂‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß (Household) =====
  google.script.run
    .withSuccessHandler(function(data) {
      console.log('>>> Households data received:', data);
      console.log('>>> Data type:', typeof data);
      console.log('>>> Is array:', Array.isArray(data));
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ data ‡πÄ‡∏õ‡πá‡∏ô null ‡∏´‡∏£‡∏∑‡∏≠ undefined
      if (!data) {
        console.error('>>> ERROR: Data is null or undefined');
        householdsData = [];
      } else if (!Array.isArray(data)) {
        console.error('>>> ERROR: Data is not an array, type:', typeof data);
        householdsData = [];
      } else {
        console.log('>>> Households count:', data.length);
        
        if (data.length > 0) {
          console.log('>>> First household:', data[0]);
        }
        
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô global variable
        householdsData = data;
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á IndexedDB
        if (data.length > 0) {
          data.forEach(household => {
            saveToIndexedDB('households', household)
              .catch(err => console.error('Failed to save household:', err));
          });
          console.log('>>> Households data saved to IndexedDB');
        }
      }
      
      // ‚úÖ ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Household ‡πÄ‡∏™‡∏£‡πá‡∏à ‚Üí ‡πÇ‡∏´‡∏•‡∏î Mobile ‡∏ï‡πà‡∏≠
      loadMobileDataAfterHousehold();
    })
    .withFailureHandler(function(error) {
      console.error('>>> ERROR fetching households:', error);
      console.error('>>> Error message:', error.message);
      
      householdsData = [];
      
      // ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å IndexedDB
      loadFromIndexedDB('households', null).then(data => {
        if (data && data.length > 0) {
          console.log('>>> Loaded households from IndexedDB:', data.length);
          householdsData = data;
        } else {
          console.log('>>> No households in IndexedDB');
        }
        
        // ‚úÖ ‡πÅ‡∏°‡πâ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡πá‡∏¢‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î Mobile ‡∏ï‡πà‡∏≠
        loadMobileDataAfterHousehold();
      });
    })
    .getHouseholdData(villageSheetId);
  
  // ===== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î Mobile ‡∏´‡∏•‡∏±‡∏á Household =====
  function loadMobileDataAfterHousehold() {
    console.log('>>> Now fetching mobile data...');
    
    google.script.run
      .withSuccessHandler(function(data) {
        console.log('>>> Mobile data received:', data);
        console.log('>>> Mobile count:', data ? data.length : 0);
        
        if (!data) {
          console.error('>>> ERROR: Mobile data is null');
          mobilesData = [];
        } else if (!Array.isArray(data)) {
          console.error('>>> ERROR: Mobile data is not array');
          mobilesData = [];
        } else {
          mobilesData = data;
          
          // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á IndexedDB
          if (data.length > 0) {
            data.forEach(mobile => {
              saveToIndexedDB('mobiles', mobile)
                .catch(err => console.error('Failed to save mobile:', err));
            });
            console.log('>>> Mobile data saved to IndexedDB');
          }
        }
        
        // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        finishLoadingAllData();
      })
      .withFailureHandler(function(error) {
        console.error('>>> ERROR fetching mobile:', error);
        mobilesData = [];
        
        // ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å IndexedDB
        loadFromIndexedDB('mobiles', null).then(data => {
          if (data && data.length > 0) {
            console.log('>>> Loaded mobile from IndexedDB:', data.length);
            mobilesData = data;
          }
          
          // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
          finishLoadingAllData();
        });
      })
      .getMobileData(villageSheetId);
  }
  
  // ===== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à =====
  function finishLoadingAllData() {
    console.log('>>> All data loaded!');
    console.log('>>> Households:', householdsData.length);
    console.log('>>> Mobiles:', mobilesData.length);
    
    // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    let totalPeople = householdsData.length; // ‡∏´‡∏±‡∏ß‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß
    householdsData.forEach(household => {
      if (household.members && Array.isArray(household.members)) {
        totalPeople += household.members.length;
      }
    });
    totalPeople += mobilesData.length; // ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà
    
    console.log('>>> Total people (all):', totalPeople);
    
    // ‡πÅ‡∏™‡∏î‡∏á Counter Animation
    const counterDiv = document.getElementById('loadingCounter');
    const messageDiv = document.getElementById('loadingMessage');
    
    if (counterDiv && messageDiv && totalPeople > 0) {
      messageDiv.textContent = `‡∫Å‡∫≥‡∫•‡∫±‡∫á‡ªÇ‡∫´‡∫•‡∫î ${totalPeople} ‡∫Ñ‡∫ª‡∫ô...`;
      
      let current = 0;
      const duration = 1500; // 1.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
      const increment = totalPeople / (duration / 30);
      
      const timer = setInterval(() => {
        current += increment;
        if (current >= totalPeople) {
          current = totalPeople;
          clearInterval(timer);
          
          // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô "‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î"
          messageDiv.textContent = `‚úÖ ‡ªÇ‡∫´‡∫•‡∫î‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î ${totalPeople} ‡∫Ñ‡∫ª‡∫ô`;
          
          // ‡∏£‡∏≠ 0.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏ã‡πà‡∏≠‡∏ô loading
          setTimeout(() => {
            hideLoading();
          }, 500);
        }
        counterDiv.textContent = Math.floor(current);
      }, 30);
    } else {
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ã‡πà‡∏≠‡∏ô loading ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      hideLoading();
    }
    
    // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ population ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    if (document.getElementById('dataContainer').classList.contains('active')) {
      console.log('>>> Reloading population data table...');
      loadPopulationData();
    }
    
    // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ mobile ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    if (document.getElementById('mobileContainer') && 
        document.getElementById('mobileContainer').classList.contains('active')) {
      console.log('>>> Reloading mobile data table...');
      loadMobileData();
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á Toast ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    if (householdsData.length > 0 || mobilesData.length > 0) {
      showToast(
        `‡ªÇ‡∫´‡∫•‡∫î‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î: ${householdsData.length} ‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß, ${mobilesData.length} ‡∫õ‡∫∞‡∫ä‡∫≤‡∫Å‡∫≠‡∫ô‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫ô‡∫ó‡∫µ‡ªà`, 
        'success'
      );
    } else {
      showToast('‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÉ‡∫ô‡∫ö‡ªâ‡∫≤‡∫ô‡∫ô‡∫µ‡ªâ', 'error');
      
      // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡πà‡∏≤‡∏á
      const tbody = document.getElementById('dataTableBody');
      if (tbody) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px;">
              <div style="font-size: 48px; margin-bottom: 10px;">‚ö†Ô∏è</div>
              <div style="margin-bottom: 15px; color: #f44336;">‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÉ‡∫ô‡∫ö‡ªâ‡∫≤‡∫ô‡∫ô‡∫µ‡ªâ</div>
              <div style="margin-bottom: 15px; font-size: 14px; color: #666;">‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô</div>
              <button onclick="openHouseholdForm()" class="btn btn-primary">‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß</button>
            </td>
          </tr>
        `;
      }
    }
  }
}

    // ===================================
    // INDEXEDDB OPERATIONS
    // ===================================
    function saveToIndexedDB(storeName, data) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.put(data);
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    function loadFromIndexedDB(storeName, key) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readonly');
        const store = transaction.objectStore(storeName);
        
        if (key) {
          const request = store.get(key);
          request.onsuccess = () => resolve(request.result ? request.result.data : null);
          request.onerror = () => reject(request.error);
        } else {
          const request = store.getAll();
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        }
      });
    }

    function deleteFromIndexedDB(storeName, key) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.delete(key);
        
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }
function populateLoginForm() {
  console.log('>>> Populating login form...');
  
  // Safety checks
  if (!loginData) {
    console.error('>>> ERROR: loginData is null or undefined');
    showToast('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤ Refresh ‡ªú‡ªâ‡∫≤‡ªÄ‡∫ß‡∫±‡∫ö', 'error');
    return;
  }
  
  if (!loginData.provinces) {
    console.error('>>> ERROR: loginData.provinces is null or undefined');
    console.log('>>> loginData structure:', Object.keys(loginData));
    showToast('‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ö‡ªç‡ªà‡∫™‡∫ª‡∫°‡∫ö‡∫π‡∫ô', 'error');
    return;
  }
  
  if (!Array.isArray(loginData.provinces)) {
    console.error('>>> ERROR: loginData.provinces is not an array');
    console.log('>>> Type of provinces:', typeof loginData.provinces);
    showToast('‡∫Æ‡∫π‡∫ö‡ªÅ‡∫ö‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ö‡ªç‡ªà‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á', 'error');
    return;
  }
  
  if (loginData.provinces.length === 0) {
    console.error('>>> ERROR: loginData.provinces is empty array');
    showToast('‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÅ‡∫Ç‡∫ß‡∫á', 'error');
    return;
  }
  
  console.log('>>> loginData is valid');
  console.log('>>> Provinces to populate:', loginData.provinces);
  
  // Populate Names
  const nameDatalist = document.getElementById('loginNameList');
  if (nameDatalist && loginData.users) {
    nameDatalist.innerHTML = '';
    
    const uniqueNames = [...new Set(loginData.users.map(u => u.name))].sort();
    console.log('>>> Unique names count:', uniqueNames.length);
    
    uniqueNames.forEach(name => {
      const option = document.createElement('option');
      option.value = name;
      nameDatalist.appendChild(option);
    });
    
    console.log('>>> Names populated');
  } else {
    console.warn('>>> Name datalist not found or no users data');
  }
  
  // Populate Provinces
  const provinceDatalist = document.getElementById('loginProvinceList');
  if (!provinceDatalist) {
    console.error('>>> ERROR: Province datalist element not found');
    return;
  }
  
  provinceDatalist.innerHTML = '';
  console.log('>>> Starting to populate provinces...');
  
  try {
    loginData.provinces.forEach((province, index) => {
      const option = document.createElement('option');
      option.value = province;
      provinceDatalist.appendChild(option);
      
      if (index < 3) {
        console.log('>>> Added province:', province);
      }
    });
    
    console.log('>>> Successfully populated ' + loginData.provinces.length + ' provinces');
    console.log('>>> Login form ready!');
    
  } catch (error) {
    console.error('>>> ERROR while populating provinces:', error);
    showToast('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫™‡ªâ‡∫≤‡∫á‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡ªÅ‡∫Ç‡∫ß‡∫á', 'error');
  }
}
// ===================================
// Login Province Change Handler
// ===================================
document.getElementById('loginProvince').addEventListener('input', function() {
  const province = this.value.trim();
  const districtInput = document.getElementById('loginDistrict');
  const villageInput = document.getElementById('loginVillage');
  const districtDatalist = document.getElementById('loginDistrictList');
  const villageDatalist = document.getElementById('loginVillageList');
  
  // Reset district and village
  districtInput.value = '';
  villageInput.value = '';
  districtDatalist.innerHTML = '';
  villageDatalist.innerHTML = '';
  districtInput.disabled = true;
  villageInput.disabled = true;
  
  // Check if province exists in data
  if (province && loginData.districts[province]) {
    districtInput.disabled = false;
    districtInput.placeholder = '‡∫û‡∫¥‡∫°‡ªÄ‡∫°‡∫∑‡∫≠‡∫á‡∫´‡∫º‡∫∑‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô';
    
    loginData.districts[province].forEach(district => {
      const option = document.createElement('option');
      option.value = district;
      districtDatalist.appendChild(option);
    });
    
    console.log('Loaded ' + loginData.districts[province].length + ' districts for province: ' + province);
  } else {
    districtInput.placeholder = '‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÅ‡∫Ç‡∫ß‡∫á‡∫Å‡ªà‡∫≠‡∫ô';
  }
});

// ===================================
// Login District Change Handler
// ===================================
document.getElementById('loginDistrict').addEventListener('input', function() {
  const province = document.getElementById('loginProvince').value.trim();
  const district = this.value.trim();
  const villageInput = document.getElementById('loginVillage');
  const villageDatalist = document.getElementById('loginVillageList');
  
  // Reset village
  villageInput.value = '';
  villageDatalist.innerHTML = '';
  villageInput.disabled = true;
  
  // Check if district exists in data
  if (province && district) {
    const key = `${province}|${district}`;
    if (loginData.villages[key]) {
      villageInput.disabled = false;
      villageInput.placeholder = '‡∫û‡∫¥‡∫°‡∫ö‡ªâ‡∫≤‡∫ô‡∫´‡∫º‡∫∑‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô';
      
      loginData.villages[key].forEach(village => {
        const option = document.createElement('option');
        option.value = village;
        villageDatalist.appendChild(option);
      });
      
      console.log('Loaded ' + loginData.villages[key].length + ' villages for: ' + key);
    } else {
      villageInput.placeholder = '‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ö‡ªâ‡∫≤‡∫ô';
    }
  } else {
    villageInput.placeholder = '‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÄ‡∫°‡∫∑‡∫≠‡∫á‡∫Å‡ªà‡∫≠‡∫ô';
  }
});

// ===================================
// Auto-fill Login Data When Name Selected
// ===================================
document.getElementById('loginName').addEventListener('input', function() {
  const selectedName = this.value.trim();
  
  if (!selectedName || !loginData || !loginData.users) return;
  
  // Find user with matching name
  const matchedUser = loginData.users.find(u => u.name === selectedName);
  
  if (matchedUser) {
    console.log('Auto-filling data for user:', matchedUser);
    
    // Fill province
    document.getElementById('loginProvince').value = matchedUser.province;
    document.getElementById('loginProvince').dispatchEvent(new Event('input'));
    
    // Wait a bit for province to load districts
    setTimeout(() => {
      // Fill district
      document.getElementById('loginDistrict').value = matchedUser.district;
      document.getElementById('loginDistrict').dispatchEvent(new Event('input'));
      
      // Wait a bit for district to load villages
      setTimeout(() => {
        // Fill village
        document.getElementById('loginVillage').value = matchedUser.village;
      }, 100);
    }, 100);
  }
});

   document.getElementById('loginForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const loginInfo = {
    code: document.getElementById('loginCode').value.trim(),
    name: document.getElementById('loginName').value.trim(),
    province: document.getElementById('loginProvince').value.trim(),
    district: document.getElementById('loginDistrict').value.trim(),
    village: document.getElementById('loginVillage').value.trim()
  };
  
  // Validate all fields are filled
  if (!loginInfo.code || !loginInfo.name || !loginInfo.province || !loginInfo.district || !loginInfo.village) {
    showToast('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫ï‡∫∑‡ªà‡∫°‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÉ‡∫´‡ªâ‡∫Ñ‡∫ª‡∫ö‡∫ó‡∫∏‡∫Å‡∫ä‡ªà‡∫≠‡∫á', 'error');
    return;
  }
  
  console.log('Attempting login with:', loginInfo);
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(result) {
      console.log('Login result:', result);
      hideLoading();
      
      if (result.success) {
        // ‡πÄ‡∏Å‡πá‡∏ö villageSheetId ‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå login
        villageSheetId = result.villageSheetId;
        currentUser = result; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• login ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        console.log('‚úÖ Village Sheet ID set to:', villageSheetId);
        showMainApp();
        showToast('‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡∫™‡∫π‡ªà‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î', 'success');
      } else {
        showToast(result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      console.error('Login error:', error);
      hideLoading();
      showToast('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î: ' + error.message, 'error');
    })
    .validateLogin(loginInfo);
});

    function showMainApp() {
      document.getElementById('loginModal').classList.remove('active');
      document.getElementById('mainContainer').classList.add('active');
      document.getElementById('userName').textContent = `üë§ ${currentUser.village || currentUser.name}`;
      document.getElementById('userLocation').textContent = `üìç ${currentUser.village}, ${currentUser.district}, ${currentUser.province}`;
      
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å fetchHouseholdsData ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
      console.log('‚úÖ Login successful, fetching household data for:', villageSheetId);
      showLoading();
      fetchHouseholdsData();
    }

    function logout() {
      if (confirm('‡∫ó‡ªà‡∫≤‡∫ô‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫≠‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡∫ö‡ªç‡ªà?')) {
        currentUser = null;
        document.getElementById('loginModal').classList.add('active');
        document.getElementById('mainContainer').classList.remove('active');
        document.getElementById('loginForm').reset();
        backToMenu();
        showToast('‡∫≠‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î', 'success');
      }
    }

    // ===================================
    // IDLE TIMER
    // ===================================
    function resetIdleTimer() {
      clearTimeout(idleTimer);
      clearTimeout(idleWarningTimer);
      document.getElementById('idleWarning').classList.remove('active');
      
      idleWarningTimer = setTimeout(showIdleWarning, 115 * 60 * 1000);
      idleTimer = setTimeout(autoLogout, 120 * 60 * 1000);
    }

    function showIdleWarning() {
      document.getElementById('idleWarning').classList.add('active');
      let timeLeft = 5;
      
      const countdown = setInterval(() => {
        timeLeft--;
        document.getElementById('idleTimer').textContent = timeLeft;
        
        if (timeLeft <= 0) {
          clearInterval(countdown);
        }
      }, 60 * 1000);
    }

    function autoLogout() {
      showToast('‡∫≠‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡∫≠‡∫±‡∫î‡∫ï‡∫∞‡ªÇ‡∫ô‡∫°‡∫±‡∫î‡ªÄ‡∫ô‡∫∑‡ªà‡∫≠‡∫á‡∫à‡∫≤‡∫Å‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Å‡∫≤‡∫ô‡ªÉ‡∫ä‡ªâ‡∫á‡∫≤‡∫ô', 'error');
      setTimeout(() => {
        currentUser = null;
        document.getElementById('loginModal').classList.add('active');
        document.getElementById('mainContainer').classList.remove('active');
        document.getElementById('loginForm').reset();
        backToMenu();
      }, 2000);
    }

  function openPopulation() {
  console.log('>>> Opening population page...');
  console.log('>>> villageSheetId:', villageSheetId);
  
  document.getElementById('menu').style.display = 'none';
  document.getElementById('dataContainer').classList.add('active');
  
  // Always fetch from server to get the correct village data
  console.log('>>> Fetching households for village: ' + villageSheetId);
  showLoading();
  fetchHouseholdsData();
}

    function backToMenu() {
      document.getElementById('menu').style.display = 'grid';
      document.getElementById('dataContainer').classList.remove('active');
    }
function loadPopulationData() {
  console.log('>>> Loading population data to table...');
  console.log('>>> householdsData length:', householdsData.length);
  
  const tbody = document.getElementById('dataTableBody');
  tbody.innerHTML = '';
  
  if (householdsData.length === 0) {
    console.log('>>> No households data to display');
    tbody.innerHTML = `
      <tr>
        <td colspan="7" style="text-align: center; padding: 40px;">
          <div style="font-size: 48px; margin-bottom: 10px;">üìã</div>
          <div style="margin-bottom: 15px;">‡∫ç‡∫±‡∫á‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß</div>
          <button onclick="fetchHouseholdsData()" class="btn btn-primary">üîÑ ‡ªÇ‡∫´‡∫•‡∫î‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫à‡∫≤‡∫Å‡ªÄ‡∫ä‡∫µ‡∫ö‡ªÄ‡∫ß‡∫µ</button>
        </td>
      </tr>
    `;
    document.getElementById('pagination').style.display = 'none';
    return;
  }
  
  // Create all rows first
  const allRows = [];
  
  householdsData.forEach((household, index) => {
    // Household header row
    const headRow = createTableRow({
      photo: household.photo,
      code: household.householdCode,
      name: household.name,
      gender: '-',
      relationship: '‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß',
      unit: household.unit,
      phone: household.phone,
      type: 'household',
      householdCode: household.householdCode
    });
    allRows.push(headRow);
    
    // Member rows
    if (household.members && household.members.length > 0) {
      household.members.forEach(member => {
        const memberRow = createTableRow({
          photo: member.photo,
          code: member.memberCode,
          name: member.name,
          gender: member.gender,
          relationship: member.relationship,
          unit: member.unit,
          phone: member.phone,
          type: 'member',
          householdCode: household.householdCode,
          memberCode: member.memberCode
        });
        allRows.push(memberRow);
      });
    }
  });
  
  totalRows = allRows.length;
  const totalPages = Math.ceil(totalRows / rowsPerPage);
  
  // Display rows for current page
  const startIndex = (currentPage - 1) * rowsPerPage;
  const endIndex = Math.min(startIndex + rowsPerPage, totalRows);
  
  for (let i = startIndex; i < endIndex; i++) {
    tbody.appendChild(allRows[i]);
  }
  
  // Update pagination UI
  updatePaginationUI(totalPages);
  
  console.log('>>> Displayed rows ' + (startIndex + 1) + '-' + endIndex + ' of ' + totalRows);
  hideLoading();
}

function updatePaginationUI(totalPages) {
  document.getElementById('currentPage').textContent = currentPage;
  document.getElementById('totalPages').textContent = totalPages;
  
  document.getElementById('btnFirst').disabled = currentPage === 1;
  document.getElementById('btnPrev').disabled = currentPage === 1;
  document.getElementById('btnNext').disabled = currentPage === totalPages;
  document.getElementById('btnLast').disabled = currentPage === totalPages;
  
  document.getElementById('pagination').style.display = totalPages > 1 ? 'flex' : 'none';
}

function changePage(direction) {
  const totalPages = Math.ceil(totalRows / rowsPerPage);
  
  switch(direction) {
    case 'first':
      currentPage = 1;
      break;
    case 'prev':
      if (currentPage > 1) currentPage--;
      break;
    case 'next':
      if (currentPage < totalPages) currentPage++;
      break;
    case 'last':
      currentPage = totalPages;
      break;
  }
  
  loadPopulationData();
  
  // Scroll to top of table
  document.getElementById('dataTable').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

   function createTableRow(data) {
  const tr = document.createElement('tr');
  
  const photoUrl = data.photo || '';
  const photoHTML = photoUrl ? 
    `<img src="${photoUrl}" class="profile-img" alt="Photo" onclick="showImagePreview('${photoUrl}')" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
     <div class="profile-img" style="font-size: 24px; display: none;">‚ùì</div>` : 
    '<div class="profile-img" style="font-size: 24px; display: flex; align-items: center; justify-content: center;">‚ùì</div>';
  // WhatsApp button
  const whatsappBtn = data.phone ? 
    `<a href="https://wa.me/${data.phone.replace(/\D/g, '')}" target="_blank" class="btn-whatsapp" title="${data.phone}">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
      </svg>
    </a>` : 
    '<span style="color: #999;">-</span>';
  
  // Action buttons based on type
  let actionButtons = '';
  if (data.type === 'member') {
    actionButtons = `
      <button class="btn-edit" onclick="editMemberOnly('${data.memberCode}')" title="‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡∫ö‡∫∏‡∫Å‡∫Ñ‡∫ª‡∫ô">
        ‚úèÔ∏è ‡ªÅ‡∫Å‡ªâ‡∫ö‡∫∏‡∫Å‡∫Ñ‡∫ª‡∫ô
      </button>
      <button class="btn-delete" onclick="showDeleteModal('member', '${data.memberCode}')" title="‡∫•‡∫ª‡∫ö‡∫Ñ‡∫ª‡∫ô‡∫î‡∫Ω‡∫ß">
        üóëÔ∏è ‡∫•‡∫ª‡∫ö‡∫Ñ‡∫ª‡∫ô‡∫î‡∫Ω‡∫ß
      </button>
      <button class="btn-edit-family" onclick="editHousehold('${data.householdCode}')" title="‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß">
        üë®‚Äçüë©‚Äçüëß ‡ªÅ‡∫Å‡ªâ‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß
      </button>
      <button class="btn-delete-family" onclick="showDeleteModal('household', '${data.householdCode}')" title="‡∫•‡∫ª‡∫ö‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß">
        üóëÔ∏è‚ùå ‡∫•‡∫ª‡∫ö‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß
      </button>
    `;
  } else {
    actionButtons = `
      <button class="btn-edit-family" onclick="editHousehold('${data.householdCode}')" title="‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß">
        üë®‚Äçüë©‚Äçüëß ‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß
      </button>
      <button class="btn-delete-family" onclick="showDeleteModal('household', '${data.householdCode}')" title="‡∫•‡∫ª‡∫ö‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß">
        üóëÔ∏è‚ùå ‡∫•‡∫ª‡∫ö‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß
      </button>
    `;
  }
  
  tr.innerHTML = `
    <td>${photoHTML}</td>
    <td><strong>${data.name}</strong></td>
    <td>${data.gender || '-'}</td>
    <td>${data.relationship || '-'}</td>
    <td>${data.unit || '-'}</td>
    <td style="text-align: center;">${whatsappBtn}</td>
    <td>
      <div class="action-buttons">
        ${actionButtons}
      </div>
    </td>
  `;
  
  return tr;
}
function searchData() {
  const searchTerm = document.getElementById('searchInput').value.trim();
  
  if (!searchTerm) {
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏Å‡∏ï‡∏¥
    loadPopulationData();
    return;
  }
  
  if (searchTerm.length < 2) {
    showToast('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫û‡∫¥‡∫°‡∫¢‡ªà‡∫≤‡∫á‡ªú‡ªâ‡∫≠‡∫ç 2 ‡∫ï‡∫ª‡∫ß‡∫≠‡∫±‡∫Å‡∫™‡∫≠‡∫ô', 'error');
    return;
  }
  
  showLoading();
  
  // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å server
  google.script.run
    .withSuccessHandler(function(results) {
      hideLoading();
      
      if (!results || results.length === 0) {
        const tbody = document.getElementById('dataTableBody');
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px;">
              <div style="font-size: 48px; margin-bottom: 10px;">üîç</div>
              <div>‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ó‡∫µ‡ªà‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤: "${searchTerm}"</div>
              <button onclick="clearSearch()" class="btn btn-primary" style="margin-top: 15px;">
                ‚ùå ‡∫•‡ªâ‡∫≤‡∫á‡∫Å‡∫≤‡∫ô‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤
              </button>
            </td>
          </tr>
        `;
        document.getElementById('pagination').style.display = 'none';
        showToast('‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫ú‡∫ª‡∫ô‡∫Å‡∫≤‡∫ô‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤', 'error');
        return;
      }
      
      // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      displaySearchResults(results, searchTerm);
      showToast(`‡∫û‡∫ª‡∫ö ${results.length} ‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß`, 'success');
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showToast('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤: ' + error.message, 'error');
    })
    .searchHouseholds(searchTerm, '', villageSheetId);
}

function displaySearchResults(results, searchTerm) {
  const tbody = document.getElementById('dataTableBody');
  tbody.innerHTML = '';
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
  const headerRow = document.createElement('tr');
  headerRow.innerHTML = `
    <td colspan="7" style="background: #fff3cd; padding: 15px; border-left: 5px solid #ffc107;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <strong>üîç ‡∫ú‡∫ª‡∫ô‡∫Å‡∫≤‡∫ô‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤: "${searchTerm}"</strong> - 
          ‡∫û‡∫ª‡∫ö <strong style="color: #667eea;">${results.length}</strong> ‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß
        </div>
        <button onclick="clearSearch()" class="btn btn-secondary" style="padding: 5px 15px;">
          ‚ùå ‡∫•‡ªâ‡∫≤‡∫á‡∫Å‡∫≤‡∫ô‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤
        </button>
      </div>
    </td>
  `;
  tbody.appendChild(headerRow);
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
  results.forEach(household => {
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≤‡∏Å householdsData
    const fullHousehold = householdsData.find(h => h.householdCode === household.householdCode);
    
    if (fullHousehold) {
      // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏±‡∏ß‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß
      const headRow = createTableRow({
        photo: fullHousehold.photo,
        code: fullHousehold.householdCode,
        name: fullHousehold.name,
        gender: '-',
        relationship: '‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß',
        unit: fullHousehold.unit,
        phone: fullHousehold.phone,
        type: 'household',
        householdCode: fullHousehold.householdCode
      });
      tbody.appendChild(headRow);
      
      // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
      if (fullHousehold.members && fullHousehold.members.length > 0) {
        fullHousehold.members.forEach(member => {
          const memberRow = createTableRow({
            photo: member.photo,
            code: member.memberCode,
            name: member.name,
            gender: member.gender,
            relationship: member.relationship,
            unit: member.unit,
            phone: member.phone,
            type: 'member',
            householdCode: fullHousehold.householdCode,
            memberCode: member.memberCode
          });
          tbody.appendChild(memberRow);
        });
      }
    }
  });
  
  // ‡∏ã‡πà‡∏≠‡∏ô pagination ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
  document.getElementById('pagination').style.display = 'none';
}

function clearSearch() {
  document.getElementById('searchInput').value = '';
  currentPage = 1;
  loadPopulationData();
  showToast('‡∫•‡ªâ‡∫≤‡∫á‡∫Å‡∫≤‡∫ô‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î', 'success');
}

    function openHouseholdForm() {
  document.getElementById('formTitle').textContent = '‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß‡ªÉ‡ªù‡ªà';
  document.getElementById('householdForm').reset();
  document.getElementById('householdCode').value = '';
  document.getElementById('membersContainer').innerHTML = '';
  document.getElementById('householdPhotoPreview').innerHTML = '<div class="placeholder">‚ùì</div>';
  memberCounter = 0;
  
  if (currentUser) {
    document.getElementById('village').value = currentUser.village;
    document.getElementById('district').value = currentUser.district;
    document.getElementById('province').value = currentUser.province;
  }
  
  // Enable all household fields
  document.getElementById('householdName').readOnly = false;
  document.getElementById('householdPhone').readOnly = false;
  document.getElementById('houseNumber').readOnly = false;
  document.getElementById('roofCount').readOnly = false;
  document.getElementById('householdCount').readOnly = false;
  document.getElementById('familyCount').readOnly = false;
  document.getElementById('registryBookCount').readOnly = false;
  document.getElementById('registryNumber').readOnly = false;
  document.getElementById('familyMemberCount').readOnly = true; // Auto-calculate
  document.getElementById('pageCount').readOnly = true; // Auto-calculate
  document.getElementById('unit').readOnly = false;
  document.getElementById('rentalLocation').readOnly = false;
  document.getElementById('monthlyIncome').readOnly = false;
  document.getElementById('housePosition').readOnly = false;
  document.getElementById('householdPhoto').disabled = false;
  
  populateRentalLocationList();
  document.getElementById('householdFormModal').classList.add('active');
}

    function closeHouseholdForm() {
      document.getElementById('householdFormModal').classList.remove('active');
    }

    function populateRentalLocationList() {
      if (optionsData && optionsData.K) {
        const datalist = document.getElementById('rentalLocationList');
        datalist.innerHTML = '';
        optionsData.K.forEach(option => {
          const optionEl = document.createElement('option');
          optionEl.value = option;
          datalist.appendChild(optionEl);
        });
      }
    }
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
function addMemberForm() {
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô
  if (memberCounter > 0) {
    const lastMember = document.getElementById(`member-${memberCounter}`);
    if (lastMember) {
      const errors = validateMemberForm(lastMember);
      
      if (errors.length > 0) {
        showValidationPopup(errors, memberCounter);
        return;
      }
    }
  }
  
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà
  memberCounter++;
  const container = document.getElementById('membersContainer');
  
  const memberDiv = document.createElement('div');
  memberDiv.className = 'form-section member-section';
  memberDiv.id = `member-${memberCounter}`;
  memberDiv.innerHTML = getMemberFormHTML(memberCounter, null);
  
  container.appendChild(memberDiv);
  populateDataLists();
  updateFamilyCounters();
  
// Initialize disease input listeners (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
  setupDiseaseInputListeners(memberCounter);
  
  // Initialize disease tags if editing existing member
  setTimeout(() => {
    const diseaseTextarea = document.getElementById(`diseaseHidden${memberCounter}`);
    if (diseaseTextarea && diseaseTextarea.value) {
      initializeExistingDiseases(memberCounter, diseaseTextarea.value);
    }
  }, 100);
  
  // Scroll ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà
  memberDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
  addRegistryChangeListeners();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
function validateMemberForm(memberDiv) {
  const errors = [];
  const requiredFields = memberDiv.querySelectorAll('.required-field');
  
  requiredFields.forEach(field => {
    const value = field.value.trim();
    const fieldName = field.getAttribute('data-field-name') || '‡∫ä‡ªà‡∫≠‡∫á‡∫ô‡∫µ‡ªâ';
    
    if (!value) {
      errors.push({
        field: field,
        fieldName: fieldName,
        message: `${fieldName} ‡∫ç‡∫±‡∫á‡∫ö‡ªç‡ªà‡ªÑ‡∫î‡ªâ‡∫ï‡∫∑‡ªà‡∫°‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô`
      });
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏≤‡∏™ invalid
      field.classList.add('invalid');
    } else {
      // ‡∏•‡∏ö‡∏Ñ‡∏•‡∏≤‡∏™ invalid ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤
      field.classList.remove('invalid');
    }
  });
  
  return errors;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á Popup ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
function showValidationPopup(errors, memberNumber) {
  const popup = document.createElement('div');
  popup.className = 'validation-error-popup';
  
  let errorListHTML = '';
  errors.forEach((error, index) => {
    errorListHTML += `
      <div class="validation-error-item">
        <span style="font-size: 1.2rem;">‚ùå</span>
        <span>${index + 1}. ${error.message}</span>
      </div>
    `;
  });
  
  popup.innerHTML = `
    <div class="validation-error-header">
      <span>‚ö†Ô∏è</span>
      <span>‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫ï‡∫∑‡ªà‡∫°‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÉ‡∫´‡ªâ‡∫Ñ‡∫ª‡∫ö‡∫ñ‡ªâ‡∫ß‡∫ô</span>
    </div>
    <p style="margin-bottom: 15px; color: #666;">
      ‡∫™‡∫∞‡∫°‡∫≤‡∫ä‡∫¥‡∫Å‡∫Ñ‡∫ª‡∫ô‡∫ó‡∫µ‡ªà ${memberNumber} ‡∫ç‡∫±‡∫á‡∫ï‡∫∑‡ªà‡∫°‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ö‡ªç‡ªà‡∫Ñ‡∫ª‡∫ö:
    </p>
    <div class="validation-error-list">
      ${errorListHTML}
    </div>
    <button class="btn btn-primary" onclick="closeValidationPopup()" style="width: 100%;">
      ‚úÖ ‡∫Æ‡∫±‡∫ö‡∫ó‡∫Æ‡∫≤‡∫ö
    </button>
  `;
  
  // ‡πÄ‡∏û‡∏¥‡πà‡∏° overlay
  const overlay = document.createElement('div');
  overlay.id = 'validationOverlay';
  overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000;';
  
  document.body.appendChild(overlay);
  document.body.appendChild(popup);
  
  // Scroll ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î
  setTimeout(() => {
    if (errors.length > 0) {
      errors[0].field.scrollIntoView({ behavior: 'smooth', block: 'center' });
      errors[0].field.focus();
    }
  }, 500);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î Popup
function closeValidationPopup() {
  const popup = document.querySelector('.validation-error-popup');
  const overlay = document.getElementById('validationOverlay');
  
  if (popup) popup.remove();
  if (overlay) overlay.remove();
}

// ‚úÖ ‡∏•‡∏ö animation invalid ‡πÄ‡∏°‡∏∑‡πà‡∏≠ user ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error)
document.addEventListener('input', function(e) {
  try {
    if (e.target && e.target.classList && e.target.classList.contains('required-field')) {
      if (e.target.value && e.target.value.trim()) {
        e.target.classList.remove('invalid');
      }
    }
  } catch (error) {
    console.error('‚ùå Input validation error:', error);
  }
}, { passive: true });

function removeMemberForm(id) {
  const memberDiv = document.getElementById(`member-${id}`);
  if (memberDiv && confirm('‡∫ó‡ªà‡∫≤‡∫ô‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫•‡∫ª‡∫ö‡∫™‡∫∞‡∫°‡∫≤‡∫ä‡∫¥‡∫Å‡∫Ñ‡∫ª‡∫ô‡∫ô‡∫µ‡ªâ‡∫ö‡ªç‡ªà?')) {
    memberDiv.remove();
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà
    reorderMembers();
    
    updateFamilyCounters();
  addRegistryChangeListeners(); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï relationship options (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
    updateRelationshipOptions();

  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà
function reorderMembers() {
  const container = document.getElementById('membersContainer');
  const memberDivs = container.querySelectorAll('.member-section');
  
  memberDivs.forEach((div, index) => {
    const newNumber = index + 1;
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
    const heading = div.querySelector('h3');
    if (heading) {
      heading.setAttribute('data-member-number', newNumber); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
      const span = heading.querySelector('span');
      if (span) {
        span.textContent = `üë§ ‡∫™‡∫∞‡∫°‡∫≤‡∫ä‡∫¥‡∫Å‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß ‡∫Ñ‡∫ª‡∫ô‡∫ó‡∫µ‡ªà ${newNumber}`;
      }
    }
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ID ‡∏Ç‡∏≠‡∏á div
    const oldId = div.id.match(/\d+/)[0];
    div.id = `member-${newNumber}`;
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∫î‡∏ï ID ‡∏Ç‡∏≠‡∏á inputs ‡πÅ‡∏•‡∏∞ buttons ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô
    updateElementIds(div, oldId, newNumber);
  });
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï memberCounter
  memberCounter = memberDivs.length;
  
  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï relationship options (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
  updateRelationshipOptions();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï IDs
function updateElementIds(container, oldId, newId) {
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Photo Notice
  const photoNotice = container.querySelector(`#photoNotice${oldId}`);
  if (photoNotice) photoNotice.id = `photoNotice${newId}`;
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Photo Wrapper
  const photoWrapper = container.querySelector(`#photoWrapper${oldId}`);
  if (photoWrapper) photoWrapper.id = `photoWrapper${newId}`;
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Photo Input
  const photoInput = container.querySelector(`#memberPhoto${oldId}`);
  if (photoInput) {
    photoInput.id = `memberPhoto${newId}`;
    const photoUpload = container.querySelector('.photo-upload');
    if (photoUpload) {
      photoUpload.setAttribute('onclick', `document.getElementById('memberPhoto${newId}').click()`);
    }
  }
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Photo Preview
  const photoPreview = container.querySelector(`#memberPhotoPreview${oldId}`);
  if (photoPreview) {
    photoPreview.id = `memberPhotoPreview${newId}`;
    if (photoInput) {
      photoInput.setAttribute('onchange', `previewPhoto(this, 'memberPhotoPreview${newId}')`);
    }
  }
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Delete Button
  const deleteBtn = container.querySelector('.btn-delete-member');
  if (deleteBtn) {
    deleteBtn.setAttribute('onclick', `removeMemberForm(${newId})`);
  }
}

 function getMemberFormHTML(counter, member) {
  const birthParts = member && member.birthDate ? member.birthDate.split('/') : ['', '', ''];
  const hasRelationship = member && member.relationship && member.relationship.trim() !== '';
  
  return `
   <h3 data-member-number="${counter}">
  <span style="margin-left: 35px;">üë§ ‡∫™‡∫∞‡∫°‡∫≤‡∫ä‡∫¥‡∫Å‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß ‡∫Ñ‡∫ª‡∫ô‡∫ó‡∫µ‡ªà ${counter}</span>
  <button type="button" class="btn-delete-member" onclick="removeMemberForm(${counter})">üóëÔ∏è ‡∫•‡∫ª‡∫ö</button>
</h3>
    <input type="hidden" class="memberCode" value="${member ? member.memberCode || '' : ''}">
    
    <!-- Photo Upload Notice -->
    <div class="photo-upload-notice ${hasRelationship ? 'hidden' : ''}" id="photoNotice${counter}">
      <span class="icon">üì∏</span>
      <span>‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å "‡∫™‡∫≤‡∫ç‡∫û‡∫ª‡∫ß‡∫û‡∫±‡∫ô‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß" ‡∫Å‡ªà‡∫≠‡∫ô ‡∫à‡∫∂‡ªà‡∫á‡∫à‡∫∞‡∫™‡∫≤‡∫°‡∫≤‡∫î‡∫≠‡∫±‡∫ö‡ªÇ‡∫´‡∫•‡∫î‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö‡ªÑ‡∫î‡ªâ</span>
    </div>
    
    <!-- Photo Upload Wrapper -->
    <div class="photo-upload-wrapper ${hasRelationship ? 'show' : ''}" id="photoWrapper${counter}">
      <div class="form-group">
        <div class="photo-upload" onclick="document.getElementById('memberPhoto${counter}').click()">
          <div class="photo-preview" id="memberPhotoPreview${counter}">
            ${member && member.photo ? `<img src="${member.photo}" alt="Photo">` : '<div class="placeholder">‚ùì</div>'}
          </div>
          <p>üì∑ ‡∫≠‡∫±‡∫ö‡ªÇ‡∫´‡∫•‡∫î/‡∫ñ‡ªà‡∫≤‡∫ç‡∫Æ‡∫π‡∫ö</p>
          <input type="file" id="memberPhoto${counter}" accept="image/*" style="display: none" onchange="previewPhoto(this, 'memberPhotoPreview${counter}')">
        </div>
      </div>
    </div>

    <!-- Row 1: ‡∫ä‡∫∑‡ªà, ‡ªÄ‡∫û‡∫î, ‡∫ß‡∫±‡∫ô‡ªÄ‡∫î‡∫∑‡∫≠‡∫ô‡∫õ‡∫µ‡ªÄ‡∫Å‡∫µ‡∫î -->
    <div class="form-row">
      <div class="form-group">
        <label>‡∫ä‡∫∑‡ªà ‡ªÅ‡∫•‡∫∞ ‡∫ô‡∫≤‡∫°‡∫™‡∫∞‡∫Å‡∫∏‡∫ô <span style="color: red;">*</span></label>
        <input type="text" class="memberName required-field" value="${member ? member.name || '' : ''}" data-field-name="‡∫ä‡∫∑‡ªà ‡ªÅ‡∫•‡∫∞ ‡∫ô‡∫≤‡∫°‡∫™‡∫∞‡∫Å‡∫∏‡∫ô">
      </div>
      <div class="form-group">
        <label>‡ªÄ‡∫û‡∫î <span style="color: red;">*</span></label>
        <input type="text" class="memberGender required-field" value="${member ? member.gender || '' : ''}" list="genderList" data-field-name="‡ªÄ‡∫û‡∫î">
      </div>
      <div class="form-group">
        <label>‡∫ß‡∫±‡∫ô‡ªÄ‡∫î‡∫∑‡∫≠‡∫ô‡∫õ‡∫µ‡ªÄ‡∫Å‡∫µ‡∫î <span style="color: red;">*</span></label>
     <div class="date-inputs">
  <input type="number" class="birthDay required-field" value="${birthParts[0]}" placeholder="‡∫ß‡∫±‡∫ô" min="1" max="31" data-field-name="‡∫ß‡∫±‡∫ô‡ªÄ‡∫Å‡∫µ‡∫î">
  <span>/</span>
  <input type="number" class="birthMonth required-field" value="${birthParts[1]}" placeholder="‡ªÄ‡∫î‡∫∑‡∫≠‡∫ô" min="1" max="12" data-field-name="‡ªÄ‡∫î‡∫∑‡∫≠‡∫ô‡ªÄ‡∫Å‡∫µ‡∫î">
  <span>/</span>
  <input type="number" class="birthYear required-field" value="${birthParts[2]}" placeholder="‡∫õ‡∫µ ‡∫Ñ.‡∫™." min="1900" max="2600" data-field-name="‡∫õ‡∫µ‡ªÄ‡∫Å‡∫µ‡∫î">
</div>
      </div>
    </div>

    <!-- Row 2: ‡∫™‡∫≤‡∫ç‡∫û‡∫ª‡∫ß‡∫û‡∫±‡∫ô, ‡∫≠‡∫≤‡∫ä‡∫µ‡∫ö, ‡∫ä‡∫ª‡∫ô‡ªÄ‡∫ú‡∫ª‡ªà‡∫≤ -->
    <div class="form-row">
     <div class="form-group">
  <label>‡∫™‡∫≤‡∫ç‡∫û‡∫ª‡∫ß‡∫û‡∫±‡∫ô‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß <span style="color: red;">*</span></label>
  <input type="text" 
         class="memberRelationship required-field" 
         value="${member ? member.relationship || '' : ''}" 
         list="relationshipList" 
         onchange="handleRelationshipChange(this, ${counter}); handleRelationshipChange_ClearPhoto(${counter})" 
         oninput="handleRelationshipChange(this, ${counter}); handleRelationshipChange_ClearPhoto(${counter})"
         data-field-name="‡∫™‡∫≤‡∫ç‡∫û‡∫ª‡∫ß‡∫û‡∫±‡∫ô‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß">
</div>
      <div class="form-group">
        <label>‡∫≠‡∫≤‡∫ä‡∫µ‡∫ö <span style="color: red;">*</span></label>
        <input type="text" class="memberOccupation required-field" value="${member ? member.occupation || '' : ''}" list="occupationList" data-field-name="‡∫≠‡∫≤‡∫ä‡∫µ‡∫ö">
      </div>
      <div class="form-group">
        <label>‡∫ä‡∫ª‡∫ô‡ªÄ‡∫ú‡∫ª‡ªà‡∫≤ <span style="color: red;">*</span></label>
        <input type="text" class="memberEthnicity required-field" value="${member ? member.ethnicity || '' : ''}" list="ethnicityList" data-field-name="‡∫ä‡∫ª‡∫ô‡ªÄ‡∫ú‡∫ª‡ªà‡∫≤">
      </div>
    </div>

    <!-- Row 3: ‡∫Æ‡ªà‡∫≤‡∫á‡∫Å‡∫≤‡∫ç‡∫™‡∫ª‡∫°‡∫ö‡∫π‡∫ô, ‡∫õ‡∫∞‡∫Å‡∫±‡∫ô‡∫™‡∫∏‡∫Ç‡∫∞‡∫û‡∫≤‡∫ö, ‡∫û‡∫∞‡∫ç‡∫≤‡∫î‡∫õ‡∫∞‡∫à‡ªç‡∫≤‡∫ï‡∫ª‡∫ß -->
    <div class="form-row">
      <div class="form-group">
        <label>‡∫Æ‡ªà‡∫≤‡∫á‡∫Å‡∫≤‡∫ç‡∫™‡∫ª‡∫°‡∫ö‡∫π‡∫ô <span style="color: red;">*</span></label>
        <input type="text" class="memberBodyComplete required-field" value="${member ? member.bodyComplete || '' : ''}" list="bodyCompleteList" data-field-name="‡∫Æ‡ªà‡∫≤‡∫á‡∫Å‡∫≤‡∫ç‡∫™‡∫ª‡∫°‡∫ö‡∫π‡∫ô">
      </div>
      <div class="form-group">
        <label>‡∫õ‡∫∞‡∫Å‡∫±‡∫ô‡∫™‡∫∏‡∫Ç‡∫∞‡∫û‡∫≤‡∫ö <span style="color: red;">*</span></label>
        <input type="text" class="memberInsurance required-field" value="${member ? member.insurance || '' : ''}" list="insuranceList" data-field-name="‡∫õ‡∫∞‡∫Å‡∫±‡∫ô‡∫™‡∫∏‡∫Ç‡∫∞‡∫û‡∫≤‡∫ö">
      </div>
    <div class="form-group">
  <label>‡∫û‡∫∞‡∫ç‡∫≤‡∫î‡∫õ‡∫∞‡∫à‡ªç‡∫≤‡∫ï‡∫ª‡∫ß <span style="color: red;">*</span></label>
  
  <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á Tags -->
  <div class="disease-tags-container" 
       id="diseaseTagsContainer${counter}" 
       style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; min-height: 40px; padding: 10px; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px;">
    <div style="width: 100%; text-align: center; color: #999; font-size: 13px;" class="empty-placeholder">
      ‡∫ç‡∫±‡∫á‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫û‡∫∞‡∫ç‡∫≤‡∫î - ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫´‡∫º‡∫∑‡∫û‡∫¥‡∫°‡∫î‡ªâ‡∫≤‡∫ô‡∫•‡∫∏‡ªà‡∫°
    </div>
  </div>
  
  <!-- Input ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏û‡∏¥‡∏°‡∏û‡πå -->
  <div style="position: relative;">
    <input type="text" 
           class="memberDiseaseInput" 
           id="diseaseInput${counter}"
           list="diseaseList" 
           placeholder="üîç ‡∫Ñ‡∫•‡∫¥‡∫Å‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å ‡∫´‡∫º‡∫∑ ‡∫û‡∫¥‡∫°‡ªÄ‡∫≠‡∫á..."
           style="width: 100%; padding: 12px 40px 12px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s;"
           onkeydown="handleDiseaseInput(event, ${counter})"
           onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)';"
           onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none';">
    
    <!-- ‡∏õ‡∏∏‡πà‡∏° Add -->
    <button type="button" 
            onclick="manualAddDisease(${counter})"
            style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); padding: 8px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.3s;"
            onmouseover="this.style.transform='translateY(-50%) scale(1.05)'"
            onmouseout="this.style.transform='translateY(-50%) scale(1)'">
      ‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°
    </button>
  </div>
  
  <small style="display: block; color: #666; font-size: 12px; margin-top: 5px; line-height: 1.5;">
    üí° <strong>‡∫ß‡∫¥‡∫ó‡∫µ‡ªÉ‡∫ä‡ªâ:</strong><br>
    ‚Ä¢ ‡∫Ñ‡∫•‡∫¥‡∫Å‡ªÉ‡∫™‡ªà‡∫ä‡ªà‡∫≠‡∫á‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÄ‡∫ö‡∫¥‡ªà‡∫á‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô‡∫û‡∫∞‡∫ç‡∫≤‡∫î<br>
    ‚Ä¢ ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô ‡∫´‡∫º‡∫∑ ‡∫û‡∫¥‡∫°‡ªÄ‡∫≠‡∫á<br>
    ‚Ä¢ ‡∫Å‡∫ª‡∫î Enter ‡∫´‡∫º‡∫∑ ‡∫Å‡∫ª‡∫î‡∫õ‡∫∏‡ªà‡∫° "‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°"<br>
    ‚Ä¢ ‡∫™‡∫≤‡∫°‡∫≤‡∫î‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡ªÑ‡∫î‡ªâ‡∫´‡∫º‡∫≤‡∫ç‡∫û‡∫∞‡∫ç‡∫≤‡∫î
  </small>
  
  <!-- Hidden textarea ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á -->
  <textarea class="memberDisease required-field" 
            id="diseaseHidden${counter}"
            rows="1" 
            style="display: none;"
            data-field-name="‡∫û‡∫∞‡∫ç‡∫≤‡∫î‡∫õ‡∫∞‡∫à‡ªç‡∫≤‡∫ï‡∫ª‡∫ß">${member ? member.disease || '' : ''}</textarea>
</div>
    </div>

    <!-- Row 4: ‡∫•‡∫∞‡∫î‡∫±‡∫ö‡∫Å‡∫≤‡∫ô‡∫™‡∫∂‡∫Å‡∫™‡∫≤, ‡∫™‡∫≤‡∫™‡∫∞‡ªú‡∫≤, ‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫∞‡∫û‡∫≤‡∫ö‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß -->
    <div class="form-row">
      <div class="form-group">
        <label>‡∫•‡∫∞‡∫î‡∫±‡∫ö‡∫Å‡∫≤‡∫ô‡∫™‡∫∂‡∫Å‡∫™‡∫≤ <span style="color: red;">*</span></label>
        <input type="text" class="memberEducation required-field" value="${member ? member.education || '' : ''}" list="educationList" data-field-name="‡∫•‡∫∞‡∫î‡∫±‡∫ö‡∫Å‡∫≤‡∫ô‡∫™‡∫∂‡∫Å‡∫™‡∫≤">
      </div>
      <div class="form-group">
        <label>‡∫™‡∫≤‡∫™‡∫∞‡ªú‡∫≤ <span style="color: red;">*</span></label>
        <input type="text" class="memberReligion required-field" value="${member ? member.religion || '' : ''}" list="religionList" data-field-name="‡∫™‡∫≤‡∫™‡∫∞‡ªú‡∫≤">
      </div>
      <div class="form-group">
        <label>‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫∞‡∫û‡∫≤‡∫ö‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß <span style="color: red;">*</span></label>
        <input type="text" class="memberMaritalStatus required-field" value="${member ? member.maritalStatus || '' : ''}" list="maritalStatusList" data-field-name="‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫∞‡∫û‡∫≤‡∫ö‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß">
      </div>
    </div>

    <!-- Row 5: ‡∫°‡∫µ‡ªú‡ªâ‡∫≤‡ªÉ‡∫ô‡∫™‡ªç‡∫≤‡∫°‡∫∞‡ªÇ‡∫ô‡∫Ñ‡∫ª‡∫ß, ‡∫°‡∫µ‡ªú‡ªâ‡∫≤‡∫¢‡∫π‡ªà‡∫ï‡∫ª‡∫ß‡∫à‡∫¥‡∫á, ‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó‡∫ï‡∫¥‡∫î‡∫ï‡ªç‡ªà -->
    <div class="form-row">
      <div class="form-group">
        <label>‡∫°‡∫µ‡ªú‡ªâ‡∫≤‡ªÉ‡∫ô‡∫™‡ªç‡∫≤‡∫°‡∫∞‡ªÇ‡∫ô‡∫Ñ‡∫ª‡∫ß <span style="color: red;">*</span></label>
        <input type="text" class="memberInRegistry required-field" value="${member ? member.inRegistry || '' : ''}" list="inRegistryList" data-field-name="‡∫°‡∫µ‡ªú‡ªâ‡∫≤‡ªÉ‡∫ô‡∫™‡ªç‡∫≤‡∫°‡∫∞‡ªÇ‡∫ô‡∫Ñ‡∫ª‡∫ß">
      </div>
      <div class="form-group">
        <label>‡∫°‡∫µ‡ªú‡ªâ‡∫≤‡∫¢‡∫π‡ªà‡∫ï‡∫ª‡∫ß‡∫à‡∫¥‡∫á <span style="color: red;">*</span></label>
        <input type="text" class="memberActualResident required-field" value="${member ? member.actualResident || '' : ''}" list="actualResidentList" data-field-name="‡∫°‡∫µ‡ªú‡ªâ‡∫≤‡∫¢‡∫π‡ªà‡∫ï‡∫ª‡∫ß‡∫à‡∫¥‡∫á">
      </div>
      <div class="form-group">
        <label>‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó‡∫ï‡∫¥‡∫î‡∫ï‡ªç‡ªà</label>
        <input type="tel" class="memberPhone" value="${member ? member.phone || '' : ''}" placeholder="20XXXXXXXX">
      </div>
    </div>
  `;
}

   function populateDataLists() {
  if (!optionsData) return;
  
  const datalists = {
    genderList: optionsData.A,
    occupationList: optionsData.B,
    insuranceList: optionsData.C,
    educationList: optionsData.D,
    maritalStatusList: optionsData.E,
    diseaseList: optionsData.F,
    ethnicityList: optionsData.G,
    relationshipList: optionsData.H,
    religionList: optionsData.J,
    bodyCompleteList: optionsData.L,
    actualResidentList: optionsData.U,
    inRegistryList: optionsData.V
  };
  
  Object.keys(datalists).forEach(listId => {
    const datalist = document.getElementById(listId);
    if (datalist && datalists[listId]) {
      datalist.innerHTML = '';
      datalists[listId].forEach(option => {
        const optionEl = document.createElement('option');
        optionEl.value = option;
        datalist.appendChild(optionEl);
      });
    }
  });
  
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
  addRegistryChangeListeners();
  updateFamilyCounters();
}



    // ===================================
    // SAVE HOUSEHOLD
    // ===================================
  // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô Event Listener ‡∏Ç‡∏≠‡∏á householdForm ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

// ‚úÖ ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ 3: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
function validateAllFormFields() {
  const errors = [];
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß
  const householdName = document.getElementById('householdName');
  if (!householdName.value.trim()) {
    errors.push({ field: 'householdName', message: '‡∫ä‡∫∑‡ªà‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß ‡∫ö‡ªç‡ªà‡∫Å‡∫ª‡∫ô‡∫£‡∫∏‡∫ô‡∫≤‡∫Å‡∫±‡∫ô‡∫Å‡ªç‡ªà' });
  }
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
  const memberForms = document.querySelectorAll('#membersContainer .member-section');
  memberForms.forEach((form, index) => {
    const memberErrors = validateMemberForm(form);
    errors.push(...memberErrors);
  });
  
  // ‚ùå ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ error
  if (errors.length > 0) {
    // Highlight ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î
    errors.forEach(error => {
      const field = document.getElementById(error.field);
      if (field) {
        field.classList.add('invalid');
      }
    });
    
    // ‡πÅ‡∏™‡∏î‡∏á Popup
    showValidationPopup(errors, 0);
    return false;
  }
  
  return true;
}

    document.getElementById('householdForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡πà‡∏≠‡∏ô
  if (!validateAllFormFields()) {
    return;
  }
  
  
  console.log('=== Form Submit Started ===');
  
  // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß
  const householdData = {
    householdCode: document.getElementById('householdCode').value,
    name: document.getElementById('householdName').value,
    photo: getPhotoData('householdPhotoPreview'),
    phone: document.getElementById('householdPhone').value,
    houseNumber: document.getElementById('houseNumber').value,
    roofCount: document.getElementById('roofCount').value,
    householdCount: document.getElementById('householdCount').value,
    familyCount: document.getElementById('familyCount').value,
    registryBookCount: document.getElementById('registryBookCount').value,
    registryNumber: document.getElementById('registryNumber').value,
    familyMemberCount: document.getElementById('familyMemberCount').value,
    pageCount: document.getElementById('pageCount').value,
    unit: document.getElementById('unit').value,
    rentalLocation: document.getElementById('rentalLocation').value,
    monthlyIncome: document.getElementById('monthlyIncome').value || '0',
    housePosition: document.getElementById('housePosition').value,
    village: document.getElementById('village').value,
    district: document.getElementById('district').value,
    province: document.getElementById('province').value,
    villageParticipation: document.getElementById('villageParticipation').value,
    userCode: currentUser ? currentUser.code : '',
    userName: currentUser ? currentUser.name : '',
    members: []
  };
  
  console.log('Household data collected:', householdData);
  
  // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
  const memberForms = document.querySelectorAll('#membersContainer .member-section');
  console.log('Found member forms:', memberForms.length);
  
  memberForms.forEach((form, index) => {
    const counterId = form.id.split('-')[1];
    console.log('Processing member form:', counterId);
    
  const member = {
  memberCode: form.querySelector('.memberCode') ? form.querySelector('.memberCode').value : '',
  name: form.querySelector('.memberName') ? form.querySelector('.memberName').value : '',
  photo: getPhotoData(`memberPhotoPreview${counterId}`), // ‡∏à‡∏∞‡πÑ‡∏î‡πâ URL ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß
      gender: form.querySelector('.memberGender') ? form.querySelector('.memberGender').value : '',
      birthDate: `${form.querySelector('.birthDay') ? form.querySelector('.birthDay').value : ''}/${form.querySelector('.birthMonth') ? form.querySelector('.birthMonth').value : ''}/${form.querySelector('.birthYear') ? form.querySelector('.birthYear').value : ''}`,
      relationship: form.querySelector('.memberRelationship') ? form.querySelector('.memberRelationship').value : '',
      occupation: form.querySelector('.memberOccupation') ? form.querySelector('.memberOccupation').value : '',
      ethnicity: form.querySelector('.memberEthnicity') ? form.querySelector('.memberEthnicity').value : '',
      bodyComplete: form.querySelector('.memberBodyComplete') ? form.querySelector('.memberBodyComplete').value : '',
      insurance: form.querySelector('.memberInsurance') ? form.querySelector('.memberInsurance').value : '',
      disease: form.querySelector('.memberDisease') ? form.querySelector('.memberDisease').value : '',
      education: form.querySelector('.memberEducation') ? form.querySelector('.memberEducation').value : '',
      religion: form.querySelector('.memberReligion') ? form.querySelector('.memberReligion').value : '',
      maritalStatus: form.querySelector('.memberMaritalStatus') ? form.querySelector('.memberMaritalStatus').value : '',
      inRegistry: form.querySelector('.memberInRegistry') ? form.querySelector('.memberInRegistry').value : '',
      actualResident: form.querySelector('.memberActualResident') ? form.querySelector('.memberActualResident').value : '',
      phone: form.querySelector('.memberPhone') ? form.querySelector('.memberPhone').value : '',
      village: householdData.village,
      district: householdData.district,
      province: householdData.province,
      unit: householdData.unit,
      housePosition: householdData.housePosition
    };
    
    console.log('Member data:', member);
    householdData.members.push(member);
  });
  
  console.log('Final household data:', householdData);
  showLoading();
  
  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  if (householdData.householdCode) {
    console.log('Updating existing household...');
    google.script.run
      .withSuccessHandler(handleSaveSuccess)
      .withFailureHandler(handleSaveFailure)
      .updateHousehold(householdData, villageSheetId);
  } else {
    console.log('Saving new household...');
    google.script.run
      .withSuccessHandler(handleSaveSuccess)
      .withFailureHandler(handleSaveFailure)
      .saveHousehold(householdData, villageSheetId);
  }
  
  function handleSaveSuccess(result) {
    console.log('Save success:', result);
    
    if (result.success) {
      if (result.householdCode) {
        householdData.householdCode = result.householdCode;
      }
      
      const existingIndex = householdsData.findIndex(h => h.householdCode === householdData.householdCode);
      if (existingIndex >= 0) {
        householdsData[existingIndex] = householdData;
      } else {
        householdsData.push(householdData);
      }
      
      saveToIndexedDB('households', householdData);
      
      hideLoading();
      showToast(result.message, 'success');
      closeHouseholdForm();
      loadPopulationData();
    } else {
      hideLoading();
      showToast(result.message, 'error');
    }
  }
  
  function handleSaveFailure(error) {
    console.error('Save failed:', error);
    
    saveToSyncQueue('save', householdData);
    
    if (!householdData.householdCode) {
      householdData.householdCode = generateRandomCode(13);
    }
    
    const existingIndex = householdsData.findIndex(h => h.householdCode === householdData.householdCode);
    if (existingIndex >= 0) {
      householdsData[existingIndex] = householdData;
    } else {
      householdsData.push(householdData);
    }
    
    saveToIndexedDB('households', householdData);
    
    hideLoading();
    showToast('‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡ªÅ‡∫ö‡∫ö‡∫≠‡∫≠‡∫ö‡ªÑ‡∫•‡∫ô‡ªå‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î ‡∫à‡∫∞ Sync ‡ªÄ‡∫°‡∫∑‡ªà‡∫≠‡∫°‡∫µ‡∫≠‡∫¥‡∫ô‡ªÄ‡∫ï‡∫µ‡ªÄ‡∫ô‡∫±‡∫î', 'success');
    closeHouseholdForm();
    loadPopulationData();
  }
});

function getPhotoData(previewId) {
  const preview = document.getElementById(previewId);
  if (!preview) return '';
  
  const img = preview.querySelector('img');
  if (!img || !img.src) return '';
  
  // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô URL ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏•‡∏¢ (‡πÑ‡∏°‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥)
  if (preview.getAttribute('data-is-household-photo') === 'true') {
    const householdPhotoUrl = preview.getAttribute('data-household-photo-url');
    
    console.log('üì∏ Reusing household photo URL (same file, no duplicate):');
    console.log('URL:', householdPhotoUrl);
    
    // ‡∏Ñ‡∏∑‡∏ô URL ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô https:// ‡πÄ‡∏•‡∏¢ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà data:image)
    if (householdPhotoUrl && householdPhotoUrl.startsWith('https://')) {
      return householdPhotoUrl; // ‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡πÑ‡∏°‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
    }
    
    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô data:image (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ
    return img.src;
  }
  
  // ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥ - ‡∏£‡∏π‡∏õ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
  return img.src;
}

    function generateRandomCode(length) {
      let code = '';
      for (let i = 0; i < length; i++) {
        code += Math.floor(Math.random() * 10);
      }
      return code;
    }

    // ===================================
    // EDIT HOUSEHOLD
    // ===================================
    function editHousehold(householdCode) {
      const household = householdsData.find(h => h.householdCode === householdCode);
      if (!household) {
        showToast('‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß', 'error');
        return;
      }
      
      document.getElementById('formTitle').textContent = '‚úèÔ∏è ‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß';
      document.getElementById('householdCode').value = household.householdCode;
      document.getElementById('householdName').value = household.name || '';
      document.getElementById('householdPhone').value = household.phone || '';
      document.getElementById('houseNumber').value = household.houseNumber || '';
      document.getElementById('roofCount').value = household.roofCount || '';
      document.getElementById('householdCount').value = household.householdCount || '';
      document.getElementById('familyCount').value = household.familyCount || '';
      document.getElementById('registryBookCount').value = household.registryBookCount || '';
      document.getElementById('registryNumber').value = household.registryNumber || '';
      document.getElementById('familyMemberCount').value = household.familyMemberCount || '';
      document.getElementById('pageCount').value = household.pageCount || '';
      document.getElementById('unit').value = household.unit || '';
      document.getElementById('rentalLocation').value = household.rentalLocation || '';
      document.getElementById('monthlyIncome').value = household.monthlyIncome || '';
      document.getElementById('housePosition').value = household.housePosition || '';
      document.getElementById('village').value = household.village || '';
      document.getElementById('district').value = household.district || '';
     document.getElementById('province').value = household.province || '';

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ
if (household.villageParticipation) {
  document.getElementById('villageParticipation').value = household.villageParticipation;
  
  // ‡πÅ‡∏™‡∏î‡∏á display
  const participationTexts = {
    'excellent': '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê ‡∫°‡∫µ‡∫™‡ªà‡∫ß‡∫ô‡∫Æ‡ªà‡∫ß‡∫°‡∫î‡∫µ‡ªÄ‡∫•‡∫µ‡∫î',
    'verygood': '‚≠ê‚≠ê‚≠ê‚≠ê ‡∫°‡∫µ‡∫™‡ªà‡∫ß‡∫ô‡∫Æ‡ªà‡∫ß‡∫°‡∫î‡∫µ‡∫´‡∫º‡∫≤‡∫ç',
    'moderate': '‚≠ê‚≠ê‚≠ê ‡∫°‡∫µ‡∫™‡ªà‡∫ß‡∫ô‡∫Æ‡ªà‡∫ß‡∫°‡∫õ‡∫≤‡∫ô‡∫Å‡∫≤‡∫á',
    'lacking': '‚≠ê ‡∫Ç‡∫≤‡∫î‡∫Å‡∫≤‡∫ô‡∫°‡∫µ‡∫™‡ªà‡∫ß‡∫ô‡∫Æ‡ªà‡∫ß‡∫°'
  };
  
  const display = document.getElementById('participationDisplay');
  const text = document.getElementById('participationText');
  
  if (participationTexts[household.villageParticipation]) {
    text.textContent = participationTexts[household.villageParticipation];
    display.className = '';
    display.classList.add(household.villageParticipation);
    display.style.display = 'block';
  }
}
      
      const photoPreview = document.getElementById('householdPhotoPreview');
      if (household.photo) {
        photoPreview.innerHTML = `<img src="${household.photo}" alt="Photo">`;
      } else {
        photoPreview.innerHTML = '<div class="placeholder">‚ùì</div>';
      }
      
      const membersContainer = document.getElementById('membersContainer');
      membersContainer.innerHTML = '';
      memberCounter = 0;
      
      if (household.members && household.members.length > 0) {
        household.members.forEach(member => {
          memberCounter++;
          const memberDiv = document.createElement('div');
          memberDiv.className = 'form-section';
          memberDiv.id = `member-${memberCounter}`;
          memberDiv.innerHTML = getMemberFormHTML(memberCounter, member);
          membersContainer.appendChild(memberDiv);
        });
      }
      
      populateDataLists();
      populateRentalLocationList();
      document.getElementById('householdFormModal').classList.add('active');
    }

    function editMember(memberCode) {
      let targetHousehold = null;
      let targetMember = null;
      
      for (let household of householdsData) {
        if (household.members) {
          const member = household.members.find(m => m.memberCode === memberCode);
          if (member) {
            targetHousehold = household;
            targetMember = member;
            break;
          }
        }
      }
      
      if (!targetMember) {
        showToast('‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫™‡∫∞‡∫°‡∫≤‡∫ä‡∫¥‡∫Å', 'error');
        return;
      }
      
      editHousehold(targetHousehold.householdCode);
    }

 function showDeleteModal(type, code) {
  deleteTarget = { type, code };
  selectedReason = null;
  
  const optionsContainer = document.getElementById('deleteReasonOptions');
  optionsContainer.innerHTML = '';
  
  // Set title
  const title = type === 'member' ? 
    '‚ö†Ô∏è ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÄ‡∫´‡∫î‡∫ú‡∫ª‡∫ô‡∫Å‡∫≤‡∫ô‡∫•‡∫ª‡∫ö‡∫™‡∫∞‡∫°‡∫≤‡∫ä‡∫¥‡∫Å' : 
    '‚ö†Ô∏è ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÄ‡∫´‡∫î‡∫ú‡∫ª‡∫ô‡∫Å‡∫≤‡∫ô‡∫•‡∫ª‡∫ö‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß';
  document.getElementById('deleteModalTitle').textContent = title;
  
  // Set options based on type
  let reasons = [];
  if (type === 'member') {
    reasons = [
      { value: 1, text: '1. ‡∫ç‡∫ª‡∫Å‡∫ç‡ªâ‡∫≤‡∫ç‡∫≠‡∫≠‡∫Å' },
      { value: 2, text: '2. ‡ªÄ‡∫™‡∫ç‡∫ä‡∫µ‡∫ß‡∫¥‡∫î' },
      { value: 3, text: '3. ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ö‡ªç‡ªà‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á' }
    ];
  } else {
    reasons = [
      { value: 1, text: '1. ‡∫ç‡∫ª‡∫Å‡∫ç‡ªâ‡∫≤‡∫ç‡∫≠‡∫≠‡∫Å' },
      { value: 3, text: '2. ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ö‡ªç‡ªà‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á' }
    ];
  }
  
  // Create reason options
  reasons.forEach(reason => {
    const optionDiv = document.createElement('div');
    optionDiv.className = 'reason-option';
    optionDiv.onclick = () => selectReason(reason.value);
    
    optionDiv.innerHTML = `
      <input type="radio" name="deleteReason" value="${reason.value}" id="reason${reason.value}">
      <label for="reason${reason.value}">${reason.text}</label>
    `;
    
    optionsContainer.appendChild(optionDiv);
  });
  
  document.getElementById('confirmDeleteBtn').disabled = true;
  document.getElementById('deleteReasonModal').classList.add('active');
}

    function closeDeleteModal() {
      document.getElementById('deleteReasonModal').classList.remove('active');
      deleteTarget = null;
      selectedReason = null;
    }

    function selectReason(reason) {
      selectedReason = reason;
      document.querySelectorAll('.reason-option').forEach(el => el.classList.remove('selected'));
      document.getElementById(`reason${reason}`).closest('.reason-option').classList.add('selected');
      document.getElementById(`reason${reason}`).checked = true;
      document.getElementById('confirmDeleteBtn').disabled = false;
    }

    function confirmDelete() {
      if (!deleteTarget || !selectedReason) return;
      
      const reasonTexts = {
        1: '‡∫ç‡∫ª‡∫Å‡∫ç‡ªâ‡∫≤‡∫ç‡∫≠‡∫≠‡∫Å',
        2: '‡ªÄ‡∫™‡∫ç‡∫ä‡∫µ‡∫ß‡∫¥‡∫î',
        3: '‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ö‡ªç‡ªà‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á'
      };
      
      showLoading();
      
      if (deleteTarget.type === 'member') {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              householdsData.forEach(household => {
                if (household.members) {
                  household.members = household.members.filter(m => m.memberCode !== deleteTarget.code);
                  saveToIndexedDB('households', household);
                }
              });
              
              hideLoading();
              showToast(result.message, 'success');
              closeDeleteModal();
              loadPopulationData();
            } else {
              hideLoading();
              showToast(result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            saveToSyncQueue('deleteMember', { memberCode: deleteTarget.code, reason: reasonTexts[selectedReason] });
            
            householdsData.forEach(household => {
              if (household.members) {
                household.members = household.members.filter(m => m.memberCode !== deleteTarget.code);
                saveToIndexedDB('households', household);
              }
            });
            
            hideLoading();
            showToast('‡∫•‡∫ª‡∫ö‡ªÅ‡∫ö‡∫ö‡∫≠‡∫≠‡∫ö‡ªÑ‡∫•‡∫ô‡ªå‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î ‡∫à‡∫∞ Sync ‡ªÄ‡∫°‡∫∑‡ªà‡∫≠‡∫°‡∫µ‡∫≠‡∫¥‡∫ô‡ªÄ‡∫ï‡∫µ‡ªÄ‡∫ô‡∫±‡∫î', 'success');
            closeDeleteModal();
            loadPopulationData();
          })
          .deleteMember(deleteTarget.code, reasonTexts[selectedReason], villageSheetId);
      } else {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              householdsData = householdsData.filter(h => h.householdCode !== deleteTarget.code);
              deleteFromIndexedDB('households', deleteTarget.code);
              
              hideLoading();
              showToast(result.message, 'success');
              closeDeleteModal();
              loadPopulationData();
            } else {
              hideLoading();
              showToast(result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            saveToSyncQueue('deleteHousehold', { householdCode: deleteTarget.code, reason: reasonTexts[selectedReason] });
            
            householdsData = householdsData.filter(h => h.householdCode !== deleteTarget.code);
            deleteFromIndexedDB('households', deleteTarget.code);
            
            hideLoading();
            showToast('‡∫•‡∫ª‡∫ö‡ªÅ‡∫ö‡∫ö‡∫≠‡∫≠‡∫ö‡ªÑ‡∫•‡∫ô‡ªå‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î ‡∫à‡∫∞ Sync ‡ªÄ‡∫°‡∫∑‡ªà‡∫≠‡∫°‡∫µ‡∫≠‡∫¥‡∫ô‡ªÄ‡∫ï‡∫µ‡ªÄ‡∫ô‡∫±‡∫î', 'success');
            closeDeleteModal();
            loadPopulationData();
          })
          .deleteHousehold(deleteTarget.code, reasonTexts[selectedReason], villageSheetId);
      }
    }

    // ===================================
    // SYNC QUEUE
    // ===================================
    function saveToSyncQueue(action, data) {
      if (!db) return;
      
      const syncItem = {
        action: action,
        data: data,
        timestamp: new Date().getTime()
      };
      
      const transaction = db.transaction(['syncQueue'], 'readwrite');
      const store = transaction.objectStore('syncQueue');
      store.add(syncItem);
    }

    function processSyncQueue() {
      if (!db) return;
      
      const transaction = db.transaction(['syncQueue'], 'readonly');
      const store = transaction.objectStore('syncQueue');
      const request = store.getAll();
      
      request.onsuccess = function() {
        const items = request.result;
        
        items.forEach(item => {
          if (item.action === 'save') {
            google.script.run
              .withSuccessHandler(function(result) {
                if (result.success) {
                  const tx = db.transaction(['syncQueue'], 'readwrite');
                  tx.objectStore('syncQueue').delete(item.id);
                }
              })
              .saveHousehold(item.data, villageSheetId);
          } else if (item.action === 'deleteMember') {
            google.script.run
              .withSuccessHandler(function(result) {
                if (result.success) {
                  const tx = db.transaction(['syncQueue'], 'readwrite');
                  tx.objectStore('syncQueue').delete(item.id);
                }
              })
              .deleteMember(item.data.memberCode, item.data.reason, villageSheetId);
          } else if (item.action === 'deleteHousehold') {
            google.script.run
              .withSuccessHandler(function(result) {
                if (result.success) {
                  const tx = db.transaction(['syncQueue'], 'readwrite');
                  tx.objectStore('syncQueue').delete(item.id);
                }
              })
              .deleteHousehold(item.data.householdCode, item.data.reason, villageSheetId);
          }
        });
      };
    }

    setInterval(function() {
      if (navigator.onLine && db) {
        processSyncQueue();
      }
    }, 30000);

    // ===================================
    // UTILITY FUNCTIONS
    // ===================================
 function showLoading(targetCount = 0, message = '‡∫Å‡∫≥‡∫•‡∫±‡∫á‡ªÇ‡∫´‡∫•‡∫î‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô...') {
  const loadingDiv = document.getElementById('loading');
  const counterDiv = document.getElementById('loadingCounter');
  const messageDiv = document.getElementById('loadingMessage');
  
  loadingDiv.classList.add('active');
  
  if (counterDiv) {
    counterDiv.textContent = '0';
  }
  
  if (messageDiv) {
    messageDiv.textContent = message;
  }
  
  // Animation counter
  if (targetCount > 0 && counterDiv) {
    let current = 0;
    const duration = 2000; // 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    const increment = targetCount / (duration / 50);
    
    const timer = setInterval(() => {
      current += increment;
      if (current >= targetCount) {
        current = targetCount;
        clearInterval(timer);
      }
      counterDiv.textContent = Math.floor(current);
    }, 50);
    
    // ‡πÄ‡∏Å‡πá‡∏ö timer ‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠ clear ‡∏ï‡∏≠‡∏ô hide
    loadingDiv.setAttribute('data-timer', timer);
  }
}

 function hideLoading() {
  const loadingDiv = document.getElementById('loading');
  
  // Clear timer ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
  const timer = loadingDiv.getAttribute('data-timer');
  if (timer) {
    clearInterval(parseInt(timer));
    loadingDiv.removeAttribute('data-timer');
  }
  
  loadingDiv.classList.remove('active');
}

    function showToast(message, type) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} active`;
      
      setTimeout(() => {
        toast.classList.remove('active');
      }, 3000);
    }
    // ===================================
// DEBUG: Test Login Data
// ===================================
function testLoginData() {
  console.log('Testing login data...');
  console.log('Current loginData:', loginData);
  
  if (loginData) {
    console.log('Provinces count:', loginData.provinces ? loginData.provinces.length : 0);
    console.log('Users count:', loginData.users ? loginData.users.length : 0);
    
    if (loginData.provinces && loginData.provinces.length > 0) {
      console.log('First province:', loginData.provinces[0]);
      
      const firstProvince = loginData.provinces[0];
      if (loginData.districts && loginData.districts[firstProvince]) {
        console.log('Districts in first province:', loginData.districts[firstProvince]);
      }
    }
    
    if (loginData.users && loginData.users.length > 0) {
      console.log('First 3 users:', loginData.users.slice(0, 3));
    }
  } else {
    console.log('No login data loaded');
  }
}
// ===================================
// DEBUG: Test Household Data
// ===================================
function debugHouseholdData() {
  console.clear();
  console.log('='.repeat(50));
  console.log('DEBUG HOUSEHOLD DATA');
  console.log('='.repeat(50));
  
  console.log('1. householdsData exists?', householdsData !== null && householdsData !== undefined);
  console.log('2. householdsData type:', typeof householdsData);
  console.log('3. householdsData is Array?', Array.isArray(householdsData));
  console.log('4. householdsData length:', householdsData.length);
  
  if (householdsData.length > 0) {
    console.log('5. First household:');
    console.log(householdsData[0]);
    
    if (householdsData[0].members) {
      console.log('6. First household members count:', householdsData[0].members.length);
      if (householdsData[0].members.length > 0) {
        console.log('7. First member of first household:');
        console.log(householdsData[0].members[0]);
      }
    }
  } else {
    console.log('ERROR: No households in householdsData array');
    console.log('Attempting to fetch from server...');
    fetchHouseholdsData();
  }
  
  console.log('='.repeat(50));
  
  // Check IndexedDB
  loadFromIndexedDB('households', null).then(data => {
    console.log('8. Data in IndexedDB:', data ? data.length : 0);
    if (data && data.length > 0) {
      console.log('9. First household from IndexedDB:', data[0]);
    }
  });
  
  alert('‡∫Å‡∫ß‡∫î‡∫™‡∫≠‡∫ö Console (F12) ‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÄ‡∫ö‡∫¥‡ªà‡∫á‡∫ú‡∫ª‡∫ô‡∫•‡∫±‡∫ö');
}
// ===================================
// Test Server Connection
// ===================================
function testServerConnection() {
  console.log('>>> Testing server connection...');
  showLoading();
  
  // Test 1: Get sheet names
  google.script.run
    .withSuccessHandler(function(result) {
      console.log('>>> Server test result:', result);
      
      hideLoading();
      
      let message = 'üìä ‡∫ú‡∫ª‡∫ô‡∫Å‡∫≤‡∫ô‡∫ó‡∫ª‡∫î‡∫™‡∫≠‡∫ö:\n\n';
      message += '‚úÖ ‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡∫ï‡ªç‡ªà‡ªÄ‡∫ä‡∫µ‡∫ö‡ªÄ‡∫ß‡∫µ‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î\n\n';
      
      if (result.error) {
        message += '‚ùå ‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î:\n' + result.error + '\n\n';
      } else {
        if (result.householdExists) {
          message += '‚úÖ ‡∫û‡∫ª‡∫ö Sheet "‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß"\n';
          message += '   ‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡ªÅ‡∫ñ‡∫ß: ' + result.householdRows + '\n\n';
        } else {
          message += '‚ùå ‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö Sheet "‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß"\n\n';
        }
        
        if (result.memberExists) {
          message += '‚úÖ ‡∫û‡∫ª‡∫ö Sheet "‡∫™‡∫∞‡∫°‡∫≤‡∫ä‡∫¥‡∫Å‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß"\n';
          message += '   ‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡ªÅ‡∫ñ‡∫ß: ' + result.memberRows + '\n\n';
        } else {
          message += '‚ùå ‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö Sheet "‡∫™‡∫∞‡∫°‡∫≤‡∫ä‡∫¥‡∫Å‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß"\n\n';
        }
      }
      
      message += '\n‡∫Å‡∫ß‡∫î‡∫™‡∫≠‡∫ö Console (F12) ‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÄ‡∫ö‡∫¥‡ªà‡∫á‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î';
      
      alert(message);
    })
    .withFailureHandler(function(error) {
      console.error('>>> Server test failed:', error);
      hideLoading();
      
      alert('‚ùå ‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡∫ï‡ªç‡ªà‡ªÄ‡∫ä‡∫µ‡∫ö‡ªÄ‡∫ß‡∫µ‡ªÑ‡∫î‡ªâ\n\n' + error.message + '\n\n‡∫Å‡∫ß‡∫î‡∫™‡∫≠‡∫ö Console (F12) ‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÄ‡∫ö‡∫¥‡ªà‡∫á‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î');
    })
    .testDataExists();
}
// ===================================
// Edit Member Only (Highlight Mode)
// ===================================
function editMemberOnly(memberCode) {
  console.log('>>> Editing member only:', memberCode);
  
  // Find the member
  let targetHousehold = null;
  let targetMember = null;
  let memberIndex = -1;
  
  for (let household of householdsData) {
    if (household.members) {
      const index = household.members.findIndex(m => m.memberCode === memberCode);
      if (index >= 0) {
        targetHousehold = household;
        targetMember = household.members[index];
        memberIndex = index;
        break;
      }
    }
  }
  
  if (!targetMember) {
    showToast('‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫™‡∫∞‡∫°‡∫≤‡∫ä‡∫¥‡∫Å', 'error');
    return;
  }
  
  // Open form in edit mode
  document.getElementById('formTitle').textContent = '‚úèÔ∏è ‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫™‡∫∞‡∫°‡∫≤‡∫ä‡∫¥‡∫Å: ' + targetMember.name;
  document.getElementById('householdCode').value = targetHousehold.householdCode;
  
  // Fill household data (readonly)
  fillHouseholdFormReadonly(targetHousehold);
  
  // Clear members container
  const membersContainer = document.getElementById('membersContainer');
  membersContainer.innerHTML = '';
  memberCounter = 0;
  
  // Add all members
  targetHousehold.members.forEach((member, index) => {
    memberCounter++;
    const memberDiv = document.createElement('div');
    memberDiv.className = 'form-section member-section';
    memberDiv.id = `member-${memberCounter}`;
    
    // Add editing class to target member
    if (index === memberIndex) {
      memberDiv.classList.add('member-editing');
      memberDiv.setAttribute('data-editable', 'true');
    } else {
      memberDiv.setAttribute('data-editable', 'false');
    }
    
    memberDiv.innerHTML = getMemberFormHTML(memberCounter, member, index === memberIndex);
    membersContainer.appendChild(memberDiv);
  });
  
  // Scroll to editing member after modal opens
  populateDataLists();
  document.getElementById('householdFormModal').classList.add('active');
  
  setTimeout(() => {
    const editingSection = document.querySelector('.member-editing');
    if (editingSection) {
      editingSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }, 300);
}

function fillHouseholdFormReadonly(household) {
  document.getElementById('householdName').value = household.name || '';
  document.getElementById('householdName').readOnly = true;
  document.getElementById('householdPhone').value = household.phone || '';
  document.getElementById('householdPhone').readOnly = true;
  document.getElementById('houseNumber').value = household.houseNumber || '';
  document.getElementById('houseNumber').readOnly = true;
  // ... fill other fields and set readonly
  
  const photoPreview = document.getElementById('householdPhotoPreview');
  if (household.photo) {
    photoPreview.innerHTML = `<img src="${household.photo}" alt="Photo">`;
  }
  
  // Disable photo upload
  document.getElementById('householdPhoto').disabled = true;
}
// ===================================
// Image Preview
// ===================================
function showImagePreview(imageSrc) {
  if (!imageSrc) return;
  
  const modal = document.getElementById('imagePreviewModal');
  const img = document.getElementById('imagePreviewImg');
  
  img.src = imageSrc;
  modal.classList.add('active');
}

function closeImagePreview() {
  document.getElementById('imagePreviewModal').classList.remove('active');
}





// ===================================
// LOCATION PICKER - FIXED VERSION
// ===================================
let map = null;
let marker = null;
let selectedLatLng = null;
let streetLayer = null;
let satelliteLayer = null;
let currentLayer = 'satellite';

function openLocationPicker() {
  document.getElementById('locationModal').classList.add('active');
  
  // Destroy old map if exists
  if (map) {
    map.remove();
    map = null;
  }
  
  // Wait for modal to be visible
  setTimeout(() => {
    initializeMap();
  }, 300);
}
function initializeMap() {
  // Default to Vientiane, Laos
  const defaultLat = 17.9757;
  const defaultLng = 102.6331;
  
  // Get current value if exists
  const currentValue = document.getElementById('housePosition').value;
  let initialLat = defaultLat;
  let initialLng = defaultLng;
  
  if (currentValue && currentValue.includes(',')) {
    const parts = currentValue.split(',');
    initialLat = parseFloat(parts[0].trim()) || defaultLat;
    initialLng = parseFloat(parts[1].trim()) || defaultLng;
  }
  
  // Create map
  map = L.map('map', {
    center: [initialLat, initialLng],
    zoom: 15,
    preferCanvas: true
  });
  
  // Create Street Map Layer
  streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap',
    maxZoom: 19
  });
  
  // Create Satellite Layer
  satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: '¬© Esri',
    maxZoom: 19
  });
  
  // Add satellite layer as default
  satelliteLayer.addTo(map);
  
  // Create custom beautiful marker
  const beautifulIcon = createCustomMarkerIcon();
  
  // Add marker with custom icon
  marker = L.marker([initialLat, initialLng], { 
    draggable: true,
    icon: beautifulIcon
  }).addTo(map);
  
  selectedLatLng = { lat: initialLat, lng: initialLng };
  updateLocationDisplay();
  
  // Update location when marker is dragged
  marker.on('dragend', function(e) {
    const pos = marker.getLatLng();
    selectedLatLng = { lat: pos.lat, lng: pos.lng };
    updateLocationDisplay();
  });
  
  // Update location when map is clicked
  map.on('click', function(e) {
    marker.setLatLng(e.latlng);
    selectedLatLng = { lat: e.latlng.lat, lng: e.latlng.lng };
    updateLocationDisplay();
  });
  
  // Force tiles to load
  map.invalidateSize();
  
  // Try to get user location
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function(position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        map.setView([lat, lng], 17);
        marker.setLatLng([lat, lng]);
        selectedLatLng = { lat: lat, lng: lng };
        updateLocationDisplay();
        showToast('üìç ‡∫û‡∫ª‡∫ö‡∫ï‡∫≥‡ªÅ‡ªú‡ªà‡∫á‡∫õ‡∫±‡∫î‡∫à‡∫∏‡∫ö‡∫±‡∫ô‡∫Ç‡∫≠‡∫á‡∫ó‡ªà‡∫≤‡∫ô', 'success');
      },
      function(error) {
        console.log('Geolocation error:', error);
      }
    );
  }
}

function switchMapLayer(layerType) {
  if (!map) return;
  
  // Remove all layers
  if (streetLayer && map.hasLayer(streetLayer)) {
    map.removeLayer(streetLayer);
  }
  if (satelliteLayer && map.hasLayer(satelliteLayer)) {
    map.removeLayer(satelliteLayer);
  }
  
  // Add selected layer
  if (layerType === 'street') {
    streetLayer.addTo(map);
    currentLayer = 'street';
  } else {
    satelliteLayer.addTo(map);
    currentLayer = 'satellite';
  }
  
  // Update button states
  document.getElementById('btnStreetMap').classList.toggle('active', layerType === 'street');
  document.getElementById('btnSatellite').classList.toggle('active', layerType === 'satellite');
  
  // Force redraw
  setTimeout(() => {
    map.invalidateSize();
  }, 100);
}

function updateLocationDisplay() {
  if (selectedLatLng) {
    const lat = selectedLatLng.lat.toFixed(6);
    const lng = selectedLatLng.lng.toFixed(6);
    document.getElementById('selectedLocation').innerHTML = `
      <strong>Latitude:</strong> ${lat}<br>
      <strong>Longitude:</strong> ${lng}
    `;
  }
}

function confirmLocation() {
  if (selectedLatLng) {
    const lat = selectedLatLng.lat.toFixed(6);
    const lng = selectedLatLng.lng.toFixed(6);
    document.getElementById('housePosition').value = `${lat}, ${lng}`;
    showToast('‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫ï‡ªç‡∫≤‡ªÅ‡ªú‡ªà‡∫á‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î ‚úÖ', 'success');
  }
  closeLocationPicker();
}

function closeLocationPicker() {
  document.getElementById('locationModal').classList.remove('active');
  if (map) {
    setTimeout(() => {
      map.remove();
      map = null;
    }, 300);
  }
}
// ===================================
// AUTO-CALCULATE FAMILY COUNTERS
// ===================================
function updateFamilyCounters() {
  const memberForms = document.querySelectorAll('#membersContainer .member-section');
  const totalMembers = memberForms.length;
  
  // ‡∏ô‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà "‡∫°‡∫µ‡ªú‡ªâ‡∫≤‡ªÉ‡∫ô‡∫™‡ªç‡∫≤‡∫°‡∫∞‡ªÇ‡∫ô‡∫Ñ‡∫ª‡∫ß" = "‡∫°‡∫µ‡ªú‡ªâ‡∫≤"
  let membersWithRegistry = 0;
  
  memberForms.forEach(form => {
    const inRegistryInput = form.querySelector('.memberInRegistry');
    if (inRegistryInput) {
      const value = inRegistryInput.value.trim();
      if (value === '‡∫°‡∫µ‡ªú‡ªâ‡∫≤') {
        membersWithRegistry++;
      }
    }
  });
  
  // Update displays
  const familyMemberCountField = document.getElementById('familyMemberCount');
  const pageCountField = document.getElementById('pageCount');
  
  if (familyMemberCountField) {
    familyMemberCountField.value = totalMembers;
  }
  
  if (pageCountField) {
    pageCountField.value = membersWithRegistry;
  }
  
  console.log('‚úÖ Real-Time Update - Total:', totalMembers, '‡∏°‡∏µ‡ªú‡ªâ‡∫≤:', membersWithRegistry);
}

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Real-Time Listener (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error)
let realTimeListenersAdded = false; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ã‡πâ‡∏≥

function addRealTimeCounterListeners() {
  if (realTimeListenersAdded) {
    console.log('‚ö†Ô∏è Real-time listeners already added');
    return;
  }
  
  console.log('‚úÖ Adding real-time counter listeners...');
  
  // ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
  document.addEventListener('change', function(e) {
    try {
      if (e.target && e.target.classList && e.target.classList.contains('memberInRegistry')) {
        updateFamilyCounters();
      }
    } catch (error) {
      console.error('‚ùå Change event error:', error);
    }
  }, { passive: true });
  
  document.addEventListener('input', function(e) {
    try {
      if (e.target && e.target.classList && e.target.classList.contains('memberInRegistry')) {
        updateFamilyCounters();
      }
    } catch (error) {
      console.error('‚ùå Input event error:', error);
    }
  }, { passive: true });
  
  realTimeListenersAdded = true;
  console.log('‚úÖ Real-time listeners added successfully');
}

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
// ‚úÖ ‡πÉ‡∏ä‡πâ window.onload ‡πÅ‡∏ó‡∏ô DOMContentLoaded (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤)
window.addEventListener('load', function() {
  console.log('‚úÖ Page fully loaded');
  
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
  if (typeof addRealTimeCounterListeners === 'function') {
    addRealTimeCounterListeners();
  }
  
  if (typeof initializeMultiSelect === 'function') {
    initializeMultiSelect();
  }
});

function addRegistryChangeListeners() {
  const inRegistryInputs = document.querySelectorAll('.memberInRegistry');
  inRegistryInputs.forEach(input => {
    input.removeEventListener('change', updateFamilyCounters);
    input.removeEventListener('input', updateFamilyCounters);
    input.addEventListener('change', updateFamilyCounters);
    input.addEventListener('input', updateFamilyCounters);
  });
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
  updateFamilyCounters();
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡πâ‡∏≠ 6)
function checkRelationshipAndCopyPhoto(counterId) {
  const relationshipSelect = document.querySelector(`#member-${counterId} .relationship`);
  if (!relationshipSelect) return;
  
  const relationship = relationshipSelect.value;
  
  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô "‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß" ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏•‡∏±‡∏Å
  if (relationship === "‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß") {
    const householdPhoto = document.getElementById("householdPhotoPreview");
    const memberPhotoPreview = document.getElementById(`memberPhotoPreview-${counterId}`);
    
    if (householdPhoto && memberPhotoPreview) {
      const img = householdPhoto.querySelector("img");
      if (img && img.src && img.src !== "") {
        // ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß
        memberPhotoPreview.innerHTML = `<img src="${img.src}" alt="Member Photo">`;
        memberPhotoPreview.classList.add("has-image");
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL ‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥
        memberPhotoPreview.setAttribute("data-photo-url", img.src);
        memberPhotoPreview.setAttribute("data-is-head-photo", "true");
        
        showToast("‡ªÉ‡∫ä‡ªâ‡∫Æ‡∫π‡∫ö‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß‡ªÅ‡∫ö‡∫ö‡∫≠‡∫±‡∫î‡∫ï‡∫∞‡ªÇ‡∫ô‡∫°‡∫±‡∫î", "success");
      }
    }
  }
}

// ===================================
// IMAGE CROP & ROTATE FUNCTIONS
// ===================================
let scaleX = 1;
let scaleY = 1;

function openCropModal(file, previewId) {
  if (!file || !file.type.startsWith('image/')) {
    showToast('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÑ‡∫ü‡∫•‡πå‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö', 'error');
    return;
  }
  
  currentCropPreviewId = previewId;
  const reader = new FileReader();
  
  reader.onload = function(e) {
    const cropImage = document.getElementById('cropImage');
    cropImage.src = e.target.result;
    
    // Destroy previous cropper if exists
    if (cropper) {
      cropper.destroy();
    }
    
    // Initialize Cropper.js
    cropper = new Cropper(cropImage, {
      aspectRatio: 1, // Default 1:1
      viewMode: 2,
      dragMode: 'move',
      autoCropArea: 0.8,
      restore: false,
      guides: true,
      center: true,
      highlight: false,
      cropBoxMovable: true,
      cropBoxResizable: true,
      toggleDragModeOnDblclick: false,
      background: false,
      responsive: true,
      checkOrientation: true
    });
    
    // Reset scales
    scaleX = 1;
    scaleY = 1;
    
    // Show modal
    document.getElementById('cropModal').classList.add('active');
  };
  
  reader.readAsDataURL(file);
}

function setAspectRatio(ratio) {
  if (cropper) {
    cropper.setAspectRatio(ratio);
  }
  
  // Update active button
  document.querySelectorAll('.aspect-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
}

function rotateCropImage(degree) {
  if (cropper) {
    cropper.rotate(degree);
  }
}

function flipCropImage(direction) {
  if (cropper) {
    if (direction === 'horizontal') {
      scaleX = -scaleX;
      cropper.scaleX(scaleX);
    } else {
      scaleY = -scaleY;
      cropper.scaleY(scaleY);
    }
  }
}

function zoomCropImage(ratio) {
  if (cropper) {
    cropper.zoom(ratio);
  }
}

function resetCrop() {
  if (cropper) {
    cropper.reset();
    scaleX = 1;
    scaleY = 1;
  }
}
// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global
let householdPhotoData = null;

// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô previewPhoto ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ
function previewPhoto(input, previewId) {
  const file = input.files[0];
  if (!file) return;
  
  if (!file.type.startsWith('image/')) {
    showToast('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÑ‡∫ü‡∫•‡ªå‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö', 'error');
    return;
  }
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const isHouseholdPhoto = previewId === 'householdPhotoPreview';
  
  // ‡πÄ‡∏Å‡πá‡∏ö previewId ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô global
  currentCropPreviewId = previewId;
  
  // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î Crop Modal
  const reader = new FileReader();
  reader.onload = function(e) {
    const cropImage = document.getElementById('cropImage');
    cropImage.src = e.target.result;
    
   // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô global variable
if (isHouseholdPhoto) {
  householdPhotoData = e.target.result;
  
  // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  setTimeout(() => {
    updateHouseholdHeadPhotos(e.target.result);
  }, 100);
}
    
    // Destroy previous cropper if exists
    if (cropper) {
      cropper.destroy();
    }
    
    // Initialize Cropper.js
    cropper = new Cropper(cropImage, {
      aspectRatio: 1,
      viewMode: 2,
      dragMode: 'move',
      autoCropArea: 0.8,
      restore: false,
      guides: true,
      center: true,
      highlight: false,
      cropBoxMovable: true,
      cropBoxResizable: true,
      toggleDragModeOnDblclick: false,
      background: false,
      responsive: true,
      checkOrientation: true
    });
    
    // Reset scales
    scaleX = 1;
    scaleY = 1;
    
    // Show modal
    document.getElementById('cropModal').classList.add('active');
  };
  
  reader.readAsDataURL(file);
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß
function updateHouseholdHeadPhotos(photoUrl) {
  const container = document.getElementById('membersContainer');
  if (!container) return;
  
  const memberDivs = container.querySelectorAll('.member-section');
  
  memberDivs.forEach(div => {
    const relationshipInput = div.querySelector('.memberRelationship');
    
    if (relationshipInput && relationshipInput.value === '‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß') {
      const photoPreview = div.querySelector('.photo-preview');
      if (photoPreview) {
        photoPreview.innerHTML = `<img src="${photoUrl}" alt="Photo" style="width: 100%; height: 100%; object-fit: cover;">`;
        photoPreview.setAttribute('data-is-household-photo', 'true');
        photoPreview.setAttribute('data-household-photo-url', photoUrl);
        
        console.log('‚úÖ Auto-updated household head photo (same URL)');
      }
    }
  });
}
// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô confirmCrop ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ
function confirmCrop() {
  if (!cropper || !currentCropPreviewId) return;
  
  const canvas = cropper.getCroppedCanvas({
    width: 800,
    height: 800,
    imageSmoothingEnabled: true,
    imageSmoothingQuality: 'high'
  });
  
  const croppedImage = canvas.toDataURL('image/png');
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
  const preview = document.getElementById(currentCropPreviewId);
  if (preview) {
    preview.innerHTML = `<img src="${croppedImage}" alt="Photo">`;
  }
  
 // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß
if (currentCropPreviewId === 'householdPhotoPreview') {
  householdPhotoData = croppedImage;
  
  // ‚úÖ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß (‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
  setTimeout(() => {
    updateHouseholdHeadPhotos(croppedImage);
  }, 100);
}
  
  closeCropModal();
  showToast('‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫Æ‡∫π‡∫ö‡∫û‡∫≤‡∫ö‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î', 'success');
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏£‡∏π‡∏õ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô confirmCrop)
function syncHouseholdPhotoToMembers(photoData) {
  const container = document.getElementById('membersContainer');
  const memberDivs = container.querySelectorAll('.member-section');
  
  memberDivs.forEach(div => {
    const relationshipInput = div.querySelector('.memberRelationship');
    
    if (relationshipInput && (relationshipInput.value === '‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß' || relationshipInput.value === '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß')) {
      const photoPreview = div.querySelector('.photo-preview');
      if (photoPreview) {
        photoPreview.innerHTML = `<img src="${photoData}" alt="Photo">`;
      }
    }
  });
}
// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô handleRelationshipChange ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ
function handleRelationshipChange(input, memberId) {
  if (!input) return;
  
  const selectedValue = input.value.trim();
  const photoWrapper = document.getElementById(`photoWrapper${memberId}`);
  const photoNotice = document.getElementById(`photoNotice${memberId}`);
  const photoPreview = document.getElementById(`memberPhotoPreview${memberId}`);
  const photoInput = document.getElementById(`memberPhoto${memberId}`);
  
  console.log('=== Relationship Change ===');
  console.log('Selected value:', selectedValue);
  console.log('Member ID:', memberId);
  
  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∞‡πÑ‡∏£ - ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
  if (!selectedValue || selectedValue === '') {
    if (photoWrapper) photoWrapper.classList.remove('show');
    if (photoNotice) photoNotice.classList.remove('hidden');
    return;
  }
  
  // ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß - ‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
  if (photoWrapper) photoWrapper.classList.add('show');
  if (photoNotice) photoNotice.classList.add('hidden');
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô "‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const isHouseholdHead = (selectedValue === '‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß');
  
  console.log('Is household head:', isHouseholdHead);
  
  if (isHouseholdHead) {
    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß - ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    console.log('>>> Trying to get household photo...');
    
    const householdPhotoPreview = document.getElementById('householdPhotoPreview');
    console.log('Household photo preview element:', householdPhotoPreview);
    
    if (householdPhotoPreview) {
      const householdImg = householdPhotoPreview.querySelector('img');
      console.log('Household img element:', householdImg);
      console.log('Household img src:', householdImg ? householdImg.src : 'No img');
      
      if (householdImg && householdImg.src && 
          (householdImg.src.startsWith('data:image') || householdImg.src.startsWith('https://'))) {
        // ‡∏°‡∏µ‡∏£‡∏π‡∏õ - ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
        console.log('‚úÖ Using same photo (same URL, no duplicate)...');
        
        if (photoPreview) {
          // ‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
          photoPreview.innerHTML = `<img src="${householdImg.src}" alt="Photo" style="width: 100%; height: 100%; object-fit: cover;">`;
          
          // **‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç!** ‡πÄ‡∏Å‡πá‡∏ö flag ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß
          photoPreview.setAttribute('data-is-household-photo', 'true');
          photoPreview.setAttribute('data-household-photo-url', householdImg.src);
        }
        
        // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
        if (photoInput) {
          photoInput.disabled = true;
          photoInput.value = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ input
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        const memberDiv = document.getElementById(`member-${memberId}`);
        if (memberDiv) {
          const photoUploadDiv = memberDiv.querySelector('.photo-upload');
          if (photoUploadDiv) {
            photoUploadDiv.style.cursor = 'not-allowed';
            photoUploadDiv.style.opacity = '0.7';
            photoUploadDiv.onclick = null; // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å
            
            // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô
            const oldNotice = photoUploadDiv.querySelector('.head-notice');
            if (oldNotice) oldNotice.remove();
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà
            const noticeDiv = document.createElement('p');
            noticeDiv.className = 'head-notice';
            noticeDiv.style.cssText = 'background: #fff3cd; color: #856404; padding: 8px; border-radius: 5px; margin-top: 8px; font-size: 12px; text-align: center; border: 2px solid #ffc107;';
            noticeDiv.innerHTML = 'üîí ‡ªÉ‡∫ä‡ªâ‡∫Æ‡∫π‡∫ö‡∫à‡∫≤‡∫Å‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß (‡∫•‡∫¥‡∫á‡∫Ñ‡πå‡ªÄ‡∫î‡∫Ω‡∫ß‡∫Å‡∫±‡∫ô)<br><small>‡∫ö‡ªç‡ªà‡∫≠‡∫±‡∫ö‡ªÇ‡∫´‡∫•‡∫î‡∫ä‡ªâ‡∫≥ - ‡∫õ‡∫∞‡∫´‡∫ç‡∫±‡∫î‡∫û‡∫∑‡ªâ‡∫ô‡∫ó‡∫µ‡ªà</small>';
            photoUploadDiv.appendChild(noticeDiv);
          }
        }
        
        showToast('‚úÖ ‡ªÉ‡∫ä‡ªâ‡∫Æ‡∫π‡∫ö‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß (‡∫•‡∫¥‡∫á‡∫Ñ‡πå‡ªÄ‡∫î‡∫Ω‡∫ß‡∫Å‡∫±‡∫ô)', 'success');
        
      } else {
        // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ
        console.log('‚ùå No household photo yet');
        showToast('‚ö†Ô∏è ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫≠‡∫±‡∫ö‡ªÇ‡∫´‡∫•‡∫î‡∫Æ‡∫π‡∫ö‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß‡∫Å‡ªà‡∫≠‡∫ô', 'error');
        
        if (photoPreview) {
          photoPreview.innerHTML = '<div class="placeholder" style="font-size: 60px; color: #ccc;">‚ùì</div>';
          photoPreview.removeAttribute('data-is-household-photo');
          photoPreview.removeAttribute('data-household-photo-url');
        }
        
        // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î
        if (photoInput) {
          photoInput.disabled = true;
        }
      }
      
    } else {
      console.log('‚ùå Cannot find household photo preview element');
      showToast('‚ùå ‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫™‡ªà‡∫ß‡∫ô‡∫Æ‡∫π‡∫ö‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß', 'error');
    }
    
  } else {
    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß - ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ
    console.log('>>> Not household head - enable photo upload');
    
    // ‡∏•‡∏ö flag
    if (photoPreview) {
      photoPreview.removeAttribute('data-is-household-photo');
      photoPreview.removeAttribute('data-household-photo-url');
    }
    
    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î
    if (photoInput) {
      photoInput.disabled = false;
    }
    
    // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    const memberDiv = document.getElementById(`member-${memberId}`);
    if (memberDiv) {
      const photoUploadDiv = memberDiv.querySelector('.photo-upload');
      if (photoUploadDiv) {
        photoUploadDiv.style.cursor = 'pointer';
        photoUploadDiv.style.opacity = '1';
        photoUploadDiv.onclick = function() {
          document.getElementById(`memberPhoto${memberId}`).click();
        };
        
        const oldNotice = photoUploadDiv.querySelector('.head-notice');
        if (oldNotice) oldNotice.remove();
      }
    }
  }
}

function closeCropModal() {
  document.getElementById('cropModal').classList.remove('active');
  if (cropper) {
    cropper.destroy();
    cropper = null;
  }
}

// Function to check relationship input
function checkRelationshipInput(memberCounter) {
  const memberForm = document.getElementById(`member-${memberCounter}`);
  if (!memberForm) return;
  
  const relationshipInput = memberForm.querySelector('.relationship');
  const photoWrapper = document.getElementById(`photoWrapper${memberCounter}`);
  const photoNotice = document.getElementById(`photoNotice${memberCounter}`);
  
  if (!relationshipInput || !photoWrapper || !photoNotice) return;
  
  const hasRelationship = relationshipInput.value.trim() !== '';
  
  if (hasRelationship) {
    // Show photo upload
    photoWrapper.classList.add('show');
    photoNotice.classList.add('hidden');
  } else {
    // Hide photo upload
    photoWrapper.classList.remove('show');
    photoNotice.classList.remove('hidden');
  }
}

// ‚úÖ FIXED: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ß‡∏û‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß"
function handleRelationshipChange_ClearPhoto(memberId) {
  const memberDiv = document.getElementById(`member-${memberId}`);
  if (!memberDiv) return;
  
  const relationshipInput = memberDiv.querySelector('.memberRelationship');
  if (!relationshipInput) return;
  
  const selectedValue = relationshipInput.value.trim();
  const photoPreview = document.getElementById(`memberPhotoPreview${memberId}`);
  const photoInput = document.getElementById(`memberPhoto${memberId}`);
  
  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß" ‚Üí ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πà‡∏≤
  if (selectedValue !== '‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß') {
    // ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πà‡∏≤
    if (photoPreview) {
      photoPreview.innerHTML = '<div class="placeholder" style="font-size: 60px; color: #ccc;">üì∑</div>';
      // ‡∏•‡∏ö flag
      photoPreview.removeAttribute('data-is-household-photo');
      photoPreview.removeAttribute('data-household-photo-url');
    }
    
    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î
    if (photoInput) {
      photoInput.disabled = false;
      photoInput.value = ''; // ‡∏•‡πâ‡∏≤‡∏á input
    }
    
    // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "üîí"
    if (memberDiv) {
      const headNotice = memberDiv.querySelector('.head-notice');
      if (headNotice) {
        headNotice.remove();
      }
      const photoUploadDiv = memberDiv.querySelector('.photo-upload');
      if (photoUploadDiv) {
        photoUploadDiv.style.opacity = '1';
        photoUploadDiv.style.cursor = 'pointer';
        photoUploadDiv.onclick = function() {
          document.getElementById(`memberPhoto${memberId}`).click();
        };
      }
    }
  }
}

// Initialize photo visibility when editing existing members
function initializePhotoVisibility() {
  const memberForms = document.querySelectorAll('.member-section');
  memberForms.forEach((form, index) => {
    const counter = index + 1;
    checkRelationshipInput(counter);
  });
}
// ===================================
// REGISTRY MANAGEMENT
// ===================================
function openRegistryModal() {
  // Reset registry data completely (FIX 2)
  registryData = {
    old: { enabled: false, count: 0, numbers: [], dates: [] },
    new: { enabled: false, count: 0, numbers: [], dates: [] },
    none: false
  };
  
  // Reset UI
  document.getElementById('chkOldRegistry').checked = false;
  document.getElementById('chkNewRegistry').checked = false;
  document.getElementById('chkNoRegistry').checked = false;
  document.getElementById('oldRegistryCount').value = 0;
  document.getElementById('newRegistryCount').value = 0;
  document.getElementById('oldRegistryNumbers').innerHTML = '';
  document.getElementById('newRegistryNumbers').innerHTML = '';
  document.getElementById('oldRegistryOption').classList.remove('selected');
  document.getElementById('newRegistryOption').classList.remove('selected');
  document.getElementById('noRegistryOption').classList.remove('selected');
  document.getElementById('oldRegistryDetails').classList.remove('active');
  document.getElementById('newRegistryDetails').classList.remove('active');
  
  // Load existing data if editing
  loadExistingRegistryData();
  
  updateRegistrySummary();
  document.getElementById('registryModal').classList.add('active');
}

function closeRegistryModal() {
  document.getElementById('registryModal').classList.remove('active');
}

function loadExistingRegistryData() {
  // Load from form if exists
  const bookCount = parseInt(document.getElementById('registryBookCount').value) || 0;
  const registryNumber = document.getElementById('registryNumber').value;
  
  if (bookCount > 0 && registryNumber) {
    // Parse existing data
    const parts = registryNumber.split('|');
    
    // Parse old registry
    if (parts.length >= 1 && parts[0].includes(':')) {
      const oldPart = parts[0].split(':')[1].trim();
      if (oldPart) {
        const oldItems = oldPart.split(',').map(n => n.trim()).filter(n => n);
        const oldNumbers = [];
        const oldDates = [];
        
        oldItems.forEach(item => {
          const itemParts = item.split(' (');
          oldNumbers.push(itemParts[0]);
          if (itemParts[1]) {
            oldDates.push(itemParts[1].replace(')', ''));
          } else {
            oldDates.push('');
          }
        });
        
        registryData.old.enabled = true;
        registryData.old.count = oldNumbers.length;
        registryData.old.numbers = oldNumbers;
        registryData.old.dates = oldDates;
        
        document.getElementById('chkOldRegistry').checked = true;
        document.getElementById('oldRegistryCount').value = oldNumbers.length;
        updateOldRegistryNumbers();
        toggleRegistryOption('old');
      }
    }
    
    // Parse new registry
    if (parts.length >= 2 && parts[1].includes(':')) {
      const newPart = parts[1].split(':')[1].trim();
      if (newPart) {
        const newItems = newPart.split(',').map(n => n.trim()).filter(n => n);
        const newNumbers = [];
        const newDates = [];
        
        newItems.forEach(item => {
          const itemParts = item.split(' (');
          newNumbers.push(itemParts[0]);
          if (itemParts[1]) {
            newDates.push(itemParts[1].replace(')', ''));
          } else {
            newDates.push('');
          }
        });
        
        registryData.new.enabled = true;
        registryData.new.count = newNumbers.length;
        registryData.new.numbers = newNumbers;
        registryData.new.dates = newDates;
        
        document.getElementById('chkNewRegistry').checked = true;
        document.getElementById('newRegistryCount').value = newNumbers.length;
        updateNewRegistryNumbers();
        toggleRegistryOption('new');
      }
    }
  }
  
  updateRegistrySummary();
}

function toggleRegistryOption(type) {
  const checkbox = document.getElementById(`chk${type === 'old' ? 'Old' : type === 'new' ? 'New' : 'No'}Registry`);
  const details = document.getElementById(`${type}RegistryDetails`);
  const option = document.getElementById(`${type}RegistryOption`);
  
  if (type === 'none') {
    registryData.none = checkbox.checked;
    if (checkbox.checked) {
      option.classList.add('selected');
      // Uncheck other options
      document.getElementById('chkOldRegistry').checked = false;
      document.getElementById('chkNewRegistry').checked = false;
      registryData.old.enabled = false;
      registryData.new.enabled = false;
      document.getElementById('oldRegistryOption').classList.remove('selected');
      document.getElementById('newRegistryOption').classList.remove('selected');
      document.getElementById('oldRegistryDetails').classList.remove('active');
      document.getElementById('newRegistryDetails').classList.remove('active');
    } else {
      option.classList.remove('selected');
    }
  } else {
    const enabled = checkbox.checked;
    registryData[type].enabled = enabled;
    
    if (enabled) {
      option.classList.add('selected');
      details.classList.add('active');
      // Uncheck "none"
      document.getElementById('chkNoRegistry').checked = false;
      registryData.none = false;
      document.getElementById('noRegistryOption').classList.remove('selected');
    } else {
      option.classList.remove('selected');
      details.classList.remove('active');
      registryData[type].count = 0;
      registryData[type].numbers = [];
    }
  }
  
  updateRegistrySummary();
}

function updateOldRegistryNumbers() {
  const count = parseInt(document.getElementById('oldRegistryCount').value) || 0;
  const container = document.getElementById('oldRegistryNumbers');
  
  registryData.old.count = count;
  container.innerHTML = '';
  
  for (let i = 0; i < count; i++) {
    const existingNumber = registryData.old.numbers[i] || '';
    const existingDate = registryData.old.dates[i] || '';
    const dateParts = existingDate.split('/');
    
    const item = document.createElement('div');
    item.className = 'registry-number-item';
    item.innerHTML = `
      <label>‡∫õ‡∫∑‡ªâ‡∫°‡∫ó‡∫µ‡ªà ${i + 1}:</label>
      <div class="registry-input-group">
        <input type="text" 
               class="number-input"
               placeholder="‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ‡∫™‡ªç‡∫≤‡∫°‡∫∞‡ªÇ‡∫ô‡∫Ñ‡∫ª‡∫ß‡ªÄ‡∫Å‡∫ª‡ªà‡∫≤" 
               value="${existingNumber}"
               oninput="updateOldRegistryNumber(${i}, this.value)">
        <div class="date-inputs">
          <span>‡∫ß‡∫±‡∫ô‡∫ó‡∫µ‡ªà:</span>
          <input type="number" 
                 placeholder="‡∫ß" 
                 min="1" max="31"
                 value="${dateParts[0] || ''}"
                 oninput="updateOldRegistryDate(${i}, 'day', this.value)">
          <span>/</span>
          <input type="number" 
                 placeholder="‡∫î" 
                 min="1" max="12"
                 value="${dateParts[1] || ''}"
                 oninput="updateOldRegistryDate(${i}, 'month', this.value)">
          <span>/</span>
          <input type="number" 
                 placeholder="‡∫õ‡∫µ" 
                 min="1900" max="2100"
                 value="${dateParts[2] || ''}"
                 oninput="updateOldRegistryDate(${i}, 'year', this.value)">
        </div>
      </div>
    `;
    container.appendChild(item);
  }
  
  updateRegistrySummary();
}


function updateNewRegistryNumbers() {
  const count = parseInt(document.getElementById('newRegistryCount').value) || 0;
  const container = document.getElementById('newRegistryNumbers');
  
  registryData.new.count = count;
  container.innerHTML = '';
  
  for (let i = 0; i < count; i++) {
    const existingNumber = registryData.new.numbers[i] || '';
    const existingDate = registryData.new.dates[i] || '';
    const dateParts = existingDate.split('/');
    
    const item = document.createElement('div');
    item.className = 'registry-number-item';
    item.innerHTML = `
      <label>‡∫õ‡∫∑‡ªâ‡∫°‡∫ó‡∫µ‡ªà ${i + 1}:</label>
      <div class="registry-input-group">
        <input type="text" 
               class="number-input"
               placeholder="‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ‡∫™‡ªç‡∫≤‡∫°‡∫∞‡ªÇ‡∫ô‡∫Ñ‡∫ª‡∫ß‡ªÉ‡ªù‡ªà" 
               value="${existingNumber}"
               oninput="updateNewRegistryNumber(${i}, this.value)">
        <div class="date-inputs">
          <span>‡∫ß‡∫±‡∫ô‡∫ó‡∫µ‡ªà:</span>
          <input type="number" 
                 placeholder="‡∫ß" 
                 min="1" max="31"
                 value="${dateParts[0] || ''}"
                 oninput="updateNewRegistryDate(${i}, 'day', this.value)">
          <span>/</span>
          <input type="number" 
                 placeholder="‡∫î" 
                 min="1" max="12"
                 value="${dateParts[1] || ''}"
                 oninput="updateNewRegistryDate(${i}, 'month', this.value)">
          <span>/</span>
          <input type="number" 
                 placeholder="‡∫õ‡∫µ" 
                 min="1900" max="2100"
                 value="${dateParts[2] || ''}"
                 oninput="updateNewRegistryDate(${i}, 'year', this.value)">
        </div>
      </div>
    `;
    container.appendChild(item);
  }
  
  updateRegistrySummary();
}

function updateOldRegistryNumber(index, value) {
  if (!registryData.old.numbers) registryData.old.numbers = [];
  registryData.old.numbers[index] = value;
}

function updateNewRegistryNumber(index, value) {
  if (!registryData.new.numbers) registryData.new.numbers = [];
  registryData.new.numbers[index] = value;
}
function updateOldRegistryDate(index, type, value) {
  if (!registryData.old.dates) registryData.old.dates = [];
  if (!registryData.old.dates[index]) registryData.old.dates[index] = '';
  
  const parts = registryData.old.dates[index].split('/');
  const day = parts[0] || '';
  const month = parts[1] || '';
  const year = parts[2] || '';
  
  if (type === 'day') parts[0] = value;
  if (type === 'month') parts[1] = value;
  if (type === 'year') parts[2] = value;
  
  registryData.old.dates[index] = parts.join('/');
}
function updateNewRegistryDate(index, type, value) {
  if (!registryData.new.dates) registryData.new.dates = [];
  if (!registryData.new.dates[index]) registryData.new.dates[index] = '';
  
  const parts = registryData.new.dates[index].split('/');
  const day = parts[0] || '';
  const month = parts[1] || '';
  const year = parts[2] || '';
  
  if (type === 'day') parts[0] = value;
  if (type === 'month') parts[1] = value;
  if (type === 'year') parts[2] = value;
  
  registryData.new.dates[index] = parts.join('/');
}

function updateRegistrySummary() {
  const oldCount = registryData.old.enabled ? registryData.old.count : 0;
  const newCount = registryData.new.enabled ? registryData.new.count : 0;
  const totalCount = oldCount + newCount;
  
  document.getElementById('summaryOldCount').textContent = oldCount + ' ‡∫õ‡∫∑‡ªâ‡∫°';
  document.getElementById('summaryNewCount').textContent = newCount + ' ‡∫õ‡∫∑‡ªâ‡∫°';
  document.getElementById('summaryTotalCount').textContent = totalCount + ' ‡∫õ‡∫∑‡ªâ‡∫°';
}

function confirmRegistry() {
  // Collect all registry numbers with dates
  const oldItems = [];
  const newItems = [];
  
  if (registryData.old.enabled) {
    for (let i = 0; i < registryData.old.count; i++) {
      const number = registryData.old.numbers[i] || '';
      const date = registryData.old.dates[i] || '';
      if (number.trim()) {
        if (date && date !== '//') {
          oldItems.push(`${number.trim()} (${date})`);
        } else {
          oldItems.push(number.trim());
        }
      }
    }
  }
  
  if (registryData.new.enabled) {
    for (let i = 0; i < registryData.new.count; i++) {
      const number = registryData.new.numbers[i] || '';
      const date = registryData.new.dates[i] || '';
      if (number.trim()) {
        if (date && date !== '//') {
          newItems.push(`${number.trim()} (${date})`);
        } else {
          newItems.push(number.trim());
        }
      }
    }
  }
  
  // Calculate total
  const totalBooks = oldItems.length + newItems.length;
  
  // Format registry number string
  let registryNumberText = '';
  if (oldItems.length > 0) {
    registryNumberText += '‡ªÄ‡∫Å‡∫ª‡ªà‡∫≤: ' + oldItems.join(', ');
  }
  if (newItems.length > 0) {
    if (registryNumberText) registryNumberText += ' | ';
    registryNumberText += '‡ªÉ‡ªù‡ªà: ' + newItems.join(', ');
  }
  
  // Update form fields
  document.getElementById('registryBookCount').value = totalBooks;
  document.getElementById('registryNumber').value = registryNumberText;
  
  // Show success message
  showToast(`‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î: ${totalBooks} ‡∫õ‡∫∑‡ªâ‡∫°`, 'success');
  
  closeRegistryModal();
}
// Variable for accuracy circle
let accuracyCircle = null;

// Function to go to current location
function goToMyLocation() {
  if (!navigator.geolocation) {
    showToast('‡∫ö‡∫£‡∫≤‡∫ß‡ªÄ‡∫ä‡∫µ‡∫ö‡ªç‡ªà‡∫Æ‡∫≠‡∫á‡∫Æ‡∫±‡∫ö‡∫Å‡∫≤‡∫ô‡∫ä‡∫≠‡∫Å‡∫´‡∫≤‡∫ï‡∫≥‡ªÅ‡ªú‡ªà‡∫á', 'error');
    return;
  }
  
  showToast('‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫ä‡∫≠‡∫Å‡∫´‡∫≤‡∫ï‡∫≥‡ªÅ‡ªú‡ªà‡∫á...', 'success');
  
  navigator.geolocation.getCurrentPosition(
    function(position) {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      const accuracy = position.coords.accuracy;
      
      // Move map and marker
      map.setView([lat, lng], 18);
      marker.setLatLng([lat, lng]);
      selectedLatLng = { lat: lat, lng: lng };
      updateLocationDisplay();
      
      // Remove old accuracy circle if exists
      if (accuracyCircle) {
        map.removeLayer(accuracyCircle);
      }
      
      // Add accuracy circle
      accuracyCircle = L.circle([lat, lng], {
        radius: accuracy,
        color: '#4285F4',
        fillColor: '#4285F4',
        fillOpacity: 0.15,
        weight: 2
      }).addTo(map);
      
      // Show accuracy info
      showToast(`üìç ‡∫û‡∫ª‡∫ö‡∫ï‡∫≥‡ªÅ‡ªú‡ªà‡∫á! ‡∫Ñ‡∫ß‡∫≤‡∫°‡ªÅ‡∫°‡ªà‡∫ô‡∫ç‡∫≥: ${Math.round(accuracy)} ‡ªÅ‡∫°‡∫±‡∫î`, 'success');
      
      // Bind popup to marker
      marker.bindPopup(`
        <div style="text-align: center;">
          <b>‡∫ï‡∫≥‡ªÅ‡ªú‡ªà‡∫á‡∫õ‡∫±‡∫î‡∫à‡∫∏‡∫ö‡∫±‡∫ô‡∫Ç‡∫≠‡∫á‡∫ó‡ªà‡∫≤‡∫ô</b><br>
          ‡∫Ñ‡∫ß‡∫≤‡∫°‡ªÅ‡∫°‡ªà‡∫ô‡∫ç‡∫≥: ${Math.round(accuracy)} ‡ªÅ‡∫°‡∫±‡∫î<br>
          <small>‡∫ß‡∫ª‡∫á‡∫™‡∫µ‡∫ü‡ªâ‡∫≤ = ‡∫Ç‡∫≠‡∫ö‡ªÄ‡∫Ç‡∫î‡∫Ñ‡∫ß‡∫≤‡∫°‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î</small>
        </div>
      `).openPopup();
    },
    function(error) {
      showToast('‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡∫ä‡∫≠‡∫Å‡∫´‡∫≤‡∫ï‡∫≥‡ªÅ‡ªú‡ªà‡∫á‡ªÑ‡∫î‡ªâ: ' + error.message, 'error');
    },
    {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    }
  );
}

// Update marker dragging to remove accuracy circle
marker.on('dragstart', function() {
  if (accuracyCircle) {
    map.removeLayer(accuracyCircle);
    accuracyCircle = null;
  }
});
// Village Participation Functions
var selectedParticipation = null;

function openParticipationModal() {
  document.getElementById('participationModal').classList.add('active');
  
  // Reset selection
  selectedParticipation = null;
  document.querySelectorAll('.participation-option').forEach(function(el) {
    el.classList.remove('selected');
  });
  document.querySelectorAll('.participation-option input[type="radio"]').forEach(function(el) {
    el.checked = false;
  });
  document.getElementById('confirmParticipationBtn').disabled = true;
  
  // Check if there's existing value
  const currentValue = document.getElementById('villageParticipation').value;
  if (currentValue) {
    selectParticipation(currentValue);
  }
}

function closeParticipationModal() {
  document.getElementById('participationModal').classList.remove('active');
}

function selectParticipation(value) {
  // Set global variable
  window.selectedParticipation = value;
  
  // Update UI
  document.querySelectorAll('.participation-option').forEach(function(el) {
    el.classList.remove('selected');
    if (el.getAttribute('data-value') === value) {
      el.classList.add('selected');
    }
  });
  
  // Check radio button
  const radio = document.querySelector('input[name="participation"][value="' + value + '"]');
  if (radio) {
    radio.checked = true;
  }
  
  // Enable confirm button
  document.getElementById('confirmParticipationBtn').disabled = false;
}

function confirmParticipation() {
  if (!window.selectedParticipation) return;
  
  // Save value
  document.getElementById('villageParticipation').value = window.selectedParticipation;
  
  // Update display
  const participationTexts = {
    'excellent': '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê ‡∫°‡∫µ‡∫™‡ªà‡∫ß‡∫ô‡∫Æ‡ªà‡∫ß‡∫°‡∫î‡∫µ‡ªÄ‡∫•‡∫µ‡∫î',
    'verygood': '‚≠ê‚≠ê‚≠ê‚≠ê ‡∫°‡∫µ‡∫™‡ªà‡∫ß‡∫ô‡∫Æ‡ªà‡∫ß‡∫°‡∫î‡∫µ‡∫´‡∫º‡∫≤‡∫ç',
    'moderate': '‚≠ê‚≠ê‚≠ê ‡∫°‡∫µ‡∫™‡ªà‡∫ß‡∫ô‡∫Æ‡ªà‡∫ß‡∫°‡∫õ‡∫≤‡∫ô‡∫Å‡∫≤‡∫á',
    'lacking': '‚≠ê ‡∫Ç‡∫≤‡∫î‡∫Å‡∫≤‡∫ô‡∫°‡∫µ‡∫™‡ªà‡∫ß‡∫ô‡∫Æ‡ªà‡∫ß‡∫°'
  };
  
  const display = document.getElementById('participationDisplay');
  const text = document.getElementById('participationText');
  
  text.textContent = participationTexts[window.selectedParticipation];
  display.className = ''; // Clear classes
  display.classList.add(window.selectedParticipation);
  display.style.display = 'block';
  
  showToast('‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫∞‡∫î‡∫±‡∫ö‡∫Å‡∫≤‡∫ô‡∫°‡∫µ‡∫™‡ªà‡∫ß‡∫ô‡∫Æ‡ªà‡∫ß‡∫°‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î', 'success');
  closeParticipationModal();
}

function createCustomMarkerIcon() {
  // Create beautiful custom marker icon
  const customIcon = L.divIcon({
    html: `
      <div class="custom-map-marker">
        <svg width="40" height="60" viewBox="0 0 40 60" xmlns="http://www.w3.org/2000/svg">
          <!-- Shadow -->
          <ellipse cx="20" cy="58" rx="10" ry="3" fill="#000000" opacity="0.3"/>
          <!-- Outer glow -->
          <path d="M20 0C8.95 0 0 8.95 0 20c0 15 20 40 20 40s20-25 20-40C40 8.95 31.05 0 20 0z" 
                fill="url(#grad1)" stroke="#fff" stroke-width="2" filter="url(#glow)"/>
          <!-- Inner circle -->
          <circle cx="20" cy="20" r="8" fill="#fff" opacity="0.9"/>
          <!-- Center dot -->
          <circle cx="20" cy="20" r="4" fill="#f44336"/>
          <!-- Gradient definition -->
          <defs>
            <linearGradient id="grad1" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" style="stop-color:#f44336;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#d32f2f;stop-opacity:1" />
            </linearGradient>
            <filter id="glow">
              <feShadow dx="0" dy="0" stdDeviation="3" flood-color="#f44336" flood-opacity="0.5"/>
            </filter>
          </defs>
        </svg>
      </div>
    `,
    className: 'custom-beautiful-marker',
    iconSize: [40, 60],
    iconAnchor: [20, 60],
    popupAnchor: [0, -60]
  });
  
  return customIcon;
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Multi-Select
function initializeMultiSelect() {
  const diseaseTextareas = document.querySelectorAll('.multi-select-field');
  
  diseaseTextareas.forEach(textarea => {
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á container ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á tags
    const tagsContainer = document.createElement('div');
    tagsContainer.className = 'disease-tags-container';
    tagsContainer.style.cssText = 'display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;';
    
    textarea.parentElement.insertBefore(tagsContainer, textarea);
    
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô tags
    if (textarea.value) {
      const diseases = textarea.value.split(',').map(d => d.trim()).filter(d => d);
      diseases.forEach(disease => {
        addDiseaseTag(disease, tagsContainer, textarea);
      });
    }
    
    // Event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Enter
    textarea.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const value = this.value.trim();
        
        if (value) {
          addDiseaseTag(value, tagsContainer, this);
          this.value = '';
        }
      }
    });
  });
}

function addDiseaseTag(disease, container, textarea) {
  const tag = document.createElement('span');
  tag.className = 'disease-tag';
  tag.style.cssText = 'background: #e3f2fd; color: #1976d2; padding: 5px 10px; border-radius: 15px; display: inline-flex; align-items: center; gap: 5px; font-size: 0.9rem;';
  tag.innerHTML = `
    ${disease}
    <span onclick="removeTag(this)" style="cursor: pointer; font-weight: bold; margin-left: 5px;">√ó</span>
  `;
  
  container.appendChild(tag);
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï textarea value
  updateDiseaseTextarea(textarea);
}

function removeTag(element) {
  const tag = element.parentElement;
  const container = tag.parentElement;
  const textarea = container.nextElementSibling;
  
  tag.remove();
  updateDiseaseTextarea(textarea);
}

function updateDiseaseTextarea(textarea) {
  const container = textarea.previousElementSibling;
  const tags = container.querySelectorAll('.disease-tag');
  const diseases = Array.from(tags).map(tag => tag.textContent.trim().replace('√ó', '').trim());
  
  textarea.value = diseases.join(', ');
}

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°
// ‚úÖ ‡πÉ‡∏ä‡πâ window.onload ‡πÅ‡∏ó‡∏ô DOMContentLoaded (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤)
window.addEventListener('load', function() {
  console.log('‚úÖ Page fully loaded');
  
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
  if (typeof addRealTimeCounterListeners === 'function') {
    addRealTimeCounterListeners();
  }
  
  if (typeof initializeMultiSelect === 'function') {
    initializeMultiSelect();
  }
});
// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô handleDiseaseInput ‡πÄ‡∏î‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ
function handleDiseaseInput(event, memberId) {
  const input = document.getElementById(`diseaseInput${memberId}`);
  const value = input.value.trim();
  
  // ‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏£‡∏Ñ
  if (event.key === 'Enter') {
    event.preventDefault();
    
    if (value) {
      addDiseaseTag(value, memberId);
      input.value = '';
    }
  }
  
  // Tab ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏£‡∏Ñ
  if (event.key === 'Tab' && value) {
    event.preventDefault();
    addDiseaseTag(value, memberId);
    input.value = '';
  }
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å datalist (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
function setupDiseaseInputListeners(memberId) {
  const input = document.getElementById(`diseaseInput${memberId}`);
  if (!input) return;
  
  // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å datalist
  input.addEventListener('change', function() {
    const value = this.value.trim();
    if (value) {
      addDiseaseTag(value, memberId);
      this.value = '';
    }
  });
  
  // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ blur (‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å input) ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡πà‡∏≤
  input.addEventListener('blur', function() {
    setTimeout(() => {
      const value = this.value.trim();
      if (value) {
        addDiseaseTag(value, memberId);
        this.value = '';
      }
    }, 200);
  });
}
// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô addDiseaseTag ‡πÄ‡∏î‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ
function addDiseaseTag(disease, memberId) {
  const container = document.getElementById(`diseaseTagsContainer${memberId}`);
  const hiddenTextarea = document.getElementById(`diseaseHidden${memberId}`);
  
  if (!container || !hiddenTextarea) return;
  
  // ‡∏•‡∏ö placeholder ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
  const placeholder = container.querySelector('.empty-placeholder');
  if (placeholder) {
    placeholder.remove();
  }
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÇ‡∏£‡∏Ñ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
  const existingTags = container.querySelectorAll('.disease-tag');
  for (let tag of existingTags) {
    if (tag.getAttribute('data-disease') === disease) {
      showToast('‚ö†Ô∏è ‡∫°‡∫µ‡∫û‡∫∞‡∫ç‡∫≤‡∫î‡∫ô‡∫µ‡ªâ‡ªÅ‡∫•‡ªâ‡∫ß', 'error');
      return;
    }
  }
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á tag
  const tag = document.createElement('span');
  tag.className = 'disease-tag';
  tag.setAttribute('data-disease', disease);
  tag.style.cssText = 'background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); color: #1976d2; padding: 8px 12px; border-radius: 20px; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.3s; animation: slideIn 0.3s ease;';
  tag.innerHTML = `
    <span style="font-weight: 500;">üî¥ ${disease}</span>
    <span onclick="removeDiseaseTag(this, ${memberId})" 
          style="cursor: pointer; font-weight: bold; font-size: 1.2rem; color: #f44336; transition: transform 0.2s; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(244,67,54,0.1);"
          onmouseover="this.style.transform='scale(1.3)'; this.style.background='rgba(244,67,54,0.2)'"
          onmouseout="this.style.transform='scale(1)'; this.style.background='rgba(244,67,54,0.1)'">√ó</span>
  `;
  
  container.appendChild(tag);
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï hidden textarea
  updateDiseaseTextarea(memberId);
  
  showToast('‚úÖ ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫û‡∫∞‡∫ç‡∫≤‡∫î‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î', 'success');
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö Tag ‡πÇ‡∏£‡∏Ñ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
function removeDiseaseTag(element, memberId) {
  const tag = element.parentElement;
  tag.style.transform = 'scale(0)';
  
  setTimeout(() => {
    tag.remove();
    updateDiseaseTextarea(memberId);
    showToast('‡∫•‡∫ª‡∫ö‡∫û‡∫∞‡∫ç‡∫≤‡∫î‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î', 'success');
  }, 200);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Textarea (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
function updateDiseaseTextarea(memberId) {
  const container = document.getElementById(`diseaseTagsContainer${memberId}`);
  const hiddenTextarea = document.getElementById(`diseaseHidden${memberId}`);
  
  if (!container || !hiddenTextarea) return;
  
  const tags = container.querySelectorAll('.disease-tag');
  const diseases = Array.from(tags).map(tag => tag.getAttribute('data-disease'));
  
  hiddenTextarea.value = diseases.join(', ');
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Initialize ‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
function initializeExistingDiseases(memberId, diseasesString) {
  if (!diseasesString) return;
  
  const diseases = diseasesString.split(',').map(d => d.trim()).filter(d => d);
  diseases.forEach(disease => {
    addDiseaseTag(disease, memberId);
  });
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏£‡∏Ñ‡∏î‡πâ‡∏ß‡∏¢‡∏õ‡∏∏‡πà‡∏° (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
function manualAddDisease(memberId) {
  const input = document.getElementById(`diseaseInput${memberId}`);
  const value = input.value.trim();
  
  if (value) {
    addDiseaseTag(value, memberId);
    input.value = '';
    input.focus();
  } else {
    showToast('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫û‡∫¥‡∫°‡∫ä‡∫∑‡ªà‡∫û‡∫∞‡∫ç‡∫≤‡∫î‡∫Å‡ªà‡∫≠‡∫ô', 'error');
    input.focus();
  }
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï Relationship Options (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
function updateRelationshipOptions() {
  const memberForms = document.querySelectorAll('.member-section');
  let hasHouseholdHead = false;
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß" ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
  memberForms.forEach(form => {
    const relationshipInput = form.querySelector('.memberRelationship');
    if (relationshipInput && relationshipInput.value.trim() === '‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß') {
      hasHouseholdHead = true;
    }
  });
  
  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï datalist ‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
  const datalist = document.getElementById('relationshipList');
  if (datalist && optionsData && optionsData.H) {
    datalist.innerHTML = '';
    
    optionsData.H.forEach(option => {
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á "‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß" ‡πÉ‡∏ô datalist
      if (hasHouseholdHead && option === '‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß') {
        return; // skip
      }
      
      const optionEl = document.createElement('option');
      optionEl.value = option;
      datalist.appendChild(optionEl);
    });
  }
  
  console.log('üîÑ Relationship options updated. Has household head:', hasHouseholdHead);
}


// ===================================
// Open Mobile Population
// ===================================
function openMobilePopulation() {
  console.log('>>> Opening mobile population page...');
  
  document.getElementById('menu').style.display = 'none';
  document.getElementById('dataContainer').classList.remove('active');
  document.getElementById('mobileContainer').classList.add('active');
  
  // Load mobile data
  showLoading();
  
  if (mobilesData.length === 0) {
    console.log('>>> Fetching mobile data...');
    
    google.script.run
      .withSuccessHandler(function(data) {
        hideLoading();
        mobilesData = data || [];
        
        // Save to IndexedDB
        mobilesData.forEach(m => saveToIndexedDB('mobiles', m));
        
        loadMobileData();
        showToast(`‡ªÇ‡∫´‡∫•‡∫î‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î: ${mobilesData.length} ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô`, 'success');
      })
      .withFailureHandler(function(error) {
        hideLoading();
        console.error('Error loading mobile data:', error);
        showToast('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î: ' + error.message, 'error');
        
        // Try load from IndexedDB
        loadFromIndexedDB('mobiles', null).then(data => {
          mobilesData = data || [];
          loadMobileData();
        });
      })
      .getMobileData(villageSheetId);
  } else {
    hideLoading();
    loadMobileData();
  }
}

// ===================================
// Load Mobile Data to Table
// ===================================
function loadMobileData() {
  console.log('>>> Loading mobile data to table...');
  console.log('>>> mobilesData length:', mobilesData.length);
  
  const tbody = document.getElementById('mobileTableBody');
  tbody.innerHTML = '';
  
  if (mobilesData.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" style="text-align: center; padding: 40px;">
          <div style="font-size: 48px; margin-bottom: 10px;">üìã</div>
          <div style="margin-bottom: 15px;">‡∫ç‡∫±‡∫á‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫õ‡∫∞‡∫ä‡∫≤‡∫Å‡∫≠‡∫ô‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫ô‡∫ó‡∫µ‡ªà</div>
          <button onclick="openMobileTypeModal()" class="btn btn-primary">‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô</button>
        </td>
      </tr>
    `;
    document.getElementById('mobilePagination').style.display = 'none';
    return;
  }
  
  // Create rows
  const allRows = [];
  
  mobilesData.forEach((mobile, index) => {
    const row = createMobileTableRow(mobile);
    allRows.push(row);
  });
  
  totalMobileRows = allRows.length;
  const totalPages = Math.ceil(totalMobileRows / mobileRowsPerPage);
  
  // Display rows for current page
  const startIndex = (currentMobilePage - 1) * mobileRowsPerPage;
  const endIndex = Math.min(startIndex + mobileRowsPerPage, totalMobileRows);
  
  for (let i = startIndex; i < endIndex; i++) {
    tbody.appendChild(allRows[i]);
  }
  
  // Update pagination
  updateMobilePaginationUI(totalPages);
  
  console.log('>>> Displayed mobile rows ' + (startIndex + 1) + '-' + endIndex + ' of ' + totalMobileRows);
}

// ===================================
// Create Mobile Table Row
// ===================================
function createMobileTableRow(mobile) {
  const tr = document.createElement('tr');
  
  const photoUrl = mobile.photo || '';
  const photoHTML = photoUrl ? 
    `<img src="${photoUrl}" class="profile-img" alt="Photo" onclick="showImagePreview('${photoUrl}')" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
     <div class="profile-img" style="font-size: 24px; display: none;">‚ùì</div>` : 
    '<div class="profile-img" style="font-size: 24px; display: flex; align-items: center; justify-content: center;">‚ùì</div>';
  
  // WhatsApp button
  const whatsappBtn = mobile.phone ? 
    `<a href="https://wa.me/${mobile.phone.replace(/\D/g, '')}" target="_blank" class="btn-whatsapp" title="${mobile.phone}">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
      </svg>
    </a>` : 
    '<span style="color: #999;">-</span>';
  
  // Type badge
  const typeColor = mobile.rentalType === '‡∫û‡∫±‡∫Å‡ªÄ‡∫ä‡∫ª‡∫≤‡∫Ñ‡∫ª‡∫á‡∫ó‡∫µ‡ªà' ? '#2196F3' : '#FF9800';
  const typeBadge = `<span style="background: ${typeColor}; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: 600;">${mobile.rentalType || '-'}</span>`;
  
  tr.innerHTML = `
    <td>${photoHTML}</td>
    <td><strong>${mobile.name || '-'}</strong></td>
    <td>${mobile.gender || '-'}</td>
    <td>${mobile.roomNumber || '-'}</td>
    <td>${typeBadge}</td>
    <td style="text-align: center;">${whatsappBtn}</td>
    <td>
      <div class="action-buttons">
        <button class="btn-edit" onclick="editMobile('${mobile.mobileCode}')" title="‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç">
          ‚úèÔ∏è ‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç
        </button>
        <button class="btn-delete" onclick="showDeleteModal('mobile', '${mobile.mobileCode}')" title="‡∫•‡∫ª‡∫ö">
          üóëÔ∏è ‡∫•‡∫ª‡∫ö
        </button>
      </div>
    </td>
  `;
  
  return tr;
}

// ===================================
// Mobile Pagination
// ===================================
function updateMobilePaginationUI(totalPages) {
  document.getElementById('currentMobilePage').textContent = currentMobilePage;
  document.getElementById('totalMobilePages').textContent = totalPages;
  
  document.getElementById('btnMobileFirst').disabled = currentMobilePage === 1;
  document.getElementById('btnMobilePrev').disabled = currentMobilePage === 1;
  document.getElementById('btnMobileNext').disabled = currentMobilePage === totalPages;
  document.getElementById('btnMobileLast').disabled = currentMobilePage === totalPages;
  
  document.getElementById('mobilePagination').style.display = totalPages > 1 ? 'flex' : 'none';
}

function changeMobilePage(direction) {
  const totalPages = Math.ceil(totalMobileRows / mobileRowsPerPage);
  
  switch(direction) {
    case 'first':
      currentMobilePage = 1;
      break;
    case 'prev':
      if (currentMobilePage > 1) currentMobilePage--;
      break;
    case 'next':
      if (currentMobilePage < totalPages) currentMobilePage++;
      break;
    case 'last':
      currentMobilePage = totalPages;
      break;
  }
  
  loadMobileData();
  document.getElementById('mobileTable').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ===================================
// Search Mobile Data
// ===================================
function searchMobileData() {
  const searchTerm = document.getElementById('searchMobileInput').value.trim();
  
  if (!searchTerm) {
    loadMobileData();
    return;
  }
  
  if (searchTerm.length < 2) {
    showToast('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫û‡∫¥‡∫°‡∫¢‡ªà‡∫≤‡∫á‡ªú‡ªâ‡∫≠‡∫ç 2 ‡∫ï‡∫ª‡∫ß‡∫≠‡∫±‡∫Å‡∫™‡∫≠‡∫ô', 'error');
    return;
  }
  
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(results) {
      hideLoading();
      
      if (!results || results.length === 0) {
        const tbody = document.getElementById('mobileTableBody');
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px;">
              <div style="font-size: 48px; margin-bottom: 10px;">üîç</div>
              <div>‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ó‡∫µ‡ªà‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤: "${searchTerm}"</div>
              <button onclick="clearMobileSearch()" class="btn btn-primary" style="margin-top: 15px;">
                ‚ùå ‡∫•‡ªâ‡∫≤‡∫á‡∫Å‡∫≤‡∫ô‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤
              </button>
            </td>
          </tr>
        `;
        document.getElementById('mobilePagination').style.display = 'none';
        showToast('‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫ú‡∫ª‡∫ô‡∫Å‡∫≤‡∫ô‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤', 'error');
        return;
      }
      
      displayMobileSearchResults(results, searchTerm);
      showToast(`‡∫û‡∫ª‡∫ö ${results.length} ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô`, 'success');
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showToast('‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤: ' + error.message, 'error');
    })
    .searchMobile(searchTerm, villageSheetId);
}

function displayMobileSearchResults(results, searchTerm) {
  const tbody = document.getElementById('mobileTableBody');
  tbody.innerHTML = '';
  
  // Header row
  const headerRow = document.createElement('tr');
  headerRow.innerHTML = `
    <td colspan="7" style="background: #fff3cd; padding: 15px; border-left: 5px solid #ffc107;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <strong>üîç ‡∫ú‡∫ª‡∫ô‡∫Å‡∫≤‡∫ô‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤: "${searchTerm}"</strong> - 
          ‡∫û‡∫ª‡∫ö <strong style="color: #667eea;">${results.length}</strong> ‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô
        </div>
        <button onclick="clearMobileSearch()" class="btn btn-secondary" style="padding: 5px 15px;">
          ‚ùå ‡∫•‡ªâ‡∫≤‡∫á‡∫Å‡∫≤‡∫ô‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤
        </button>
      </div>
    </td>
  `;
  tbody.appendChild(headerRow);
  
  // Result rows
  results.forEach(mobile => {
    tbody.appendChild(createMobileTableRow(mobile));
  });
  
  document.getElementById('mobilePagination').style.display = 'none';
}

function clearMobileSearch() {
  document.getElementById('searchMobileInput').value = '';
  currentMobilePage = 1;
  loadMobileData();
  showToast('‡∫•‡ªâ‡∫≤‡∫á‡∫Å‡∫≤‡∫ô‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î', 'success');
}

// ===================================
// Open Mobile Type Modal
// ===================================
function openMobileTypeModal() {
  currentMobileType = null;
  selectedHouseholdForMobile = null;
  
  // Reset selections
  document.querySelectorAll('.mobile-type-option').forEach(el => {
    el.classList.remove('selected');
  });
  
  document.getElementById('mobileTypeModal').classList.add('active');
}

function closeMobileTypeModal() {
  document.getElementById('mobileTypeModal').classList.remove('active');
}

function selectMobileType(type) {
  currentMobileType = type;
  
  console.log('>>> Selected mobile type:', type);
  
  // Update UI
  document.querySelectorAll('.mobile-type-option').forEach(el => {
    el.classList.remove('selected');
    if (el.getAttribute('data-type') === type) {
      el.classList.add('selected');
    }
  });
  
  // Close modal and proceed
  setTimeout(() => {
    closeMobileTypeModal();
    
    if (type === '‡∫û‡∫±‡∫Å‡ªÄ‡∫ä‡∫ª‡∫≤‡∫Ñ‡∫ª‡∫á‡∫ó‡∫µ‡ªà') {
      openHouseholdSelectorModal();
    } else {
      openMobileFormDirect();
    }
  }, 300);
}

// ===================================
// Household Selector Modal
// ===================================
function openHouseholdSelectorModal() {
  console.log('>>> Opening household selector...');
  
  // Populate household list
  const container = document.getElementById('householdListContainer');
  container.innerHTML = '';
  
  if (householdsData.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #999;">
        <div style="font-size: 48px; margin-bottom: 10px;">üìã</div>
        <div>‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫´‡∫ª‡∫ß‡ªú‡ªâ‡∫≤‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß</div>
      </div>
    `;
  } else {
    householdsData.forEach(household => {
      const card = createHouseholdCard(household);
      container.appendChild(card);
    });
  }
  
  // Populate datalist
  const datalist = document.getElementById('householdNameList');
  datalist.innerHTML = '';
  householdsData.forEach(h => {
    const option = document.createElement('option');
    option.value = h.name;
    datalist.appendChild(option);
  });
  
  document.getElementById('householdSelectorModal').classList.add('active');
}

function closeHouseholdSelectorModal() {
  document.getElementById('householdSelectorModal').classList.remove('active');
}

function createHouseholdCard(household) {
  const card = document.createElement('div');
  card.className = 'household-card';
  card.setAttribute('data-code', household.householdCode);
  
  const photoHTML = household.photo ? 
    `<img src="${household.photo}" class="household-card-photo">` : 
    '<div class="household-card-photo placeholder">‚ùì</div>';
  
  card.innerHTML = `
    <div class="household-card-header">
      ${photoHTML}
      <div class="household-card-info">
        <h4>${household.name}</h4>
        <p>üìû ${household.phone || '-'} | üè† ${household.houseNumber || '-'}</p>
      </div>
    </div>
    <div class="household-card-details">
      <span>üìç ${household.unit || '-'}</span>
      <span>üë• ${household.familyMemberCount || 0} ‡∫Ñ‡∫ª‡∫ô</span>
    </div>
  `;
  
  card.onclick = function() {
    selectHouseholdForMobile(household);
  };
  
  return card;
}

function selectHouseholdForMobile(household) {
  selectedHouseholdForMobile = household;
  
  console.log('>>> Selected household:', household);
  
  // Update UI
  document.querySelectorAll('.household-card').forEach(el => {
    el.classList.remove('selected');
  });
  
  const card = document.querySelector(`.household-card[data-code="${household.householdCode}"]`);
  if (card) {
    card.classList.add('selected');
  }
  
  // Close modal and open form
  setTimeout(() => {
    closeHouseholdSelectorModal();
    openMobileFormWithHousehold(household);
  }, 300);
}

function filterHouseholdList() {
  const searchValue = document.getElementById('householdSearchInput').value.toLowerCase();
  const cards = document.querySelectorAll('.household-card');
  
  cards.forEach(card => {
    const name = card.querySelector('h4').textContent.toLowerCase();
    const phone = card.querySelector('p').textContent.toLowerCase();
    
    if (name.includes(searchValue) || phone.includes(searchValue)) {
      card.style.display = 'block';
    } else {
      card.style.display = 'none';
    }
  });
}

// ===================================
// Open Mobile Form
// ===================================
function openMobileFormWithHousehold(household) {
  console.log('>>> Opening mobile form with household data');
  
  document.getElementById('mobileFormTitle').textContent = '‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫õ‡∫∞‡∫ä‡∫≤‡∫Å‡∫≠‡∫ô‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫ô‡∫ó‡∫µ‡ªà (‡∫û‡∫±‡∫Å‡ªÄ‡∫ä‡∫ª‡∫≤‡∫Ñ‡∫ª‡∫á‡∫ó‡∫µ‡ªà)';
  document.getElementById('mobileForm').reset();
  document.getElementById('mobileCode').value = '';
  document.getElementById('mobileType').value = '‡∫û‡∫±‡∫Å‡ªÄ‡∫ä‡∫ª‡∫≤‡∫Ñ‡∫ª‡∫á‡∫ó‡∫µ‡ªà';
  document.getElementById('mobileMembersContainer').innerHTML = '';
  mobileMemberCounter = 0;
  
  // Fill household data
  document.getElementById('mobileOwnerName').value = household.name;
  document.getElementById('mobileOwnerName').readOnly = true;
  document.getElementById('mobileHouseholdCode').value = household.householdCode;
  document.getElementById('mobileProvince').value = household.province || currentUser.province;
  document.getElementById('mobileDistrict').value = household.district || currentUser.district;
  document.getElementById('mobileVillage').value = household.village || currentUser.village;
  document.getElementById('mobileUnit').value = household.unit || '';
  document.getElementById('mobilePosition').value = household.housePosition || '';
  
  populateMobileDataLists();
  document.getElementById('mobileFormModal').classList.add('active');
}

function openMobileFormDirect() {
  console.log('>>> Opening mobile form (direct entry)');
  
  document.getElementById('mobileFormTitle').textContent = '‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫õ‡∫∞‡∫ä‡∫≤‡∫Å‡∫≠‡∫ô‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫ô‡∫ó‡∫µ‡ªà (‡∫û‡∫±‡∫Å‡ªÄ‡∫ä‡∫ª‡∫≤‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫ô‡∫ó‡∫µ‡ªà)';
  document.getElementById('mobileForm').reset();
  document.getElementById('mobileCode').value = '';
  document.getElementById('mobileType').value = '‡∫û‡∫±‡∫Å‡ªÄ‡∫ä‡∫ª‡∫≤‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫ô‡∫ó‡∫µ‡ªà';
  document.getElementById('mobileMembersContainer').innerHTML = '';
  mobileMemberCounter = 0;
  
  // Auto-fill from login
  document.getElementById('mobileOwnerName').value = '';
  document.getElementById('mobileOwnerName').readOnly = false;
  document.getElementById('mobileHouseholdCode').value = 'Mobile-' + generateRandomCode(13);
  document.getElementById('mobileProvince').value = currentUser ? currentUser.province : '';
  document.getElementById('mobileDistrict').value = currentUser ? currentUser.district : '';
  document.getElementById('mobileVillage').value = currentUser ? currentUser.village : '';
  document.getElementById('mobileUnit').value = '';
  document.getElementById('mobilePosition').value = '';
  
  populateMobileDataLists();
  document.getElementById('mobileFormModal').classList.add('active');
}

function closeMobileForm() {
  document.getElementById('mobileFormModal').classList.remove('active');
}

// ===================================
// Populate Mobile DataLists
// ===================================
function populateMobileDataLists() {
  if (!optionsData) return;
  
  // Owner name list (from households + existing mobiles)
  const ownerNameList = document.getElementById('ownerNameList');
  ownerNameList.innerHTML = '';
  
  const ownerNames = new Set();
  householdsData.forEach(h => ownerNames.add(h.name));
  mobilesData.forEach(m => {
    if (m.ownerName) ownerNames.add(m.ownerName);
  });
  
  Array.from(ownerNames).sort().forEach(name => {
    const option = document.createElement('option');
    option.value = name;
    ownerNameList.appendChild(option);
  });
}

// ===================================
// Add Mobile Member Form
// ===================================
function addMobileMemberForm() {
  mobileMemberCounter++;
  const container = document.getElementById('mobileMembersContainer');
  
  const memberDiv = document.createElement('div');
  memberDiv.className = 'mobile-member-section';
  memberDiv.id = `mobile-member-${mobileMemberCounter}`;
  memberDiv.innerHTML = getMobileMemberFormHTML(mobileMemberCounter, null);
  
  container.appendChild(memberDiv);
  updateMobileRoomCount();
  
  memberDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function getMobileMemberFormHTML(counter, member) {
  const birthParts = member && member.birthDate ? member.birthDate.split('/') : ['', '', ''];
  
  return `
    <h3 data-member-number="${counter}">
      <span style="margin-left: 35px;">üë§ ‡∫™‡∫∞‡∫°‡∫≤‡∫ä‡∫¥‡∫Å‡∫Ñ‡∫ª‡∫ô‡∫ó‡∫µ‡ªà ${counter}</span>
      <button type="button" class="btn-delete-member" onclick="removeMobileMemberForm(${counter})">üóëÔ∏è ‡∫•‡∫ª‡∫ö</button>
    </h3>
    
    <!-- Photo Upload -->
    <div class="form-group">
      <div class="photo-upload" onclick="document.getElementById('mobileMemberPhoto${counter}').click()">
        <div class="photo-preview" id="mobileMemberPhotoPreview${counter}">
          ${member && member.photo ? `<img src="${member.photo}" alt="Photo">` : '<div class="placeholder">‚ùì</div>'}
        </div>
        <p>üì∑ ‡∫≠‡∫±‡∫ö‡ªÇ‡∫´‡∫•‡∫î/‡∫ñ‡ªà‡∫≤‡∫ç‡∫Æ‡∫π‡∫ö</p>
        <input type="file" id="mobileMemberPhoto${counter}" accept="image/*" style="display: none" onchange="previewPhoto(this, 'mobileMemberPhotoPreview${counter}')">
      </div>
    </div>
    
    <!-- Row 1: Name, Birth Date, Gender -->
    <div class="form-row">
      <div class="form-group">
        <label>‡∫ä‡∫∑‡ªà ‡ªÅ‡∫•‡∫∞ ‡∫ô‡∫≤‡∫°‡∫™‡∫∞‡∫Å‡∫∏‡∫ô *</label>
        <input type="text" class="mobileMemberName required-field" value="${member ? member.name || '' : ''}" required data-field-name="‡∫ä‡∫∑‡ªà">
      </div>
      <div class="form-group">
        <label>‡∫ß‡∫±‡∫ô‡ªÄ‡∫î‡∫∑‡∫≠‡∫ô‡∫õ‡∫µ‡ªÄ‡∫Å‡∫µ‡∫î *</label>
        <div class="date-inputs">
          <input type="number" class="mobileBirthDay required-field" value="${birthParts[0]}" placeholder="‡∫ß‡∫±‡∫ô" min="1" max="31" data-field-name="‡∫ß‡∫±‡∫ô‡ªÄ‡∫Å‡∫µ‡∫î">
          <span>/</span>
          <input type="number" class="mobileBirthMonth required-field" value="${birthParts[1]}" placeholder="‡ªÄ‡∫î‡∫∑‡∫≠‡∫ô" min="1" max="12" data-field-name="‡ªÄ‡∫î‡∫∑‡∫≠‡∫ô‡ªÄ‡∫Å‡∫µ‡∫î">
          <span>/</span>
          <input type="number" class="mobileBirthYear required-field" value="${birthParts[2]}" placeholder="‡∫õ‡∫µ" min="1900" max="2100" data-field-name="‡∫õ‡∫µ‡ªÄ‡∫Å‡∫µ‡∫î">
        </div>
      </div>
      <div class="form-group">
        <label>‡ªÄ‡∫û‡∫î *</label>
        <input type="text" class="mobileMemberGender required-field" value="${member ? member.gender || '' : ''}" list="genderList" required data-field-name="‡ªÄ‡∫û‡∫î">
      </div>
    </div>
    
    <!-- Row 2: Nationality, Ethnicity, Religion -->
    <div class="form-row">
      <div class="form-group">
        <label>‡∫™‡∫±‡∫ô‡∫ä‡∫≤‡∫î *</label>
        <input type="text" class="mobileMemberNationality required-field" value="${member ? member.nationality || '' : ''}" list="ethnicityList" required data-field-name="‡∫™‡∫±‡∫ô‡∫ä‡∫≤‡∫î">
      </div>
      <div class="form-group">
        <label>‡∫ä‡∫ª‡∫ô‡ªÄ‡∫ú‡∫ª‡ªà‡∫≤ *</label>
        <input type="text" class="mobileMemberEthnicity required-field" value="${member ? member.ethnicity || '' : ''}" list="ethnicityList" required data-field-name="‡∫ä‡∫ª‡∫ô‡ªÄ‡∫ú‡∫ª‡ªà‡∫≤">
      </div>
      <div class="form-group">
        <label>‡∫™‡∫≤‡∫™‡∫∞‡ªú‡∫≤ *</label>
        <input type="text" class="mobileMemberReligion required-field" value="${member ? member.religion || '' : ''}" list="religionList" required data-field-name="‡∫™‡∫≤‡∫™‡∫∞‡ªú‡∫≤">
      </div>
    </div>
    
    <!-- Row 3: Education, Relationship, Marital Status -->
    <div class="form-row">
      <div class="form-group">
        <label>‡∫•‡∫∞‡∫î‡∫±‡∫ö‡∫Å‡∫≤‡∫ô‡∫™‡∫∂‡∫Å‡∫™‡∫≤ *</label>
        <input type="text" class="mobileMemberEducation required-field" value="${member ? member.education || '' : ''}" list="educationList" required data-field-name="‡∫•‡∫∞‡∫î‡∫±‡∫ö‡∫Å‡∫≤‡∫ô‡∫™‡∫∂‡∫Å‡∫™‡∫≤">
      </div>
      <div class="form-group">
        <label>‡∫™‡∫≤‡∫ç‡∫û‡∫ª‡∫ß‡∫û‡∫±‡∫ô‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß *</label>
        <input type="text" class="mobileMemberRelationship required-field" value="${member ? member.relationship || '' : ''}" list="relationshipList" required data-field-name="‡∫™‡∫≤‡∫ç‡∫û‡∫ª‡∫ß‡∫û‡∫±‡∫ô">
      </div>
      <div class="form-group">
        <label>‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫∞‡∫û‡∫≤‡∫ö‡∫Ñ‡∫≠‡∫ö‡∫Ñ‡∫ª‡∫ß *</label>
        <input type="text" class="mobileMemberMaritalStatus required-field" value="${member ? member.maritalStatus || '' : ''}" list="maritalStatusList" required data-field-name="‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫∞‡∫û‡∫≤‡∫ö">
      </div>
    </div>
    
    <!-- Row 4: Phone, Occupation, Workplace -->
    <div class="form-row">
      <div class="form-group">
        <label>‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó‡∫ú‡∫π‡ªâ‡∫Å‡ªà‡∫Ω‡∫ß</label>
        <input type="tel" class="mobileMemberPhone" value="${member ? member.phone || '' : ''}" placeholder="20XXXXXXXX">
      </div>
      <div class="form-group">
        <label>‡∫≠‡∫≤‡∫ä‡∫µ‡∫ö *</label>
        <input type="text" class="mobileMemberOccupation required-field" value="${member ? member.occupation || '' : ''}" list="occupationList" required data-field-name="‡∫≠‡∫≤‡∫ä‡∫µ‡∫ö">
      </div>
      <div class="form-group">
        <label>‡∫•‡∫∞‡∫ö‡∫∏‡∫ö‡ªà‡∫≠‡∫ô‡ªÄ‡∫Æ‡∫±‡∫î‡∫ß‡∫Ω‡∫Å</label>
        <textarea class="mobileMemberWorkplace" rows="2" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">${member ? member.workplace || '' : ''}</textarea>
      </div>
    </div>
    
    <!-- Row 5: Purpose (Multi-Select Tags) -->
    <div class="form-row">
      <div class="form-group" style="grid-column: 1 / -1;">
        <label>‡∫à‡∫∏‡∫î‡∫õ‡∫∞‡∫™‡∫ª‡∫á‡ªÉ‡∫ô‡∫Å‡∫≤‡∫ô‡∫û‡∫±‡∫Å‡ªÄ‡∫ä‡∫ª‡ªà‡∫≤ *</label>
        <div class="disease-tags-container" id="purposeTagsContainer${counter}" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; min-height: 40px; padding: 10px; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px;">
          <div style="width: 100%; text-align: center; color: #999; font-size: 13px;" class="empty-placeholder">
            ‡∫ç‡∫±‡∫á‡∫ö‡ªç‡ªà‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫à‡∫∏‡∫î‡∫õ‡∫∞‡∫™‡∫ª‡∫á
          </div>
        </div>
        <div style="position: relative;">
          <input type="text" 
                 class="mobilePurposeInput" 
                 id="purposeInput${counter}"
                 list="purposeList" 
                 placeholder="üîç ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫´‡∫º‡∫∑‡∫û‡∫¥‡∫°‡ªÄ‡∫≠‡∫á..."
                 style="width: 100%; padding: 12px 40px 12px 12px; border: 2px solid #e0e0e0; border-radius: 8px;"
                 onkeydown="handlePurposeInput(event, ${counter})">
          <button type="button" 
                  onclick="manualAddPurpose(${counter})"
                  style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); padding: 8px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 5px; cursor: pointer;">
            ‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°
          </button>
        </div>
        <textarea class="mobileMemberPurpose required-field" 
                  id="purposeHidden${counter}"
                  rows="1" 
                  style="display: none;"
                  data-field-name="‡∫à‡∫∏‡∫î‡∫õ‡∫∞‡∫™‡∫ª‡∫á">${member ? member.purpose || '' : ''}</textarea>
      </div>
    </div>
    
    <!-- Row 6: Permit -->
    <div class="form-row">
      <div class="form-group">
        <label>‡∫õ‡∫∑‡ªâ‡∫°‡∫≠‡∫∞‡∫ô‡∫∏‡∫ç‡∫≤‡∫î‡∫û‡∫±‡∫Å‡ªÄ‡∫ä‡∫ª‡ªà‡∫≤‡∫ä‡∫ª‡ªà‡∫ß‡∫Ñ‡∫≤‡∫ß *</label>
        <div style="display: flex; gap: 10px;">
          <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="radio" name="mobilePermit${counter}" value="‡∫°‡∫µ" onchange="togglePermitNumber(${counter}, true)" ${member && member.hasPermit === '‡∫°‡∫µ' ? 'checked' : ''}>
            <span>‡∫°‡∫µ</span>
          </label>
          <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="radio" name="mobilePermit${counter}" value="‡∫ö‡ªç‡ªà‡∫°‡∫µ" onchange="togglePermitNumber(${counter}, false)" ${!member || member.hasPermit !== '‡∫°‡∫µ' ? 'checked' : ''}>
            <span>‡∫ö‡ªç‡ªà‡∫°‡∫µ</span>
          </label>
        </div>
      </div>
      <div class="form-group" id="permitNumberGroup${counter}" style="display: ${member && member.hasPermit === '‡∫°‡∫µ' ? 'block' : 'none'};">
        <label>‡ªÄ‡∫•‡∫Å‡∫ó‡∫µ‡∫õ‡∫∑‡ªâ‡∫°</label>
        <input type="text" class="mobilePermitNumber" id="permitNumber${counter}" value="${member ? member.permitNumber || '' : ''}">
      </div>
      <div class="form-group">
        <label>‡∫ß‡∫±‡∫ô‡∫ó‡∫µ‡∫°‡∫≤‡∫û‡∫±‡∫Å‡ªÄ‡∫ä‡∫ª‡ªà‡∫≤‡∫Ñ‡∫±‡ªâ‡∫á‡∫ó‡ªç‡∫≤‡∫≠‡∫¥‡∫î</label>
        <input type="date" class="mobileFirstArrival" value="${member ? member.firstArrival || '' : ''}">
      </div>
    </div>
    
    <!-- Row 7: Rental Periods (Dynamic) -->
    <div class="form-row">
      <div class="form-group" style="grid-column: 1 / -1;">
        <label>‡∫ß‡∫±‡∫ô‡∫ó‡∫µ‡∫≠‡∫≠‡∫Å‡∫Å‡∫≤‡∫ô‡∫û‡∫±‡∫Å‡ªÄ‡∫ä‡∫ª‡ªà‡∫≤ & ‡∫ß‡∫±‡∫ô‡∫ó‡∫µ‡∫™‡∫¥‡ªâ‡∫ô‡∫™‡∫∏‡∫î</label>
        <div class="rental-periods-container" id="rentalPeriodsContainer${counter}">
          <div id="rentalPeriodsList${counter}">
            <!-- Rental periods will be added here -->
          </div>
          <button type="button" class="btn-add-period" onclick="addRentalPeriod(${counter})">
            ‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫Å‡∫≤‡∫ô‡∫ï‡ªç‡ªà‡∫≠‡∫≤‡∫ç‡∫∏
          </button>
        </div>
      </div>
    </div>
  `;
}
// ===================================
// MOBILE POPULATION - REMAINING FUNCTIONS
// ===================================

// ===================================
// Remove Mobile Member Form
// ===================================
function removeMobileMemberForm(id) {
  const memberDiv = document.getElementById(`mobile-member-${id}`);
  if (memberDiv && confirm('‡∫ó‡ªà‡∫≤‡∫ô‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫•‡∫ª‡∫ö‡∫™‡∫∞‡∫°‡∫≤‡∫ä‡∫¥‡∫Å‡∫Ñ‡∫ª‡∫ô‡∫ô‡∫µ‡ªâ‡∫ö‡ªç‡ªà?')) {
    memberDiv.remove();
    
    // Reorder members
    reorderMobileMembers();
    
    // Update room count
    updateMobileRoomCount();
  }
}

// ===================================
// Reorder Mobile Members
// ===================================
function reorderMobileMembers() {
  const container = document.getElementById('mobileMembersContainer');
  const memberDivs = container.querySelectorAll('.mobile-member-section');
  
  memberDivs.forEach((div, index) => {
    const newNumber = index + 1;
    
    // Update heading
    const heading = div.querySelector('h3');
    if (heading) {
      heading.setAttribute('data-member-number', newNumber);
      const span = heading.querySelector('span');
      if (span) {
        span.textContent = `üë§ ‡∫™‡∫∞‡∫°‡∫≤‡∫ä‡∫¥‡∫Å‡∫Ñ‡∫ª‡∫ô‡∫ó‡∫µ‡ªà ${newNumber}`;
      }
    }
    
    // Update ID
    div.id = `mobile-member-${newNumber}`;
    
    // Update all IDs inside
    updateMobileElementIds(div, newNumber);
  });
  
  // Update counter
  mobileMemberCounter = memberDivs.length;
}

// ===================================
// Update Mobile Element IDs
// ===================================
function updateMobileElementIds(container, newId) {
  // Photo
  const photoInput = container.querySelector('[id^="mobileMemberPhoto"]');
  if (photoInput) photoInput.id = `mobileMemberPhoto${newId}`;
  
  const photoPreview = container.querySelector('[id^="mobileMemberPhotoPreview"]');
  if (photoPreview) photoPreview.id = `mobileMemberPhotoPreview${newId}`;
  
  // Purpose tags
  const purposeTags = container.querySelector('[id^="purposeTagsContainer"]');
  if (purposeTags) purposeTags.id = `purposeTagsContainer${newId}`;
  
  const purposeInput = container.querySelector('[id^="purposeInput"]');
  if (purposeInput) {
    purposeInput.id = `purposeInput${newId}`;
    purposeInput.setAttribute('onkeydown', `handlePurposeInput(event, ${newId})`);
  }
  
  const purposeHidden = container.querySelector('[id^="purposeHidden"]');
  if (purposeHidden) purposeHidden.id = `purposeHidden${newId}`;
  
  // Permit
  const permitRadios = container.querySelectorAll('[name^="mobilePermit"]');
  permitRadios.forEach(radio => {
    radio.name = `mobilePermit${newId}`;
   // Permit
var permitRadios = container.querySelectorAll('[name^="mobilePermit"]');
permitRadios.forEach(function(radio) {
  radio.name = 'mobilePermit' + newId;
  var onchangeAttr = '';
  if (radio.value === '‡∫°‡∫µ') {
    onchangeAttr = 'togglePermitNumber(' + newId + ', true)';
  } else {
    onchangeAttr = 'togglePermitNumber(' + newId + ', false)';
  }
  radio.setAttribute('onchange', onchangeAttr);
});
  
  
  const permitGroup = container.querySelector('[id^="permitNumberGroup"]');
  if (permitGroup) permitGroup.id = `permitNumberGroup${newId}`;
  
  const permitNumber = container.querySelector('[id^="permitNumber"]');
  if (permitNumber) permitNumber.id = `permitNumber${newId}`;
  
  // Rental periods
  const rentalContainer = container.querySelector('[id^="rentalPeriodsContainer"]');
  if (rentalContainer) rentalContainer.id = `rentalPeriodsContainer${newId}`;
  
  const rentalList = container.querySelector('[id^="rentalPeriodsList"]');
  if (rentalList) rentalList.id = `rentalPeriodsList${newId}`;
  
  // Delete button
  const deleteBtn = container.querySelector('.btn-delete-member');
  if (deleteBtn) {
    deleteBtn.setAttribute('onclick', `removeMobileMemberForm(${newId})`);
  }
}

// ===================================
// Update Mobile Room Count (Auto)
// ===================================
function updateMobileRoomCount() {
  const memberForms = document.querySelectorAll('#mobileMembersContainer .mobile-member-section');
  const totalMembers = memberForms.length;
  
  const roomCountField = document.getElementById('mobileRoomCount');
  if (roomCountField) {
    roomCountField.value = totalMembers;
  }
  
  console.log('‚úÖ Mobile room count updated:', totalMembers);
}

// ===================================
// Toggle Permit Number Field
// ===================================
function togglePermitNumber(memberId, show) {
  const permitGroup = document.getElementById(`permitNumberGroup${memberId}`);
  if (permitGroup) {
    permitGroup.style.display = show ? 'block' : 'none';
    
    const permitInput = document.getElementById(`permitNumber${memberId}`);
    if (permitInput && !show) {
      permitInput.value = '';
    }
  }
}

// ===================================
// Handle Purpose Input (Multi-Select)
// ===================================
function handlePurposeInput(event, memberId) {
  const input = document.getElementById(`purposeInput${memberId}`);
  const value = input.value.trim();
  
  // Enter to add
  if (event.key === 'Enter') {
    event.preventDefault();
    
    if (value) {
      addPurposeTag(value, memberId);
      input.value = '';
    }
  }
  
  // Tab to add
  if (event.key === 'Tab' && value) {
    event.preventDefault();
    addPurposeTag(value, memberId);
    input.value = '';
  }
}

// ===================================
// Manual Add Purpose
// ===================================
function manualAddPurpose(memberId) {
  const input = document.getElementById(`purposeInput${memberId}`);
  const value = input.value.trim();
  
  if (value) {
    addPurposeTag(value, memberId);
    input.value = '';
    input.focus();
  } else {
    showToast('‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫û‡∫¥‡∫°‡∫à‡∫∏‡∫î‡∫õ‡∫∞‡∫™‡∫ª‡∫á‡∫Å‡ªà‡∫≠‡∫ô', 'error');
    input.focus();
  }
}

// ===================================
// Add Purpose Tag
// ===================================
function addPurposeTag(purpose, memberId) {
  const container = document.getElementById(`purposeTagsContainer${memberId}`);
  const hiddenTextarea = document.getElementById(`purposeHidden${memberId}`);
  
  if (!container || !hiddenTextarea) return;
  
  // Remove placeholder
  const placeholder = container.querySelector('.empty-placeholder');
  if (placeholder) {
    placeholder.remove();
  }
  
  // Check duplicate
  const existingTags = container.querySelectorAll('.disease-tag');
  for (let tag of existingTags) {
    if (tag.getAttribute('data-purpose') === purpose) {
      showToast('‚ö†Ô∏è ‡∫°‡∫µ‡∫à‡∫∏‡∫î‡∫õ‡∫∞‡∫™‡∫ª‡∫á‡∫ô‡∫µ‡ªâ‡ªÅ‡∫•‡ªâ‡∫ß', 'error');
      return;
    }
  }
  
  // Create tag
  const tag = document.createElement('span');
  tag.className = 'disease-tag';
  tag.setAttribute('data-purpose', purpose);
  tag.style.cssText = 'background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); color: #f57c00; padding: 8px 12px; border-radius: 20px; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.3s; animation: slideIn 0.3s ease;';
  tag.innerHTML = `
    <span style="font-weight: 500;">üéØ ${purpose}</span>
    <span onclick="removePurposeTag(this, ${memberId})" 
          style="cursor: pointer; font-weight: bold; font-size: 1.2rem; color: #f44336; transition: transform 0.2s; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(244,67,54,0.1);"
          onmouseover="this.style.transform='scale(1.3)'; this.style.background='rgba(244,67,54,0.2)'"
          onmouseout="this.style.transform='scale(1)'; this.style.background='rgba(244,67,54,0.1)'">√ó</span>
  `;
  
  container.appendChild(tag);
  
  // Update hidden textarea
  updatePurposeTextarea(memberId);
  
  showToast('‚úÖ ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫à‡∫∏‡∫î‡∫õ‡∫∞‡∫™‡∫ª‡∫á‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î', 'success');
}

// ===================================
// Remove Purpose Tag
// ===================================
function removePurposeTag(element, memberId) {
  const tag = element.parentElement;
  tag.style.transform = 'scale(0)';
  
  setTimeout(() => {
    tag.remove();
    updatePurposeTextarea(memberId);
    showToast('‡∫•‡∫ª‡∫ö‡∫à‡∫∏‡∫î‡∫õ‡∫∞‡∫™‡∫ª‡∫á‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î', 'success');
  }, 200);
}

// ===================================
// Update Purpose Textarea
// ===================================
function updatePurposeTextarea(memberId) {
  const container = document.getElementById(`purposeTagsContainer${memberId}`);
  const hiddenTextarea = document.getElementById(`purposeHidden${memberId}`);
  
  if (!container || !hiddenTextarea) return;
  
  const tags = container.querySelectorAll('.disease-tag');
  const purposes = Array.from(tags).map(tag => tag.getAttribute('data-purpose'));
  
  hiddenTextarea.value = purposes.join(', ');
}

// ===================================
// Add Rental Period
// ===================================
function addRentalPeriod(memberId) {
  const list = document.getElementById(`rentalPeriodsList${memberId}`);
  if (!list) return;
  
  const periodCount = list.querySelectorAll('.rental-period-item').length + 1;
  
  const periodDiv = document.createElement('div');
  periodDiv.className = 'rental-period-item';
  periodDiv.setAttribute('data-period', periodCount);
  periodDiv.innerHTML = `
    <label>‡∫Ñ‡∫±‡ªâ‡∫á‡∫ó‡∫µ‡ªà ${periodCount}:</label>
    <input type="text" class="date-input rentalDate" placeholder="dd/mm/yyyy" oninput="calculateRentalEndDate(${memberId}, ${periodCount})">
    <input type="number" class="days-input rentalDays" placeholder="‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫ß‡∫±‡∫ô" min="1" oninput="calculateRentalEndDate(${memberId}, ${periodCount})">
    <div class="end-date-display rentalEndDate">-</div>
    <button type="button" class="btn-remove-period" onclick="removeRentalPeriod(${memberId}, ${periodCount})">üóëÔ∏è</button>
  `;
  
  list.appendChild(periodDiv);
  
  showToast('‚úÖ ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫Å‡∫≤‡∫ô‡∫ï‡ªç‡ªà‡∫≠‡∫≤‡∫ç‡∫∏‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î', 'success');
}

// ===================================
// Remove Rental Period
// ===================================
function removeRentalPeriod(memberId, periodNumber) {
  const list = document.getElementById(`rentalPeriodsList${memberId}`);
  if (!list) return;
  
  const items = list.querySelectorAll('.rental-period-item');
  items.forEach(item => {
    if (parseInt(item.getAttribute('data-period')) === periodNumber) {
      item.remove();
    }
  });
  
  // Reorder periods
  const remainingItems = list.querySelectorAll('.rental-period-item');
  remainingItems.forEach((item, index) => {
    const newNumber = index + 1;
    item.setAttribute('data-period', newNumber);
    
    const label = item.querySelector('label');
    if (label) {
      label.textContent = `‡∫Ñ‡∫±‡ªâ‡∫á‡∫ó‡∫µ‡ªà ${newNumber}:`;
    }
    
    const removeBtn = item.querySelector('.btn-remove-period');
    if (removeBtn) {
      removeBtn.setAttribute('onclick', `removeRentalPeriod(${memberId}, ${newNumber})`);
    }
    
    const dateInput = item.querySelector('.rentalDate');
    const daysInput = item.querySelector('.rentalDays');
    if (dateInput && daysInput) {
      dateInput.setAttribute('oninput', `calculateRentalEndDate(${memberId}, ${newNumber})`);
      daysInput.setAttribute('oninput', `calculateRentalEndDate(${memberId}, ${newNumber})`);
    }
  });
  
  showToast('‡∫•‡∫ª‡∫ö‡∫Å‡∫≤‡∫ô‡∫ï‡ªç‡ªà‡∫≠‡∫≤‡∫ç‡∫∏‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î', 'success');
}

// ===================================
// Calculate Rental End Date
// ===================================
function calculateRentalEndDate(memberId, periodNumber) {
  const list = document.getElementById(`rentalPeriodsList${memberId}`);
  if (!list) return;
  
  const items = list.querySelectorAll('.rental-period-item');
  items.forEach(item => {
    if (parseInt(item.getAttribute('data-period')) === periodNumber) {
      const dateInput = item.querySelector('.rentalDate');
      const daysInput = item.querySelector('.rentalDays');
      const endDateDisplay = item.querySelector('.rentalEndDate');
      
      if (dateInput && daysInput && endDateDisplay) {
        const startDate = dateInput.value.trim();
        const days = parseInt(daysInput.value) || 0;
        
        if (startDate && days > 0) {
          // Parse dd/mm/yyyy
          const parts = startDate.split('/');
          if (parts.length === 3) {
            const day = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1; // JS months are 0-based
            const year = parseInt(parts[2]);
            
            const date = new Date(year, month, day);
            date.setDate(date.getDate() + days);
            
            const endDay = String(date.getDate()).padStart(2, '0');
            const endMonth = String(date.getMonth() + 1).padStart(2, '0');
            const endYear = date.getFullYear();
            
            endDateDisplay.textContent = `${endDay}/${endMonth}/${endYear}`;
          }
        } else {
          endDateDisplay.textContent = '-';
        }
      }
    }
  });
}

// ===================================
// Save Mobile Form
// ===================================
document.getElementById('mobileForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  console.log('=== Mobile Form Submit Started ===');
  
  // Collect main data
  const mobileData = {
    mobileCode: document.getElementById('mobileCode').value,
    householdCode: document.getElementById('mobileHouseholdCode').value,
    province: document.getElementById('mobileProvince').value,
    district: document.getElementById('mobileDistrict').value,
    village: document.getElementById('mobileVillage').value,
    unit: document.getElementById('mobileUnit').value,
    position: document.getElementById('mobilePosition').value,
    roomNumber: document.getElementById('mobileRoomNumber').value,
    roomCount: document.getElementById('mobileRoomCount').value,
    ownerName: document.getElementById('mobileOwnerName').value,
    rentalType: document.getElementById('mobileType').value,
    members: []
  };
  
  console.log('Mobile data collected:', mobileData);
  
  // Collect members
  const memberForms = document.querySelectorAll('#mobileMembersContainer .mobile-member-section');
  console.log('Found member forms:', memberForms.length);
  
  memberForms.forEach((form, index) => {
    const memberId = index + 1;
    console.log('Processing mobile member:', memberId);
    
    // Get permit data
    const permitRadios = form.querySelectorAll(`[name="mobilePermit${memberId}"]`);
    let hasPermit = '‡∫ö‡ªç‡ªà‡∫°‡∫µ';
    permitRadios.forEach(radio => {
      if (radio.checked) {
        hasPermit = radio.value;
      }
    });
    
    const permitNumber = hasPermit === '‡∫°‡∫µ' ? 
      (document.getElementById(`permitNumber${memberId}`) ? document.getElementById(`permitNumber${memberId}`).value : '') : '';
    
    // Get rental periods
    const rentalPeriods = [];
    const periodsList = document.getElementById(`rentalPeriodsList${memberId}`);
    if (periodsList) {
      const periodItems = periodsList.querySelectorAll('.rental-period-item');
      periodItems.forEach(item => {
        const dateInput = item.querySelector('.rentalDate');
        const daysInput = item.querySelector('.rentalDays');
        const endDateDisplay = item.querySelector('.rentalEndDate');
        
        if (dateInput && daysInput && endDateDisplay) {
          rentalPeriods.push({
            periodNumber: parseInt(item.getAttribute('data-period')),
            renewalDate: dateInput.value,
            days: parseInt(daysInput.value) || 0,
            endDate: endDateDisplay.textContent !== '-' ? endDateDisplay.textContent : ''
          });
        }
      });
    }
    
    const member = {
      name: form.querySelector('.mobileMemberName') ? form.querySelector('.mobileMemberName').value : '',
      photo: getPhotoData(`mobileMemberPhotoPreview${memberId}`),
      gender: form.querySelector('.mobileMemberGender') ? form.querySelector('.mobileMemberGender').value : '',
      birthDate: `${form.querySelector('.mobileBirthDay') ? form.querySelector('.mobileBirthDay').value : ''}/${form.querySelector('.mobileBirthMonth') ? form.querySelector('.mobileBirthMonth').value : ''}/${form.querySelector('.mobileBirthYear') ? form.querySelector('.mobileBirthYear').value : ''}`,
      nationality: form.querySelector('.mobileMemberNationality') ? form.querySelector('.mobileMemberNationality').value : '',
      ethnicity: form.querySelector('.mobileMemberEthnicity') ? form.querySelector('.mobileMemberEthnicity').value : '',
      religion: form.querySelector('.mobileMemberReligion') ? form.querySelector('.mobileMemberReligion').value : '',
      education: form.querySelector('.mobileMemberEducation') ? form.querySelector('.mobileMemberEducation').value : '',
      relationship: form.querySelector('.mobileMemberRelationship') ? form.querySelector('.mobileMemberRelationship').value : '',
      maritalStatus: form.querySelector('.mobileMemberMaritalStatus') ? form.querySelector('.mobileMemberMaritalStatus').value : '',
      phone: form.querySelector('.mobileMemberPhone') ? form.querySelector('.mobileMemberPhone').value : '',
      occupation: form.querySelector('.mobileMemberOccupation') ? form.querySelector('.mobileMemberOccupation').value : '',
      workplace: form.querySelector('.mobileMemberWorkplace') ? form.querySelector('.mobileMemberWorkplace').value : '',
      purpose: form.querySelector('.mobileMemberPurpose') ? form.querySelector('.mobileMemberPurpose').value : '',
      hasPermit: hasPermit,
      permitNumber: permitNumber,
      firstArrival: form.querySelector('.mobileFirstArrival') ? form.querySelector('.mobileFirstArrival').value : '',
      rentalPeriods: rentalPeriods
    };
    
    console.log('Mobile member data:', member);
    mobileData.members.push(member);
  });
  
  console.log('Final mobile data:', mobileData);
  showLoading();
  
  // Save data
  if (mobileData.mobileCode) {
    console.log('Updating existing mobile...');
    google.script.run
      .withSuccessHandler(handleMobileSaveSuccess)
      .withFailureHandler(handleMobileSaveFailure)
      .updateMobile(mobileData, villageSheetId);
  } else {
    console.log('Saving new mobile...');
    google.script.run
      .withSuccessHandler(handleMobileSaveSuccess)
      .withFailureHandler(handleMobileSaveFailure)
      .saveMobile(mobileData, villageSheetId);
  }
  
  function handleMobileSaveSuccess(result) {
    console.log('Mobile save success:', result);
    
    if (result.success) {
      if (result.mobileCode) {
        mobileData.mobileCode = result.mobileCode;
      }
      
      const existingIndex = mobilesData.findIndex(m => m.mobileCode === mobileData.mobileCode);
      if (existingIndex >= 0) {
        mobilesData[existingIndex] = mobileData;
      } else {
        mobilesData.push(mobileData);
      }
      
      saveToIndexedDB('mobiles', mobileData);
      
      hideLoading();
      showToast(result.message, 'success');
      closeMobileForm();
      loadMobileData();
    } else {
      hideLoading();
      showToast(result.message, 'error');
    }
  }
  
  function handleMobileSaveFailure(error) {
    console.error('Mobile save failed:', error);
    
    saveToSyncQueue('saveMobile', mobileData);
    
    if (!mobileData.mobileCode) {
      mobileData.mobileCode = 'Mobile-' + generateRandomCode(13);
    }
    
    const existingIndex = mobilesData.findIndex(m => m.mobileCode === mobileData.mobileCode);
    if (existingIndex >= 0) {
      mobilesData[existingIndex] = mobileData;
    } else {
      mobilesData.push(mobileData);
    }
    
    saveToIndexedDB('mobiles', mobileData);
    
    hideLoading();
    showToast('‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡ªÅ‡∫ö‡∫ö‡∫≠‡∫≠‡∫ö‡ªÑ‡∫•‡∫ô‡ªå‡∏™‡∫≥‡πÄ‡∫•‡∫±‡∫î ‡∫à‡∫∞ Sync ‡ªÄ‡∫°‡∫∑‡ªà‡∫≠‡∫°‡∫µ‡∫≠‡∫¥‡∫ô‡ªÄ‡∫ï‡∫µ‡ªÄ‡∫ô‡∫±‡∫î', 'success');
    closeMobileForm();
    loadMobileData();
  }
});

// ===================================
// Edit Mobile
// ===================================
function editMobile(mobileCode) {
  const mobile = mobilesData.find(m => m.mobileCode === mobileCode);
  if (!mobile) {
    showToast('‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô', 'error');
    return;
  }
  
  console.log('Editing mobile:', mobile);
  
  document.getElementById('mobileFormTitle').textContent = '‚úèÔ∏è ‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡∫õ‡∫∞‡∫ä‡∫≤‡∫Å‡∫≠‡∫ô‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫ô‡∫ó‡∫µ‡ªà';
  document.getElementById('mobileCode').value = mobile.mobileCode;
  document.getElementById('mobileType').value = mobile.rentalType || '‡∫û‡∫±‡∫Å‡ªÄ‡∫ä‡∫ª‡∫≤‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫ô‡∫ó‡∫µ‡ªà';
  document.getElementById('mobileHouseholdCode').value = mobile.householdCode || '';
  document.getElementById('mobileProvince').value = mobile.province || '';
  document.getElementById('mobileDistrict').value = mobile.district || '';
  document.getElementById('mobileVillage').value = mobile.village || '';
  document.getElementById('mobileUnit').value = mobile.unit || '';
  document.getElementById('mobilePosition').value = mobile.position || '';
  document.getElementById('mobileRoomNumber').value = mobile.roomNumber || '';
  document.getElementById('mobileRoomCount').value = mobile.roomCount || '';
  document.getElementById('mobileOwnerName').value = mobile.ownerName || '';
  
  // Clear members container
  const membersContainer = document.getElementById('mobileMembersContainer');
  membersContainer.innerHTML = '';
  mobileMemberCounter = 0;
  
  // Add members if exist
  if (mobile.members && mobile.members.length > 0) {
    mobile.members.forEach(member => {
      mobileMemberCounter++;
      const memberDiv = document.createElement('div');
      memberDiv.className = 'mobile-member-section';
      memberDiv.id = `mobile-member-${mobileMemberCounter}`;
      memberDiv.innerHTML = getMobileMemberFormHTML(mobileMemberCounter, member);
      membersContainer.appendChild(memberDiv);
      
      // Initialize purpose tags
      setTimeout(() => {
        if (member.purpose) {
          initializeExistingPurposes(mobileMemberCounter, member.purpose);
        }
      }, 100);
      
      // Initialize rental periods
      setTimeout(() => {
        if (member.rentalPeriods && member.rentalPeriods.length > 0) {
          member.rentalPeriods.forEach(period => {
            addRentalPeriod(mobileMemberCounter);
            
            // Fill data
            const list = document.getElementById(`rentalPeriodsList${mobileMemberCounter}`);
            if (list) {
              const items = list.querySelectorAll('.rental-period-item');
              const lastItem = items[items.length - 1];
              
              if (lastItem) {
                const dateInput = lastItem.querySelector('.rentalDate');
                const daysInput = lastItem.querySelector('.rentalDays');
                const endDateDisplay = lastItem.querySelector('.rentalEndDate');
                
                if (dateInput) dateInput.value = period.renewalDate || '';
                if (daysInput) daysInput.value = period.days || '';
                if (endDateDisplay) endDateDisplay.textContent = period.endDate || '-';
              }
            }
          });
        }
      }, 200);
    });
  }
  
  populateMobileDataLists();
  document.getElementById('mobileFormModal').classList.add('active');
}

// ===================================
// Initialize Existing Purposes
// ===================================
function initializeExistingPurposes(memberId, purposesString) {
  if (!purposesString) return;
  
  const purposes = purposesString.split(',').map(p => p.trim()).filter(p => p);
  purposes.forEach(purpose => {
    addPurposeTag(purpose, memberId);
  });
}

// ===================================
// Delete Mobile (already handled in showDeleteModal)
// ===================================
// No additional code needed - deletion is handled by:
// showDeleteModal('mobile', mobileCode) -> confirmDelete() -> deleteMobile() in GAS

// ===================================
// Open Mobile Location Picker
// ===================================
function openMobileLocationPicker() {
  // Reuse the same location picker modal
  document.getElementById('locationModal').classList.add('active');
  
  // Destroy old map if exists
  if (map) {
    map.remove();
    map = null;
  }
  
  // Wait for modal to be visible
  setTimeout(() => {
    initializeMobileMap();
  }, 300);
}

// ===================================
// Initialize Mobile Map
// ===================================
function initializeMobileMap() {
  // Default to Vientiane, Laos
  const defaultLat = 17.9757;
  const defaultLng = 102.6331;
  
  // Get current value if exists
  const currentValue = document.getElementById('mobilePosition').value;
  let initialLat = defaultLat;
  let initialLng = defaultLng;
  
  if (currentValue && currentValue.includes(',')) {
    const parts = currentValue.split(',');
    initialLat = parseFloat(parts[0].trim()) || defaultLat;
    initialLng = parseFloat(parts[1].trim()) || defaultLng;
  }
  
  // Create map
  map = L.map('map', {
    center: [initialLat, initialLng],
    zoom: 15,
    preferCanvas: true
  });
  
  // Create Street Map Layer
  streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap',
    maxZoom: 19
  });
  
  // Create Satellite Layer
  satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: '¬© Esri',
    maxZoom: 19
  });
  
  // Add satellite layer as default
  satelliteLayer.addTo(map);
  
  // Create custom marker
  const beautifulIcon = createCustomMarkerIcon();
  
  // Add marker
  marker = L.marker([initialLat, initialLng], { 
    draggable: true,
    icon: beautifulIcon
  }).addTo(map);
  
  selectedLatLng = { lat: initialLat, lng: initialLng };
  updateLocationDisplay();
  
  // Update location when marker is dragged
  marker.on('dragend', function(e) {
    const pos = marker.getLatLng();
    selectedLatLng = { lat: pos.lat, lng: pos.lng };
    updateLocationDisplay();
  });
  
  // Update location when map is clicked
  map.on('click', function(e) {
    marker.setLatLng(e.latlng);
    selectedLatLng = { lat: e.latlng.lat, lng: e.latlng.lng };
    updateLocationDisplay();
  });
  
  // Force tiles to load
  map.invalidateSize();
  
  // Try to get user location
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function(position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        map.setView([lat, lng], 17);
        marker.setLatLng([lat, lng]);
        selectedLatLng = { lat: lat, lng: lng };
        updateLocationDisplay();
        showToast('üìç ‡∫û‡∫ª‡∫ö‡∫ï‡∫≥‡ªÅ‡ªú‡ªà‡∫á‡∫õ‡∫±‡∫î‡∫à‡∫∏‡∫ö‡∫±‡∫ô‡∫Ç‡∫≠‡∫á‡∫ó‡ªà‡∫≤‡∫ô', 'success');
      },
      function(error) {
        console.log('Geolocation error:', error);
      }
    );
  }
  
  // Override confirmLocation to save to mobile position field
  window.confirmMobileLocation = function() {
    if (selectedLatLng) {
      const lat = selectedLatLng.lat.toFixed(6);
      const lng = selectedLatLng.lng.toFixed(6);
      document.getElementById('mobilePosition').value = `${lat}, ${lng}`;
      showToast('‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫ï‡ªç‡∫≤‡ªÅ‡ªú‡ªà‡∫á‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î ‚úÖ', 'success');
    }
    closeLocationPicker();
  };
}

// ===================================
// Purpose List DataList
// ===================================
function createPurposeDataList() {
  // Check if datalist exists
  let datalist = document.getElementById('purposeList');
  if (!datalist) {
    datalist = document.createElement('datalist');
    datalist.id = 'purposeList';
    document.body.appendChild(datalist);
  }
  
  // Common purposes
  const purposes = [
    '‡ªÄ‡∫Æ‡∫±‡∫î‡∫ß‡∫Ω‡∫Å',
    '‡∫Æ‡∫Ω‡∫ô‡∫´‡∫ô‡∫±‡∫á‡∫™‡∫∑',
    '‡∫õ‡∫¥‡ªà‡∫ô‡∫õ‡∫ª‡∫ß‡∫û‡∫∞‡∫ç‡∫≤‡∫î',
    '‡∫ó‡ªà‡∫≠‡∫á‡∫ó‡ªà‡∫Ω‡∫ß',
    '‡∫ó‡∫∏‡∫•‡∫∞‡∫Å‡∫¥‡∫î',
    '‡∫¢‡ªâ‡∫≤‡∫ç‡∫ö‡ªà‡∫≠‡∫ô‡∫¢‡∫π‡ªà',
    '‡∫û‡∫±‡∫Å‡ªÄ‡∫ä‡∫ª‡∫≤‡∫ä‡∫ª‡ªà‡∫ß‡∫Ñ‡∫≤‡∫ß',
    '‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡∫Æ‡ªà‡∫ß‡∫°‡ªÇ‡∫Ñ‡∫á‡∫Å‡∫≤‡∫ô',
    '‡∫≠‡∫∑‡ªà‡∫ô‡ªÜ'
  ];
  
  datalist.innerHTML = '';
  purposes.forEach(purpose => {
    const option = document.createElement('option');
    option.value = purpose;
    datalist.appendChild(option);
  });
}

// Create purpose datalist on page load
createPurposeDataList();

// ===================================
// Console Helper - Debug Mobile Data
// ===================================
function debugMobileData() {
  console.clear();
  console.log('='.repeat(50));
  console.log('DEBUG MOBILE DATA');
  console.log('='.repeat(50));
  
  console.log('1. mobilesData exists?', mobilesData !== null && mobilesData !== undefined);
  console.log('2. mobilesData type:', typeof mobilesData);
  console.log('3. mobilesData is Array?', Array.isArray(mobilesData));
  console.log('4. mobilesData length:', mobilesData.length);
  
  if (mobilesData.length > 0) {
    console.log('5. First mobile:');
    console.log(mobilesData[0]);
    
    if (mobilesData[0].members) {
      console.log('6. First mobile members count:', mobilesData[0].members.length);
    }
  } else {
    console.log('ERROR: No mobiles in mobilesData array');
  }
  
  console.log('='.repeat(50));
  
  alert('‡∫Å‡∫ß‡∫î‡∫™‡∫≠‡∫ö Console (F12) ‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÄ‡∫ö‡∫¥‡ªà‡∫á‡∫ú‡∫ª‡∫ô‡∫•‡∫±‡∫ö');
}

console.log('‚úÖ All mobile population functions loaded successfully!');

  </script>
</body>
</html>